<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>arm-trusted-firmware可信启动机制 - Y1secoのblog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Y1secoのblog"><meta name="msapplication-TileImage" content="./img/avatar1.jpg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Y1secoのblog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="ATF 可信启动调研"><meta property="og:type" content="blog"><meta property="og:title" content="Y1seco"><meta property="og:url" content="https://y1seco.github.io/"><meta property="og:site_name" content="Y1seco"><meta property="og:description" content="ATF 可信启动调研"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://w.wallhaven.cc/full/1k/wallhaven-1km5dg.jpg"><meta property="article:published_time" content="2022-04-20T02:36:32.926Z"><meta property="article:modified_time" content="2022-04-20T02:39:46.127Z"><meta property="article:author" content="Y1seco"><meta property="article:tag" content="arm"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://w.wallhaven.cc/full/1k/wallhaven-1km5dg.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://y1seco.github.io/2022/04/20/ATF%E5%AE%89%E5%85%A8%E6%8A%80%E6%9C%AF%E8%B0%83%E7%A0%94%E6%8A%A5%E5%91%8A/"},"headline":"Y1secoのblog","image":["https://w.wallhaven.cc/full/1k/wallhaven-1km5dg.jpg"],"datePublished":"2022-04-20T02:36:32.926Z","dateModified":"2022-04-20T02:39:46.127Z","author":{"@type":"Person","name":"y1seco"},"description":"ATF 可信启动调研"}</script><link rel="canonical" href="https://y1seco.github.io/2022/04/20/ATF%E5%AE%89%E5%85%A8%E6%8A%80%E6%9C%AF%E8%B0%83%E7%A0%94%E6%8A%A5%E5%91%8A/"><link rel="icon" href="/./img/avatar1.jpg"><meta name="referrer" content="no-referrer-when-downgrade"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css?family=Ubuntu:400,600|Source+Code+Pro|Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Microsoft YaHei:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&amp;amp;subset=latin,latin-ext|Inconsolata|Itim|Lobster.css"><script src="https://cdnjs.loli.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="/js/globalUtils.js"></script><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdnjs.loli.net/ajax/libs/pace/1.0.2/pace.min.js"></script><meta name="generator" content="Hexo 5.4.1"><link rel="alternate" href="/atom.xml" title="Y1secoのblog" type="application/atom+xml">
</head><body class="is-3-column has-navbar-fixed-top"><nav class="navbar navbar-main is-fixed-top"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/./img/avatar1.jpg" alt="Y1secoのblog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Join Gitter" href="https://gitter.im/hexo-theme-amazing/community"><i class="fab fa-gitter"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/removeif/hexo-theme-amazing"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a><a class="navbar-item" id="night-nav" title="Night Mode" href="javascript:;"><i class="fas fa-moon" id="night-icon"></i></a></div></div></div></nav><script type="text/javascript" src="/js/theme-setting.js"></script><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><!--!--><div class="card"><div class="card-image"><span class="image is-7by3"><img class="fill" src="https://w.wallhaven.cc/full/1k/wallhaven-1km5dg.jpg" alt="arm-trusted-firmware可信启动机制"></span></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><i class="far fa-calendar-plus"> </i>2022-04-20  <a class="commentCountImg" href="/2022/04/20/ATF%E5%AE%89%E5%85%A8%E6%8A%80%E6%9C%AF%E8%B0%83%E7%A0%94%E6%8A%A5%E5%91%8A/#comment-container"><span class="display-none-class">3d9981d53f6c0bbc249c97d69eab8dbb</span><i class="far fa-comment-dots"></i> <span class="commentCount" id="3d9981d53f6c0bbc249c97d69eab8dbb">99+</span>  </a><span class="level-item"><i class="far fa-clock"> </i>28 m  <i class="fas fa-pencil-alt"> </i>4.2 k</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>&nbsp;visits</span></div></div><h1 class="title is-3 is-size-4-mobile">arm-trusted-firmware可信启动机制</h1><div class="content"><p>ATF 可信启动调研</p>
<span id="more"></span>
<h1 id="arm安全技术atf的可信启动"><a class="markdownIt-Anchor" href="#arm安全技术atf的可信启动">#</a> ARM 安全技术（ATF 的可信启动）</h1>
<h1 id="一-目标"><a class="markdownIt-Anchor" href="#一-目标">#</a> 一、目标</h1>
<p>本文主要针对 ATF 的可信启动进行分析，可信机制主要位于代码的 BL2 文件夹中，目录结构如下：</p>
<p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202204192350730.png" alt="image-20220419235053590"></p>
<p>为便于后续分析给出 ATF 加载流程，给出官网中一个直观的流程图：</p>
<p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202204201039122.jpeg" alt="img"></p>
<p>另外 ATF 固件源码整体架构如下：</p>
<p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202204191908530.png" alt="在这里插入图片描述"></p>
<h1 id="二-核心服务原理分析"><a class="markdownIt-Anchor" href="#二-核心服务原理分析">#</a> 二、核心服务原理分析</h1>
<h2 id="一安全启动与信任链"><a class="markdownIt-Anchor" href="#一安全启动与信任链">#</a> （一）安全启动与信任链</h2>
<p>安全启动是建立系统信任链（Chain of Trust）的基础。信任链（Chain of Trust）是基于根信任（Root of trust）创建的， 而根信任的实现是基于两种技术：不可修改的 bootloader 和不可被修改的公钥。公钥通常存放在 OTP（One-Time-Programmable）内存中， bootloader 同常存储在 ROM 中或者不可修改的 Flash 内存中。</p>
<h2 id="二安全启动流程图"><a class="markdownIt-Anchor" href="#二安全启动流程图">#</a> （二）安全启动流程图</h2>
<blockquote>
<p>为了便于后续对代码的理解分析，这里先给出安全启动流程图</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202204192304669.png" alt="image-20220419230432541"></p>
<h3 id="说明"><a class="markdownIt-Anchor" href="#说明">#</a> 说明：</h3>
<h4 id="arch初始化"><a class="markdownIt-Anchor" href="#arch初始化">#</a> arch 初始化</h4>
<p>对于 AArch64：</p>
<ol>
<li>BL2 执行 normal world 和后续阶段所需的最小架构初始化。</li>
<li>通过清零 CPACR.FPEN 位，使 EL1 和 EL0 可以访问 SIMD 寄存器。</li>
</ol>
<h4 id="platform初始化"><a class="markdownIt-Anchor" href="#platform初始化">#</a> Platform 初始化</h4>
<p>BL2 主要执行如下初始化步骤：</p>
<p>1、初始化 console (PL101).（尽管在 bl1 时已经初始化过一次）<br>
2、初始化和配置储存设备驱动，用于加载后续的 bl。<br>
3、使能 MMU ，map the memory，访问权限.<br>
4、平台安全设置，相关组件（寄存器，外设，地址等）的访问控制<br>
 5、为 BL3 阶段的 image 保留内存空间。<br>
6、为 BL3 阶段的 image 定义可用内存地址范围。<br>
7、如果 BL1 使用 TB_FW_CONFIG dynamic configuration file (保存在 arg0) , 解析配置参数</p>
<h4 id="image-load"><a class="markdownIt-Anchor" href="#image-load">#</a> image load</h4>
<p>BL2 通过查找 image list 的方式加载 image，并且将这个 list 传递给下一个 BL 镜像。</p>
<p>平台实现方法提供的可加载 image list 还可以包含动态配置文件。这个配置文件可以根据需要在 bl2_plat_handle_post_image_load（）函数中进行解析。 通过更新此函数中的相应 ep 信息，可以将这些配置文件作为参数传递给下一个 Boot Loader 阶段。</p>
<h4 id="scp_bl2-image-load"><a class="markdownIt-Anchor" href="#scp_bl2-image-load">#</a> SCP_BL2 image load</h4>
<p>BL2 将可选的 SCP_BL2 镜像从平台存储设备加载到特定的安全内存区域。 SCP_BL2 的后续处理是特定于具体平台的，需要自行实现。 例如，Arm Juno ，BL2 先把 SCP_BL2 加载到 trust sram，再使用 Boot Over MHU (BOM) 协议，把 SCP_BL2 加载到 SCP 的内部 RAM 之后，SCP 运行 SCP_BL2，并给 AP 发出 signals，通知 BL2 继续执行。</p>
<h4 id="load-el3-software"><a class="markdownIt-Anchor" href="#load-el3-software">#</a> Load EL3 software</h4>
<p>BL2 从平台存储设备加载 EL3 runtime software 到 trusted SRAM. 如果内存空间不够或者镜像不存在去，则 assert 停止运行。</p>
<h4 id="aarch64secure-el1-payload-image-load"><a class="markdownIt-Anchor" href="#aarch64secure-el1-payload-image-load">#</a> AArch64(Secure-EL1 payload) image load</h4>
<p>BL2 将可选的 BL32 镜像从平台存储设备加载到特定于平台的安全存储区域。BL32 镜像在安全世界中执行。BL2 依靠 BL31 将控制权限传递给 BL32（如果存在）。 因此，BL2 也会使用 BL32 镜像的 entrypoint。 用于进入 BL32 的 Saved Processor Status Register（SPSR）的值不是由 BL2 确定的，它由 BL31 内的 Secure-EL1 Payload Dispatcher (SPD) 初始化，SPD 负责管理与 BL32 的交互。此信息将传递给 BL31。</p>
<h4 id="bl33non-trusted-fireware-image-load"><a class="markdownIt-Anchor" href="#bl33non-trusted-fireware-image-load">#</a> BL33(Non-trusted Fireware) image load</h4>
<p>BL2 将 BL33 镜像（e.g. UEFI or other test or boot software）从平台存储设备加载到由平台定义的非安全内存中。</p>
<p>一旦安全状态初始化完成，BL2 依靠 EL3 Runtime Software 将控制权传递给 BL33。 因此，BL2 使用正常世界的镜像入口和保存程序状态寄存器（SPSR）填充平台指定的存储区域。entrypoint 是 BL33 镜像的加载地址。 SPSR 按照 PSCI PDD 中的规定确定（PSCI 5.13 节）。 此信息将传递给 EL3runtime software。</p>
<h4 id="aarch64-bl31el3-runtime-software-execution"><a class="markdownIt-Anchor" href="#aarch64-bl31el3-runtime-software-execution">#</a> AArch64 BL31(EL3 Runtime Software) execution</h4>
<p>BL2 执行继续如下：</p>
<p>BL2 通过产生 SMC 异常将控制权传递回 BL1，并给 BL1 提供 BL31 入口点。 SMC 异常由 BL1 阶段 install 的 SMC exception handler 来处理。<br>
BL1 关闭 MMU 并刷 Cache。清 SCTLR_EL3.M/ I / C 位，将 D-cache 刷新到 point of coherency 并使 TLB 无效。<br>
BL1 在 EL3 的指定入口地址将控制权传递给 BL31。</p>
<h1 id="三-源代码分析"><a class="markdownIt-Anchor" href="#三-源代码分析">#</a> 三、源代码分析</h1>
<h2 id="一bl1trusted-boot-rom分析"><a class="markdownIt-Anchor" href="#一bl1trusted-boot-rom分析">#</a> （一）BL1（<strong>Trusted Boot ROM</strong>）分析</h2>
<p>BL1 启动最早的 ROM，是在 CPU 的 ROM 里不是和 BIOS 一起，是一起的信任根。BL1 主要目的是建立 Trusted SRAM、exception vector、初始化串口 console 等等。然后找到并验证 BL2（验签 CSF 头），然后跳过去。</p>
<p>入口点:bl1_entrypoint.S:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">func bl1_entrypoint</span><br><span class="line">        ....</span><br><span class="line">	bl	bl1_early_platform_setup</span><br><span class="line">	bl	bl1_plat_arch_setup</span><br><span class="line">        ....</span><br><span class="line">	bl	bl1_main</span><br><span class="line">        ....</span><br><span class="line">	b	el3_exit</span><br><span class="line">endfunc bl1_entrypoint</span><br></pre></td></tr></table></figure>
<h2 id="二bl2trusted-boot-firmware分析"><a class="markdownIt-Anchor" href="#二bl2trusted-boot-firmware分析">#</a> （二）BL2（<strong>Trusted Boot Firmware</strong>）分析</h2>
<h3 id="1-功能概要"><a class="markdownIt-Anchor" href="#1-功能概要">#</a> 1、功能概要</h3>
<p>BL2 主要负责对其他所有 BL 进行认证和加载，并执行 BL31, 该函数主要实现将 BL3x 的 image 加载 RAM 中，并通过 smc 调用执行 BL1 中指定的 smc handle 将 CPU 的全向交给 BL31。</p>
<h3 id="2-主过程"><a class="markdownIt-Anchor" href="#2-主过程">#</a> 2、主过程</h3>
<blockquote>
<p>各部分代码分析已在注释中给出</p>
</blockquote>
<h4 id="bl2_entrypoints"><a class="markdownIt-Anchor" href="#bl2_entrypoints">#</a> BL2_entrypoint.S</h4>
<ul>
<li>BL2 入口位于 <code>bl2/aarch64/bl2_entrypoint.S</code>  中，BL2_entrypoint 是 BL2 的入口，前半部分主要进行一系列初始化工作，然后通过 BL2_main () 加载 BL3x 镜像到 RAM 中，最后通过 SMC 调用执行 BL1 中指定的 smc handler 将 CPU 执行权交给 BL31。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">	.globl	bl2_entrypoint</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">func bl2_entrypoint</span><br><span class="line">	mov	x20, x1 /* x1保存了内存布局信息 */</span><br><span class="line"></span><br><span class="line">    /* 设置异常处理函数 */</span><br><span class="line">	adr	x0, early_exceptions</span><br><span class="line">	msr	vbar_el1, x0</span><br><span class="line">	isb</span><br><span class="line"></span><br><span class="line">	/* ---------------------------------------------</span><br><span class="line">	 * 使能异常</span><br><span class="line">	 * ---------------------------------------------</span><br><span class="line">	 */</span><br><span class="line">	msr	daifclr, #DAIF_ABT_BIT</span><br><span class="line"></span><br><span class="line">	/* ---------------------------------------------</span><br><span class="line">	 * 使能指令缓存，使能堆栈数据访问对齐检查</span><br><span class="line">	 * ---------------------------------------------</span><br><span class="line">	 */</span><br><span class="line">	mov	x1, #(SCTLR_I_BIT | SCTLR_A_BIT | SCTLR_SA_BIT)</span><br><span class="line">	mrs	x0, sctlr_el1</span><br><span class="line">	orr	x0, x0, x1</span><br><span class="line">	msr	sctlr_el1, x0</span><br><span class="line">	isb</span><br><span class="line"></span><br><span class="line">	/* ---------------------------------------------</span><br><span class="line">	 * 失效内存</span><br><span class="line">	 * ---------------------------------------------</span><br><span class="line">	 */</span><br><span class="line">	adr	x0, __RW_START__</span><br><span class="line">	adr	x1, __RW_END__</span><br><span class="line">	sub	x1, x1, x0</span><br><span class="line">	bl	inv_dcache_range</span><br><span class="line"></span><br><span class="line">	/* ---------------------------------------------</span><br><span class="line">	 * BSS内存初始化</span><br><span class="line">	 * ---------------------------------------------</span><br><span class="line">	 */</span><br><span class="line">	ldr	x0, =__BSS_START__</span><br><span class="line">	ldr	x1, =__BSS_SIZE__</span><br><span class="line">	bl	zeromem16</span><br><span class="line"></span><br><span class="line">#if USE_COHERENT_MEM</span><br><span class="line">	ldr	x0, =__COHERENT_RAM_START__</span><br><span class="line">	ldr	x1, =__COHERENT_RAM_UNALIGNED_SIZE__</span><br><span class="line">	bl	zeromem16</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">	/* --------------------------------------------</span><br><span class="line">	 * 设置SP指针</span><br><span class="line">	 * --------------------------------------------</span><br><span class="line">	 */</span><br><span class="line">	bl	plat_set_my_stack</span><br><span class="line"></span><br><span class="line">	/* ---------------------------------------------</span><br><span class="line">	 * 串口初始化，更新内存布局信息，并初始化页表使能mmu</span><br><span class="line">	 * ---------------------------------------------</span><br><span class="line">	 */</span><br><span class="line">	mov	x0, x20</span><br><span class="line">	bl	bl2_early_platform_setup</span><br><span class="line">	bl	bl2_plat_arch_setup</span><br><span class="line"></span><br><span class="line">	/* ---------------------------------------------</span><br><span class="line">	 * 跳转到主函数（通过SMC执行下一级BL不会返回）</span><br><span class="line">	 * ---------------------------------------------</span><br><span class="line">	 */</span><br><span class="line">	bl	bl2_main</span><br><span class="line"></span><br><span class="line">	/* ---------------------------------------------</span><br><span class="line">	 * 下面的代码不会执行</span><br><span class="line">	 * ---------------------------------------------</span><br><span class="line">	 */</span><br><span class="line">	no_ret	plat_panic_handler</span><br><span class="line"></span><br><span class="line">endfunc bl2_entrypoint</span><br></pre></td></tr></table></figure>
<h4 id="bl2_main"><a class="markdownIt-Anchor" href="#bl2_main">#</a> BL2_main</h4>
<p>bl2_main 为 bl2 的主程序，位于 bl2/bl2_main.c 中，安全启动的最重要两步在这个函数中完成：初始化硬件和找到 BL31。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">void bl2_main(void)</span><br><span class="line">&#123;</span><br><span class="line">	entry_point_info_t *next_bl_ep_info;</span><br><span class="line">	/* 输出提示信息 */</span><br><span class="line">	NOTICE(&quot;BL2: %s\n&quot;, version_string); </span><br><span class="line">	NOTICE(&quot;BL2: %s\n&quot;, build_message);</span><br><span class="line"></span><br><span class="line">	/* Perform remaining generic architectural setup in S-EL1 */</span><br><span class="line">	</span><br><span class="line">	/* 初始化，这里开启FP/SIMD的访问权限 */</span><br><span class="line">	bl2_arch_setup();</span><br><span class="line"></span><br><span class="line">#if PSA_FWU_SUPPORT</span><br><span class="line">	fwu_init();</span><br><span class="line">#endif /* PSA_FWU_SUPPORT */</span><br><span class="line"></span><br><span class="line">	crypto_mod_init();	//初始化加密库，加密库可以用于校验签名和哈希</span><br><span class="line"></span><br><span class="line">	/* Initialize authentication module */</span><br><span class="line">	auth_mod_init(); //初始化认证模块</span><br><span class="line"></span><br><span class="line">	/* Initialize the Measured Boot backend */</span><br><span class="line">	bl2_plat_mboot_init();	//初始化 measured boot后端</span><br><span class="line"></span><br><span class="line">	/* Initialize boot source */</span><br><span class="line">	bl2_plat_preload_setup();  //初始化镜像解析模块（img_parser_mod），用于校验镜像完整性以及从镜像中提取内容</span><br><span class="line"></span><br><span class="line">	/*加载后续引导加载程序映像。*/	</span><br><span class="line">	next_bl_ep_info = bl2_load_images();</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	/*拆除 Measured Boot 后端*/</span><br><span class="line">	bl2_plat_mboot_finish();</span><br><span class="line"></span><br><span class="line">#if !BL2_AT_EL3 &amp;&amp; !ENABLE_RME</span><br><span class="line">#ifndef __aarch64__</span><br><span class="line">	/*</span><br><span class="line">	 * 对于 AArch32 状态，BL1 和 BL2 共享 MMU 设置。</span><br><span class="line">	 * 鉴于 BL2 不映射 BL1 区域，MMU 需要</span><br><span class="line">	 * 被禁用以返回 BL1。</span><br><span class="line">	 */</span><br><span class="line">	disable_mmu_icache_secure();</span><br><span class="line">#endif /* !__aarch64__ */</span><br><span class="line"></span><br><span class="line">	console_flush(); //控制台刷新</span><br><span class="line"></span><br><span class="line">#if ENABLE_PAUTH</span><br><span class="line">	/*</span><br><span class="line">	 * 在运行下一个引导映像之前禁用指针身份验证</span><br><span class="line">	 */</span><br><span class="line">	pauth_disable_el1();</span><br><span class="line">#endif /* ENABLE_PAUTH */</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">/* 调用smc指令，触发在bl1中设定的smc异常中断处理函数，跳转到bl31 */</span><br><span class="line">	smc(BL1_SMC_RUN_IMAGE, (unsigned long)next_bl_ep_info, 0, 0, 0, 0, 0, 0);</span><br><span class="line">#else /* if BL2_AT_EL3 || ENABLE_RME */</span><br><span class="line">	NOTICE(&quot;BL2: Booting &quot; NEXT_IMAGE &quot;\n&quot;);</span><br><span class="line">	print_entry_point_info(next_bl_ep_info);</span><br><span class="line">	console_flush();</span><br><span class="line"></span><br><span class="line">#if ENABLE_PAUTH</span><br><span class="line">	/*</span><br><span class="line">	 * 在运行下一个引导映像之前禁用指针身份验证</span><br><span class="line">	 */</span><br><span class="line">	pauth_disable_el3();</span><br><span class="line">#endif /* ENABLE_PAUTH */</span><br><span class="line"></span><br><span class="line">	bl2_run_next_image(next_bl_ep_info);</span><br><span class="line">#endif /* BL2_AT_EL3 &amp;&amp; ENABLE_RME */</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面依次对 bl2_main 中的安全模块进行分析：</p>
<h5 id="crypto_mod_init"><a class="markdownIt-Anchor" href="#crypto_mod_init">#</a> crypto_mod_init()</h5>
<p>主要初始化加密库，加密库可以用于校验签名和哈希，跟进 <code>crypto_mod_init()</code></p>
<p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202204192238842.png" alt="image-20220419223805632"></p>
<p>在 crypto_mod.h 中定义了 <code>crypto_lib_desc_s</code>  结构体</p>
<p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202204192239362.png" alt="image-20220419223942221"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">crypto_lib_desc_s</span> &#123;</span></span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *name;<span class="comment">/* 名称， */</span></span><br><span class="line"></span><br><span class="line">	<span class="type">void</span> (*init)(<span class="type">void</span>);<span class="comment">/* 初始化方法 */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 校验签名的方法 */</span></span><br><span class="line">	<span class="type">int</span> (*verify_signature)(</span><br><span class="line">                <span class="type">void</span> *data_ptr, <span class="type">unsigned</span> <span class="type">int</span> data_len,   <span class="comment">/* 要签名的数据 */</span></span><br><span class="line">				<span class="type">void</span> *sig_ptr, <span class="type">unsigned</span> <span class="type">int</span> sig_len,     <span class="comment">/* 签名 */</span></span><br><span class="line">				<span class="type">void</span> *sig_alg, <span class="type">unsigned</span> <span class="type">int</span> sig_alg_len, <span class="comment">/* 签名算法 */</span></span><br><span class="line">				<span class="type">void</span> *pk_ptr, <span class="type">unsigned</span> <span class="type">int</span> pk_len);      <span class="comment">/* 公钥 */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 校验哈希的方法 */</span></span><br><span class="line">	<span class="type">int</span> (*verify_hash)(</span><br><span class="line">               <span class="type">void</span> *data_ptr, <span class="type">unsigned</span> <span class="type">int</span> data_len,       <span class="comment">/* 要计算哈希的数据 */</span></span><br><span class="line">			   <span class="type">void</span> *digest_info_ptr, <span class="type">unsigned</span> <span class="type">int</span> digest_info_len);<span class="comment">/* 哈希值 */</span></span><br><span class="line">&#125; <span class="type">crypto_lib_desc_t</span>;</span><br></pre></td></tr></table></figure>
<p>通过 <code>REGISTER_CRYPTO_LIB</code>  宏实现一个名为 <code>crypto_lib_desc</code>  类型为 <code>crypto_lib_desc_t</code>  结构体。宏实现如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#define REGISTER_CRYPTO_LIB(_name, _init, _verify_signature, _verify_hash) \</span><br><span class="line">	const crypto_lib_desc_t crypto_lib_desc = &#123; \</span><br><span class="line">		.name = _name, \</span><br><span class="line">		.init = _init, \</span><br><span class="line">		.verify_signature = _verify_signature, \</span><br><span class="line">		.verify_hash = _verify_hash \</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>此模块通过操作 crypto_lib_desc 变量，实现模块初始化、校验签名、校验哈希。函数声明如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/* 模块初始化 */</span><br><span class="line">void crypto_mod_init(void);</span><br><span class="line"></span><br><span class="line">/* 校验签名 */</span><br><span class="line">int crypto_mod_verify_signature(void *data_ptr, unsigned int data_len,</span><br><span class="line">				void *sig_ptr, unsigned int sig_len,</span><br><span class="line">				void *sig_alg, unsigned int sig_alg_len,</span><br><span class="line">				void *pk_ptr, unsigned int pk_len);</span><br><span class="line">/* 校验哈希值 */</span><br><span class="line">int crypto_mod_verify_hash(void *data_ptr, unsigned int data_len,</span><br><span class="line">			   void *digest_info_ptr, unsigned int digest_info_len);</span><br></pre></td></tr></table></figure>
<h5 id="auth_mod_init"><a class="markdownIt-Anchor" href="#auth_mod_init">#</a> auth_mod_init()</h5>
<p>auth_mod 实现了一个校验镜像的模型，此模型通过结构体 <code>auth_img_desc_t</code>  描述，跟进 auth_mod_init,</p>
<p><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202204192243044.png" alt="image-20220419224356942"></p>
<p>在 auth.mod.h 中定义了 auth_img_desc_s 结构体</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">typedef struct auth_img_desc_s &#123;</span><br><span class="line">	/* 镜像的ID,标志是哪一个镜像 */</span><br><span class="line">	unsigned int img_id;</span><br><span class="line"></span><br><span class="line">	/* 镜像类型(Binary、证书等) */</span><br><span class="line">	img_type_t img_type;</span><br><span class="line"></span><br><span class="line">	/* 父镜像，保存了认证当前镜像的公钥、哈希等 */</span><br><span class="line">	const struct auth_img_desc_s *parent;</span><br><span class="line"></span><br><span class="line">	/* 认证当前镜像的方法 */</span><br><span class="line">	auth_method_desc_t img_auth_methods[AUTH_METHOD_NUM];</span><br><span class="line"></span><br><span class="line">	/* 用于校验子镜像的公钥、哈希等 */</span><br><span class="line">	auth_param_desc_t authenticated_data[COT_MAX_VERIFIED_PARAMS];</span><br><span class="line">&#125; auth_img_desc_t;</span><br></pre></td></tr></table></figure>
<p>并定义一个宏 <code>REGISTER_COT</code> ，用于注册 <code>auth_img_desc_t</code>  数组</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#define REGISTER_COT(_cot) \</span><br><span class="line">	const auth_img_desc_t *const cot_desc_ptr = \</span><br><span class="line">			(const auth_img_desc_t *const)&amp;_cot[0]; \</span><br><span class="line">	unsigned int auth_img_flags[sizeof(_cot)/sizeof(_cot[0])]</span><br></pre></td></tr></table></figure>
<p><code>auth_mod_verify_img</code>  通过 <code>img_id</code>  访问 <code>cot_desc_ptr</code>  数组，找到对应的镜像描述符 <code>auth_method_desc_t</code> ，即可知道当前镜像的认证方式，访问父节点找到签名的公钥或哈希，即可认证当前镜像是否合法。在认证完当前镜像后，从镜像中解析出公钥哈希等放入当前的镜像描述符中，便于对下一级镜像校验</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">int auth_mod_verify_img(unsigned int img_id,</span><br><span class="line">			void *img_ptr,</span><br><span class="line">			unsigned int img_len)</span><br><span class="line">&#123;</span><br><span class="line">	const auth_img_desc_t *img_desc = NULL;</span><br><span class="line">	const auth_method_desc_t *auth_method = NULL;</span><br><span class="line">	void *param_ptr;</span><br><span class="line">	unsigned int param_len;</span><br><span class="line">	int rc, i;</span><br><span class="line"></span><br><span class="line">	/* 根据img_id获取镜像描述符 */</span><br><span class="line">	img_desc = &amp;cot_desc_ptr[img_id];</span><br><span class="line"></span><br><span class="line">	/* 校验镜像完整性 */</span><br><span class="line">	rc = img_parser_check_integrity(img_desc-&gt;img_type, img_ptr, img_len);</span><br><span class="line">	return_if_error(rc);</span><br><span class="line"></span><br><span class="line">	/* 根据镜像描述符的仍正方式对镜像进行认证 */</span><br><span class="line">	for (i = 0 ; i &lt; AUTH_METHOD_NUM ; i++) &#123;</span><br><span class="line">		auth_method = &amp;img_desc-&gt;img_auth_methods[i];</span><br><span class="line">		switch (auth_method-&gt;type) &#123;</span><br><span class="line">		case AUTH_METHOD_NONE:/* 不需要认证 */</span><br><span class="line">			rc = 0;</span><br><span class="line">			break;</span><br><span class="line">		case AUTH_METHOD_HASH:/* 哈希认证 */</span><br><span class="line">			rc = auth_hash(&amp;auth_method-&gt;param.hash,</span><br><span class="line">					img_desc, img_ptr, img_len);</span><br><span class="line">			break;</span><br><span class="line">		case AUTH_METHOD_SIG:/* 签名认证 */</span><br><span class="line">			rc = auth_signature(&amp;auth_method-&gt;param.sig,</span><br><span class="line">					img_desc, img_ptr, img_len);</span><br><span class="line">			break;</span><br><span class="line">		case AUTH_METHOD_NV_CTR:/* Non-Volatile counter认证？ */</span><br><span class="line">			rc = auth_nvctr(&amp;auth_method-&gt;param.nv_ctr,</span><br><span class="line">					img_desc, img_ptr, img_len);</span><br><span class="line">			break;</span><br><span class="line">		default:</span><br><span class="line">			/* 未知认证类型，报错 */</span><br><span class="line">			rc = 1;</span><br><span class="line">			break;</span><br><span class="line">		&#125;</span><br><span class="line">		return_if_error(rc);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/* 从镜像中解析出公钥哈希等，以便对下一级镜像进行认证 */</span><br><span class="line">	for (i = 0 ; i &lt; COT_MAX_VERIFIED_PARAMS ; i++) &#123;</span><br><span class="line">		if (img_desc-&gt;authenticated_data[i].type_desc == NULL) &#123;</span><br><span class="line">			continue;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		/* 通过镜像解析器从镜像中提取内容 */</span><br><span class="line">		rc = img_parser_get_auth_param(img_desc-&gt;img_type,</span><br><span class="line">				img_desc-&gt;authenticated_data[i].type_desc,</span><br><span class="line">				img_ptr, img_len, &amp;param_ptr, &amp;param_len);</span><br><span class="line">		return_if_error(rc);</span><br><span class="line"></span><br><span class="line">		/* 异常检查</span><br><span class="line">		   防止从镜像中解析出的数据字节数大于镜像描述符中的字节数</span><br><span class="line">		   出现内存访问溢出 */</span><br><span class="line">		if (param_len &gt; img_desc-&gt;authenticated_data[i].data.len) &#123;</span><br><span class="line">			return 1;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		/* 把解析出的内容拷贝到镜像描述符中，便于解析下一级BL */</span><br><span class="line">		memcpy((void *)img_desc-&gt;authenticated_data[i].data.ptr,</span><br><span class="line">				(void *)param_ptr, param_len);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/* 标记镜像以认证过 */</span><br><span class="line">	auth_img_flags[img_desc-&gt;img_id] |= IMG_FLAG_AUTHENTICATED;</span><br><span class="line"></span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="bl2_image_load_v2c"><a class="markdownIt-Anchor" href="#bl2_image_load_v2c">#</a> BL2_image_load_v2.c</h4>
<p>该函数用来加载 bl3x 的 image 到 RAM 中，返回一个具有 image 入口信息的变量。smc handle 根据该变量跳转到 bl31 进行执行。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="type">entry_point_info_t</span> *<span class="title function_">bl2_load_images</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">bl_params_t</span> *bl2_to_next_bl_params;</span><br><span class="line"><span class="type">bl_load_info_t</span> *bl2_load_info;</span><br><span class="line"><span class="type">const</span> <span class="type">bl_load_info_node_t</span> *bl2_node_info;</span><br><span class="line"><span class="type">int</span> plat_setup_done = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> err;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* Get information about the images to load.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">/* 获取bl3x image的加载和入口信息 */</span></span><br><span class="line">bl2_load_info = plat_get_bl_image_load_info();</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 检查返回的bl2_load_info中的信息是否正确 */</span></span><br><span class="line">assert(bl2_load_info);</span><br><span class="line">assert(bl2_load_info-&gt;head);</span><br><span class="line">assert(bl2_load_info-&gt;h.type == PARAM_BL_LOAD_INFO);</span><br><span class="line">assert(bl2_load_info-&gt;h.version &gt;= VERSION_2);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 将bl2_load_info中的head变量的值赋值为bl2_node_info，即将bl31 image的入口信息传递給bl2_node_info变量 */</span></span><br><span class="line">bl2_node_info = bl2_load_info-&gt;head;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 进入loop循环， */</span></span><br><span class="line"><span class="keyword">while</span> (bl2_node_info) &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* Perform platform setup before loading the image,</span></span><br><span class="line"><span class="comment">* if indicated in the image attributes AND if NOT</span></span><br><span class="line"><span class="comment">* already done before.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">/* 在加载特定的bl3x image到RAM之前先确定是否需要做平台的初始化 */</span></span><br><span class="line"><span class="keyword">if</span> (bl2_node_info-&gt;image_info-&gt;h.attr &amp; IMAGE_ATTRIB_PLAT_SETUP) &#123;</span><br><span class="line"><span class="keyword">if</span> (plat_setup_done) &#123;</span><br><span class="line">WARN(<span class="string">&quot;BL2: Platform setup already done!!\n&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">INFO(<span class="string">&quot;BL2: Doing platform setup\n&quot;</span>);</span><br><span class="line">bl2_platform_setup();</span><br><span class="line">plat_setup_done = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 对bl3x image进行电子验签，如果通过则执行加载操作 */</span></span><br><span class="line"><span class="keyword">if</span> (!(bl2_node_info-&gt;image_info-&gt;h.attr &amp; IMAGE_ATTRIB_SKIP_LOADING)) &#123;</span><br><span class="line">INFO(<span class="string">&quot;BL2: Loading image id %d\n&quot;</span>, bl2_node_info-&gt;image_id);</span><br><span class="line">err = load_auth_image(bl2_node_info-&gt;image_id,</span><br><span class="line">bl2_node_info-&gt;image_info);</span><br><span class="line"><span class="keyword">if</span> (err) &#123;</span><br><span class="line">ERROR(<span class="string">&quot;BL2: Failed to load image (%i)\n&quot;</span>, err);</span><br><span class="line">plat_error_handler(err);</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">INFO(<span class="string">&quot;BL2: Skip loading image id %d\n&quot;</span>, bl2_node_info-&gt;image_id);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Allow platform to handle image information. */</span></span><br><span class="line"><span class="comment">/* 可以根据实际需要更改，通过给定image ID来更改image的加载信息 */</span></span><br><span class="line">err = bl2_plat_handle_post_image_load(bl2_node_info-&gt;image_id);</span><br><span class="line"><span class="keyword">if</span> (err) &#123;</span><br><span class="line">ERROR(<span class="string">&quot;BL2: Failure in post image load handling (%i)\n&quot;</span>, err);</span><br><span class="line">plat_error_handler(err);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Go to next image */</span></span><br><span class="line">bl2_node_info = bl2_node_info-&gt;next_load_info;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* Get information to pass to the next image.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">/* 获取下一个执行的Image的入口信息，并且将以后会被执行的image的入口信息组合成链表 ,t通过判断image des中的ep_info.h.attr的值是否为（EXECUTABLE|EP_FIRST_EX）来确定接下来第一个被执行的image*/</span></span><br><span class="line">bl2_to_next_bl_params = plat_get_next_bl_params();</span><br><span class="line">assert(bl2_to_next_bl_params);</span><br><span class="line">assert(bl2_to_next_bl_params-&gt;head);</span><br><span class="line">assert(bl2_to_next_bl_params-&gt;h.type == PARAM_BL_PARAMS);</span><br><span class="line">assert(bl2_to_next_bl_params-&gt;h.version &gt;= VERSION_2);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Flush the parameters to be passed to next image */</span></span><br><span class="line">plat_flush_next_bl_params();</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 返回下一个进入的image的入口信息,即bl31的入口信息 */</span></span><br><span class="line"><span class="keyword">return</span> bl2_to_next_bl_params-&gt;head-&gt;ep_info;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="四-分析结论"><a class="markdownIt-Anchor" href="#四-分析结论">#</a> 四、分析结论</h1>
<p>​		结合 ATF 整个信任链条建立的流程图，我们了解到可信启动中的安全模块和可信机制，从作为信任根的 BL1 开始，逐步进行初始化和加载镜像，最后来到 BL33，后面就是 OS 了。</p>
<p>最后引用一张 ATF 的 UEFI 启动流程进行更直观展示：</p>
<p><img src="https://pic2.zhimg.com/80/v2-fac683117333c274fd22832772342d81_1440w.jpg" alt="img"></p>
<p>以上仅是对 ATF 可信启动机制的简要分析，而对于 ATF 的更深层次技术需要更多信息搜集和整理研究。</p>
<h1 id="五-参考文章"><a class="markdownIt-Anchor" href="#五-参考文章">#</a> 五、参考文章</h1>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/391101179">https://zhuanlan.zhihu.com/p/391101179</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/hardenedlinux/embedded-iot_profile/blob/master/docs/arm64/arm-trusted-firmware%E5%88%86%E6%9E%90.md">https://github.com/hardenedlinux/embedded-iot_profile/blob/master/docs/arm64/arm-trusted-firmware 分析.md</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/puyoupuyou/article/details/109506419?spm=1001.2101.3001.6650.15&amp;utm_medium=distribute.pc_relevant.none-task-blog-2">https://blog.csdn.net/puyoupuyou/article/details/109506419?spm=1001.2101.3001.6650.15&amp;utm_medium=distribute.pc_relevant.none-task-blog-2</a><sub>default</sub>BlogCommendFromBaidu<sub>Rate-15.topblog&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2</sub>default<sub>BlogCommendFromBaidu</sub>Rate-15.topblog&amp;utm_relevant_index=20</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>arm-trusted-firmware可信启动机制</p><p><a href="https://y1seco.github.io/2022/04/20/ATF安全技术调研报告/">https://y1seco.github.io/2022/04/20/ATF安全技术调研报告/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><a href="https://y1seco.github.io"><p>y1seco</p></a></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2022-04-20</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2022-04-20</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="icon" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a><a class="icon" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="recommend-area"></div><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/css/share.min.css"><div class="social-share"></div><script src="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">Like this article? Support the author with</h3><div class="buttons is-centered"><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>Alipay</span><span class="qrcode"><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202112251641315.png" alt="Alipay"></span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>Wechat</span><span class="qrcode"><img src="https://raw.githubusercontent.com/y1seco/blog_image/master/img/202112251641009.png" alt="Wechat"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2022/04/10/OPTEE_ATF/"><span class="level-item">基于QEMU的OPTEE/ATF学习</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--><div class="card"><div class="card-content"><div class="title is-5">Comments</div><div id="comment-container"></div><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/gitalk/1.6.0/gitalk.css"><script> $.getScript('/js/gitalk.min.js', function () { 
            var gitalk = new Gitalk({
            language:'zh-CN',
            id: '3d9981d53f6c0bbc249c97d69eab8dbb',
            repo: 'blog_comments',
            owner: 'y1seco',
            clientID: 'fd76c4da4d218138902f',
            clientSecret: '4e352bc8c73327810c18892ef0a825d8ec6cb020',
            admin: ["y1seco"],
            createIssueManually: true,
            distractionFreeMode: false,
            perPage: 10,
            pagerDirection: 'last',
            proxy: 'https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token',
            
            enableHotKey: true,
            isLocked: false
        })
        gitalk.render('comment-container')});</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="is-flex is-mobile" href="#arm安全技术atf的可信启动"><span class="mr-2">1</span><span> ARM 安全技术（ATF 的可信启动）</span></a></li><li><a class="is-flex is-mobile" href="#一-目标"><span class="mr-2">2</span><span> 一、目标</span></a></li><li><a class="is-flex is-mobile" href="#二-核心服务原理分析"><span class="mr-2">3</span><span> 二、核心服务原理分析</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#一安全启动与信任链"><span class="mr-2">3.1</span><span> （一）安全启动与信任链</span></a></li><li><a class="is-flex is-mobile" href="#二安全启动流程图"><span class="mr-2">3.2</span><span> （二）安全启动流程图</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#aarch64-bl31el3-runtime-software-execution"><span class="mr-2">3.2.1</span><span> AArch64 BL31(EL3 Runtime Software) execution</span></a></li></ul></li></ul></li><li><a class="is-flex is-mobile" href="#三-源代码分析"><span class="mr-2">4</span><span> 三、源代码分析</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#一bl1trusted-boot-rom分析"><span class="mr-2">4.1</span><span> （一）BL1（Trusted Boot ROM）分析</span></a></li><li><a class="is-flex is-mobile" href="#二bl2trusted-boot-firmware分析"><span class="mr-2">4.2</span><span> （二）BL2（Trusted Boot Firmware）分析</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#1-功能概要"><span class="mr-2">4.2.1</span><span> 1、功能概要</span></a></li><li><a class="is-flex is-mobile" href="#bl2_image_load_v2c"><span class="mr-2">4.2.2</span><span> BL2_image_load_v2.c</span></a></li></ul></li></ul></li><li><a class="is-flex is-mobile" href="#四-分析结论"><span class="mr-2">5</span><span> 四、分析结论</span></a></li><li><a class="is-flex is-mobile" href="#五-参考文章"><span class="mr-2">6</span><span> 五、参考文章</span></a></li></ul></div></div><style>.menu-list > li > a.is-active + .menu-list { display: block; }.menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/./img/avatar1.jpg" alt="y1seco"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">y1seco</p><p class="is-size-6 is-block">Trying to do better</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">26</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">10</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">9</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/y1seco" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/y1seco"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Email" href="mailto:K4oer_Xr@bupt.edu.cn"><i class="fa fa-envelope"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/atom.xml"><i class="fas fa-rss"></i></a></div><div><hr><p id="hitokoto">:D 一言句子获取中...</p><script type="text/javascript" defer>function getYiyan(){
                                $.getJSON("https://v1.hitokoto.cn/", function (data) {
                                if(data){
                                    $('#hitokoto').html("");
                                    $('#hitokoto').append("<strong style='color: #3273dc;'>"+data.hitokoto+"</strong>"+
                                    "<p>"+"From《"+data.from+"》</p><p>Provider-"+data.creator+"</p>");
                                }});}
                                $(function (){getYiyan();$('#hitokoto').click(function(){getYiyan();})});</script></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">Links</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://P4nda.top" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">P4nda</span></span><span class="level-right"><span class="level-item tag">p4nda.top</span></span></a></li><li><a class="level is-mobile" href="https://ama2in9.top/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Ama2in9</span></span><span class="level-right"><span class="level-item tag">ama2in9.top</span></span></a></li><li><a class="level is-mobile" href="https://eternalsakura13.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Sakura</span></span><span class="level-right"><span class="level-item tag">eternalsakura13.com</span></span></a></li><li><a class="level is-mobile" href="https://p1umer.github.io/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">P1umer</span></span><span class="level-right"><span class="level-item tag">p1umer.github.io</span></span></a></li><li><a class="level is-mobile" href="https://e0hyl.github.io/BLOG-OF-E0/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">E0</span></span><span class="level-right"><span class="level-item tag">e0hyl.github.io</span></span></a></li><li><a class="level is-mobile" href="https://linkleyping.top/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">EP</span></span><span class="level-right"><span class="level-item tag">linkleyping.top</span></span></a></li></ul></div></div></div><!--!--><div class="card widget"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><figure class="media-left"><a class="image" href="/2022/04/20/ATF%E5%AE%89%E5%85%A8%E6%8A%80%E6%9C%AF%E8%B0%83%E7%A0%94%E6%8A%A5%E5%91%8A/"><img src="https://w.wallhaven.cc/full/1k/wallhaven-1km5dg.jpg" alt="arm-trusted-firmware可信启动机制"></a></figure><div class="media-content"><p class="date"><time dateTime="2022-04-20T02:36:32.926Z">2022-04-20</time></p><p class="title"><a href="/2022/04/20/ATF%E5%AE%89%E5%85%A8%E6%8A%80%E6%9C%AF%E8%B0%83%E7%A0%94%E6%8A%A5%E5%91%8A/">arm-trusted-firmware可信启动机制</a></p><p class="categories"><a href="/categories/arm/">arm</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2022/04/10/OPTEE_ATF/"><img src="https://w.wallhaven.cc/full/l3/wallhaven-l37vzy.png" alt="基于QEMU的OPTEE/ATF学习"></a></figure><div class="media-content"><p class="date"><time dateTime="2022-04-10T13:52:08.727Z">2022-04-10</time></p><p class="title"><a href="/2022/04/10/OPTEE_ATF/">基于QEMU的OPTEE/ATF学习</a></p><p class="categories"><a href="/categories/qemu/">qemu</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2022/03/07/vue%E5%BC%80%E5%8F%91%20(1)/"><img src="https://w.wallhaven.cc/full/3z/wallhaven-3zy6r3.jpg" alt="vue开发问题总结"></a></figure><div class="media-content"><p class="date"><time dateTime="2022-03-06T16:38:29.355Z">2022-03-07</time></p><p class="title"><a href="/2022/03/07/vue%E5%BC%80%E5%8F%91%20(1)/">vue开发问题总结</a></p><p class="categories"><a href="/categories/vue/">vue</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2022/03/03/BUUOJ%20PWN%20EXERCISE(%E4%B8%89%EF%BC%89/"><img src="https://w.wallhaven.cc/full/v9/wallhaven-v9v3r5.jpg" alt="BUUOJ PWN EXERCISE(二)"></a></figure><div class="media-content"><p class="date"><time dateTime="2022-03-03T10:11:18.801Z">2022-03-03</time></p><p class="title"><a href="/2022/03/03/BUUOJ%20PWN%20EXERCISE(%E4%B8%89%EF%BC%89/">BUUOJ PWN EXERCISE(二)</a></p><p class="categories"><a href="/categories/pwn/">pwn</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2022/02/27/CTFSHOW%E5%8D%B7%E7%8E%8B%E6%9D%AF-%20Incomplete%20Menu/"><img src="https://w.wallhaven.cc/full/o3/wallhaven-o3vyk5.jpg" alt="CTFSHOW卷王杯-pwn"></a></figure><div class="media-content"><p class="date"><time dateTime="2022-02-27T14:53:54.034Z">2022-02-27</time></p><p class="title"><a href="/2022/02/27/CTFSHOW%E5%8D%B7%E7%8E%8B%E6%9D%AF-%20Incomplete%20Menu/">CTFSHOW卷王杯-pwn</a></p><p class="categories"><a href="/categories/pwn/">pwn</a></p></div></article></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/categories/Kernel/"><span class="level-start"><span class="level-item">Kernel</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/arm/"><span class="level-start"><span class="level-item">arm</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/flask/"><span class="level-start"><span class="level-item">flask</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/leetcode/"><span class="level-start"><span class="level-item">leetcode</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/pwn/"><span class="level-start"><span class="level-item">pwn</span></span><span class="level-end"><span class="level-item tag">15</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/pwnable-tw/"><span class="level-start"><span class="level-item">pwnable.tw</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/qemu/"><span class="level-start"><span class="level-item">qemu</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/vue/"><span class="level-start"><span class="level-item">vue</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"><span class="level-start"><span class="level-item">数据结构</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E9%9A%8F%E7%AC%94/"><span class="level-start"><span class="level-item">随笔</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><a class="level is-mobile is-marginless" href="/categories/"><span class="level-start"><span class="level-item">查看全部&gt;&gt;</span></span></a></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/archives/2022/04/"><span class="level-start"><span class="level-item">April 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2022/03/"><span class="level-start"><span class="level-item">March 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2022/02/"><span class="level-start"><span class="level-item">February 2022</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2022/01/"><span class="level-start"><span class="level-item">January 2022</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2021/12/"><span class="level-start"><span class="level-item">December 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><a class="level is-mobile is-marginless" href="/archives/"><span class="level-start"><span class="level-item">查看全部&gt;&gt;</span></span></a></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/pwn/"><span class="tag">pwn</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/leetcode/"><span class="tag">leetcode</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%9A%8F%E7%AC%94/"><span class="tag">随笔</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Kernel/"><span class="tag">Kernel</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/arm/"><span class="tag">arm</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/flask/"><span class="tag">flask</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/qemu/"><span class="tag">qemu</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vue/"><span class="tag">vue</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"><span class="tag">数据结构</span><span class="tag is-grey-lightest">1</span></a></div></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">Subscribe for updates</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div><!--!--><div class="column-right-shadow is-hidden-widescreen"></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/./img/avatar1.jpg" alt="Y1secoのblog" height="28"></a><p class="size-small"><span>&copy; 2022 y1seco</span>  Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a> &amp; <a href="https://github.com/removeif/hexo-theme-amazing" target="_blank">Amazing</a> <br><span><span id="statistic-times">loading...</span><script>function createTime(time) {
            var n = new Date(time);
            now.setTime(now.getTime() + 250),
                days = (now - n) / 1e3 / 60 / 60 / 24,
                dnum = Math.floor(days),
                hours = (now - n) / 1e3 / 60 / 60 - 24 * dnum,
                hnum = Math.floor(hours),
            1 == String(hnum).length && (hnum = "0" + hnum),
                minutes = (now - n) / 1e3 / 60 - 1440 * dnum - 60 * hnum,
                mnum = Math.floor(minutes),
            1 == String(mnum).length && (mnum = "0" + mnum),
                seconds = (now - n) / 1e3 - 86400 * dnum - 3600 * hnum - 60 * mnum,
                snum = Math.round(seconds),
            1 == String(snum).length && (snum = "0" + snum),
                document.getElementById("statistic-times").innerHTML = "❤️Site from <strong>"+time.split(" ")[0].replace(/\//g,".")+"</strong> has existed <strong>" + dnum + "</strong> d <strong>" + hnum + "</strong> h <strong>" + mnum + "</strong> m <strong>" + snum + "</strong> s！❤️";
        }var now = new Date();setInterval("createTime('2021/12/8 00:00:00')", 250,"");</script><br></span><div class="size-small"><span>❤️Thx <strong><span id="busuanzi_value_site_uv">99+</span></strong> users <strong><span id="busuanzi_value_site_pv">99+</span></strong> visited！❤️</span></div></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/removeif/hexo-theme-amazing"><i class="fab fa-github"></i></a></p></div><div class="sideMusic"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css"><script src="/js/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script><meting-js style="width: auto;height: 2000px;" server="netease" type="playlist" id="2364053447" theme="#2980b9" loop="all" autoplay="false" order="list" storageName="aplayer-setting" lrctype="0" list-max-height="400px" fixed="true"></meting-js></div></div></div></div></footer><script src="https://cdnjs.loli.net/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" async></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/js/lightgallery.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><script>$.getScript('/js/comment-issue-data.js',function(){loadIssueData('fd76c4da4d218138902f','4e352bc8c73327810c18892ef0a825d8ec6cb020','y1seco','blog_comments',false);})</script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.js"></script><script type="text/javascript">var pjax = new Pjax({
            elements: "a",//代表点击链接就更新
            selectors: [  //代表要更新的节点
                ".section",
                "title"
            ],
            cache: true,
            cacheBust:false
        })

        function loadBusuanzi(){
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js", function () {});
        }

        function loadMathJax() { //加载mathjax
            $.getScript("//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML", function () {
                MathJax.Hub.Config({ tex2jax: { inlineMath: [['$', '$'], ['\(', '\)']] } });
                var math = document.getElementsByClassName("entry-content")[0];
                MathJax.Hub.Queue(["Typeset", MathJax.Hub, math]);
            });
        };

        // 开始 PJAX 执行的函数
        document.addEventListener('pjax:send', function () {
        });
        
        // PJAX 完成之后执行的函数，可以和上面的重载放在一起
        document.addEventListener('pjax:complete', function () {
            $(".section").css({opacity:1});
            if(false){
                $.getScript('/js/comment-issue-data.js',function(){loadIssueData('fd76c4da4d218138902f','4e352bc8c73327810c18892ef0a825d8ec6cb020','y1seco','blog_comments',false);});
            }
            if(false){
                loadMathJax();
            }
            loadMainJs(jQuery, window.moment, window.ClipboardJS, window.IcarusThemeSettings);
            loadBackTop();
            loadBusuanzi();
            if(typeof loadBanner == 'function'){
                loadBanner();
            }
        });</script></body></html>